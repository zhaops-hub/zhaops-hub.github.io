<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title></title>
    <link href="/wiki/2024/04/29/mysql/liquibase/liquibase%20%E5%91%BD%E4%BB%A4%E8%A1%8C/"/>
    <url>/wiki/2024/04/29/mysql/liquibase/liquibase%20%E5%91%BD%E4%BB%A4%E8%A1%8C/</url>
    
    <content type="html"><![CDATA[<h2 id="配置信息"><a href="#配置信息" class="headerlink" title="配置信息"></a>配置信息</h2><h3 id="liquibase-properties"><a href="#liquibase-properties" class="headerlink" title="liquibase.properties"></a>liquibase.properties</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx">driver: com.mysql.cj.jdbc.<span class="hljs-attribute">Driver</span><br>classpath: ./mysql-connector-java-<span class="hljs-number">8</span>.<span class="hljs-number">0</span>.<span class="hljs-number">11</span>.jar<br>url: jdbc:mysql://127.0.0.1:3306/test?useSSL=false&amp;serverTimezone=UTC&amp;autoReconnect=true&amp;allowPublicKeyRetrieval=true&amp;useOldAliasMetadataBehavior=true<br>username: root<br>password: abc123<br>changeLogFile: myChangeLog.xml<br>liquibase.hub.mode=<span class="hljs-literal">off</span><br></code></pre></td></tr></table></figure><ol><li><p><code>mysql-connector-java-8.0.11.jar</code> 提前下载好放到同级目录下面.</p></li><li><p>如果使用 <code>liquibase diff</code> 需要增加 <code>reference</code> 配置节点</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx">referenceUrl: jdbc:mysql://127.0.0.1:3306/test?useSSL=false&amp;serverTimezone=UTC&amp;autoReconnect=true&amp;allowPublicKeyRetrieval=true&amp;useOldAliasMetadataBehavior=<span class="hljs-attribute">true</span><br>referenceUsername: root<br>referencePassword: abc123<br></code></pre></td></tr></table></figure></li></ol><h3 id="myChangeLog-xml"><a href="#myChangeLog-xml" class="headerlink" title="myChangeLog.xml"></a>myChangeLog.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">databaseChangeLog</span></span><br><span class="hljs-tag">                   <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.liquibase.org/xml/ns/dbchangelog&quot;</span></span><br><span class="hljs-tag">                   <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">                   <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.liquibase.org/xml/ns/dbchangelog</span></span><br><span class="hljs-string"><span class="hljs-tag">                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd&quot;</span>&gt;</span><br>  <br>  <span class="hljs-comment">&lt;!-- </span><br><span class="hljs-comment">  1.file：表示将此路径下 /sql/001_create_person_table.sql 目录中的 changelog 文件引入。</span><br><span class="hljs-comment">  假设 db 目录下还有其他模块（目录），继续通过 &lt;include&gt; 或 &lt;includeAll&gt; 元素引入即可。 </span><br><span class="hljs-comment">  2.relativeToChangelogFile：为 true 时表示使用的是相对路径 而不是classpath</span><br><span class="hljs-comment">  --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">file</span>=<span class="hljs-string">&quot;./sql/create_table.xml&quot;</span> <span class="hljs-attr">relativeToChangelogFile</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">file</span>=<span class="hljs-string">&quot;./sql/init_data.sql&quot;</span> <span class="hljs-attr">relativeToChangelogFile</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">databaseChangeLog</span>&gt;</span><br></code></pre></td></tr></table></figure><ol><li>include 可以设置多个,  现在这个配置<code>create_table.xml</code> 是表结构, <code>init_data.sql</code>是数据.</li></ol><h3 id="create-table-xml"><a href="#create-table-xml" class="headerlink" title="create_table.xml"></a>create_table.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">databaseChangeLog</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.liquibase.org/xml/ns/dbchangelog&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.liquibase.org/xml/ns/dbchangelog</span></span><br><span class="hljs-string"><span class="hljs-tag">         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd&quot;</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">changeSet</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;1&quot;</span> <span class="hljs-attr">author</span>=<span class="hljs-string">&quot;zhaopeisheng&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">createTable</span> <span class="hljs-attr">tableName</span>=<span class="hljs-string">&quot;department&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;int&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">constraints</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">nullable</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">column</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;varchar(50)&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">constraints</span> <span class="hljs-attr">nullable</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">column</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;active&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;varchar(1)&quot;</span> <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">&quot;Y&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">createTable</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">changeSet</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">databaseChangeLog</span>&gt;</span><br><br></code></pre></td></tr></table></figure><ol><li><code>id</code> 和 <code>author</code> 必填</li></ol><h3 id="init-data-sql"><a href="#init-data-sql" class="headerlink" title="init_data.sql"></a>init_data.sql</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- liquibase formatted sql</span><br><span class="hljs-comment">-- changeset jack:2022_04_2</span><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> department <span class="hljs-keyword">values</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;研发部&#x27;</span>, <span class="hljs-string">&#x27;Y&#x27;</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> department <span class="hljs-keyword">values</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;销售部&#x27;</span>, <span class="hljs-string">&#x27;Y&#x27;</span>);<br><span class="hljs-comment">-- changeset tom:2022_04_22</span><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> department <span class="hljs-keyword">values</span>(<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;后勤部&#x27;</span>, <span class="hljs-string">&#x27;Y&#x27;</span>);<br></code></pre></td></tr></table></figure><ol><li>文件开始必须以 <code>-- liquibase formatted sql</code> 开头</li><li>每一个<code>changeset</code> 格式 <code>-- changeset author:id</code></li></ol><h2 id="整体项目结构图"><a href="#整体项目结构图" class="headerlink" title="整体项目结构图"></a>整体项目结构图</h2><p><img src="/wiki/img/liquibase/1.png"></p><h2 id="设置数据库"><a href="#设置数据库" class="headerlink" title="设置数据库"></a>设置数据库</h2><h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">liquibase update<br></code></pre></td></tr></table></figure><h3 id="执行日志"><a href="#执行日志" class="headerlink" title="执行日志"></a>执行日志</h3><p><img src="/wiki/img/liquibase/2.png"></p><h3 id="查看数据库"><a href="#查看数据库" class="headerlink" title="查看数据库"></a>查看数据库</h3><p><img src="/wiki/img/liquibase/3.png"></p><p><img src="/wiki/img/liquibase/4.png"></p><p>前两张表<code>databasechangelog</code> <code>databasechangeloglock</code> 是liquibase的业务表.</p><h3 id="给当前版本数据库打标签"><a href="#给当前版本数据库打标签" class="headerlink" title="给当前版本数据库打标签"></a>给当前版本数据库打标签</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">liquibase tag v1.0<br>liquibase <span class="hljs-built_in">history</span><br>+---------------+----------------+----------------------+------------------+--------------+------+<br>| Deployment ID | Update Date    | Changelog Path       | Changeset Author | Changeset ID | Tag  |<br>+---------------+----------------+----------------------+------------------+--------------+------+<br>| 4357274202    | 24-4-29 下午6:21 | sql/create_table.xml | zhaopeisheng     | 1            |      |<br>+---------------+----------------+----------------------+------------------+--------------+------+<br>| 4357274202    | 24-4-29 下午6:21 | sql/init_data.sql    | jack             | 2022_04_2    |      |<br>+---------------+----------------+----------------------+------------------+--------------+------+<br>| 4357274202    | 24-4-29 下午6:21 | sql/init_data.sql    | tom              | 2022_04_22   | v1.0 |<br>+---------------+----------------+----------------------+------------------+--------------+------+<br></code></pre></td></tr></table></figure><h3 id="新增changeset记录"><a href="#新增changeset记录" class="headerlink" title="新增changeset记录"></a>新增changeset记录</h3><p>这种场景是项目在开发过程中新增表了.</p><p>在<code>create_table.xml</code> 记录增加新表</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">changeSet</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">author</span>=<span class="hljs-string">&quot;zhaopeisheng&quot;</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">createTable</span> <span class="hljs-attr">tableName</span>=<span class="hljs-string">&quot;org&quot;</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;int&quot;</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">constraints</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">nullable</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>         <span class="hljs-tag">&lt;/<span class="hljs-name">column</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;varchar(50)&quot;</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">constraints</span> <span class="hljs-attr">nullable</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>         <span class="hljs-tag">&lt;/<span class="hljs-name">column</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">createTable</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">changeSet</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh">liquibase update<br>liquibase tag v2.0<br>liquibase <span class="hljs-built_in">history</span><br><br>+---------------+----------------+----------------------+------------------+--------------+------+<br>| Deployment ID | Update Date    | Changelog Path       | Changeset Author | Changeset ID | Tag  |<br>+---------------+----------------+----------------------+------------------+--------------+------+<br>| 4357274202    | 24-4-29 下午6:21 | sql/create_table.xml | zhaopeisheng     | 1            |      |<br>+---------------+----------------+----------------------+------------------+--------------+------+<br>| 4357274202    | 24-4-29 下午6:21 | sql/init_data.sql    | jack             | 2022_04_2    |      |<br>+---------------+----------------+----------------------+------------------+--------------+------+<br>| 4357274202    | 24-4-29 下午6:21 | sql/init_data.sql    | tom              | 2022_04_22   | v1.0 |<br>+---------------+----------------+----------------------+------------------+--------------+------+<br><br><br>+---------------+----------------+----------------------+------------------+--------------+------+<br>| Deployment ID | Update Date    | Changelog Path       | Changeset Author | Changeset ID | Tag  |<br>+---------------+----------------+----------------------+------------------+--------------+------+<br>| 4358382582    | 24-4-29 下午6:39 | sql/create_table.xml | zhaopeisheng     | 2            | v2.0 |<br></code></pre></td></tr></table></figure><p><img src="/wiki/img/liquibase/5.png"></p><h3 id="回滚版本"><a href="#回滚版本" class="headerlink" title="回滚版本"></a>回滚版本</h3><p>回滚版本必须有 <code>tag</code> 标签的.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">liquibase rollback v1.0<br>liquibase <span class="hljs-built_in">history</span><br>+---------------+----------------+----------------------+------------------+--------------+------+<br>| Deployment ID | Update Date    | Changelog Path       | Changeset Author | Changeset ID | Tag  |<br>+---------------+----------------+----------------------+------------------+--------------+------+<br>| 4357274202    | 24-4-29 下午6:21 | sql/create_table.xml | zhaopeisheng     | 1            |      |<br>+---------------+----------------+----------------------+------------------+--------------+------+<br>| 4357274202    | 24-4-29 下午6:21 | sql/init_data.sql    | jack             | 2022_04_2    |      |<br>+---------------+----------------+----------------------+------------------+--------------+------+<br>| 4357274202    | 24-4-29 下午6:21 | sql/init_data.sql    | tom              | 2022_04_22   | v1.0 |<br>+---------------+----------------+----------------------+------------------+--------------+------+<br></code></pre></td></tr></table></figure><p>v2.0 新增的表被删除掉了</p><h3 id="根据数据库逆向生成changelog-xml"><a href="#根据数据库逆向生成changelog-xml" class="headerlink" title="根据数据库逆向生成changelog.xml"></a>根据数据库逆向生成<code>changelog.xml</code></h3><p>把原来的<code>myChangeLog.xml</code> 改个名字.  <code>liquibase</code> 是根据<code>liquibase.properties</code> 里面的<code>changeLogFile</code> 来生成的文件, 还原的数据库是<code>liquibase.properties</code> 配置的数据库.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">liquibase generate-changelog<br></code></pre></td></tr></table></figure><p>新生成的表结构<code>xml</code>,  这个文件可以直接复制到 <code>create_table.xml</code>,</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.1&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> standalone=<span class="hljs-string">&quot;no&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">databaseChangeLog</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.liquibase.org/xml/ns/dbchangelog&quot;</span> <span class="hljs-attr">xmlns:ext</span>=<span class="hljs-string">&quot;http://www.liquibase.org/xml/ns/dbchangelog-ext&quot;</span> <span class="hljs-attr">xmlns:pro</span>=<span class="hljs-string">&quot;http://www.liquibase.org/xml/ns/pro&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-latest.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">changeSet</span> <span class="hljs-attr">author</span>=<span class="hljs-string">&quot;zhaopeisheng (generated)&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;1714362443795-1&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">createTable</span> <span class="hljs-attr">tableName</span>=<span class="hljs-string">&quot;department&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;INT&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">constraints</span> <span class="hljs-attr">nullable</span>=<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">column</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;VARCHAR(50)&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">constraints</span> <span class="hljs-attr">nullable</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">column</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">&quot;Y&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;active&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;VARCHAR(1)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">createTable</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">changeSet</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">databaseChangeLog</span>&gt;</span><br></code></pre></td></tr></table></figure><p>用生成的<code>xml</code> 还原数据库</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh">liquibase update<br>liquibase <span class="hljs-built_in">history</span><br><br>+---------------+----------------+----------------------+--------------------------+-----------------+-----+<br>| Deployment ID | Update Date    | Changelog Path       | Changeset Author         | Changeset ID    | Tag |<br>+---------------+----------------+----------------------+--------------------------+-----------------+-----+<br>| 4362687615    | 24-4-29 下午7:51 | sql/create_table.xml | zhaopeisheng (generated) | 1714362443795-1 |     |<br>+---------------+----------------+----------------------+--------------------------+-----------------+-----+<br>| 4362687615    | 24-4-29 下午7:51 | sql/init_data.sql    | jack                     | 2022_04_2       |     |<br>+---------------+----------------+----------------------+--------------------------+-----------------+-----+<br>| 4362687615    | 24-4-29 下午7:51 | sql/init_data.sql    | tom                      | 2022_04_22      |     |<br>+---------------+----------------+----------------------+--------------------------+-----------------+-----+<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/wiki/2024/04/28/mysql/liquibase/liquibase/"/>
    <url>/wiki/2024/04/28/mysql/liquibase/liquibase/</url>
    
    <content type="html"><![CDATA[<h2 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h2><p><code>https://github.com/liquibase/liquibase/releases</code></p><p>根据自己的系统下载文件, 直接解压出来, 可执行文件.</p><h2 id="免费命令"><a href="#免费命令" class="headerlink" title="免费命令"></a>免费命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs sh">//版本<br>liquibase --version<br><br>//查看liquibase支持的所有命令<br>liquibase --<span class="hljs-built_in">help</span><br><br>//查看此个命令支持的参数选项信息<br>liquibase 命令 --<span class="hljs-built_in">help</span><br><br>//查看目标数据库是否能连接成功、pro证书信息是否有效（使用高级命令）<br>//当前目录需要有liquibase.properties文件<br>liquibase status<br><br><span class="hljs-comment"># 通过数据库更新 myChangeLog.xml</span><br>//前提：当前目录必须有liquibase.properties文件<br>//基于数据库信息生成一份原始changeLogFile文件<br>//数据库结构快照备份，备份完之后修改liquibase.properties的地址，运行 liquibase update 可快速迁移无需一个一个创建<br>liquibase generate-changelog<br><br>//前提：当前目录必须有liquibase.properties文件以及liquibase.properties定义的changeLogFile文件<br>//基于liquibase.properties属性里面定义的changeLogFile文件来更新、修改数据库<br>liquibase update<br><br><br>//前提：当前目录必须有liquibase.properties文件以及liquibase.properties定义的changeLogFile文件<br>//基于liquibase.properties属性里面定义的changeLogFile文件来更新、修改数据库（最多仅更新10个未部署的&lt;changgeset&gt;的语句，如果某个changeset之前已经部署过就不算）<br>liquibase updateCount 部署changeset节点的个数<br><br>//前提：当前目录必须有liquibase.properties文件以及liquibase.properties定义的changeLogFile文件<br>//基于changeLogFile的文件生成具体的真正可在数据库运行的SQL语句 == 仅仅生成SQL语句不会在数据库中生效，如果想让SQL语句的数据库生效请使用 liquibase update<br>liquibase update-sql<br><br><br>//其实就是展示databasechangelog的记录：FILENAME、ID、AUTHOR、DEPLOYMENT_ID<br>liquibase <span class="hljs-built_in">history</span><br><br><br>//比对数据库结构<br>//选项参数参看：liquibase diff --<span class="hljs-built_in">help</span> <br>//liquibase diff<br>//将比对结果保存在当前目录的diff.txt目录中  == 结果形式看下面的图片即可<br>//liquibase diff   --outputFile=diff.txt<br>//将比对结果保存在当前目录的diff.json目录中，且内容格式是json，结构化数据<br>//liquibase diff  --format=json --outputFile=diff.json<br>liquibase diff<br><br>//生成的文件，表示当前目标数据库在源库表结构相差的东西<br>//生成的文件最后可以使用（使得目标库与源库结构一致）：liquibase update --changelog-file=diffChangelog.xml  <br>liquibase diff-changelog --changelog-file=diffChangelog.xml<br><br><br>//生成数据库结构、changlog文件内容显示 -- 仅能生成html文档<br>liquibase db-doc --output-directory=文档输出目录<br><br><br>//查看当前是否有用户在运行liquibase更改数据库结构 == 即表DATABASECHANGELOGLOCK是否有LOCKED=1的记录<br>liquibase list-locks<br><br>//释放锁 = 将表DATABASECHANGELOGLOCK的LOCKED=1的记录，修改LOCKED=0且将被锁的开始时间LOCKGRANTED、使用锁的IP地址LOCKEDBY都置空<br>//一般来说用不上，因为liquibase正常变更、退出会自动释放锁，如果非正常退出可能锁的状态没来得及释放，需要你手动执行该条命令释放，或者直接去数据库修改锁状态设为0即可<br>liquibase release-locks<br><br><br>//数据库结构快照 == 感觉跟 generate-changgelog差不多 == 文件存放在当前目录下<br>liquibase --outputFile=snapshot.text  snapshot --snapshot-format=text<br>liquibase --outputFile=snapshot.yml  snapshot --snapshot-format=yml<br>liquibase --outputFile=snapshot.json  snapshot --snapshot-format=json<br><br>//表结构回滚<br>liquibase rollback 标签名<br><br>//基于某个changelog文件，表结构回滚最新部署的某几条变更（将SQL作用到数据库，建议使用这条命令前，先用 rollback-count-sql确认一下SQL语句）<br>liquibase rollback-count  回滚最新部署的条数<br>//基于某个changelog文件，表结构回滚最新部署的SQL查看（未作用SQL部署到数据库，仅是看SQL的命令而已）<br>liquibase rollback-count-sql 回滚最新部署的条数<br><br><br><br><br>//表结构回滚到某一个时间节点的部署 == 原本部署的是新增，回滚即是删除，如果原本部署的是删除，回滚新增是不支持的<br>//下面的语句是等价于  liquibase rollback-to-date  yyyy-MM-<span class="hljs-built_in">dd</span> 00:00:00<br>liquibase rollback-to-date  yyyy-MM-<span class="hljs-built_in">dd</span><br>//具体的时间节点 -- 更建议加上详细的时间点上去<br>liquibase rollback-to-date  yyyy-MM-<span class="hljs-built_in">dd</span> HH:mm:ss<br><br><br><span class="hljs-comment"># 针对当前数据库，我们通过liquibase tag进行打标签操作</span><br>liquibase tag v1.0<br><br><span class="hljs-comment"># 回滚到指定版本</span><br>liquibase rollback v1.0<br><br><span class="hljs-comment"># 更新历史</span><br>liquibase <span class="hljs-built_in">history</span><br></code></pre></td></tr></table></figure><h3 id="liquibase-properties"><a href="#liquibase-properties" class="headerlink" title="liquibase.properties"></a>liquibase.properties</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"># mysql config<br>driver: com.mysql.cj.jdbc.Driver<br>classpath: ./lib/mysql-connector-java-8.0.11.jar<br>url: jdbc:mysql://127.0.0.1:3306/test?useSSL=false&amp;serverTimezone=UTC&amp;autoReconnect=true&amp;allowPublicKeyRetrieval=true&amp;useOldAliasMetadataBehavior=true<br>username: root<br>password: abc123<br>changeLogFile: myChangeLog.xml<br>liquibase.hub.mode=off<br></code></pre></td></tr></table></figure><h3 id="myChangeLog-xml"><a href="#myChangeLog-xml" class="headerlink" title="myChangeLog.xml"></a>myChangeLog.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">databaseChangeLog</span></span><br><span class="hljs-tag">                   <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.liquibase.org/xml/ns/dbchangelog&quot;</span></span><br><span class="hljs-tag">                   <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">                   <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.liquibase.org/xml/ns/dbchangelog</span></span><br><span class="hljs-string"><span class="hljs-tag">                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd&quot;</span>&gt;</span><br>  <br>  <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">file</span>=<span class="hljs-string">&quot;./sql/create_table.xml&quot;</span> <span class="hljs-attr">relativeToChangelogFile</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">file</span>=<span class="hljs-string">&quot;./sql/init_data.sql&quot;</span> <span class="hljs-attr">relativeToChangelogFile</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">databaseChangeLog</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="create-table-xml"><a href="#create-table-xml" class="headerlink" title="create_table.xml"></a>create_table.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">databaseChangeLog</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.liquibase.org/xml/ns/dbchangelog&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.liquibase.org/xml/ns/dbchangelog</span></span><br><span class="hljs-string"><span class="hljs-tag">         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd&quot;</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">changeSet</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;1&quot;</span> <span class="hljs-attr">author</span>=<span class="hljs-string">&quot;bob&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">createTable</span> <span class="hljs-attr">tableName</span>=<span class="hljs-string">&quot;department&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;int&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">constraints</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">nullable</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">column</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;varchar(50)&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">constraints</span> <span class="hljs-attr">nullable</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">column</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;active&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;varchar(1)&quot;</span> <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">&quot;Y&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">createTable</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">changeSet</span>&gt;</span><br><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">changeSet</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;2&quot;</span> <span class="hljs-attr">author</span>=<span class="hljs-string">&quot;zhaops&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">createTable</span> <span class="hljs-attr">tableName</span>=<span class="hljs-string">&quot;department1&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;int&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">constraints</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">nullable</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">column</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;varchar(50)&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">constraints</span> <span class="hljs-attr">nullable</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">column</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;active&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;varchar(1)&quot;</span> <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">&quot;Y&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">createTable</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">changeSet</span>&gt;</span><br><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">changeSet</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;3&quot;</span> <span class="hljs-attr">author</span>=<span class="hljs-string">&quot;zhaops&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">createTable</span> <span class="hljs-attr">tableName</span>=<span class="hljs-string">&quot;department2&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;int&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">constraints</span> <span class="hljs-attr">primaryKey</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">nullable</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">column</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;varchar(50)&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">constraints</span> <span class="hljs-attr">nullable</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">column</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">column</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;active&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;varchar(1)&quot;</span> <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">&quot;Y&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">createTable</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">changeSet</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">databaseChangeLog</span>&gt;</span><br><br></code></pre></td></tr></table></figure><h3 id="init-data-sql"><a href="#init-data-sql" class="headerlink" title="init_data.sql"></a>init_data.sql</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- liquibase formatted sql</span><br><span class="hljs-comment">-- changeset jack:2022_04_2</span><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> department <span class="hljs-keyword">values</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;研发部&#x27;</span>, <span class="hljs-string">&#x27;Y&#x27;</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> department <span class="hljs-keyword">values</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;销售部&#x27;</span>, <span class="hljs-string">&#x27;Y&#x27;</span>);<br><span class="hljs-comment">-- changeset tom:2022_04_22</span><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> department <span class="hljs-keyword">values</span>(<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;后勤部&#x27;</span>, <span class="hljs-string">&#x27;Y&#x27;</span>);<br></code></pre></td></tr></table></figure><p>echo $PATH | tr : “\n”| sort</p><p>eval <code>/usr/libexec/path_helper -s</code></p><p>排序</p><p>echo $PATH | tr : “\n”| sort | uniq | tr “\n” :</p><p>给环境变量排序</p><p>export PATH=$(echo $PATH | tr : “\n”| sort | uniq | tr “\n” :)</p><p>删除第三处</p><p>export PATH=echo $PATH | cut -d”:” -f1,2,4-</p><p>删除第八行</p><p>export PATH=$(echo $PATH | cut -d”:” -f1-7,9-) </p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>shardingshphere数据库分片</title>
    <link href="/wiki/2024/04/27/mysql/shardingsphere/shardingshphere%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E7%89%87/"/>
    <url>/wiki/2024/04/27/mysql/shardingsphere/shardingshphere%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E7%89%87/</url>
    
    <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Apache ShardingSphere 是一款分布式的数据库生态系统， 可以将任意数据库转换为分布式数据库，并通过数据分片、弹性伸缩、加密等能力对原有数据库进行增强。</p><p>Apache ShardingSphere 设计哲学为 Database Plus，旨在构建异构数据库上层的标准和生态。 它关注如何充分合理地利用数据库的计算和存储能力，而并非实现一个全新的数据库。 它站在数据库的上层视角，关注它们之间的协作多于数据库自身。</p><p>ShardingShpere的两个核心模块：</p><p>ShardingSphere-JDBC：ShardingSphere-JDBC 定位为轻量级 Java 框架，在 Java 的 JDBC 层提供的额外服务。<br>ShardingSphere-Proxy：ShardingSphere-Proxy 定位为透明化的数据库代理端，通过实现数据库二进制协议，对异构语言提供支持。</p><p>在开发中实现分库分表的操作，我们一般使用的<code>ShardingSphere-JDBC</code>这个模块。</p><p>ShardingSphere的分库分表操作的逻辑图：</p><p><img src="/wiki/img/mysql/1.png"></p><p><strong>开发者配置了分库分表策略后，我们只需要操作逻辑表名就可以了。</strong></p><h2 id="数据分片带来的优缺点"><a href="#数据分片带来的优缺点" class="headerlink" title="数据分片带来的优缺点"></a>数据分片带来的优缺点</h2><p>数据分片主要是用来解决海量的数据访问的问题，将数据库采用<code>垂直拆分</code>或者<code>水平拆分</code>的方式将海量、复杂的数据分布到不同的数据库、数据表中，以此来实现专库专用、提高访问性能。</p><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ol><li><strong>提高可扩展性</strong>：通过将数据拆分成多个小型数据库，每个数据库仅处理一部分数据，可以在数据增长时动态地添加新的分片，从而提高整个系统的可扩展性。</li><li><strong>提升性能</strong>：分片后的每个小型数据库只处理部分数据，减轻了单个节点的压力，从而提升了整个系统的性能。</li></ol><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ol><li><p><strong>复杂性增加</strong>：数据分片意味着需要更多的数据库来存储和管理数据，这增加了系统的复杂性。同时，对于每个查询，可能需要跨多个数据库进行查找，增加了查询的复杂性。</p></li><li><p><strong>并发控制</strong>：在分布式系统中，并发控制是一个重要的问题。如果多个节点同时更新同一片数据，就可能导致数据不一致的问题。因此，需要采用并发控制技术来保证数据的正确性。</p></li><li><p><strong>数据迁移和恢复</strong>：当新增或删除分片时，需要进行数据迁移和恢复。这个过程可能会导致数据的不一致或丢失。因此，需要设计合理的迁移和恢复策略来保证数据的正确性。</p></li></ol><p>我们所使用ShardingSphere组件，通过配置Yaml文件来降低我们的编码复杂度。并发控制何数据迁移与恢复都是需要其他的方式来解决。</p><h2 id="ShardingSphere分表操作"><a href="#ShardingSphere分表操作" class="headerlink" title="ShardingSphere分表操作"></a>ShardingSphere分表操作</h2><p>ShardingSphere的分库分表操作都是基于<code>ShardingSphere-JDBC</code>这个模块来实现。在当前开发中一般都需要和Springboot进行整合，而且只要是流行的框架、组件，SpringBoot一般都会有一个集成的依赖。</p><p> <strong>分片和读写分离请看该分类其他文档.</strong></p>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
      <tag>shardingshphere</tag>
      
      <tag>数据库分片</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>shardingshphere水平分片</title>
    <link href="/wiki/2024/04/27/mysql/shardingsphere/shardingshphere%E6%B0%B4%E5%B9%B3%E5%88%86%E7%89%87/"/>
    <url>/wiki/2024/04/27/mysql/shardingsphere/shardingshphere%E6%B0%B4%E5%B9%B3%E5%88%86%E7%89%87/</url>
    
    <content type="html"><![CDATA[<p>可以分库分表也可以单独进行分表</p><h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><p>父pom</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>ShardingSphereReadWrite<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>ShardingSphereVertical<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>ShardingSphereLevel<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-boot.version</span>&gt;</span>2.2.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring-boot.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">fastjson.version</span>&gt;</span>1.2.62<span class="hljs-tag">&lt;/<span class="hljs-name">fastjson.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">shardingsphere.version</span>&gt;</span>5.1.2<span class="hljs-tag">&lt;/<span class="hljs-name">shardingsphere.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mybatis-plus.version</span>&gt;</span>3.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">mybatis-plus.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;fastjson.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p>pom</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ShardingSphereLevel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>ShardingSphereLevel<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>ShardingSphereLevel<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shardingsphere-jdbc-core-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;shardingsphere.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mybatis-plus.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br><br></code></pre></td></tr></table></figure><h2 id="准备数据库和表"><a href="#准备数据库和表" class="headerlink" title="准备数据库和表"></a>准备数据库和表</h2><p>数据库1:  localhost:3306</p><p>数据库2: localhost:3307</p><h3 id="分别在两个数据库创建库和表"><a href="#分别在两个数据库创建库和表" class="headerlink" title="分别在两个数据库创建库和表"></a>分别在两个数据库创建库和表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> DATABASE db_order;<br><br>USE db_order;<br><br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_order0 (<br>                          id <span class="hljs-type">BIGINT</span>,<br>                          order_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br>                          user_id <span class="hljs-type">BIGINT</span>,<br>                          amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),<br>                          <span class="hljs-keyword">PRIMARY</span> KEY(id)<br>);<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_order1 (<br>                          id <span class="hljs-type">BIGINT</span>,<br>                          order_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br>                          user_id <span class="hljs-type">BIGINT</span>,<br>                          amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),<br>                          <span class="hljs-keyword">PRIMARY</span> KEY(id)<br>);<br></code></pre></td></tr></table></figure><h3 id="创建完之后的样子"><a href="#创建完之后的样子" class="headerlink" title="创建完之后的样子"></a>创建完之后的样子</h3><p><img src="/wiki/img/mysql/2.png"></p><h3 id="规则配置"><a href="#规则配置" class="headerlink" title="规则配置"></a>规则配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">ShardingSphereLevel</span><br>  <span class="hljs-attr">shardingsphere:</span><br>    <span class="hljs-attr">datasource:</span>   <span class="hljs-comment"># 配置数据源</span><br>      <span class="hljs-attr">server-order-0:</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span><br>        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/db_order</span><br>        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>        <span class="hljs-attr">password:</span> <span class="hljs-string">abc123</span><br>      <span class="hljs-attr">server-order-1:</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span><br>        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3307/db_order</span><br>        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>        <span class="hljs-attr">password:</span> <span class="hljs-string">abc123</span><br>      <span class="hljs-attr">names:</span> <span class="hljs-string">server-order-0,server-order-1</span>  <span class="hljs-comment"># 所有数据源的名称，用逗号隔开</span><br>    <span class="hljs-attr">rules:</span><br>      <span class="hljs-attr">sharding:</span><br>        <span class="hljs-attr">sharding-algorithms:</span>  <span class="hljs-comment"># 分片算法配置</span><br>          <span class="hljs-attr">alg_inline_userid:</span>  <span class="hljs-comment"># 分片算法名称，自定义的名称</span><br>            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>      <span class="hljs-comment"># 分片算法类型</span><br>            <span class="hljs-attr">props:</span>            <span class="hljs-comment"># 分片算法属性配置</span><br>              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">server-order-$-&gt;&#123;user_id</span> <span class="hljs-string">%</span> <span class="hljs-number">2</span><span class="hljs-string">&#125;</span>   <span class="hljs-comment"># 分片规则指定语句</span><br>          <span class="hljs-attr">table-inline:</span>       <span class="hljs-comment"># 分片算法名称，自定义的名称</span><br>            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span> <span class="hljs-comment"># 分片算法类型</span><br>            <span class="hljs-attr">props:</span> <span class="hljs-comment"># 分片算法属性配置</span><br>              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">t_order$-&gt;&#123;id</span> <span class="hljs-string">%</span> <span class="hljs-number">2</span><span class="hljs-string">&#125;</span> <span class="hljs-comment"># 分片规则指定语句</span><br>        <span class="hljs-attr">tables:</span> <span class="hljs-comment"># 分片表配置</span><br>          <span class="hljs-attr">t_order:</span>  <span class="hljs-comment"># 表名</span><br>            <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">server-order-$-&gt;&#123;0..1&#125;.t_order$-&gt;&#123;0..1&#125;</span> <span class="hljs-comment"># 真实的表名称，数据源.表名称，多个表之间用逗号隔开 可以这样写server-order-0.t_order0,server-order-0.t_order1,server-order-1.t_order0,server-order-1.t_order1</span><br>            <span class="hljs-attr">database-strategy:</span>   <span class="hljs-comment"># 表分库策略</span><br>              <span class="hljs-attr">standard:</span>   <span class="hljs-comment"># 标准分片策略</span><br>                <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span> <span class="hljs-comment"># 分片的列名</span><br>                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">alg_inline_userid</span> <span class="hljs-comment"># 分片算法</span><br>            <span class="hljs-attr">table-strategy:</span><br>              <span class="hljs-attr">standard:</span><br>                <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">id</span> <span class="hljs-comment"># 分片的列名</span><br>                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">table-inline</span> <span class="hljs-comment"># 分片算法</span><br><br><br><br>    <span class="hljs-attr">props:</span><br>      <span class="hljs-attr">sql-show:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">mode:</span><br>      <span class="hljs-attr">type:</span> <span class="hljs-string">Memory</span><br>      <span class="hljs-attr">repository:</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">JDBC</span><br></code></pre></td></tr></table></figure><h3 id="分库规则是"><a href="#分库规则是" class="headerlink" title="分库规则是"></a>分库规则是</h3><p>order表中<code>user_id</code>为偶数时，数据插入<code>server-order0服务器</code>，<code>user_id</code>为奇数时，数据插入<code>server-order1服务器</code>。这样分片的好处是，同一个用户的订单数据，一定会被插入到同一台服务器上，查询一个用户的订单时效率较高。</p><h3 id="分表的规则"><a href="#分表的规则" class="headerlink" title="分表的规则"></a>分表的规则</h3><p>order表中<code>userId的为偶数时</code>，数据插入对应服务器的<code>t_order0表</code>，<code>userId为奇数时</code>，数据插入对应服务器的<code>t_order1表</code>。 </p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="运行test方法"><a href="#运行test方法" class="headerlink" title="运行test方法"></a>运行test方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 水平分片：分表插入数据测试</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testInsertOrderTableStrategy</span><span class="hljs-params">()</span>&#123;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">long</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br><br><span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();<br>order.setOrderNo(<span class="hljs-string">&quot;Sharding&quot;</span> + i);<br>order.setUserId(<span class="hljs-number">1L</span>);<br>order.setAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">100</span>));<br>orderMapper.insert(order);<br>&#125;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">long</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>; i &lt; <span class="hljs-number">9</span>; i++) &#123;<br><br><span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();<br>order.setOrderNo(<span class="hljs-string">&quot;Sharding&quot;</span> + i);<br>order.setUserId(<span class="hljs-number">2L</span>);<br>order.setAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">100</span>));<br>orderMapper.insert(order);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="插入日志"><a href="#插入日志" class="headerlink" title="插入日志"></a>插入日志</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs routeros">2024-04-27 10:07:44.996  <span class="hljs-built_in">INFO</span> 99540 --- [           main] ShardingSphere-SQL                       : Logic SQL: INSERT INTO t_order  ( id,<br>order_no,<br>user_id,<br>amount )  VALUES  ( ?,<br>?,<br>?,<br>? )<br>2024-04-27 10:07:44.996  <span class="hljs-built_in">INFO</span> 99540 --- [           main] ShardingSphere-SQL                       : SQLStatement: MySQLInsertStatement(<span class="hljs-attribute">setAssignment</span>=Optional.empty, <span class="hljs-attribute">onDuplicateKeyColumns</span>=Optional.empty)<br>2024-04-27 10:07:44.997  <span class="hljs-built_in">INFO</span> 99540 --- [           main] ShardingSphere-SQL                       : Actual SQL: server-order-1 ::: INSERT INTO t_order0  ( id,<br>order_no,<br>user_id,<br>amount )  VALUES  (?, ?, ?, ?) ::: [1784041711857569794, Sharding1, 1, 100]<br></code></pre></td></tr></table></figure><h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 水平分片：查询所有记录</span><br><span class="hljs-comment"> * 查询了两个数据源，每个数据源中使用UNION ALL连接两个表</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testShardingSelectAll</span><span class="hljs-params">()</span>&#123;<br>List&lt;Order&gt; orders = orderMapper.selectList(<span class="hljs-literal">null</span>);<br>orders.forEach(System.out::println);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 水平分片：根据user_id查询记录</span><br><span class="hljs-comment">     * 查询了一个数据源，每个数据源中使用UNION ALL连接两个表</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testShardingSelectByUserId</span><span class="hljs-params">()</span>&#123;<br>        QueryWrapper&lt;Order&gt; orderQueryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();<br>        orderQueryWrapper.eq(<span class="hljs-string">&quot;user_id&quot;</span>, <span class="hljs-number">1L</span>);<br>        List&lt;Order&gt; orders = orderMapper.selectList(orderQueryWrapper);<br>        orders.forEach(System.out::println);<br>    &#125;<br></code></pre></td></tr></table></figure><h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs routeros">2024-04-27 10:10:33.485  <span class="hljs-built_in">INFO</span> 2346 --- [           main] ShardingSphere-SQL                       : Logic SQL: SELECT  id,order_no,user_id,amount  <span class="hljs-keyword">FROM</span> t_order<br>2024-04-27 10:10:33.485  <span class="hljs-built_in">INFO</span> 2346 --- [           main] ShardingSphere-SQL                       : SQLStatement: MySQLSelectStatement(<span class="hljs-attribute">table</span>=Optional.empty, <span class="hljs-attribute">limit</span>=Optional.empty, <span class="hljs-attribute">lock</span>=Optional.empty, <span class="hljs-attribute">window</span>=Optional.empty)<br>2024-04-27 10:10:33.485  <span class="hljs-built_in">INFO</span> 2346 --- [           main] ShardingSphere-SQL                       : Actual SQL: server-order-0 ::: SELECT  id,order_no,user_id,amount  <span class="hljs-keyword">FROM</span> t_order0 UNION ALL SELECT  id,order_no,user_id,amount  <span class="hljs-keyword">FROM</span> t_order1<br>2024-04-27 10:10:33.485  <span class="hljs-built_in">INFO</span> 2346 --- [           main] ShardingSphere-SQL                       : Actual SQL: server-order-1 ::: SELECT  id,order_no,user_id,amount  <span class="hljs-keyword">FROM</span> t_order0 UNION ALL SELECT  id,order_no,user_id,amount  <span class="hljs-keyword">FROM</span> t_order1<br>Order(<span class="hljs-attribute">id</span>=1784041713484959746, <span class="hljs-attribute">orderNo</span>=Sharding8, <span class="hljs-attribute">userId</span>=2, <span class="hljs-attribute">amount</span>=100.00)<br>Order(<span class="hljs-attribute">id</span>=1784041713434628097, <span class="hljs-attribute">orderNo</span>=Sharding5, <span class="hljs-attribute">userId</span>=2, <span class="hljs-attribute">amount</span>=100.00)<br>Order(<span class="hljs-attribute">id</span>=1784041713459793921, <span class="hljs-attribute">orderNo</span>=Sharding6, <span class="hljs-attribute">userId</span>=2, <span class="hljs-attribute">amount</span>=100.00)<br>Order(<span class="hljs-attribute">id</span>=1784041713472376833, <span class="hljs-attribute">orderNo</span>=Sharding7, <span class="hljs-attribute">userId</span>=2, <span class="hljs-attribute">amount</span>=100.00)<br>Order(<span class="hljs-attribute">id</span>=1784041711857569794, <span class="hljs-attribute">orderNo</span>=Sharding1, <span class="hljs-attribute">userId</span>=1, <span class="hljs-attribute">amount</span>=100.00)<br>Order(<span class="hljs-attribute">id</span>=1784041713371713538, <span class="hljs-attribute">orderNo</span>=Sharding2, <span class="hljs-attribute">userId</span>=1, <span class="hljs-attribute">amount</span>=100.00)<br>Order(<span class="hljs-attribute">id</span>=1784041713392685058, <span class="hljs-attribute">orderNo</span>=Sharding3, <span class="hljs-attribute">userId</span>=1, <span class="hljs-attribute">amount</span>=100.00)<br>Order(<span class="hljs-attribute">id</span>=1784041713417850881, <span class="hljs-attribute">orderNo</span>=Sharding4, <span class="hljs-attribute">userId</span>=1, <span class="hljs-attribute">amount</span>=100.00)<br><br></code></pre></td></tr></table></figure><p>在<code>rules.sharding.sharding-algorithms.type</code>参数主要用于指定分片算法的类型。以下是一些常见的 type 选项：</p><table><thead><tr><th>参数名称</th><th>参数描述</th></tr></thead><tbody><tr><td>inline</td><td>行表达式分片算法。该算法允许你使用行表达式来定义分片规则，适用于简单的分片场景。</td></tr><tr><td>hint</td><td>Hint 分片算法。该算法允许你使用 Hint 来指定分片规则，适用于一些特殊的分片场景。</td></tr><tr><td>mod_sharding</td><td>取模分片算法。根据指定的分片数量进行取模运算来进行分片，例如 user_id % 8</td></tr><tr><td>range_sharding</td><td>范围分片算法。允许你定义一个范围来进行分片，适用于范围查询等场景。</td></tr><tr><td>hash_sharding</td><td>哈希分片算法。根据指定的哈希算法进行分片，适用于一些需要一致性哈希的场景。</td></tr></tbody></table><p><code>rules.sharding.tables.&lt;logic_table_name&gt;.table-strategy</code>参数用来配置表分片的策略，可配置的属性如下：</p><p>1、standard：标准分片策略。</p><table><thead><tr><th>参数名称</th><th>参数描述</th></tr></thead><tbody><tr><td>sharding-column</td><td>分片列名称</td></tr><tr><td>precise-algorithm-class-name</td><td>精确分片算法类名称，用于 = 和 IN 查询。</td></tr><tr><td>range-algorithm-class-name</td><td>范围分片算法类名称，用于 BETWEEN 查询。</td></tr></tbody></table><p>2、complex：复合分片策略。</p><table><thead><tr><th>参数名称</th><th>参数描述</th></tr></thead><tbody><tr><td>sharding-columns</td><td>分片列名称列表，多个列以逗号分隔。</td></tr><tr><td>algorithm-class-name</td><td>复合分片算法类名称。</td></tr></tbody></table><p>3、inline：行表达式分片策略。</p><table><thead><tr><th>参数名称</th><th>参数描述</th></tr></thead><tbody><tr><td>sharding-column</td><td>分片列名称。</td></tr><tr><td>algorithm-expression</td><td>分片算法行表达式，例如：${column} % 2。</td></tr></tbody></table><p>4、hint：Hint 分片策略。</p><table><thead><tr><th>参数名称</th><th>参数描述</th></tr></thead><tbody><tr><td>algorithm-class-name</td><td>Hint分片算法类名称。</td></tr></tbody></table><h2 id="gitee地址"><a href="#gitee地址" class="headerlink" title="gitee地址"></a><a href="https://gitee.com/zhaops_learning/spring-cloud-learning/tree/master/mysql/ShardingSphereLevel">gitee地址</a></h2>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
      <tag>shardingshphere</tag>
      
      <tag>数据库分片</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql主从复制部署</title>
    <link href="/wiki/2024/04/27/mysql/mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E9%83%A8%E7%BD%B2/"/>
    <url>/wiki/2024/04/27/mysql/mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h3 id="docker-compose-yaml"><a href="#docker-compose-yaml" class="headerlink" title="docker-compose.yaml"></a>docker-compose.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><br><br><span class="hljs-comment"># 网桥 -&gt; 方便相互通讯</span><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">mysql:</span><br>    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">mysql-master:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">biarms/mysql:5.7.30-linux-arm64v8</span>  <span class="hljs-comment"># 原镜像`mysql:5.7`</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql_master</span>                                  <span class="hljs-comment"># 容器名为&#x27;mysql_master&#x27;</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>                                       <span class="hljs-comment"># 指定容器退出后的重启策略为始终重启，但是不考虑在Docker守护进程启动时就已经停止了的容器</span><br>    <span class="hljs-attr">volumes:</span>                                                      <span class="hljs-comment"># 数据卷挂载路径设置,将本机目录映射到容器目录</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./mysql-master-slave/master/my.cnf:/etc/mysql/my.cnf&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./mysql-master-slave/master/data:/var/lib/mysql&quot;</span><br>      <span class="hljs-comment">#      - &quot;./mysql-master-slave/master/conf.d:/etc/mysql/conf.d&quot;</span><br>      <span class="hljs-comment">#- &quot;./mysql-master-slave/master/log/mysql/error.log:/var/log/mysql/error.log&quot;</span><br>    <span class="hljs-attr">environment:</span>                        <span class="hljs-comment"># 设置环境变量,相当于docker run命令中的-e</span><br>      <span class="hljs-attr">TZ:</span> <span class="hljs-string">Asia/Shanghai</span><br>      <span class="hljs-attr">LANG:</span> <span class="hljs-string">en_US.UTF-8</span><br>      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">abc123</span><br>    <span class="hljs-attr">ports:</span>                              <span class="hljs-comment"># 映射端口</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;3306:3306&quot;</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span><br><br>  <span class="hljs-attr">mysql-slave:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">biarms/mysql:5.7.30-linux-arm64v8</span>  <span class="hljs-comment"># 原镜像`mysql:5.7`</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql_slave</span>                                   <span class="hljs-comment"># 容器名为&#x27;mysql_slave&#x27;</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>                                       <span class="hljs-comment"># 指定容器退出后的重启策略为始终重启，但是不考虑在Docker守护进程启动时就已经停止了的容器</span><br>    <span class="hljs-attr">volumes:</span>                                                      <span class="hljs-comment"># 数据卷挂载路径设置,将本机目录映射到容器目录</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./mysql-master-slave/slave/my.cnf:/etc/mysql/my.cnf&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./mysql-master-slave/slave/data:/var/lib/mysql&quot;</span><br>      <span class="hljs-comment">#      - &quot;./mysql-master-slave/slave/conf.d:/etc/mysql/conf.d&quot;</span><br>      <span class="hljs-comment">#- &quot;./mysql-master-slave/slave/log/mysql/error.log:/var/log/mysql/error.log&quot;</span><br>    <span class="hljs-attr">environment:</span>                        <span class="hljs-comment"># 设置环境变量,相当于docker run命令中的-e</span><br>      <span class="hljs-attr">TZ:</span> <span class="hljs-string">Asia/Shanghai</span><br>      <span class="hljs-attr">LANG:</span> <span class="hljs-string">en_US.UTF-8</span><br>      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">abc123</span><br>    <span class="hljs-attr">ports:</span>                              <span class="hljs-comment"># 映射端口</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;3307:3306&quot;</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql-master</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-attr">links:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql-master</span><br></code></pre></td></tr></table></figure><h3 id="主节点-my-cnf"><a href="#主节点-my-cnf" class="headerlink" title="主节点 my.cnf"></a>主节点 my.cnf</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[mysqld]</span><br><span class="hljs-attr">user</span>=mysql                     <span class="hljs-comment"># MySQL启动用户</span><br><span class="hljs-attr">default-storage-engine</span>=INNODB  <span class="hljs-comment"># 创建新表时将使用的默认存储引擎</span><br><span class="hljs-attr">character-set-server</span>=utf8mb4      <span class="hljs-comment"># 设置mysql服务端默认字符集</span><br><span class="hljs-attr">pid-file</span>        = /var/run/mysqld/mysqld.pid  <span class="hljs-comment"># pid文件所在目录</span><br><span class="hljs-attr">socket</span>          = /var/run/mysqld/mysqld.sock <span class="hljs-comment"># 用于本地连接的socket套接字</span><br><span class="hljs-attr">datadir</span>         = /var/lib/mysql              <span class="hljs-comment"># 数据文件存放的目录</span><br><span class="hljs-comment">#log-error      = /var/log/mysql/error.log</span><br><span class="hljs-comment">#bind-address   = 127.0.0.1                   # MySQL绑定IP</span><br><span class="hljs-comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span><br><span class="hljs-attr">symbolic-links</span>=<span class="hljs-number">0</span><br><span class="hljs-attr">sql_mode</span>=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION <span class="hljs-comment"># 定义mysql应该支持的sql语法，数据校验等!</span><br><br><span class="hljs-comment"># 允许最大连接数</span><br><span class="hljs-attr">max_connections</span>=<span class="hljs-number">200</span><br><br><span class="hljs-comment"># ================= ↓↓↓ mysql主从同步配置start ↓↓↓ =================</span><br><br><span class="hljs-comment"># 同一局域网内注意要唯一</span><br><span class="hljs-attr">server-id</span>=<span class="hljs-number">3306</span><br><span class="hljs-comment"># 开启二进制日志功能 &amp; 日志位置存放位置`/var/lib/mysql`</span><br><span class="hljs-comment">#log-bin=mysql-bin</span><br><span class="hljs-attr">log-bin</span>=/var/lib/mysql/mysql-bin<br><span class="hljs-comment"># binlog格式</span><br><span class="hljs-comment"># 1. STATEMENT：基于SQL语句的模式，binlog 数据量小，但是某些语句和函数在复制过程可能导致数据不一致甚至出错；</span><br><span class="hljs-comment"># 2. MIXED：混合模式，根据语句来选用是 STATEMENT 还是 ROW 模式；</span><br><span class="hljs-comment"># 3. ROW：基于行的模式，记录的是行的完整变化。安全，但 binlog 会比其他两种模式大很多；</span><br><span class="hljs-attr">binlog_format</span>=ROW<br><span class="hljs-comment"># FULL：binlog记录每一行的完整变更 MINIMAL：只记录影响后的行</span><br><span class="hljs-attr">binlog_row_image</span>=FULL<br><span class="hljs-comment"># 日志文件大小</span><br><span class="hljs-comment"># max_binlog_size=1G</span><br><span class="hljs-attr">max_binlog_size</span>=<span class="hljs-number">100</span>M<br><span class="hljs-comment"># 定义清除过期日志的时间(这里设置为7天)</span><br><span class="hljs-attr">expire_logs_days</span>=<span class="hljs-number">7</span><br><br><span class="hljs-comment"># ================= ↑↑↑ mysql主从同步配置end ↑↑↑ =================</span><br><br><span class="hljs-section">[mysql]</span><br><span class="hljs-attr">default-character-set</span>=utf8mb4<br><br><span class="hljs-section">[client]</span><br><span class="hljs-attr">default-character-set</span>=utf8mb4  <span class="hljs-comment"># 设置mysql客户端默认字符集</span><br></code></pre></td></tr></table></figure><h3 id="从节点-my-conf"><a href="#从节点-my-conf" class="headerlink" title="从节点 my.conf"></a>从节点 my.conf</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[mysqld]</span><br><span class="hljs-attr">user</span>=mysql                     <span class="hljs-comment"># MySQL启动用户</span><br><span class="hljs-attr">default-storage-engine</span>=INNODB  <span class="hljs-comment"># 创建新表时将使用的默认存储引擎</span><br><span class="hljs-attr">character-set-server</span>=utf8mb4      <span class="hljs-comment"># 设置mysql服务端默认字符集</span><br><span class="hljs-attr">pid-file</span>        = /var/run/mysqld/mysqld.pid  <span class="hljs-comment"># pid文件所在目录</span><br><span class="hljs-attr">socket</span>          = /var/run/mysqld/mysqld.sock <span class="hljs-comment"># 用于本地连接的socket套接字</span><br><span class="hljs-attr">datadir</span>         = /var/lib/mysql              <span class="hljs-comment"># 数据文件存放的目录</span><br><span class="hljs-comment">#log-error      = /var/log/mysql/error.log</span><br><span class="hljs-comment">#bind-address   = 127.0.0.1                   # MySQL绑定IP</span><br><span class="hljs-comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span><br><span class="hljs-attr">symbolic-links</span>=<span class="hljs-number">0</span><br><span class="hljs-attr">sql_mode</span>=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION <span class="hljs-comment"># 定义mysql应该支持的sql语法，数据校验等!</span><br><br><span class="hljs-comment"># 允许最大连接数</span><br><span class="hljs-attr">max_connections</span>=<span class="hljs-number">200</span><br><br><span class="hljs-comment"># ================= ↓↓↓ mysql主从同步配置start ↓↓↓ =================</span><br><br><span class="hljs-comment"># 同一局域网内注意要唯一，从库只需要设置 server_id 即可</span><br><span class="hljs-attr">server-id</span>=<span class="hljs-number">3307</span><br><br><span class="hljs-comment"># ================= ↑↑↑ mysql主从同步配置end ↑↑↑ =================</span><br><br><span class="hljs-section">[mysql]</span><br><span class="hljs-attr">default-character-set</span>=utf8mb4<br><br><span class="hljs-section">[client]</span><br><span class="hljs-attr">default-character-set</span>=utf8mb4  <span class="hljs-comment"># 设置mysql客户端默认字符集</span><br><br></code></pre></td></tr></table></figure><h3 id="主从配置"><a href="#主从配置" class="headerlink" title="主从配置"></a>主从配置</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span> ↓↓↓↓↓↓ 配置主库 ↓↓↓↓↓↓ <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><br># 进入主库<br>docker <span class="hljs-keyword">exec</span> <span class="hljs-operator">-</span>it mysql_master <span class="hljs-operator">/</span>bin<span class="hljs-operator">/</span>bash<br># 登录mysql<br>mysql <span class="hljs-operator">-</span>uroot <span class="hljs-operator">-</span>pabc123<br>#  创建用户slave，密码<span class="hljs-number">123456</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">&#x27;slave&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;abc123&#x27;</span>;<br># 授予slave用户 `REPLICATION SLAVE`权限和`REPLICATION CLIENT`权限，用于在`主` `从` 数据库之间同步数据<br><span class="hljs-keyword">GRANT</span> REPLICATION SLAVE, REPLICATION CLIENT <span class="hljs-keyword">ON</span> <span class="hljs-operator">*</span>.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">&#x27;slave&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span>;<br># 授予所有权限则执行命令: <span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> PRIVILEGES <span class="hljs-keyword">ON</span> <span class="hljs-operator">*</span>.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">&#x27;slave&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span>;<br># 使操作生效<br>FLUSH PRIVILEGES;<br># 查看状态<br><span class="hljs-keyword">show</span> master status;<br># 注：File和Position字段的值slave中将会用到，在slave操作完成之前不要操作master，否则将会引起状态变化，即File和Position字段的值变化 <span class="hljs-operator">!</span><span class="hljs-operator">!</span><span class="hljs-operator">!</span><br># <span class="hljs-operator">+</span><span class="hljs-comment">------------------+----------+--------------+------------------+-------------------+</span><br># <span class="hljs-operator">|</span> File             <span class="hljs-operator">|</span> Position <span class="hljs-operator">|</span> Binlog_Do_DB <span class="hljs-operator">|</span> Binlog_Ignore_DB <span class="hljs-operator">|</span> Executed_Gtid_Set <span class="hljs-operator">|</span><br># <span class="hljs-operator">+</span><span class="hljs-comment">------------------+----------+--------------+------------------+-------------------+</span><br># <span class="hljs-operator">|</span> mysql<span class="hljs-operator">-</span>bin<span class="hljs-number">.000003</span> <span class="hljs-operator">|</span>      <span class="hljs-number">769</span> <span class="hljs-operator">|</span>              <span class="hljs-operator">|</span>                  <span class="hljs-operator">|</span>                   <span class="hljs-operator">|</span><br># <span class="hljs-operator">+</span><span class="hljs-comment">------------------+----------+--------------+------------------+-------------------+</span><br># <span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br><br><br># <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span> ↓↓↓↓↓↓ 配置从库 ↓↓↓↓↓↓ <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><br># 进入从库<br>docker <span class="hljs-keyword">exec</span> <span class="hljs-operator">-</span>it mysql_slave <span class="hljs-operator">/</span>bin<span class="hljs-operator">/</span>bash<br># 登录mysql<br>mysql <span class="hljs-operator">-</span>uroot <span class="hljs-operator">-</span>pabc123<br>CHANGE MASTER <span class="hljs-keyword">TO</span> MASTER_HOST<span class="hljs-operator">=</span><span class="hljs-string">&#x27;mysql-master&#x27;</span>, <br>MASTER_USER<span class="hljs-operator">=</span><span class="hljs-string">&#x27;slave&#x27;</span>,MASTER_PASSWORD<span class="hljs-operator">=</span><span class="hljs-string">&#x27;abc123&#x27;</span>, MASTER_PORT<span class="hljs-operator">=</span><span class="hljs-number">3306</span>,<br>MASTER_LOG_FILE<span class="hljs-operator">=</span><span class="hljs-string">&#x27;mysql-bin.000003&#x27;</span>,MASTER_LOG_POS<span class="hljs-operator">=</span><span class="hljs-number">769</span>;<br><br># MASTER_LOG_FILE 和 MASTER_LOG_POS 和上面master的 File,Position 对应上<br><br># 开启主从同步过程  【停止命令：stop slave;】<br><span class="hljs-keyword">start</span> slave;<br># 查看主从同步状态<br><span class="hljs-keyword">show</span> slave status \G<br># Slave_IO_Running 和 Slave_SQL_Running 都是Yes的话，就说明主从同步已经配置好了！<br># 如果Slave_IO_Running为Connecting，SlaveSQLRunning为Yes，则说明配置有问题，这时候就要检查配置中哪一步出现问题了哦，可根据Last_IO_Error字段信息排错或谷歌…<br># <span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span> <span class="hljs-number">1.</span> <span class="hljs-type">row</span> <span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><br>#                Slave_IO_State: Waiting <span class="hljs-keyword">for</span> master <span class="hljs-keyword">to</span> send event<br>#                   Master_Host: www.zhengqingya.com<br>#                   Master_User: slave<br>#                   Master_Port: <span class="hljs-number">3306</span><br>#                 Connect_Retry: <span class="hljs-number">30</span><br>#               Master_Log_File: mysql<span class="hljs-operator">-</span>bin<span class="hljs-number">.000003</span><br>#           Read_Master_Log_Pos: <span class="hljs-number">769</span><br>#                Relay_Log_File: c598d8402b43<span class="hljs-operator">-</span>relay<span class="hljs-operator">-</span>bin<span class="hljs-number">.000002</span><br>#                 Relay_Log_Pos: <span class="hljs-number">320</span><br>#         Relay_Master_Log_File: mysql<span class="hljs-operator">-</span>bin<span class="hljs-number">.000003</span><br>#              Slave_IO_Running: Yes<br>#             Slave_SQL_Running: Yes<br>#               Replicate_Do_DB:<br></code></pre></td></tr></table></figure><h3 id="解决主从同步数据不一致问题"><a href="#解决主从同步数据不一致问题" class="headerlink" title="解决主从同步数据不一致问题"></a>解决主从同步数据不一致问题</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 注意：操作的时候停止主库数据写入<br><br># 在从库查看主从同步状态<br>docker <span class="hljs-keyword">exec</span> <span class="hljs-operator">-</span>it mysql_slave <span class="hljs-operator">/</span>bin<span class="hljs-operator">/</span>bash<br>mysql <span class="hljs-operator">-</span>uroot <span class="hljs-operator">-</span>proot<br><span class="hljs-keyword">show</span> slave status \G<br>#              Slave_IO_Running: Yes<br>#             Slave_SQL_Running: <span class="hljs-keyword">No</span><br><br># <span class="hljs-number">1</span>、手动同步主从库数据<br># 先在从库停止主从同步<br>stop slave;<br># 导出主库数据<br>mysqldump <span class="hljs-operator">-</span>h www.zhengqingya.com <span class="hljs-operator">-</span>P <span class="hljs-number">3306</span> <span class="hljs-operator">-</span>uroot <span class="hljs-operator">-</span>proot <span class="hljs-comment">--all-databases &gt; /tmp/all.sql</span><br># 导入到从库<br>mysql <span class="hljs-operator">-</span>uroot <span class="hljs-operator">-</span>proot<br>source <span class="hljs-operator">/</span>tmp<span class="hljs-operator">/</span>all.sql;<br><br># <span class="hljs-number">2</span>、开启主从同步<br># 查看主库状态 <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> 拿到File和Position字段的值<br>docker <span class="hljs-keyword">exec</span> <span class="hljs-operator">-</span>it mysql_master <span class="hljs-operator">/</span>bin<span class="hljs-operator">/</span>bash<br>mysql <span class="hljs-operator">-</span>uroot <span class="hljs-operator">-</span>proot<br><span class="hljs-keyword">show</span> master status;<br># 从库操作<br>CHANGE MASTER <span class="hljs-keyword">TO</span> MASTER_HOST<span class="hljs-operator">=</span><span class="hljs-string">&#x27;mysql-master&#x27;</span>, <br>MASTER_USER<span class="hljs-operator">=</span><span class="hljs-string">&#x27;slave&#x27;</span>,MASTER_PASSWORD<span class="hljs-operator">=</span><span class="hljs-string">&#x27;abc123&#x27;</span>, MASTER_PORT<span class="hljs-operator">=</span><span class="hljs-number">3306</span>,<br>MASTER_LOG_FILE<span class="hljs-operator">=</span><span class="hljs-string">&#x27;mysql-bin.000003&#x27;</span>,MASTER_LOG_POS<span class="hljs-operator">=</span><span class="hljs-number">769</span>;<br><span class="hljs-keyword">start</span> slave;<br># 查看主从同步状态<br><span class="hljs-keyword">show</span> slave status \G<br>#              Slave_IO_Running: Yes<br>#             Slave_SQL_Running: Yes<br></code></pre></td></tr></table></figure><h3 id="测试数据"><a href="#测试数据" class="headerlink" title="测试数据"></a>测试数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> DATABASE db_user;<br><br>USE db_user;<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_user (<br> id <span class="hljs-type">BIGINT</span> AUTO_INCREMENT,<br> uname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>),<br> <span class="hljs-keyword">PRIMARY</span> KEY (id)<br>);<br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_user(uname) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;zhang3&#x27;</span>);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>mysql</tag>
      
      <tag>部署</tag>
      
      <tag>docker-compose</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/wiki/2024/04/26/mysql/shardingsphere/%E5%9E%82%E7%9B%B4%E5%88%86%E7%89%87/"/>
    <url>/wiki/2024/04/26/mysql/shardingsphere/%E5%9E%82%E7%9B%B4%E5%88%86%E7%89%87/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/wiki/2024/04/26/mysql/shardingsphere/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/"/>
    <url>/wiki/2024/04/26/mysql/shardingsphere/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>jvm</title>
    <link href="/wiki/2024/04/23/%E5%85%AB%E8%82%A1%E6%96%87/jvm/"/>
    <url>/wiki/2024/04/23/%E5%85%AB%E8%82%A1%E6%96%87/jvm/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>八股文</category>
      
    </categories>
    
    
    <tags>
      
      <tag>面试</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/wiki/2024/02/06/%E8%AE%B0%E5%BD%95/%E9%97%AE%E9%A2%98/"/>
    <url>/wiki/2024/02/06/%E8%AE%B0%E5%BD%95/%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<ul><li>注册租户的流程, 研发平台, 官网, 授权中心</li></ul><p>REDIS_HOST=10.198.40.77;REDIS_PORT=6379;REDIS_PASSWORD=root</p><p>10.198.40.77<br>3306<br>root<br>1yrVZP%KqZ#SS_cscec81_Z#98<br>hussar-base-cloud</p><p>Nacos</p><p>SHjvK*&amp;^!q6HjEud_zj81</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs shell">前端上传相关<br>ip地址：10.198.40.39<br>用户：root<br>密码：Bbn3Q@*BXC<br><br>cd /usr/local/nginx<br>cd ./html<br>cd ./bussness<br>rm -rf static/<br>rm -rf  bim-project/<br>rm -rf hussartheme/<br>rm -rf hussarvfg/<br>rm -rf dist.zip<br>unzip dist.zip<br><br>/usr/local/nginx/sbin/nginx -s reload<br><br><br><br>后端上传相关<br>ip地址：10.198.32.92<br>用户名：zj81<br>密码：KyyAlvz91M<br><br>命令相关<br>sudo su<br>/opt/rq_smart_construction/<br><br><br>停止进度微服务：ps -ef | grep java | grep -E &#x27;progress-application-exec&#x27;| grep -v &quot;grep&quot; |grep -v &quot;tail&quot; |grep -v &quot;tomcat&quot; | awk &#x27;&#123;print $2&#125;&#x27;| xargs kill -9<br>启动进度微服务：nohup java -Xms50m -Xmx500m -Dfastjson.parser.autoTypeSupport=true -Dfastjson.parser.safeMode=true -jar /opt/rq_smart_construction/progress-application-exec.jar &gt; /opt/rq_smart_construction/progress-server.log 2&gt;&amp;1 &amp;<br>tail -f /opt/rq_smart_construction/progress-server.log<br></code></pre></td></tr></table></figure><p>数据库表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 单位工程列表<br> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> progress_unitproject pu ;<br><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 总计划列表<br> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> progrees_total_plan ptp ;<br><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 总计划明细表<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> progress_total_plan_item ptpi ;<br><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 总计划明细与构件关联关系表<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> progress_total_plan_detail ptpd ; <br><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 进度反馈 反馈列表<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> progress_feedback_record pfr ;<br><br><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 月计划编制<span class="hljs-operator">/</span>月计划反馈<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> progress_month_plan pmp ;<br><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 准备工作计划<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> progress_month_plan_phys_constr pmppc ;<br><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 实体实施计划<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> progress_month_plan_prepare pmpp ;<br><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 验收工作计划<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> progress_month_plan_verify_work pmpvw ;<br> <br><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 周计划编制<span class="hljs-operator">/</span>周计划反馈<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> progress_week_plan pwp <br><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 准备工作计划<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> progress_week_plan_phys_constr pwppc <br><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 实体实施计划<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> progress_week_plan_prepare pwpp <br><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 验收工作计划<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> progress_week_plan_verify_work pwpvw <br>        <br><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 工期预警列表<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> progress_plan_alert ppa ;<br><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 工期预警明细<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> progress_plan_alert_item ppai ;<br></code></pre></td></tr></table></figure><h3 id="前端安装依赖-和启动问题"><a href="#前端安装依赖-和启动问题" class="headerlink" title="前端安装依赖, 和启动问题"></a>前端安装依赖, 和启动问题</h3><p>npm i –legacy-peer-deps</p><p>export NODE_OPTIONS=–openssl-legacy-provider</p><p>npm run start : </p><p><a href="https://www.cnblogs.com/asplover/p/17188483.html">https://www.cnblogs.com/asplover/p/17188483.html</a></p><h3 id="轻骑兵相关文档"><a href="#轻骑兵相关文档" class="headerlink" title="轻骑兵相关文档"></a>轻骑兵相关文档</h3><p><a href="http://10.198.6.41:8080/help/login?backUrl=/?v=1.14">http://10.198.6.41:8080/help/login?backUrl=/?v=1.14</a><br>账号：研发中心<br>密码：cscec81#</p><h3 id="本地docker地址"><a href="#本地docker地址" class="headerlink" title="本地docker地址"></a>本地docker地址</h3><p>/Users/zhaopeisheng/创联/zonghejnts_docker</p><h3 id="progress-配置文件"><a href="#progress-配置文件" class="headerlink" title="progress 配置文件"></a>progress 配置文件</h3><p>分组: hussar-base-cloud</p><p>id: progress-server-dev.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">dynamic:</span><br>      <span class="hljs-attr">primary:</span> <span class="hljs-string">master</span><br>      <span class="hljs-attr">seata:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">datasource:</span><br>        <span class="hljs-attr">master:</span><br>          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://10.198.40.77:3306/hussar-base-cloud?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=false&amp;useTimezone=true&amp;serverTimezone=GMT%2B8&amp;allowMultiQueries=true</span><br>          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>          <span class="hljs-attr">password:</span> <span class="hljs-string">1yrVZP%KqZ#SS_cscec81_Z#98</span><br>          <span class="hljs-attr">driver-class-name:</span>   <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">10.198</span><span class="hljs-number">.40</span><span class="hljs-number">.77</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span> <br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">type-handlers-package:</span>   <span class="hljs-string">com.jxdinfo.hussar.support.mp.typeconvter</span><br>  <span class="hljs-attr">check-config-location:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">mapper-locations:</span>   <span class="hljs-string">classpath*:com/jxdinfo/hussar/**/mapping/*.xml</span><br>  <span class="hljs-attr">typeAliasesPackage:</span>   <span class="hljs-string">com.jxdinfo.hussar.**.model,com.xxxx.**.model</span><br>  <span class="hljs-attr">typeEnumsPackage:</span>   <span class="hljs-string">com.jxdinfo.hussar.common.constant.enums</span><br>  <span class="hljs-attr">global-config:</span><br>    <span class="hljs-attr">banner:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">enable-sql-runner:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">cache-enabled:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">lazyLoadingEnabled:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">multipleResultSetsEnabled:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span><br><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">config:</span> <span class="hljs-string">classpath:log4j2.xml</span><br>  <span class="hljs-attr">level:</span><br>    <span class="hljs-attr">root:</span> <span class="hljs-string">INFO</span><br><span class="hljs-attr">open:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-number">1</span> <span class="hljs-comment">#系统内页面打开方式，0代表本页面，1代表新页签</span><br>  <span class="hljs-attr">isMultiple:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#是否允许打开多个页面</span><br><span class="hljs-attr">seata:</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">enable-auto-data-source-proxy:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">application-id:</span> <span class="hljs-string">$&#123;spring.application.name&#125;</span><br>  <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">my_tx_group</span><br>  <span class="hljs-attr">service:</span><br>    <span class="hljs-attr">vgroup-mapping:</span><br>      <span class="hljs-attr">my_tx_group:</span> <span class="hljs-string">default</span><br>  <span class="hljs-attr">registry:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">application:</span> <span class="hljs-string">seata-server</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">10.198</span><span class="hljs-number">.40</span><span class="hljs-number">.77</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;SEATA_GROUP&quot;</span><br>      <span class="hljs-attr">namespace:</span>   <span class="hljs-string">&quot;hussar-base-cloud&quot;</span><br>      <span class="hljs-attr">cluster:</span> <span class="hljs-string">default</span><br>  <span class="hljs-attr">config:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">10.198</span><span class="hljs-number">.40</span><span class="hljs-number">.77</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">&quot;SEATA_GROUP&quot;</span><br>      <span class="hljs-attr">namespace:</span>   <span class="hljs-string">&quot;hussar-base-cloud&quot;</span><br>      <span class="hljs-attr">dataId:</span>   <span class="hljs-string">&quot;seataServer.properties&quot;</span><br>      <span class="hljs-attr">username:</span> <span class="hljs-string">&quot;nacos&quot;</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;SHjvK*&amp;^!q6HjEud_zj81&quot;</span><br><span class="hljs-attr">hussar:</span><br>  <span class="hljs-attr">refer-whitelist:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">http://</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">https://</span><br></code></pre></td></tr></table></figure><h3 id="seata-配置文件"><a href="#seata-配置文件" class="headerlink" title="seata 配置文件"></a>seata 配置文件</h3><p>分组: seata</p><p>id: seataServer.properties</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">service.vgroupMapping.my_tx_group</span>=default<br><span class="hljs-attr">store.mode</span>=redis<br><span class="hljs-attr">store.db.datasource</span>=druid<br><span class="hljs-attr">store.db.dbType</span>=mysql<br><span class="hljs-attr">store.db.driverClassName</span>=com.mysql.jdbc.Driver<br><span class="hljs-attr">store.db.url</span>=jdbc:mysql://hussar-mysql:<span class="hljs-number">3306</span>/seata?useUnicode=<span class="hljs-literal">true</span><br><span class="hljs-attr">store.db.user</span>=root<br><span class="hljs-attr">store.db.password</span>=<span class="hljs-number">123456</span><br><span class="hljs-attr">store.redis.host</span>=hussar-redis<br><span class="hljs-attr">store.redis.port</span>=<span class="hljs-number">6379</span><br><span class="hljs-attr">store.redis.maxConn</span>=<span class="hljs-number">10</span><br><span class="hljs-attr">store.redis.minConn</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">store.redis.database</span>=<span class="hljs-number">0</span><br><span class="hljs-attr">store.redis.password</span>=root<br><span class="hljs-attr">store.redis.queryLimit</span>=<span class="hljs-number">100</span><br><span class="hljs-attr">client.undo.logTable</span>=sys_seata_undo_log <br><span class="hljs-attr">client.undo.logSerialization</span> = hussarJackson<br></code></pre></td></tr></table></figure><h3 id="srs"><a href="#srs" class="headerlink" title="srs"></a>srs</h3><p>源码: <a href="https://github.com/ossrs/srs">https://github.com/ossrs/srs</a></p><p><a href="http://localhost/mgmt/zh/routers-scenario?tab=live">http://localhost/mgmt/zh/routers-scenario?tab=live</a></p><p><a href="http://localhost/console/ng_index.html#/streams?port=80&amp;http=80">http://localhost/console/ng_index.html#/streams?port=80&amp;http=80</a></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">docker run <span class="hljs-attr">--rm</span> -it -<span class="hljs-selector-tag">p</span> <span class="hljs-number">80</span>:<span class="hljs-number">2022</span> -<span class="hljs-selector-tag">p</span> <span class="hljs-number">443</span>:<span class="hljs-number">2443</span> -<span class="hljs-selector-tag">p</span> <span class="hljs-number">1935</span>:<span class="hljs-number">1935</span> \<br>  -<span class="hljs-selector-tag">p</span> <span class="hljs-number">8080</span>:<span class="hljs-number">8080</span> -<span class="hljs-selector-tag">p</span> <span class="hljs-number">8000</span>:<span class="hljs-number">8000</span>/udp -<span class="hljs-selector-tag">p</span> <span class="hljs-number">10080</span>:<span class="hljs-number">10080</span>/udp <span class="hljs-attr">--name</span> srs-stack \<br>  -v <span class="hljs-variable">$HOME</span>/data:/data registry<span class="hljs-selector-class">.cn-hangzhou</span><span class="hljs-selector-class">.aliyuncs</span>.com/ossrs/srs-stack:<span class="hljs-number">5</span><br></code></pre></td></tr></table></figure><p>rtsp &gt; rtmp</p><p><a href="http://www.ossrs.net/lts/zh-cn/docs/v6/doc/ingest">http://www.ossrs.net/lts/zh-cn/docs/v6/doc/ingest</a></p><p>zl</p><p><a href="https://github.com/ZLMediaKit/ZLMediaKit/wiki/%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B">https://github.com/ZLMediaKit/ZLMediaKit/wiki/%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>spring mybits plus动态切换数据库</title>
    <link href="/wiki/2023/12/24/spring%20cloud/spring%20mybits%20plus%E5%8A%A8%E6%80%81%E5%88%87%E6%8D%A2%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    <url>/wiki/2023/12/24/spring%20cloud/spring%20mybits%20plus%E5%8A%A8%E6%80%81%E5%88%87%E6%8D%A2%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
    
    <content type="html"><![CDATA[<p>以前的做法可能是，在我们配置文件定义多个datasource，然后在dao中根据增、删、改、查去选择不同的datasource。这样做的话，可能就需要我们在代码里面硬编码选择数据源的过程，这样做显然不够友好，会产生很多冗余，重复的代码。</p><p>那有没有可以让我们的程序自动去选择路由数据源，而我代码中还是像以前那样，只关心业务逻辑，至于怎么选，选什么全都交给框架去实现。这样做的话，是不是瞬间感觉到代码清晰了很多了。那下面我们就来一步一步的实现看看。</p><h2 id="用到的技术"><a href="#用到的技术" class="headerlink" title="用到的技术"></a>用到的技术</h2><ol><li>spring提供的 AbstractRoutingDataSource 类。该类就是在多数据源下，会根据determineCurrentLookupKey() 这个方法返回的路由key，在动态选择数据源</li><li>spring AOP。需要在执行sql的方法前拦截请求，把该线程请求的方法，类名，参数等信息设置到线程局部变量（ThreadLocal）里面，然后determineCurrentLookupKey这个方法就可以根据线程的数据动态的选择数据源了。</li></ol><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>配置默认数据库(主数据库), <code>FilterThreadLocalContext</code> 拦截所有请求, 截取请求的域名,设置线程变量<code>ThreadLocal</code> 查找切换那个数据库.</p><p><code>DBConfigure.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.springmybitsdynamicdatasource.config.db;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.MybatisConfiguration;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.MybatisXMLLanguageDriver;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean;<br><span class="hljs-keyword">import</span> com.zaxxer.hikari.HikariDataSource;<br><span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;<br><span class="hljs-keyword">import</span> org.apache.ibatis.type.JdbcType;<br><span class="hljs-keyword">import</span> org.mybatis.spring.transaction.SpringManagedTransactionFactory;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;<br><span class="hljs-keyword">import</span> org.springframework.boot.web.servlet.FilterRegistrationBean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Primary;<br><span class="hljs-keyword">import</span> org.springframework.core.env.Environment;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter;<br><br><span class="hljs-keyword">import</span> javax.sql.DataSource;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DBConfigure</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebMvcConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Environment environment;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RoutingDataSource routingDataSource;<br><br>    <span class="hljs-meta">@Bean(&quot;dataSource&quot;)</span><br>    <span class="hljs-meta">@Primary</span><br>    <span class="hljs-meta">@ConfigurationProperties(&quot;spring.datasource&quot;)</span><br>    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 配置默认数据库</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">HikariDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HikariDataSource</span>();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> environment.getProperty(<span class="hljs-string">&quot;spring.datasource.url&quot;</span>);<br>        dataSource.setJdbcUrl(url);<br>        <span class="hljs-keyword">return</span> dataSource;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * mybatis-plus sqlSessionFactory config</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ds</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> globalConfig</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean(name = &quot;sqlSessionFactory&quot;)</span><br>    <span class="hljs-meta">@Primary</span><br>    <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">sqlSessionFactory</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(&quot;dataSource&quot;)</span> DataSource ds)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">MybatisSqlSessionFactoryBean</span> <span class="hljs-variable">factoryBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisSqlSessionFactoryBean</span>();<br>        factoryBean.setDataSource(routingDataSource);<br><br>        <span class="hljs-type">MybatisConfiguration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisConfiguration</span>();<br>        configuration.setDefaultScriptingLanguage(MybatisXMLLanguageDriver.class);<br>        configuration.setJdbcTypeForNull(JdbcType.NULL);<br>        factoryBean.setConfiguration(configuration);<br>        factoryBean.setTransactionFactory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringManagedTransactionFactory</span>());<br><br>        <span class="hljs-keyword">return</span> factoryBean.getObject();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 请求拦截器,  这个会拦截所有的请求</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> FilterRegistrationBean <span class="hljs-title function_">FilterThreadLocalContext</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">FilterRegistrationBean</span> <span class="hljs-variable">registration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterRegistrationBean</span>();<br>        registration.setFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterThreadLocalContext</span>());<br>        registration.addUrlPatterns(<span class="hljs-string">&quot;/*&quot;</span>);<br>        registration.setName(<span class="hljs-string">&quot;FilterThreadLocalContext&quot;</span>);<br>        registration.setOrder(<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">return</span> registration;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>FilterThreadLocalContext.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.springmybitsdynamicdatasource.config.db;<br><br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterThreadLocalContext</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-comment">// 拦截请求, 选择数据库</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">domain</span> <span class="hljs-operator">=</span> servletRequest.getServerName();<br><br><br>        ThreadLocalContext.get().setDataSource(domain);<br>        filterChain.doFilter(servletRequest, servletResponse);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>MultipleDataSource.java</code></p><p>程序启动查询数据库数据源, 添加到数据源里面.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.springmybitsdynamicdatasource.config.db;<br><br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> com.example.springmybitsdynamicdatasource.SpringContext;<br><span class="hljs-keyword">import</span> com.example.springmybitsdynamicdatasource.dao.DbDatabaseDao;<br><span class="hljs-keyword">import</span> com.example.springmybitsdynamicdatasource.dao.StudentDao;<br><span class="hljs-keyword">import</span> com.example.springmybitsdynamicdatasource.entity.DbDatabaseEntity;<br><span class="hljs-keyword">import</span> com.zaxxer.hikari.HikariDataSource;<br><span class="hljs-keyword">import</span> org.springframework.boot.CommandLineRunner;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultipleDataSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CommandLineRunner</span> &#123;<br>    <span class="hljs-keyword">private</span> RoutingDataSource routingDataSource;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadDatasource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 往连接池注入数据库</span><br>        <span class="hljs-type">DbDatabaseDao</span> <span class="hljs-variable">dbDatabaseDao</span> <span class="hljs-operator">=</span> SpringContext.getBean(DbDatabaseDao.class);<br>        routingDataSource = SpringContext.getBean(RoutingDataSource.class);<br><br>        <span class="hljs-comment">// 数据源</span><br>        Map&lt;Object, Object&gt; targetDataSources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Object, Object&gt;();<br>        List&lt;DbDatabaseEntity&gt; dbs = dbDatabaseDao.selectList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;());<br><br>        <span class="hljs-comment">// 把链接添加到连接池</span><br>        <span class="hljs-keyword">for</span> (DbDatabaseEntity db : dbs) &#123;<br>            <span class="hljs-type">HikariDataSource</span> <span class="hljs-variable">newDb</span>  <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.initDataSource(db.getUrl(),db.getDbUser(),db.getDbPwd(),db.getDriverClass());<br>            targetDataSources.put(db.getDomain(), newDb);<br>        &#125;<br><br>        routingDataSource.setTargetDataSources(targetDataSources);<span class="hljs-comment">// 设置数据源路由</span><br>        routingDataSource.afterPropertiesSet();<br>    &#125;<br><br><br>    <span class="hljs-keyword">private</span> HikariDataSource <span class="hljs-title function_">initDataSource</span><span class="hljs-params">(String url, String dbUser, String dbPwd, String driverClass)</span> &#123;<br>        <span class="hljs-comment">// 初始化数据源</span><br>        <span class="hljs-type">HikariDataSource</span> <span class="hljs-variable">new_ds</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HikariDataSource</span>();<br>        new_ds.setJdbcUrl(url);<br>        new_ds.setUsername(dbUser);<br>        new_ds.setPassword(dbPwd);<br>        new_ds.setDriverClassName(driverClass);<br>        <span class="hljs-keyword">return</span> new_ds;<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">(String... args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-built_in">this</span>.loadDatasource();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>RoutingDataSource.java</p><p>最重要的, 查询sql前 调用 <code>determineCurrentLookupKey</code>,切换要执行的数据库.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.springmybitsdynamicdatasource.config.db;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class="hljs-keyword">import</span> org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.util.StringUtils;<br><br><span class="hljs-keyword">import</span> javax.sql.DataSource;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Component(&quot;routingDataSource&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoutingDataSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractRoutingDataSource</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Map&lt;Object, Object&gt; targetDataSources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Object, Object&gt;();<br><br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RoutingDataSource</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(&quot;dataSource&quot;)</span> DataSource dataSource)</span> &#123;<br>        targetDataSources.put(<span class="hljs-string">&quot;dataSource&quot;</span>, dataSource);<br>        <span class="hljs-built_in">super</span>.setDefaultTargetDataSource(dataSource);<br>        <span class="hljs-built_in">super</span>.setTargetDataSources(<span class="hljs-built_in">this</span>.targetDataSources);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">determineCurrentLookupKey</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(ThreadLocalContext.get().getDataSource())) &#123;<br>            <span class="hljs-keyword">return</span> ThreadLocalContext.get().getDataSource();<br>        &#125;<br>        <span class="hljs-comment">// 返回空就是 默认数据库</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="数据库脚本"><a href="#数据库脚本" class="headerlink" title="数据库脚本"></a>数据库脚本</h2><p>主数据库,<code>dynamic_main</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> Navicat Premium Data Transfer</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> Source Server         : localhost</span><br><span class="hljs-comment"> Source Server Type    : MySQL</span><br><span class="hljs-comment"> Source Server Version : 50730</span><br><span class="hljs-comment"> Source Host           : localhost:3306</span><br><span class="hljs-comment"> Source Schema         : dynamic_main</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> Target Server Type    : MySQL</span><br><span class="hljs-comment"> Target Server Version : 50730</span><br><span class="hljs-comment"> File Encoding         : 65001</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> Date: 24/12/2023 17:26:08</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">SET</span> NAMES utf8mb4;<br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Table structure for db_database</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `db_database`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `db_database` (<br>  `id` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;编号&#x27;</span>,<br>  `database_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;数据库名称&#x27;</span>,<br>  `url` <span class="hljs-type">varchar</span>(<span class="hljs-number">1000</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;数据库连接字符串&#x27;</span>,<br>  `driver_class` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;数据库连接驱动&#x27;</span>,<br>  `db_user` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;数据库名称&#x27;</span>,<br>  `db_pwd` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;数据库密码&#x27;</span>,<br>  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>  `is_deleted` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;是否删除&#x27;</span>,<br>  `domain` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;domain,拦截前端请求,通过domain 查询要切换的数据库&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Records of db_database</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">BEGIN</span>;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `db_database` <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;dynamic_1&#x27;</span>, <span class="hljs-string">&#x27;jdbc:mysql://127.0.0.1:3306/dynamic_1?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;autoReconnect=true&#x27;</span>, <span class="hljs-string">&#x27;com.mysql.cj.jdbc.Driver&#x27;</span>, <span class="hljs-string">&#x27;root&#x27;</span>, <span class="hljs-string">&#x27;abc123&#x27;</span>, <span class="hljs-string">&#x27;2023-12-24 10:03:50&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&#x27;localhost&#x27;</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `db_database` <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;dynamic_2&#x27;</span>, <span class="hljs-string">&#x27;jdbc:mysql://127.0.0.1:3306/dynamic_2?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;autoReconnect=true&#x27;</span>, <span class="hljs-string">&#x27;com.mysql.cj.jdbc.Driver&#x27;</span>, <span class="hljs-string">&#x27;root&#x27;</span>, <span class="hljs-string">&#x27;abc123&#x27;</span>, <span class="hljs-string">&#x27;2023-12-24 10:03:50&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>);<br><span class="hljs-keyword">COMMIT</span>;<br><br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><br></code></pre></td></tr></table></figure><p>子数据库, <code>dynamic_1</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> Navicat Premium Data Transfer</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> Source Server         : localhost</span><br><span class="hljs-comment"> Source Server Type    : MySQL</span><br><span class="hljs-comment"> Source Server Version : 50730</span><br><span class="hljs-comment"> Source Host           : localhost:3306</span><br><span class="hljs-comment"> Source Schema         : dynamic_1</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> Target Server Type    : MySQL</span><br><span class="hljs-comment"> Target Server Version : 50730</span><br><span class="hljs-comment"> File Encoding         : 65001</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> Date: 24/12/2023 17:26:18</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">SET</span> NAMES utf8mb4;<br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Table structure for student</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `student`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `student` (<br>  `id` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;编号&#x27;</span>,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;学生姓名&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Records of student</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">BEGIN</span>;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `student` <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;localhost&#x27;</span>);<br><span class="hljs-keyword">COMMIT</span>;<br><br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><br></code></pre></td></tr></table></figure><p>子数据库, <code>dynamic_2</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> Navicat Premium Data Transfer</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> Source Server         : localhost</span><br><span class="hljs-comment"> Source Server Type    : MySQL</span><br><span class="hljs-comment"> Source Server Version : 50730</span><br><span class="hljs-comment"> Source Host           : localhost:3306</span><br><span class="hljs-comment"> Source Schema         : dynamic_2</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> Target Server Type    : MySQL</span><br><span class="hljs-comment"> Target Server Version : 50730</span><br><span class="hljs-comment"> File Encoding         : 65001</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> Date: 24/12/2023 17:26:26</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">SET</span> NAMES utf8mb4;<br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Table structure for student</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `student`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `student` (<br>  `id` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;编号&#x27;</span>,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;学生姓名&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Records of student</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">BEGIN</span>;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `student` <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>);<br><span class="hljs-keyword">COMMIT</span>;<br><br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><br></code></pre></td></tr></table></figure><h2 id="Gitee"><a href="#Gitee" class="headerlink" title="Gitee"></a>Gitee</h2><p><a href="https://gitee.com/zhaops_learning/spring-cloud-learning/tree/master/spring-mybits-dynamic-datasource">https://gitee.com/zhaops_learning/spring-cloud-learning/tree/master/spring-mybits-dynamic-datasource</a></p>]]></content>
    
    
    <categories>
      
      <category>spring cloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>springboot</tag>
      
      <tag>mybits plus</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/wiki/2023/12/18/%E8%AE%B0%E5%BD%95/%E5%B9%B3%E5%8F%B0%E8%AE%B0%E5%BD%95/"/>
    <url>/wiki/2023/12/18/%E8%AE%B0%E5%BD%95/%E5%B9%B3%E5%8F%B0%E8%AE%B0%E5%BD%95/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>SpringBoot静态方法获取bean</title>
    <link href="/wiki/2023/12/15/spring%20cloud/SpringBoot%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95%E8%8E%B7%E5%8F%96bean/"/>
    <url>/wiki/2023/12/15/spring%20cloud/SpringBoot%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95%E8%8E%B7%E5%8F%96bean/</url>
    
    <content type="html"><![CDATA[<h3 id="通过实现ApplicationContextAware接口，可以获取ApplicationContext上下文，并在静态方法中获取bean"><a href="#通过实现ApplicationContextAware接口，可以获取ApplicationContext上下文，并在静态方法中获取bean" class="headerlink" title="通过实现ApplicationContextAware接口，可以获取ApplicationContext上下文，并在静态方法中获取bean"></a>通过实现ApplicationContextAware接口，可以获取ApplicationContext上下文，并在静态方法中获取bean</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.springmybitsdynamicdatasource;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.BeansException;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.NoSuchBeanDefinitionException;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContextAware;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringContext</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Spring 应用上下文环境</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationContext applicationContext;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext context)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        applicationContext = context;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ApplicationContext <span class="hljs-title function_">getApplicationContext</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> applicationContext;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取对象</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> beanName</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Object bean的实例</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> BeansException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getBean</span><span class="hljs-params">(String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-keyword">if</span> (!SpringContext.containsBean(beanName)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> applicationContext.getBean(beanName);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取类型为requiredType的对象</span><br><span class="hljs-comment">     * 如果bean不能被类型转换，相应的异常将会被抛出（BeanNotOfRequiredTypeException）</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> requiredType 返回对象类型</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Object 返回requiredType类型对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> BeansException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(Class&lt;T&gt; requiredType)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-keyword">return</span> applicationContext.getBean(requiredType);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取类型为requiredType的对象</span><br><span class="hljs-comment">     * 如果bean不能被类型转换，相应的异常将会被抛出（BeanNotOfRequiredTypeException）</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name         bean注册名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> requiredType 返回对象类型</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Object 返回requiredType类型对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> BeansException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name, Class&lt;T&gt; requiredType)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-keyword">return</span> applicationContext.getBean(name, requiredType);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> requiredType</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> BeansException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(Class&lt;T&gt; requiredType, Object... args)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-keyword">return</span> applicationContext.getBean(requiredType, args);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name bean注册名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> BeansException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name, Object... args)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-keyword">return</span> applicationContext.getBean(name, args);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 如果BeanFactory包含一个与所给名称匹配的bean定义,则返回true</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> boolean</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsBean</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-keyword">return</span> applicationContext.containsBean(name);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 判断以给定名字注册的bean定义是一个singleton还是一个prototype。</span><br><span class="hljs-comment">     * 如果与给定名字相应的bean定义没有被找到,将会抛出一个异常（NoSuchBeanDefinitionException）</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> boolean</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NoSuchBeanDefinitionException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSingleton</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> NoSuchBeanDefinitionException &#123;<br>        <span class="hljs-keyword">return</span> applicationContext.isSingleton(name);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Class 注册对象的类型</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NoSuchBeanDefinitionException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@SuppressWarnings(&quot;rawtypes&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Class <span class="hljs-title function_">getType</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> NoSuchBeanDefinitionException &#123;<br>        <span class="hljs-keyword">return</span> applicationContext.getType(name);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 如果给定的bean名字在bean定义中有别名,则返回这些别名</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NoSuchBeanDefinitionException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String[] getAliases(String name) <span class="hljs-keyword">throws</span> NoSuchBeanDefinitionException &#123;<br>        <span class="hljs-keyword">return</span> applicationContext.getAliases(name);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isReady</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (applicationContext != <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">StudentDao</span> <span class="hljs-variable">studentDao</span> <span class="hljs-operator">=</span> SpringContext.getBean(StudentDao.class);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>spring cloud</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>springcloud</tag>
      
      <tag>springboot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/wiki/2023/12/06/%E8%AE%B0%E5%BD%95/aa/"/>
    <url>/wiki/2023/12/06/%E8%AE%B0%E5%BD%95/aa/</url>
    
    <content type="html"><![CDATA[<h1 id="搜索-mysql-版本"><a href="#搜索-mysql-版本" class="headerlink" title="搜索 mysql 版本"></a>搜索 mysql 版本</h1><p>brew search mysql</p><h1 id="安装-5-7"><a href="#安装-5-7" class="headerlink" title="安装 5.7"></a>安装 5.7</h1><p>brew install <a href="mailto:&#109;&#x79;&#115;&#113;&#x6c;&#64;&#x35;&#46;&#55;">&#109;&#x79;&#115;&#113;&#x6c;&#64;&#x35;&#46;&#55;</a></p><h1 id="配置环境变量，如下图红框1"><a href="#配置环境变量，如下图红框1" class="headerlink" title="配置环境变量，如下图红框1"></a>配置环境变量，如下图红框1</h1><p>echo ‘export PATH=”/opt/homebrew/opt/<a href="mailto:&#x6d;&#121;&#115;&#x71;&#108;&#x40;&#53;&#x2e;&#x37;">&#x6d;&#121;&#115;&#x71;&#108;&#x40;&#53;&#x2e;&#x37;</a>/bin:$PATH”‘ &gt;&gt; ~/.zshrc</p><h1 id="使配置生效"><a href="#使配置生效" class="headerlink" title="使配置生效"></a>使配置生效</h1><p>source ~/.zshrc</p><h1 id="启动-mysql-服务"><a href="#启动-mysql-服务" class="headerlink" title="启动 mysql 服务"></a>启动 mysql 服务</h1><h1 id="后台启动"><a href="#后台启动" class="headerlink" title="后台启动"></a>后台启动</h1><p>brew services start <a href="mailto:&#109;&#x79;&#115;&#x71;&#108;&#64;&#x35;&#46;&#55;">&#109;&#x79;&#115;&#x71;&#108;&#64;&#x35;&#46;&#55;</a><br>brew services stop <a href="mailto:&#x6d;&#121;&#115;&#113;&#108;&#x40;&#53;&#46;&#55;">&#x6d;&#121;&#115;&#113;&#108;&#x40;&#53;&#46;&#55;</a></p><h1 id="前台启动"><a href="#前台启动" class="headerlink" title="前台启动"></a>前台启动</h1><p>/usr/local/opt/<a href="mailto:&#x6d;&#x79;&#x73;&#113;&#108;&#x40;&#53;&#x2e;&#55;">&#x6d;&#x79;&#x73;&#113;&#108;&#x40;&#53;&#x2e;&#55;</a>/bin/mysqld_safe –datadir=/usr/local/var/mysql </p><p><a href="https://blog.csdn.net/qq_58141314/article/details/130987308">https://blog.csdn.net/qq_58141314/article/details/130987308</a></p><p><a href="https://www.jianshu.com/p/3878ca88993d">https://www.jianshu.com/p/3878ca88993d</a></p><p><a href="https://www.jianshu.com/p/3878ca88993d">https://www.jianshu.com/p/3878ca88993d</a></p><p><a href="https://blog.csdn.net/laodanqiu/article/details/134277630">https://blog.csdn.net/laodanqiu/article/details/134277630</a></p><p>ALTER USER ‘root‘@’localhost’ IDENTIFIED BY ‘abc123’; </p><p>ALTER USER ‘root‘@’%’ IDENTIFIED WITH mysql_native_password BY ‘abc123’; </p><p>FLUSH PRIVILEGES; </p><p><a href="https://brew.idayer.com/">https://brew.idayer.com/</a></p><p><a href="https://blog.51cto.com/u_16213366/6986511">https://blog.51cto.com/u_16213366/6986511</a></p><p>node 版本高</p><p><a href="https://blog.csdn.net/zjjxxh/article/details/127173968">https://blog.csdn.net/zjjxxh/article/details/127173968</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> NODE_OPTIONS=--openssl-legacy-provider<br></code></pre></td></tr></table></figure><table><thead><tr><th>表名</th><th>SYS_USERS</th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>注释</td><td>系统用户表</td><td></td><td></td><td></td><td></td></tr><tr><td>索引</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>别名</td><td>列名</td><td>数据类型</td><td>空值</td><td>主键</td><td>extra</td></tr><tr><td>用户编码</td><td>USER_ID</td><td>bigint(20)</td><td>NO</td><td>PRI</td><td></td></tr><tr><td>用户名称</td><td>USER_NAME</td><td>varchar(32)</td><td>YES</td><td></td><td></td></tr><tr><td>密码</td><td>PASSWORD</td><td>varchar(128)</td><td>YES</td><td></td><td></td></tr><tr><td>账户状态 1：激活 2：删除 3：休眠 4：注销</td><td>ACCOUNT_STATUS</td><td>char(1)</td><td>YES</td><td></td><td></td></tr><tr><td>安全级别</td><td>SECURITY_LEVEL</td><td>int(11)</td><td>YES</td><td></td><td></td></tr><tr><td>允许创建的最大会话数</td><td>MAX_SESSIONS</td><td>int(11)</td><td>YES</td><td></td><td></td></tr><tr><td>是否系统管理员</td><td>IS_SYS</td><td>char(1)</td><td>YES</td><td></td><td></td></tr><tr><td>是否公司级公用账号</td><td>IS_CPUBLIC</td><td>char(1)</td><td>YES</td><td></td><td></td></tr><tr><td>创建时间</td><td>CREATE_TIME</td><td>datetime</td><td>YES</td><td></td><td></td></tr><tr><td>创建人</td><td>CREATOR</td><td>bigint(20)</td><td>YES</td><td></td><td></td></tr><tr><td>最后一次更新时间</td><td>LAST_TIME</td><td>datetime</td><td>YES</td><td></td><td></td></tr><tr><td>最后一次更新人</td><td>LAST_EDITOR</td><td>bigint(20)</td><td>YES</td><td></td><td></td></tr><tr><td>锁定时间</td><td>LOCK_TIME</td><td>datetime</td><td>YES</td><td></td><td></td></tr><tr><td>失效时间</td><td>EXPIRED_TIME</td><td>datetime</td><td>YES</td><td></td><td></td></tr><tr><td>上次密码修改时间</td><td>PSWD_UPT_TIME</td><td>datetime</td><td>YES</td><td></td><td></td></tr><tr><td>密码失效时间</td><td>PSWD_TIME</td><td>datetime</td><td>YES</td><td></td><td></td></tr><tr><td>公司结构编码</td><td>CORPORATION_ID</td><td>bigint(20)</td><td>YES</td><td></td><td></td></tr><tr><td>部门结构编码</td><td>DEPARTMENT_ID</td><td>bigint(20)</td><td>YES</td><td></td><td></td></tr><tr><td>员工结构编码</td><td>EMPLOYEE_ID</td><td>bigint(20)</td><td>YES</td><td></td><td></td></tr><tr><td>电子邮件</td><td>E_MAIL</td><td>varchar(128)</td><td>YES</td><td></td><td></td></tr><tr><td>微信</td><td>WECHAT</td><td>varchar(64)</td><td>YES</td><td></td><td></td></tr><tr><td>电话</td><td>TELEPHONE</td><td>varchar(32)</td><td>YES</td><td></td><td></td></tr><tr><td>移动电话</td><td>MOBILE</td><td>varchar(32)</td><td>YES</td><td></td><td></td></tr><tr><td>字符型扩充字段1</td><td>CHAR_1</td><td>varchar(64)</td><td>YES</td><td></td><td></td></tr><tr><td>字符型扩充字段2</td><td>CHAR_2</td><td>varchar(64)</td><td>YES</td><td></td><td></td></tr><tr><td>数字型扩充字段1</td><td>NUM_1</td><td>int(11)</td><td>YES</td><td></td><td></td></tr><tr><td>数字型扩充字段2</td><td>NUM_2</td><td>int(11)</td><td>YES</td><td></td><td></td></tr><tr><td>权限组织结构编码</td><td>PERMISSION_STRU_ID</td><td>bigint(20)</td><td>YES</td><td></td><td></td></tr><tr><td>用户排序序号</td><td>USER_ORDER</td><td>int(11)</td><td>YES</td><td></td><td></td></tr><tr><td>行政区代码</td><td>PROVINCE_CODE</td><td>varchar(32)</td><td>YES</td><td></td><td></td></tr><tr><td>用户登录账号</td><td>USER_ACCOUNT</td><td>varchar(255)</td><td>YES</td><td>UNI</td><td>对应人员表用户第一账号</td></tr><tr><td>类型属性 0 临时账号 1长期账号</td><td>TYPE_PROPERTY</td><td>char(1)</td><td>YES</td><td></td><td></td></tr><tr><td>开始时间</td><td>START_TIME</td><td>datetime</td><td>YES</td><td></td><td></td></tr><tr><td>最后登录时间</td><td>LAST_LOGIN_TIME</td><td>datetime</td><td>YES</td><td></td><td></td></tr><tr><td>允许登录时间</td><td>ACCESS_LOGIN_START_TIME</td><td>time</td><td>YES</td><td></td><td></td></tr><tr><td>允许登录时间</td><td>ACCESS_LOGIN_END_TIME</td><td>time</td><td>YES</td><td></td><td></td></tr><tr><td>身份验证</td><td>TOTP_KEY</td><td>varchar(64)</td><td>YES</td><td></td><td></td></tr><tr><td>是否开启登录时间验证，1 开启 0不开启</td><td>LOGIN_TIME_LIMIT</td><td>char(1)</td><td>YES</td><td></td><td></td></tr><tr><td>是否开启登录IP验证，1 开启 0不开启</td><td>LOGIN_IP_LIMIT</td><td>char(1)</td><td>YES</td><td></td><td></td></tr><tr><td>数据权限类型</td><td>DATA_SCOPE_TYPE</td><td>char(1)</td><td>YES</td><td></td><td></td></tr><tr><td>外部接口用户主键</td><td>OUT_USER_ID</td><td>varchar(64)</td><td>YES</td><td></td><td></td></tr><tr><td>用户新登录账号</td><td>USER_ACCOUNT_NEW</td><td>varchar(255)</td><td>YES</td><td></td><td>第二账号</td></tr><tr><td>头像Url</td><td>AVATAR_URL</td><td>varchar(255)</td><td>YES</td><td></td><td></td></tr><tr><td>删除标识(0未删除   1已删除)</td><td>OUT_IS_DELETED</td><td>int(11)</td><td>YES</td><td></td><td></td></tr><tr><td>在职状态(0：停用 ；1：在职 ；2：离职 ；3：病假 ；)</td><td>OUT_JOB_STATUS</td><td>int(11)</td><td>YES</td><td></td><td></td></tr><tr><td>用户类型值(0：公司用户;1：相关方用户;2：业主;3：分包商用户;4：供应商;5：其他用户;6：项目级分包用户;7：单位级分包用户)</td><td>OUT_USER_TYPE_CODE</td><td>int(11)</td><td>YES</td><td></td><td></td></tr><tr><td>上游同步数据ID</td><td>OUT_ORIGIN_ID</td><td>varchar(64)</td><td>YES</td><td></td><td></td></tr><tr><td>排序</td><td>OUT_SORT_NUMBER</td><td>varchar(255)</td><td>YES</td><td></td><td></td></tr><tr><td>签名图片</td><td>SIGN_PIC</td><td>blob</td><td>YES</td><td></td><td></td></tr><tr><td>是否推送到融云系统，1：是，0：不是</td><td>IS_RONG</td><td>int(11)</td><td>YES</td><td></td><td></td></tr><tr><td>电子签名</td><td>SIGNATURE</td><td>blob</td><td>YES</td><td></td><td></td></tr></tbody></table>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>keytool RSA DSA</title>
    <link href="/wiki/2023/03/11/ssl/keytool%20RSA%20DSA/"/>
    <url>/wiki/2023/03/11/ssl/keytool%20RSA%20DSA/</url>
    
    <content type="html"><![CDATA[<h4 id="生成证书库"><a href="#生成证书库" class="headerlink" title="生成证书库"></a>生成证书库</h4><p>keytool将密钥（key）和证书（certificates）存储在keystore文件中</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">keytool -genkey -keysize 1024 -validity 3650 -keyalg RSA -alias &quot;privateKey&quot; -keystore &quot;privateKeys.keystore&quot; -storepass &quot;soyuan.123&quot; -keypass &quot;soyuan.123&quot; -dname &quot;CN=localhost, OU=localhost, O=localhost, L=SH, ST=SH, C=CN&quot;<br></code></pre></td></tr></table></figure><ul><li><p>genkey： 表示生成密钥对（公钥和私钥）</p></li><li><p>storepass: 密码库密码</p></li><li><p>keypass: 私钥密码</p></li><li><p>alias: 别名</p></li><li><p>validity: 36500 过期时间（天），默认大约90天</p></li><li><p>dname “CN=jwt,OU=jtw,O=jwt,L=zurich,S=zurich, C=CH” 名字与姓氏，组织单位，城市，区县，国家代码</p></li><li><p>keyalg RSA 加密算法 指定密钥的 算法 (如 RSA DSA（如果不指定默认采用DSA）)</p><ul><li><p>DSA只是一种算法，和RSA不同之处在于它不能用作加密和解密，也不能进行密钥交换，</p><p>只用于签名,它比RSA要快很多.</p></li></ul></li></ul><p>执行完会出现警告: <strong>JKS 密钥库使用专用格式。建议使用 “keytool -importkeystore -srckeystore privateKeys.keystore -destkeystore privateKeys.keystore -deststoretype pkcs12” 迁移到行业标准格式 PKCS12。</strong></p><h4 id="查看证书"><a href="#查看证书" class="headerlink" title="查看证书"></a>查看证书</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">keytool -list -v -keystore privateKeys.keystore -storepass soyuan.123<br><span class="hljs-meta prompt_"># </span><span class="language-bash">可编码方式打印证书</span><br>keytool -list -rfc -keystore privateKeys.keystore -storepass soyuan.123<br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看公钥</span><br>keytool -list -rfc --keystore privateKeys.keystore | openssl x509 -inform pem -pubkey<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">下面导出证书文件, 为了在java程序里面使用</span><br></code></pre></td></tr></table></figure><h4 id="JKS转换到PKCS12"><a href="#JKS转换到PKCS12" class="headerlink" title="JKS转换到PKCS12"></a>JKS转换到PKCS12</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">keytool -importkeystore -srckeystore privateKeys.keystore -destkeystore privateKeys.keystore -deststoretype pkcs12<br></code></pre></td></tr></table></figure><h4 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">修改密钥库中指定条目的密码</span><br>keytool -keypasswd -alias 需修改的别名 -keypass 旧密码 -new 新密码 -storepass keystore密码 -keystore 所在的密钥库<br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改密钥库的密码</span><br>keytool -storepasswd -keystore privateKeys.keystore -storepass 原始密码 -new 新密码 <br></code></pre></td></tr></table></figure><h4 id="导出证书"><a href="#导出证书" class="headerlink" title="导出证书"></a>导出证书</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">keytool -export -alias &quot;privateKey&quot; -file &quot;certfile.cer&quot; -keystore &quot;privateKeys.keystore&quot; -storepass soyuan.123<br></code></pre></td></tr></table></figure><h4 id="把证书导入到证书库"><a href="#把证书导入到证书库" class="headerlink" title="把证书导入到证书库"></a>把证书导入到证书库</h4><p>公钥和私钥最好分开存储二个keystore文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">keytool -import -alias &quot;publicKey&quot; -file &quot;certfile.cer&quot; -keystore &quot;privateKeys.keystore&quot; -storepass &quot;soyuan.123&quot;<br></code></pre></td></tr></table></figure><h4 id="删除证书库条目"><a href="#删除证书库条目" class="headerlink" title="删除证书库条目"></a>删除证书库条目</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">keytool -delete -alias mykey -keystore privateKeys.keystore -storepass soyuan.123<br></code></pre></td></tr></table></figure><h4 id="转换成pem证书"><a href="#转换成pem证书" class="headerlink" title="转换成pem证书"></a>转换成pem证书</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">openssl x509 -inform der -in certfile.cer -out certfile.pem<br></code></pre></td></tr></table></figure><h4 id="查看公钥"><a href="#查看公钥" class="headerlink" title="查看公钥"></a>查看公钥</h4><p>私钥条目 和 导出的证书都可以查看公钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">keytool -list -rfc --keystore privateKeys.keystore | openssl x509 -inform pem -pubkey<br></code></pre></td></tr></table></figure><p>公钥信息:</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">-----BEGIN <span class="hljs-keyword">PUBLIC</span> <span class="hljs-keyword">KEY</span>-----<br>MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCU3Evfsz32KGB0QU/D7L5F1ELx<br>X4C7u+gBjnIiF4YTTeLBevu/XO3EyXDFEnuKlRyXB/ZConG78wWcBWC1jXpcabfI<br><span class="hljs-number">8</span>HCb3nNq0fcbrz2faTps8sTldbAX4VlGKHY+xbRhwvcucXgpU7JICLDN7DhaeEds<br><span class="hljs-number">1</span>VVo5Hg/sIRuoBBF5wIDAQAB<br>-----<span class="hljs-keyword">END</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-keyword">KEY</span>-----<br></code></pre></td></tr></table></figure><h4 id="获取私钥"><a href="#获取私钥" class="headerlink" title="获取私钥"></a>获取私钥</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">openssl pkcs12 -in privateKeys.keystore -nodes -nocerts -out privatekey.pem<br></code></pre></td></tr></table></figure><p>私钥信息:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">-----BEGIN PRIVATE KEY-----<br>MIICdQIBADANBgkqhkiG9w0BAQEFAASCAl8wggJbAgEAAoGBAJTcS9+zPfYoYHRB<br>T8PsvkXUQvFfgLu76AGOciIXhhNN4sF6+79c7cTJcMUSe4qVHJcH9kKicbvzBZwF<br>YLWNelxpt8jwcJvec2rR9xuvPZ9pOmzyxOV1sBfhWUYodj7FtGHC9y5xeClTskgI<br>sM3sOFp4R2zVVWjkeD+whG6gEEXnAgMBAAECgYBhI3hnm8GdNi/q7QuuIHjxfFfK<br>xrVszGvTSC72TD9zrWmBNE2/TFbkCUeLckon3rHvZISwauyo5ycL7v5yusXTNWrH<br>MjIitWAQZP58qnIiJx72COTi3pG3U/aE9/694ChZ9pSOaaULWYPPbxjZCUe2Z1O+<br>IagLVubAhrhOWfRPQQJBAMNsHoWxsc9Nv6zMOLbxFRg9nb/KLp4VXAqMwK5ctK2Y<br>Kj34qGWwOomnT5g3V5LhBeQ0NMH0d+8Guy0/DVuzyHcCQQDDATs2ym0StdB3yzs5<br>DSsSET0m6vv49503XfQGRWsFaIzpPuddweSS2ztevfdMzUULWj2up/dGPiYOTGCS<br>MzoRAkBW83yBMBdVjdqDIDr76zjfmErgUy162TYi243ABy+9Lb9d443J8Seap/8a<br>U0V77POaHkB7LDNQ/0W5VBy1eMDxAkBK4ZgpbAYCX0rUFXiCaeoWIASJg0aKzhrS<br>/gMMvW9hPkqN7pfNyvzI3+KmePATz+cpetegz+MGWCso5m9W9NDhAkAOGZ+a8QFV<br>xY8iVb/l6ZyS0AaKghgrLv+aReTQwTc+rkkjvVwe7cyh9dChN0rWfOenceaXks+H<br>cTVuMmKV6pts<br>-----END PRIVATE KEY-----<br></code></pre></td></tr></table></figure><h4 id="java获取RSA公钥私钥"><a href="#java获取RSA公钥私钥" class="headerlink" title="java获取RSA公钥私钥"></a>java获取RSA公钥私钥</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.soyuan.umsserviceapi.security;<br><br><span class="hljs-keyword">import</span> com.soyuan.umsserviceapi.conf.JwtPrivateKeyConf;<br><span class="hljs-keyword">import</span> sun.misc.BASE64Encoder;<br><br><span class="hljs-keyword">import</span> java.io.FileWriter;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.security.*;<br><span class="hljs-keyword">import</span> java.security.cert.Certificate;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExportCert</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取jwt使用的token</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> jwtPrivateKeyConf</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getJwtPrivateKey</span><span class="hljs-params">(JwtPrivateKeyConf jwtPrivateKeyConf)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">keyStoreType</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jks&quot;</span>;<br>        <span class="hljs-type">KeyStore</span> <span class="hljs-variable">keyStore</span> <span class="hljs-operator">=</span> KeyStore.getInstance(keyStoreType);<br>        keyStore.load(Files.newInputStream(Paths.get(jwtPrivateKeyConf.getPrivateKeysStorePath())), jwtPrivateKeyConf.getPassword().toCharArray());<br>        <span class="hljs-type">KeyPair</span> <span class="hljs-variable">keyPair</span> <span class="hljs-operator">=</span> ExportCert.getKeyPair(keyStore, jwtPrivateKeyConf.getAlias(), jwtPrivateKeyConf.getPrivatePassword().toCharArray());<br>        <span class="hljs-keyword">return</span> ExportCert.exportPrivateKey(keyPair.getPrivate());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取jwt使用的token</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> jwtPrivateKeyConf</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getJwtPublicKey</span><span class="hljs-params">(JwtPrivateKeyConf jwtPrivateKeyConf)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">keyStoreType</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jks&quot;</span>;<br>        <span class="hljs-type">KeyStore</span> <span class="hljs-variable">keyStore</span> <span class="hljs-operator">=</span> KeyStore.getInstance(keyStoreType);<br>        keyStore.load(Files.newInputStream(Paths.get(jwtPrivateKeyConf.getPrivateKeysStorePath())), jwtPrivateKeyConf.getPassword().toCharArray());<br>        <span class="hljs-type">KeyPair</span> <span class="hljs-variable">keyPair</span> <span class="hljs-operator">=</span> ExportCert.getKeyPair(keyStore, jwtPrivateKeyConf.getAlias(), jwtPrivateKeyConf.getPrivatePassword().toCharArray());<br>        <span class="hljs-keyword">return</span> ExportCert.exportPublicKey(keyPair.getPublic());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 得到KeyPair</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> keyStore</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> alias</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> password</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> KeyPair <span class="hljs-title function_">getKeyPair</span><span class="hljs-params">(KeyStore keyStore, String alias, <span class="hljs-type">char</span>[] password)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Key</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyStore.getKey(alias, password);<br>            <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">instanceof</span> PrivateKey) &#123;<br>                <span class="hljs-type">Certificate</span> <span class="hljs-variable">certificate</span> <span class="hljs-operator">=</span> keyStore.getCertificate(alias);<br>                <span class="hljs-type">PublicKey</span> <span class="hljs-variable">publicKey</span> <span class="hljs-operator">=</span> certificate.getPublicKey();<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KeyPair</span>(publicKey, (PrivateKey) key);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (UnrecoverableKeyException | NoSuchAlgorithmException | KeyStoreException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 导出私钥</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> privateKey</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">exportPrivateKey</span><span class="hljs-params">(PrivateKey privateKey)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">BASE64Encoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BASE64Encoder</span>();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">encoded</span> <span class="hljs-operator">=</span> encoder.encode(privateKey.getEncoded());<br>        <span class="hljs-keyword">return</span> encoded;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 导出公钥</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> publicKey</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> exportFile</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">exportPublicKey</span><span class="hljs-params">(PublicKey publicKey)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">BASE64Encoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BASE64Encoder</span>();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">encoded</span> <span class="hljs-operator">=</span> encoder.encode(publicKey.getEncoded());<br>        <span class="hljs-keyword">return</span> encoded;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ssl</category>
      
    </categories>
    
    
    <tags>
      
      <tag>开发</tag>
      
      <tag>ssl</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>openssl链式证书</title>
    <link href="/wiki/2023/03/11/ssl/openssl%E9%93%BE%E5%BC%8F%E8%AF%81%E4%B9%A6/"/>
    <url>/wiki/2023/03/11/ssl/openssl%E9%93%BE%E5%BC%8F%E8%AF%81%E4%B9%A6/</url>
    
    <content type="html"><![CDATA[<h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>vim ca.conf</p><p>openssl genrsa -out root.key 2048</p><p>openssl req -new -key root.key -out root.csr -config ca.conf</p><p>openssl x509 -req -days 3650 -sha256 -extfile ca.conf -extensions v3_ca -in root.csr -signkey root.key -out root.crt</p><p>openssl genrsa -out middle.key 2048</p><p>vim ca_intermediate.ext</p><p>openssl req -new -key middle.key -out middle.csr -config middle.conf</p><p>openssl x509 -req -extfile ca_intermediate.ext -extensions v3_intermediate_ca -days 1800 -sha256 -CA root.crt -CAkey root.key -CAcreateserial -CAserial serial -in middle.csr -out middle.crt</p><p>openssl verify -CAfile root.crt middle.crt</p><p>openssl x509 -noout -text -in middle.crt</p><p>openssl genrsa -out 119.45.253.198.key 2048</p><p>openssl req -new -key 119.45.253.198.key -out 119.45.253.198.csr -config 119.45.253.198.conf</p><p>openssl x509 -req -extfile 119.45.253.198.conf -extensions v3_server -days 365 -sha256 -CA middle.crt -CAkey middle.key -CAserial serial -in 119.45.253.198.csr -out 119.45.253.198.crt</p><p>cat middle.crt root.crt &gt; middle-chain.crt</p><p>openssl verify -CAfile middle-chain.crt server.crt</p><p><a href="https://blog.csdn.net/baidu_34881991/article/details/129888830">https://blog.csdn.net/baidu_34881991/article/details/129888830</a></p>]]></content>
    
    
    <categories>
      
      <category>ssl</category>
      
    </categories>
    
    
    <tags>
      
      <tag>开发</tag>
      
      <tag>ssl</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>enum 高效实现方式</title>
    <link href="/wiki/2023/02/25/%E6%9E%9A%E4%B8%BE/enum/"/>
    <url>/wiki/2023/02/25/%E6%9E%9A%E4%B8%BE/enum/</url>
    
    <content type="html"><![CDATA[<h4 id="js-实现方式"><a href="#js-实现方式" class="headerlink" title="js 实现方式"></a>js 实现方式</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 事件集合枚举</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">EVENTTYPES</span> = &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 交通事件</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-title class_">TrafficIncident</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 门客伤</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-title class_">DoorGuestInjury</span>: <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>,<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 行车伤人</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-title class_">DrivingInjury</span>: <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span><br>&#125;<br><br><br><span class="hljs-keyword">let</span> eventTypes = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// 按位或运算</span><br><span class="hljs-comment">// 往枚举添加交通事件</span><br>eventTypes = eventTypes | <span class="hljs-variable constant_">EVENTTYPES</span>.<span class="hljs-property">TrafficIncident</span>;<br><span class="hljs-comment">// 枚举里面添加行车伤人</span><br>eventTypes = eventTypes | <span class="hljs-variable constant_">EVENTTYPES</span>.<span class="hljs-property">DrivingInjury</span>;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(eventTypes)<br><br><br><span class="hljs-comment">// 按位与运算</span><br><span class="hljs-comment">// 判断枚举里面 是否包含 交通事件</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable constant_">EVENTTYPES</span>.<span class="hljs-property">TrafficIncident</span> &amp; eventTypes)<br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>enum</category>
      
    </categories>
    
    
    <tags>
      
      <tag>开发</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>thinkphp nginx下出现404问题</title>
    <link href="/wiki/2022/12/05/php/thinkphp%20nginx%E4%B8%8B%E5%87%BA%E7%8E%B0404%E9%97%AE%E9%A2%98/"/>
    <url>/wiki/2022/12/05/php/thinkphp%20nginx%E4%B8%8B%E5%87%BA%E7%8E%B0404%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<p><code>thinkphp的url访问：http://serverName/index.php（或者其它应用入口文件）/模块/控制器/操作/[参数名/参数值…]，这个需要支持pathinfo，Apache默认支持，而Nginx不支持。</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs conf">server &#123;<br>    listen       81;<br>    server_name  tp5.com;<br><br>    #charset koi8-r;<br><br>    #access_log  logs/host.access.log  main;<br><br>    location / &#123;<br>        root    D:\\soft\\php\\tp5\\public;<br>        index  index.php index.html index.htm;<br><br>        #访问路径的文件不存在则重写URL转交给ThinkPHP处理<br>        if (!-e $request_filename) &#123;<br>           rewrite  ^/(.*)$  /index.php/$1  last;<br>           break;<br>        &#125;<br>    &#125;<br><br>    #error_page  404              /404.html;<br><br>    # redirect server error pages to the static page /50x.html<br>    #<br>    error_page   500 502 503 504  /50x.html;<br>    location = /50x.html &#123;<br>        root   html;<br>    &#125;<br><br>     <br><br>    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000<br>    #<br>    location ~ \.php/?.*$ &#123;<br>        root  D:\\soft\\php\\tp5\\public;<br>        fastcgi_pass   127.0.0.1:9000;<br>        fastcgi_index  index.php;<br>        #加载Nginx默认&quot;服务器环境变量&quot;配置<br>        include        fastcgi.conf;<br>        <br>        #设置PATH_INFO并改写SCRIPT_FILENAME,SCRIPT_NAME服务器环境变量<br>        set $fastcgi_script_name2 $fastcgi_script_name;<br>        if ($fastcgi_script_name ~ &quot;^(.+\.php)(/.+)$&quot;) &#123;<br>            set $fastcgi_script_name2 $1;<br>            set $path_info $2;<br>        &#125;<br>        fastcgi_param   PATH_INFO $path_info;<br>        fastcgi_param   SCRIPT_FILENAME   $document_root$fastcgi_script_name2;<br>        fastcgi_param   SCRIPT_NAME   $fastcgi_script_name2;<br>    &#125; <br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>thinkphp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>开发</tag>
      
      <tag>thinkphp</tag>
      
      <tag>php</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hive操作</title>
    <link href="/wiki/2022/11/10/hadoop/hive%E6%93%8D%E4%BD%9C/"/>
    <url>/wiki/2022/11/10/hadoop/hive%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">EXTERNAL</span> <span class="hljs-keyword">TABLE</span> accslog(key string,<br>                              accs_time string,<br>                              device_face_id string,<br>                              accs_ctrl_id string,<br>                              face_idtfy_rate string,<br>                              key_num string,<br>                              wechat_openid string,  <br>                              user_id string,<br>                              face_age string,<br>                              accs_type string,<br>                              create_time <span class="hljs-type">bigint</span>)   <br>   STORED <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;org.apache.hadoop.hive.hbase.HBaseStorageHandler&#x27;</span>   <br>   <span class="hljs-keyword">WITH</span> SERDEPROPERTIES (&quot;hbase.columns.mapping&quot; <span class="hljs-operator">=</span> &quot;:key,info:accs_time,info:device_face_id,info:accs_ctrl_id,info:face_idtfy_rate,info:key_num,info:wechat_openid,info:user_id,info:face_age,info:accs_type,:timestamp&quot;)   <br>   TBLPROPERTIES (&quot;hbase.table.name&quot; <span class="hljs-operator">=</span> &quot;accslog&quot;);<br><br><br><br></code></pre></td></tr></table></figure><p><a href="https://blog.csdn.net/qq_15300683/article/details/80455097">https://blog.csdn.net/qq_15300683/article/details/80455097</a></p><p><a href="https://blog.csdn.net/leanaoo/article/details/83351240">https://blog.csdn.net/leanaoo/article/details/83351240</a></p><p>文件</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> areas1(id string,<br>                   areaname string,<br>                   areacode string)<br><span class="hljs-type">row</span> format delimited<br>fields terminated <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;;&#x27;</span>;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">load data inpath &#x27;/wd/area.txt&#x27; overwrite into table areas;<br></code></pre></td></tr></table></figure><p>hbase</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">EXTERNAL</span> <span class="hljs-keyword">TABLE</span> areas(key string,<br>                           areaname string,<br>                           areacode string,<br>                           createtime <span class="hljs-type">bigint</span><br>                           )<br> STORED <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;org.apache.hadoop.hive.hbase.HBaseStorageHandler&#x27;</span>   <br>  <span class="hljs-keyword">WITH</span> SERDEPROPERTIES (&quot;hbase.columns.mapping&quot; <span class="hljs-operator">=</span> &quot;:key,data:areaname,data:areacode,:timestamp&quot;)   <br>  TBLPROPERTIES (&quot;hbase.table.name&quot; <span class="hljs-operator">=</span> &quot;areas&quot;);<br></code></pre></td></tr></table></figure><p>phoenix</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 访问记录<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> &quot;accslog&quot;(<br>    &quot;ID&quot; <span class="hljs-type">varchar</span> <span class="hljs-keyword">primary</span> key, <br>       &quot;data&quot;.&quot;accs_time&quot; <span class="hljs-type">varchar</span>,<br>    &quot;data&quot;.&quot;create_time&quot; <span class="hljs-type">varchar</span>,<br>        &quot;data&quot;.&quot;device_face_id&quot; <span class="hljs-type">varchar</span>,<br>        &quot;data&quot;.&quot;accs_ctrl_id&quot; <span class="hljs-type">varchar</span>,<br>        &quot;data&quot;.&quot;face_idtfy_rate&quot; <span class="hljs-type">varchar</span>,<br>        &quot;data&quot;.&quot;key_num&quot; <span class="hljs-type">varchar</span>,<br>        &quot;data&quot;.&quot;wechat_openid&quot; <span class="hljs-type">varchar</span>,<br>        &quot;data&quot;.&quot;update_time&quot; <span class="hljs-type">varchar</span>,<br>        &quot;data&quot;.&quot;user_id&quot; <span class="hljs-type">varchar</span>,<br>        &quot;data&quot;.&quot;face_age&quot; <span class="hljs-type">varchar</span>,<br>        &quot;data&quot;.&quot;accs_type&quot; <span class="hljs-type">varchar</span> <br>)column_encoded_bytes<span class="hljs-operator">=</span><span class="hljs-number">0</span>;<br><br># 用户表<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> LOT_USERINFO_V2(<br>&quot;ID&quot; <span class="hljs-type">varchar</span> <span class="hljs-keyword">primary</span> key, <br> &quot;DATA&quot;.&quot;cmmty_nm&quot; <span class="hljs-type">varchar</span>,<br>     &quot;DATA&quot;.&quot;prov_nm&quot; <span class="hljs-type">varchar</span>,<br>     &quot;DATA&quot;.&quot;user_status&quot; <span class="hljs-type">varchar</span>,<br>     &quot;DATA&quot;.&quot;cert_type&quot; <span class="hljs-type">varchar</span>,<br>     &quot;DATA&quot;.&quot;city_nm&quot; <span class="hljs-type">varchar</span>,<br>     &quot;DATA&quot;.&quot;hous_no&quot; <span class="hljs-type">varchar</span>,<br>     &quot;DATA&quot;.&quot;cmmty_id&quot; <span class="hljs-type">varchar</span>,<br>     &quot;DATA&quot;.&quot;create_time&quot; <span class="hljs-type">varchar</span>,<br>     &quot;DATA&quot;.&quot;gender&quot; <span class="hljs-type">varchar</span>,<br>     &quot;DATA&quot;.&quot;id_card&quot; <span class="hljs-type">varchar</span>,<br>     &quot;DATA&quot;.&quot;mobile_no&quot; <span class="hljs-type">varchar</span>,<br>     &quot;DATA&quot;.&quot;birth&quot; <span class="hljs-type">varchar</span>,<br>     &quot;DATA&quot;.&quot;user_nm&quot; <span class="hljs-type">varchar</span>,<br>     &quot;DATA&quot;.&quot;cert_num&quot; <span class="hljs-type">varchar</span>,<br>     &quot;DATA&quot;.&quot;rgst_face_pic&quot; <span class="hljs-type">varchar</span>,<br>     &quot;DATA&quot;.&quot;build_no&quot; <span class="hljs-type">varchar</span>,<br>     &quot;DATA&quot;.&quot;key_num&quot; <span class="hljs-type">varchar</span><br>)column_encoded_bytes<span class="hljs-operator">=</span><span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>hadoop</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hadoop</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>电子地图瓦片下载</title>
    <link href="/wiki/2022/04/22/cesium/%E7%94%B5%E5%AD%90%E5%9C%B0%E5%9B%BE%E7%93%A6%E7%89%87%E4%B8%8B%E8%BD%BD/"/>
    <url>/wiki/2022/04/22/cesium/%E7%94%B5%E5%AD%90%E5%9C%B0%E5%9B%BE%E7%93%A6%E7%89%87%E4%B8%8B%E8%BD%BD/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>cesium</category>
      
    </categories>
    
    
    <tags>
      
      <tag>cesium</tag>
      
      <tag>GIS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>cesium加载高程数据</title>
    <link href="/wiki/2022/04/21/cesium/cesium%E5%8A%A0%E8%BD%BD%E9%AB%98%E7%A8%8B%E6%95%B0%E6%8D%AE/"/>
    <url>/wiki/2022/04/21/cesium/cesium%E5%8A%A0%E8%BD%BD%E9%AB%98%E7%A8%8B%E6%95%B0%E6%8D%AE/</url>
    
    <content type="html"><![CDATA[<h2 id="高程数据下载"><a href="#高程数据下载" class="headerlink" title="高程数据下载"></a>高程数据下载</h2><p>国家地理空间数据下载：<code>http://www.gscloud.cn</code></p><p>这上面的高程数据下载，高度有问题，这个需要在研究一下。用我再百度云盘里面下载好的，格式是 <code>tif</code> 格式。</p><blockquote><ul><li>2022-6-5</li></ul><p>高度有问题是因为，选择的类型不对，下载时选择<code>GDEMV2 30M 分辨率数字高程数据</code></p><p><img src="/img/dem/3.png"></p></blockquote><h2 id="高程数据切片"><a href="#高程数据切片" class="headerlink" title="高程数据切片"></a>高程数据切片</h2><p>cesium使用格式是 <code>terrain</code>，必须用工具切片。</p><p>使用 <code>cesiumlab</code> 工具来切片 web端的，官网地址 <code>http://www.cesiumlab.com/</code> ，下载安装。</p><p><img src="/img/dem/1.png"></p><p><img src="/img/dem/2.png"></p><h2 id="搭建高程数据服务"><a href="#搭建高程数据服务" class="headerlink" title="搭建高程数据服务"></a>搭建高程数据服务</h2><p>使用<code>nginx</code>代理，</p><p><code>docker-compose.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3&quot;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">3dtiles:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">3dtiles</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">10000</span><span class="hljs-string">:80</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./conf.d:/etc/nginx/conf.d</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./data:/data</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br></code></pre></td></tr></table></figure><p><code>conf.d/default.conf</code></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">server</span> &#123;<br>    <span class="hljs-keyword">listen</span>       <span class="hljs-number">80</span>;<br>    server_name  localhost;<br><br>    #access_log  /var/<span class="hljs-keyword">log</span>/nginx/host.<span class="hljs-keyword">access</span>.<span class="hljs-keyword">log</span>  main;<br>    <br>    <span class="hljs-keyword">location</span> / &#123;<br>        root   /data;<br>        <span class="hljs-keyword">index</span>  <span class="hljs-keyword">index</span>.html <span class="hljs-keyword">index</span>.htm;<br>        add_header <span class="hljs-string">&#x27;Access-Control-Allow-Origin&#x27;</span> <span class="hljs-string">&#x27;*&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>切好片的数据放在 <code>/data/dem</code> 下</p><h2 id="cesium-使用"><a href="#cesium-使用" class="headerlink" title="cesium 使用"></a>cesium 使用</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Viewer</span>(<span class="hljs-string">&quot;cesiumContainer&quot;</span>, &#123;<br>  <span class="hljs-attr">geocoder</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">homeButton</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">sceneModePicker</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">baseLayerPicker</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">navigationHelpButton</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">animation</span>: <span class="hljs-literal">false</span>, <br>  <span class="hljs-attr">creditContainer</span>: <span class="hljs-string">&quot;cesiumContainer&quot;</span>,<br>  <span class="hljs-attr">timeline</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">fullscreenButton</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">vrButton</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-comment">// 加载高程数据</span><br>  <span class="hljs-attr">terrainProvider</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">CesiumTerrainProvider</span>(&#123;<br>    <span class="hljs-attr">url</span>: <span class="hljs-string">&quot;http://172.16.100.92:10000/dem&quot;</span>,<br>    <span class="hljs-attr">requestVertexNormals</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 请求照明</span><br>    <span class="hljs-attr">requestWaterMask</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 请求水波纹效果</span><br>  &#125;),<br>&#125;);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>cesium</category>
      
    </categories>
    
    
    <tags>
      
      <tag>cesium</tag>
      
      <tag>GIS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>gdal</title>
    <link href="/wiki/2022/04/20/cesium/gdal/"/>
    <url>/wiki/2022/04/20/cesium/gdal/</url>
    
    <content type="html"><![CDATA[<h2 id="dal-合并tif文件"><a href="#dal-合并tif文件" class="headerlink" title="dal 合并tif文件"></a>dal 合并tif文件</h2><p><code>gdal_merge.py -o o1.tif ASTGTMV003_N40E115_num.tif ASTGTMV003_N40E115_dem.tif</code></p><p>num.tif 结尾的在前面</p>]]></content>
    
    
    <categories>
      
      <category>cesium</category>
      
    </categories>
    
    
    <tags>
      
      <tag>cesium</tag>
      
      <tag>GIS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>geoserver</title>
    <link href="/wiki/2022/04/20/cesium/geoserver/"/>
    <url>/wiki/2022/04/20/cesium/geoserver/</url>
    
    <content type="html"><![CDATA[<h2 id="下载geoserver安装包"><a href="#下载geoserver安装包" class="headerlink" title="下载geoserver安装包"></a>下载geoserver安装包</h2><p><code>http://geoserver.org/</code></p><h2 id="安装geoserver"><a href="#安装geoserver" class="headerlink" title="安装geoserver"></a>安装geoserver</h2><h3 id="解压文件"><a href="#解压文件" class="headerlink" title="解压文件"></a>解压文件</h3><p><img src="/img/cesium/1.png"></p><h3 id="修改启动端口"><a href="#修改启动端口" class="headerlink" title="修改启动端口"></a>修改启动端口</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">vim start.ini</span><br>jetty.http.port=9999<br></code></pre></td></tr></table></figure><h3 id="启动服务-停止服务"><a href="#启动服务-停止服务" class="headerlink" title="启动服务,停止服务"></a>启动服务,停止服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> bin</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动服务</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sh ./startup.sh</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">停止服务</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sh ./shutdown.sh</span><br></code></pre></td></tr></table></figure><p>web页面默认登录用户名密码 <code>admin/geoserver</code></p><h3 id="登录web"><a href="#登录web" class="headerlink" title="登录web"></a>登录web</h3><p><img src="/img/cesium/2.png"></p><h2 id="添加地图瓦片服务"><a href="#添加地图瓦片服务" class="headerlink" title="添加地图瓦片服务"></a>添加地图瓦片服务</h2><h3 id="添加工作区"><a href="#添加工作区" class="headerlink" title="添加工作区"></a>添加工作区</h3><p><img src="/img/cesium/3.png"></p><p><img src="/img/cesium/4.png"></p><h3 id="添加数据存储，TIF格式"><a href="#添加数据存储，TIF格式" class="headerlink" title="添加数据存储，TIF格式"></a>添加数据存储，TIF格式</h3><p><img src="/img/cesium/5.png"></p><p><img src="/img/cesium/6.png"></p><p><img src="/img/cesium/7.png"></p><p><img src="/img/cesium/8.png"></p><p><img src="/img/cesium/9.png"></p><h3 id="数据切片"><a href="#数据切片" class="headerlink" title="数据切片"></a>数据切片</h3><p><img src="/img/cesium/10.png"></p><p><img src="/img/cesium/11.png"></p><p>切片完的缓存数据目录：<code>/soyuan/geoserver/data_dir/gwc/zps_1</code></p><p>下载个级别的tif 切片完，统一放到一个级别下面</p>]]></content>
    
    
    <categories>
      
      <category>cesium</category>
      
    </categories>
    
    
    <tags>
      
      <tag>cesium</tag>
      
      <tag>GIS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>发布3dtiles</title>
    <link href="/wiki/2022/04/20/cesium/%E5%8F%91%E5%B8%833dtiles/"/>
    <url>/wiki/2022/04/20/cesium/%E5%8F%91%E5%B8%833dtiles/</url>
    
    <content type="html"><![CDATA[<h2 id="nginx-发布三维数据服务，地形数据"><a href="#nginx-发布三维数据服务，地形数据" class="headerlink" title="nginx 发布三维数据服务，地形数据"></a>nginx 发布三维数据服务，地形数据</h2><p><code>docker-compose.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3&quot;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">3dtiles:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">3dtiles</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">10000</span><span class="hljs-string">:80</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./conf.d:/etc/nginx/conf.d</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./data:/data</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>  <span class="hljs-attr">cesiumweb:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">cesiumweb</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">10001</span><span class="hljs-string">:80</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./webconf.d:/etc/nginx/conf.d</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./webdata:/data</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>  <br></code></pre></td></tr></table></figure><p><code>default.conf</code></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">server</span> &#123;<br>    <span class="hljs-keyword">listen</span>       <span class="hljs-number">80</span>;<br>    server_name  localhost;<br><br>    #access_log  /var/<span class="hljs-keyword">log</span>/nginx/host.<span class="hljs-keyword">access</span>.<span class="hljs-keyword">log</span>  main;<br>   <br>    <span class="hljs-keyword">location</span> / &#123;<br>        root   /data;<br>        <span class="hljs-keyword">index</span>  <span class="hljs-keyword">index</span>.html <span class="hljs-keyword">index</span>.htm;<br>        add_header <span class="hljs-string">&#x27;Access-Control-Allow-Origin&#x27;</span> <span class="hljs-string">&#x27;*&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>web.conf</code></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">server</span> &#123;<br>    <span class="hljs-keyword">listen</span>       <span class="hljs-number">80</span>;<br>    server_name  localhost;<br><br>    #access_log  /var/<span class="hljs-keyword">log</span>/nginx/host.<span class="hljs-keyword">access</span>.<span class="hljs-keyword">log</span>  main;<br>   <br>    <span class="hljs-keyword">location</span> / &#123;<br>        root   /data;<br>        <span class="hljs-keyword">index</span>  <span class="hljs-keyword">index</span>.html <span class="hljs-keyword">index</span>.htm; <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><a href="http://mars3d.cn/dev/guide/data/server.html#_2-%E4%B8%89%E7%BB%B4%E6%95%B0%E6%8D%AE%E5%8F%91%E5%B8%83">http://mars3d.cn/dev/guide/data/server.html#_2-%E4%B8%89%E7%BB%B4%E6%95%B0%E6%8D%AE%E5%8F%91%E5%B8%83</a></p>]]></content>
    
    
    <categories>
      
      <category>cesium</category>
      
    </categories>
    
    
    <tags>
      
      <tag>cesium</tag>
      
      <tag>GIS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>路线规划graphhopper</title>
    <link href="/wiki/2022/04/20/cesium/%E8%B7%AF%E7%BA%BF%E8%A7%84%E5%88%92graphhopper/"/>
    <url>/wiki/2022/04/20/cesium/%E8%B7%AF%E7%BA%BF%E8%A7%84%E5%88%92graphhopper/</url>
    
    <content type="html"><![CDATA[<h2 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h2><h3 id="下载graphhopper"><a href="#下载graphhopper" class="headerlink" title="下载graphhopper"></a>下载graphhopper</h3><p>官网地址 <code>https://graphhopper.com</code></p><p>github 地址 <code>https://github.com/graphhopper/graphhopper</code>，可以下载自己编译；</p><p>直接下载releases版本 <code>https://github.com/graphhopper/graphhopper/releases</code> , 下载<code>jar</code>包，和 <code>config-example.yml</code> 文件</p><h3 id="下载路网数据"><a href="#下载路网数据" class="headerlink" title="下载路网数据"></a>下载路网数据</h3><p><code>http://download.geofabrik.de/asia.html</code></p><p>选择 <code>asia</code> <code>china</code> <code>下载pbf文件</code></p><h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">修改启动的ip</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">vi config-example.yml</span><br>     bind_host: 172.16.100.92<br></code></pre></td></tr></table></figure><h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">java -Xmx2g -Xms2g -Ddw.graphhopper.datareader.file=china-latest.osm.pbf -jar graphhopper-web-5.0.jar server config-example.yml</span><br></code></pre></td></tr></table></figure><h3 id="调用服务规划路线"><a href="#调用服务规划路线" class="headerlink" title="调用服务规划路线"></a>调用服务规划路线</h3><p><a href="http://172.16.100.92:8989/route?point=36.441659,117.100956&amp;point=39.733715,116.181885&amp;type=json&amp;locale=zh-CN&amp;vehicle=car&amp;weighting=fastest&amp;points_encoded=false">http://172.16.100.92:8989/route?point=36.441659,117.100956&amp;point=39.733715,116.181885&amp;type=json&amp;locale=zh-CN&amp;vehicle=car&amp;weighting=fastest&amp;points_encoded=false</a></p><h3 id="官网demo"><a href="#官网demo" class="headerlink" title="官网demo"></a>官网demo</h3><p><a href="https://graphhopper.com/maps/?point=%E5%8D%97%E9%83%A8%E5%B1%B1%E5%8C%BA,%20250100,%20Jinan%20City,%20China&amp;point=%E4%BA%AC%E6%8A%95%E4%B8%87%E7%A7%91%E6%96%B0%E9%87%8C%E7%A8%8B-%E5%8C%97%E5%8C%BA,%20Fangshan%20District,%20China&amp;locale=zh-CN&amp;elevation=true&amp;profile=car&amp;use_miles=false&amp;selected_detail=Elevation&amp;layer=Omniscale">https://graphhopper.com/maps/?point=%E5%8D%97%E9%83%A8%E5%B1%B1%E5%8C%BA%2C%20250100%2C%20Jinan%20City%2C%20China&amp;point=%E4%BA%AC%E6%8A%95%E4%B8%87%E7%A7%91%E6%96%B0%E9%87%8C%E7%A8%8B-%E5%8C%97%E5%8C%BA%2C%20Fangshan%20District%2C%20China&amp;locale=zh-CN&amp;elevation=true&amp;profile=car&amp;use_miles=false&amp;selected_detail=Elevation&amp;layer=Omniscale</a></p><h3 id="提示信息sign"><a href="#提示信息sign" class="headerlink" title="提示信息sign"></a>提示信息sign</h3><table><thead><tr><th align="left">sign</th><th align="left">description</th></tr></thead><tbody><tr><td align="left">-98</td><td align="left">an U-turn without the knowledge if it is a right or left U-turn</td></tr><tr><td align="left">-8</td><td align="left">a left U-turn</td></tr><tr><td align="left">-7</td><td align="left">keep left</td></tr><tr><td align="left">-6</td><td align="left"><strong>not yet used</strong>: leave roundabout</td></tr><tr><td align="left">-3</td><td align="left">turn sharp left</td></tr><tr><td align="left">-2</td><td align="left">turn left</td></tr><tr><td align="left">-1</td><td align="left">turn slight left</td></tr><tr><td align="left">0</td><td align="left">continue on street</td></tr><tr><td align="left">1</td><td align="left">turn slight right</td></tr><tr><td align="left">2</td><td align="left">turn right</td></tr><tr><td align="left">3</td><td align="left">turn sharp right</td></tr><tr><td align="left">4</td><td align="left">the finish instruction before the last point</td></tr><tr><td align="left">5</td><td align="left">the instruction before a via point</td></tr><tr><td align="left">6</td><td align="left">the instruction before entering a roundabout</td></tr><tr><td align="left">7</td><td align="left">keep right</td></tr><tr><td align="left">8</td><td align="left">a right U-turn</td></tr><tr><td align="left">*</td><td align="left"><strong>For future compatibility</strong> it is important that all clients are able to handle also unknown instruction sign numbers</td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>cesium</category>
      
    </categories>
    
    
    <tags>
      
      <tag>cesium</tag>
      
      <tag>GIS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>js发布订阅模式</title>
    <link href="/wiki/2022/03/21/js/js%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F/"/>
    <url>/wiki/2022/03/21/js/js%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">var</span> msgHandler = &#123;&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 消息队列</span><br><span class="hljs-comment"> */</span><br>msgHandler.<span class="hljs-property">msgQueue</span> = &#123;&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 订阅消息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">消息类型</span>&#125; eventType </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">回调方法</span>&#125; handler </span><br><span class="hljs-comment"> */</span><br>msgHandler.<span class="hljs-property">on</span> = <span class="hljs-function">(<span class="hljs-params">eventType, handler</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (!(eventType <span class="hljs-keyword">in</span> msgHandler.<span class="hljs-property">msgQueue</span>)) &#123;<br>        msgHandler.<span class="hljs-property">msgQueue</span>[eventType] = [];<br>    &#125;<br><br>    msgHandler.<span class="hljs-property">msgQueue</span>[eventType].<span class="hljs-title function_">push</span>(handler);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 订阅</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">消息类型</span>&#125;&#125; eventType </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">数据</span>&#125; data </span><br><span class="hljs-comment"> */</span><br>msgHandler.<span class="hljs-property">emit</span> = <span class="hljs-function">(<span class="hljs-params">eventType, data</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; msgHandler.<span class="hljs-property">msgQueue</span>[eventType] &amp;&amp; i &lt; msgHandler.<span class="hljs-property">msgQueue</span>[eventType].<span class="hljs-property">length</span>; i++) &#123;<br>        msgHandler.<span class="hljs-property">msgQueue</span>[eventType][i].<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, data);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">消息类型</span>&#125;&#125; eventType </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">回调方法</span>&#125; handler </span><br><span class="hljs-comment"> */</span><br>msgHandler.<span class="hljs-property">off</span> = <span class="hljs-function">(<span class="hljs-params">eventType, handler</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">var</span> currentEvent = msgHandler.<span class="hljs-property">msgQueue</span>[eventType];<br>    <span class="hljs-keyword">var</span> len = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (currentEvent) &#123;<br>        len = currentEvent.<span class="hljs-property">length</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = len - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) &#123;<br>            <span class="hljs-keyword">if</span> (currentEvent[i] === handler) &#123;<br>                currentEvent.<span class="hljs-title function_">splice</span>(i, <span class="hljs-number">1</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>js</category>
      
    </categories>
    
    
    <tags>
      
      <tag>js</tag>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>free-fs</title>
    <link href="/wiki/2022/03/02/k8s/free-fs/"/>
    <url>/wiki/2022/03/02/k8s/free-fs/</url>
    
    <content type="html"><![CDATA[<h3 id="服务器规划"><a href="#服务器规划" class="headerlink" title="服务器规划"></a>服务器规划</h3><table><thead><tr><th>服务器</th><th>域名</th><th>备注</th></tr></thead><tbody><tr><td>172.16.100.225</td><td></td><td></td></tr></tbody></table><h3 id="源码编译"><a href="#源码编译" class="headerlink" title="源码编译"></a>源码编译</h3><h4 id="源码链接"><a href="#源码链接" class="headerlink" title="源码链接"></a>源码链接</h4><ul><li>Gitee：<a href="https://gitee.com/dh_free/free-fs">https://gitee.com/dh_free/free-fs</a></li><li>Github：<a href="https://github.com/dh-free/free-fs">https://github.com/dh-free/free-fs</a></li></ul><h4 id="代码修改代码地址"><a href="#代码修改代码地址" class="headerlink" title="代码修改代码地址"></a>代码修改代码地址</h4><p><code>https://gitee.com/soyuangit/free-fs/tree/master</code></p><h3 id="k8s"><a href="#k8s" class="headerlink" title="k8s"></a><code>k8s</code></h3><p><code>free-fs.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>    <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">free-fs</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">free-fs</span><br><span class="hljs-attr">spec:</span><br>    <span class="hljs-attr">serviceName:</span> <span class="hljs-string">free-fs</span><br>    <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>    <span class="hljs-attr">selector:</span><br>        <span class="hljs-attr">matchLabels:</span><br>            <span class="hljs-attr">app:</span> <span class="hljs-string">free-fs</span><br>    <span class="hljs-attr">template:</span><br>        <span class="hljs-attr">metadata:</span><br>            <span class="hljs-attr">labels:</span> <br>                <span class="hljs-attr">app:</span> <span class="hljs-string">free-fs</span><br>        <span class="hljs-attr">spec:</span><br>            <span class="hljs-attr">nodeSelector:</span> <br>                <span class="hljs-attr">type:</span> <span class="hljs-string">free-fs</span><br>            <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span><br>            <span class="hljs-attr">containers:</span><br>                <span class="hljs-comment"># mysql</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">mysql</span><br>                  <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:5.7</span><br>                  <span class="hljs-attr">volumeMounts:</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/lib/mysql</span><br>                      <span class="hljs-attr">name:</span> <span class="hljs-string">mysql-volume</span><br>                  <span class="hljs-attr">env:</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">MYSQL_ROOT_PASSWORD</span><br>                      <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;soyuan.123&quot;</span><br>                <span class="hljs-comment"># free-fs server</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">server</span><br>                  <span class="hljs-attr">image:</span> <span class="hljs-string">java:8</span><br>                  <span class="hljs-attr">volumeMounts:</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/svc</span><br>                      <span class="hljs-attr">name:</span> <span class="hljs-string">fs-server-volume</span><br>                  <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;/bin/sh&quot;</span>,<span class="hljs-string">&quot;-c&quot;</span>,<span class="hljs-string">&quot;cd /svc &amp;&amp; java -Djava.security.egd=file:/dev/./urandom -Duser.timezone=GMT+08 -jar app.jar&quot;</span>]<br>                <span class="hljs-comment"># nginx</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>                  <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>                  <span class="hljs-attr">volumeMounts:</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/usr/share/nginx/html</span><br>                      <span class="hljs-attr">name:</span> <span class="hljs-string">fs-server-volume</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/nginx/conf.d</span><br>                      <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-conf-volume</span> <br>                    <span class="hljs-comment"># 启动命令</span><br>                  <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;/bin/sh&quot;</span>,<span class="hljs-string">&quot;-c&quot;</span>,<span class="hljs-string">&quot;chown -R nginx /usr/share/nginx/html/file &amp;&amp; /usr/sbin/nginx -g &#x27;daemon off;&#x27;&quot;</span>]  <br>            <span class="hljs-attr">volumes:</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">mysql-volume</span><br>                  <span class="hljs-attr">hostPath:</span><br>                    <span class="hljs-comment"># directory location on host</span><br>                    <span class="hljs-attr">path:</span> <span class="hljs-string">/free-fs-data/mysql</span><br>                    <span class="hljs-comment"># this field is optional</span><br>                    <span class="hljs-attr">type:</span> <span class="hljs-string">Directory</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">fs-server-volume</span><br>                  <span class="hljs-attr">hostPath:</span><br>                    <span class="hljs-comment"># directory location on host</span><br>                    <span class="hljs-attr">path:</span> <span class="hljs-string">/free-fs-data/server</span><br>                    <span class="hljs-comment"># this field is optional</span><br>                    <span class="hljs-attr">type:</span> <span class="hljs-string">Directory</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-conf-volume</span><br>                  <span class="hljs-attr">hostPath:</span><br>                    <span class="hljs-comment"># directory location on host</span><br>                    <span class="hljs-attr">path:</span> <span class="hljs-string">/free-fs-data/nginx/conf</span><br>                    <span class="hljs-comment"># this field is optional</span><br>                    <span class="hljs-attr">type:</span> <span class="hljs-string">Directory</span><br></code></pre></td></tr></table></figure><h4 id="nginx-配置文件"><a href="#nginx-配置文件" class="headerlink" title="nginx 配置文件"></a>nginx 配置文件</h4><p><code>default.conf</code></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs awk">server &#123;<br>    listen       <span class="hljs-number">8000</span>;<br>    server_name  localhost;<br><br>    <span class="hljs-comment">#access_log  /var/log/nginx/host.access.log  main;</span><br><br>    location / &#123;<br>        root   <span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/nginx/</span>html/file;<br>    &#125;<br><br>    <span class="hljs-comment">#error_page  404              /404.html;</span><br><br>    <span class="hljs-comment"># redirect server error pages to the static page /50x.html</span><br>    <span class="hljs-comment">#</span><br>    error_page   <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span>  /<span class="hljs-number">50</span>x.html;<br>    location = /<span class="hljs-number">50</span>x.html &#123;<br>        root   <span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/nginx/</span>html;<br>    &#125; <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="node设置labels"><a href="#node设置labels" class="headerlink" title="node设置labels"></a>node设置labels</h4><p><code>kubectl label nodes 172.16.100.225 type=free-fs</code></p><h4 id="重启statefulsets"><a href="#重启statefulsets" class="headerlink" title="重启statefulsets"></a>重启statefulsets</h4><p><code>kubectl rollout restart statefulsets free-fs</code></p><h4 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">mysql 目录</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> -p /free-fs-data/mysql</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">chmod</span> 777 /free-fs-data/mysql</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">server 目录程序，jar包和配置文件，和文件缓存目录</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> -p /free-fs-data/server</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">nginx 反向代理目录，配置文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> -p /free-fs-data/nginx/conf</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>android studio use lombok</title>
    <link href="/wiki/2022/02/21/android/android%20studio%20use%20lombok/"/>
    <url>/wiki/2022/02/21/android/android%20studio%20use%20lombok/</url>
    
    <content type="html"><![CDATA[<h3 id="gradle-配置lombok"><a href="#gradle-配置lombok" class="headerlink" title="gradle 配置lombok"></a>gradle 配置lombok</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// https://mvnrepository.com/artifact/org.projectlombok/lombok</span><br>implementation &#x27;org.projectlombok<span class="hljs-punctuation">:</span>lombok<span class="hljs-punctuation">:</span><span class="hljs-number">1.18</span><span class="hljs-number">.22</span>&#x27;<br>annotationProcessor &#x27;org.projectlombok<span class="hljs-punctuation">:</span>lombok<span class="hljs-punctuation">:</span><span class="hljs-number">1.18</span><span class="hljs-number">.22</span>&#x27;<br></code></pre></td></tr></table></figure><p>完整配置文件 <code>build.gradle</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs json">plugins <span class="hljs-punctuation">&#123;</span><br>    id &#x27;com.android.application&#x27;<br><span class="hljs-punctuation">&#125;</span><br><br>android <span class="hljs-punctuation">&#123;</span><br>    compileSdk <span class="hljs-number">32</span><br><br>    defaultConfig <span class="hljs-punctuation">&#123;</span><br>        applicationId <span class="hljs-string">&quot;com.example.listviewchat&quot;</span><br>        minSdk <span class="hljs-number">22</span><br>        targetSdk <span class="hljs-number">32</span><br>        versionCode <span class="hljs-number">1</span><br>        versionName <span class="hljs-string">&quot;1.0&quot;</span><br><br>        testInstrumentationRunner <span class="hljs-string">&quot;androidx.test.runner.AndroidJUnitRunner&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br><br>    buildTypes <span class="hljs-punctuation">&#123;</span><br>        release <span class="hljs-punctuation">&#123;</span><br>            minifyEnabled <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>            proguardFiles getDefaultProguardFile(&#x27;proguard-android-optimize.txt&#x27;)<span class="hljs-punctuation">,</span> &#x27;proguard-rules.pro&#x27;<br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>    compileOptions <span class="hljs-punctuation">&#123;</span><br>        sourceCompatibility JavaVersion.VERSION_1_8<br>        targetCompatibility JavaVersion.VERSION_1_8<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br>dependencies <span class="hljs-punctuation">&#123;</span><br><br>    implementation &#x27;androidx.appcompat<span class="hljs-punctuation">:</span>appcompat<span class="hljs-punctuation">:</span><span class="hljs-number">1.4</span><span class="hljs-number">.1</span>&#x27;<br>    implementation &#x27;com.google.android.material<span class="hljs-punctuation">:</span>material<span class="hljs-punctuation">:</span><span class="hljs-number">1.5</span><span class="hljs-number">.0</span>&#x27;<br>    implementation &#x27;androidx.constraintlayout<span class="hljs-punctuation">:</span>constraintlayout<span class="hljs-punctuation">:</span><span class="hljs-number">2.1</span><span class="hljs-number">.3</span>&#x27;<br>    testImplementation &#x27;junit<span class="hljs-punctuation">:</span>junit<span class="hljs-punctuation">:</span><span class="hljs-number">4.13</span><span class="hljs-number">.2</span>&#x27;<br>    <span class="hljs-comment">// https://mvnrepository.com/artifact/org.projectlombok/lombok</span><br>    implementation &#x27;org.projectlombok<span class="hljs-punctuation">:</span>lombok<span class="hljs-punctuation">:</span><span class="hljs-number">1.18</span><span class="hljs-number">.22</span>&#x27;<br>    annotationProcessor &#x27;org.projectlombok<span class="hljs-punctuation">:</span>lombok<span class="hljs-punctuation">:</span><span class="hljs-number">1.18</span><span class="hljs-number">.22</span>&#x27;<br>    androidTestImplementation &#x27;androidx.test.ext<span class="hljs-punctuation">:</span>junit<span class="hljs-punctuation">:</span><span class="hljs-number">1.1</span><span class="hljs-number">.3</span>&#x27;<br>    androidTestImplementation &#x27;androidx.test.espresso<span class="hljs-punctuation">:</span>espresso-core<span class="hljs-punctuation">:</span><span class="hljs-number">3.4</span><span class="hljs-number">.0</span>&#x27;<br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h3 id="lombok-插件下载"><a href="#lombok-插件下载" class="headerlink" title="lombok 插件下载"></a>lombok 插件下载</h3><p><code>ide</code> 插件下载地址 <code>https://plugins.jetbrains.com/</code></p><p><code>lombok</code> 插件下载地址 <code>https://plugins.jetbrains.com/plugin/6317-lombok</code></p><h4 id="use"><a href="#use" class="headerlink" title="use"></a>use</h4><ul><li>download .zip file</li><li>unpack to android-studio/plugins/</li><li>restart IDE</li></ul><p>解压出来放到 <code>android studio</code> 根目录的 <code>plugins</code> 下</p><p><code>D:\Program Files\Android\Android Studio\plugins</code></p>]]></content>
    
    
    <categories>
      
      <category>android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>android</tag>
      
      <tag>配置</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>gradle配置</title>
    <link href="/wiki/2022/02/21/android/gradle%E9%85%8D%E7%BD%AE/"/>
    <url>/wiki/2022/02/21/android/gradle%E9%85%8D%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<p>Gradle 配置阿里仓库镜像</p><p><code>settings.gradle</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs json">pluginManagement <span class="hljs-punctuation">&#123;</span><br>    repositories <span class="hljs-punctuation">&#123;</span><br>        gradlePluginPortal()<br>        google()<br>        mavenCentral()<br>        maven <span class="hljs-punctuation">&#123;</span><br>            url &#x27;https<span class="hljs-punctuation">:</span><span class="hljs-comment">//maven.aliyun.com/repository/public/&#x27;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br>dependencyResolutionManagement <span class="hljs-punctuation">&#123;</span><br>    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)<br>    repositories <span class="hljs-punctuation">&#123;</span><br>        google()<br>        mavenCentral()<br>        maven <span class="hljs-punctuation">&#123;</span><br>            url &#x27;https<span class="hljs-punctuation">:</span><span class="hljs-comment">//maven.aliyun.com/repository/public/&#x27;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br>rootProject.name = <span class="hljs-string">&quot;webrtctest&quot;</span><br>include &#x27;<span class="hljs-punctuation">:</span>app&#x27;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>android</tag>
      
      <tag>配置</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>cloud9-docker</title>
    <link href="/wiki/2022/01/26/cloud9%20Ide/cloud9-docker/"/>
    <url>/wiki/2022/01/26/cloud9%20Ide/cloud9-docker/</url>
    
    <content type="html"><![CDATA[<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3.0&quot;</span><br><span class="hljs-attr">services:</span><br>    <span class="hljs-attr">code:</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">node:17</span><br>      <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span><br>      <span class="hljs-attr">container_name:</span> <span class="hljs-string">code</span><br>      <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8888:8080&quot;</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">./smart_construction:/smart_construction</span><br>      <span class="hljs-attr">working_dir:</span> <span class="hljs-string">/smart_construction/sc-front</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">/bin/bash</span> <span class="hljs-string">-c</span> <span class="hljs-string">&quot; while true; do sleep 1; done&quot;</span><br>    <span class="hljs-attr">cloud9:</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">sapk/cloud9</span><br>      <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span><br>      <span class="hljs-attr">container_name:</span> <span class="hljs-string">cloud9</span><br>      <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8181:8181&quot;</span>     <br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">./smart_construction:/workspace</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">--auth</span> <span class="hljs-string">admin:abc123</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>cloud9-docker Ide</category>
      
    </categories>
    
    
    <tags>
      
      <tag>cloud9-docker</tag>
      
      <tag>工具</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>cloud9</title>
    <link href="/wiki/2022/01/26/cloud9%20Ide/cloud9/"/>
    <url>/wiki/2022/01/26/cloud9%20Ide/cloud9/</url>
    
    <content type="html"><![CDATA[<p>idoc 打包docker镜像</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> node<br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /code</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> npm install idoc -g</span><br><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"> idoc -w</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-ide-config</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">default.conf :</span> <span class="hljs-string">|</span><br><span class="hljs-string">            server &#123;</span><br><span class="hljs-string">                listen       80;</span><br><span class="hljs-string">                listen  [::]:80;</span><br><span class="hljs-string">                server_name  localhost;</span><br><span class="hljs-string"></span><br>                <span class="hljs-comment">#access_log  /var/log/nginx/host.access.log  main;</span><br><br>                <span class="hljs-string">location</span> <span class="hljs-string">/</span> &#123;<br>                    <span class="hljs-string">root</span>   <span class="hljs-string">/usr/share/nginx/html;</span><br>                    <span class="hljs-string">index</span>  <span class="hljs-string">index.html</span> <span class="hljs-string">index.htm;</span><br>                &#125; <br>              <span class="hljs-string">&#125;</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-ide</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">cloud-ide</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">&quot;cloud-ide&quot;</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">cloud-ide</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">nodeSelector:</span> <br>        <span class="hljs-attr">type:</span> <span class="hljs-string">public</span>    <br>      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cloud</span>    <span class="hljs-comment"># cloud 9</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">sapk/cloud9:latest</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8181</span> <br>          <span class="hljs-attr">name:</span> <span class="hljs-string">ide</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cloud</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/workspace</span><br>        <span class="hljs-attr">args:</span> [<span class="hljs-string">&#x27;-a :&#x27;</span>]<br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">idoc</span>      <span class="hljs-comment"># makedown 生成器</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">myidoc:latest</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span> <br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cloud</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/code</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:latest</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">ports:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>            <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cloud</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/usr/share/nginx/html</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-ide-config</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/nginx/conf.d/</span> <br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-ide-config</span><br>        <span class="hljs-attr">configMap:</span> <br>          <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-ide-config</span> <br>  <span class="hljs-attr">volumeClaimTemplates:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">cloud</span><br>      <span class="hljs-attr">annotations:</span><br>        <span class="hljs-attr">volume.beta.kubernetes.io/storage-class:</span> <span class="hljs-string">test-nfs-storage</span>   <span class="hljs-comment"># 指明storageclass的名称</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">accessModes:</span> [ <span class="hljs-string">&quot;ReadWriteOnce&quot;</span> ]<br>      <span class="hljs-attr">resources:</span><br>        <span class="hljs-attr">requests:</span><br>          <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-svc</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">cloud-ide</span><br><span class="hljs-attr">spec:</span>  <br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cloud</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">8181</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8181</span> <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">web</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span> <br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">cloud-ide</span><br><br><br><span class="hljs-meta">--- </span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">extensions/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-ingress</span>        <span class="hljs-comment">#自定义ingress名称</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">doc.spzl</span>     <span class="hljs-comment"># 自定义域名</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>        <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">cloud-svc</span>  <span class="hljs-comment"># 对应上面创建的service名称</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">8181</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">doc.spzl.web</span>     <span class="hljs-comment"># 自定义域名</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>        <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">cloud-svc</span>  <span class="hljs-comment"># 对应上面创建的service名称</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure><p><code>-a username:password</code>  指定用户名密码</p><p><code>-a</code> : 强制不登录</p>]]></content>
    
    
    <categories>
      
      <category>cloud9 Ide</category>
      
    </categories>
    
    
    <tags>
      
      <tag>工具</tag>
      
      <tag>cloud9</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>StackEdit</title>
    <link href="/wiki/2022/01/26/idoc/idoc%20%E5%8A%A8%E6%80%81%E6%A3%80%E6%B5%8B%E6%96%87%E4%BB%B6%E5%8F%98%E5%8C%96/"/>
    <url>/wiki/2022/01/26/idoc/idoc%20%E5%8A%A8%E6%80%81%E6%A3%80%E6%B5%8B%E6%96%87%E4%BB%B6%E5%8F%98%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<p><code>dockerfile</code></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> node<br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /code</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> npm install idoc -g</span><br><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"> idoc -w</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>StackEdit</category>
      
    </categories>
    
    
    <tags>
      
      <tag>工具</tag>
      
      <tag>StackEdit</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>go dlv 远程调试</title>
    <link href="/wiki/2021/12/22/go/go%20dlv%20%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95/"/>
    <url>/wiki/2021/12/22/go/go%20dlv%20%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95/</url>
    
    <content type="html"><![CDATA[<h3 id="远程机器安装dlv"><a href="#远程机器安装dlv" class="headerlink" title="远程机器安装dlv"></a>远程机器安装dlv</h3><h4 id="配置go代理"><a href="#配置go代理" class="headerlink" title="配置go代理"></a>配置go代理</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">export GO111MODULE=on<br>export GOPROXY=https://goproxy.cn<br></code></pre></td></tr></table></figure><h4 id="安装dlv"><a href="#安装dlv" class="headerlink" title="安装dlv"></a>安装dlv</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">go get github.com/go-delve/delve/cmd/dlv<br>dlv version<br></code></pre></td></tr></table></figure><h3 id="命令介绍"><a href="#命令介绍" class="headerlink" title="命令介绍"></a>命令介绍</h3><blockquote><p>Delve时Go程序的源代码级的调试器。</p><p>Delve通过控制进程的执行、评估变量以及提供线程/ goroutine状态、CPU寄存器状态等信息，使你能够与程序进行交互。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs shell">使用“--”将标志传递给正在调试的程序，例如:<br><br>`dlv exec ./hello -- server --config conf/config.toml`<br><br>Usage:<br>  dlv [command]<br><br>Available Commands:<br>  attach      连接到正在运行的进程并开始调试.<br>  connect     连接到无头调试服务器.<br>  core        检查核心转储.<br>  debug       编译并开始调试当前目录下的主包或指定的包.<br>  exec        执行预编译的二进制文件，并开始调试会话.<br>  help        帮助信息<br>  run         弃用的命令。使用“debug”替代它.<br>  test        编译测试二进制文件并开始调试程序.<br>  trace       编译并开始跟踪程序.<br>  version     打印版本.<br><br>Flags:<br>      --accept-multiclient   允许无头服务器接受多个客户机连接。注意，服务器API不是可重入的，客户端必须协调.<br>      --api-version int      无头时选择API版本. (default 1)<br>      --backend string       后端选择:<br>            default        在macOS上使用lldb，其他地方都是本地的.<br>            native        本地后端.<br>            lldb        使用lldb-server或debugserver.<br>            rr            使用mozilla rr (https://github.com/mozilla/rr).<br>         (default &quot;default&quot;) 默认使用的是default<br>      --build-flags string   生成标志，以传递给编译器.<br>      --headless             仅在headless模式下运行调试服务器.<br>      --init string          初始化文件，由终端客户端执行.<br>  -l, --listen string        调试服务器监听地址. (default &quot;localhost:0&quot;)<br>      --log                  启用调试服务器日志记录.<br>      --log-output string    应该产生调试输出的组件的逗号分隔列表，可能的值为:<br>            debugger    记录调试器命令<br>            gdbwire        日志连接到gdbserial后端<br>            lldbout        将输出从debugserver/lldb复制到标准输出<br>            debuglineerr    读取.debug_line时日志可恢复错误<br>            rpc            记录所有RPC消息<br>            fncall        日志函数调用协议<br>            minidump    日志minidump加载<br>            使用--log启用日志时，默认为“debugger”.<br>      --wd string            用于运行程序的工作目录. (default &quot;.&quot;)<br><br>使用&quot;dlv [command] --help&quot;获取有关命令的详细信息.<br></code></pre></td></tr></table></figure><h3 id="远程机器启动调试进程"><a href="#远程机器启动调试进程" class="headerlink" title="远程机器启动调试进程"></a>远程机器启动调试进程</h3><p><code>到源代码所在的目录</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">dlv debug --headless --listen &quot;:2345&quot; --log --api-version 2<br></code></pre></td></tr></table></figure><p><code>--headless指定只使用调试服务模式，</code><br><code>--listen指定了调试服务的端口，要与vscode的配置一致。</code><br><code>--log启用了调试日志输出，可关闭。</code><br><code>--api-version 2选择调试api的版本，这里必须指定为2，否则不能调试</code><br><code>-- 双减号加空格后填写程序启动的参数</code></p><h3 id="本地vscode-远程调试设置"><a href="#本地vscode-远程调试设置" class="headerlink" title="本地vscode 远程调试设置"></a>本地vscode 远程调试设置</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-comment">// 使用 IntelliSense 了解相关属性。 </span><br>    <span class="hljs-comment">// 悬停以查看现有属性的描述。</span><br>    <span class="hljs-comment">// 欲了解更多信息，请访问: https://go.microsoft.com/fwlink/?linkid=830387</span><br>    <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0.2.0&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;configurations&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-comment">// 本地调试</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;check&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;go&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;request&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;launch&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;mode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;program&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$&#123;fileDirname&#125;&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-comment">// 远程调试</span><br>        <span class="hljs-punctuation">&#123;</span>  <br>            <span class="hljs-comment">// 调试配置的名称，用作vscode中区分</span><br>            <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;remotedebug&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-comment">// 调试类型，go语言当然选择go</span><br>            <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;go&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-comment">// 调试请求类型，可以选择launch启动调试和attach附加调试</span><br>            <span class="hljs-attr">&quot;request&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;launch&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-comment">// 调试模式，这里选择远程调试</span><br>            <span class="hljs-attr">&quot;mode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;remote&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-comment">// 必填项，远程调试里好像没什么用处</span><br>            <span class="hljs-attr">&quot;program&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$&#123;fileDirname&#125;&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-comment">// 远程连接的端口号</span><br>            <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2345</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-comment">// 远程主机的ip地址</span><br>            <span class="hljs-attr">&quot;host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;172.16.100.92&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-comment">// 被调试的代码在远程主机上的路径，必须使用绝对路径.且具体到指定调试目录</span><br>            <span class="hljs-attr">&quot;remotePath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/home/go/src/check_people_gin&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h3 id="开始调试"><a href="#开始调试" class="headerlink" title="开始调试"></a>开始调试</h3><p>直接vscode 启动 <code>remotedebug</code></p>]]></content>
    
    
    <categories>
      
      <category>go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>开发</tag>
      
      <tag>go</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux下的启停脚本</title>
    <link href="/wiki/2021/12/22/liunx/linux%E4%B8%8B%E7%9A%84%E5%90%AF%E5%81%9C%E8%84%9A%E6%9C%AC/"/>
    <url>/wiki/2021/12/22/liunx/linux%E4%B8%8B%E7%9A%84%E5%90%AF%E5%81%9C%E8%84%9A%E6%9C%AC/</url>
    
    <content type="html"><![CDATA[<blockquote><p>liunx 脚本管理应用启动停止重启等操作</p></blockquote><h3 id="脚本代码"><a href="#脚本代码" class="headerlink" title="脚本代码"></a>脚本代码</h3><p><code>install.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><br>APP_HOME=/home/go/src/check_people_gin<br>APP_NAME=checkpeople<br><br>case $1 in<br>start)  # 开始<br>  PID=$(ps -ef | grep $&#123;APP_NAME&#125; | grep -v grep | awk &#x27;&#123;print $2&#125;&#x27;)<br>  if [ -z &quot;$PID&quot; ] ;then<br>        echo &quot;start $&#123;APP_NAME&#125;&quot;<br>        nohup $&#123;APP_HOME&#125;/$&#123;APP_NAME&#125; &gt; /dev/null 2&gt;&amp;1  &amp;<br>  else<br>        echo &quot;$&#123;APP_NAME&#125; is running&quot;<br>  fi<br>;;<br><br>stop)  # 停止<br> PID=$(ps -ef | grep $&#123;APP_NAME&#125; | grep -v grep | awk &#x27;&#123;print $2&#125;&#x27;)<br> if [ -z &quot;$PID&quot; ] ;then<br>        echo &quot;$&#123;APP_NAME&#125; is not running&quot;<br> else<br>        echo &quot;stop $&#123;APP_NAME&#125;&quot;<br>        kill -9 $PID<br> fi<br> ;;<br><br>restart) # 重启<br>PID=$(ps -ef | grep $&#123;APP_NAME&#125; | grep -v grep | awk &#x27;&#123;print $2&#125;&#x27;)<br>if [ -z &quot;$PID&quot; ] ;then<br>        echo &quot;start $&#123;APP_NAME&#125;&quot;<br>        nohup $&#123;APP_HOME&#125;/$&#123;APP_NAME&#125; &gt; /dev/null 2&gt;&amp;1  &amp;<br>else<br>        echo &quot;stop $&#123;APP_NAME&#125;&quot;<br>        kill -9 $PID<br>        echo &quot;start $&#123;APP_NAME&#125;&quot;<br>        nohup $&#123;APP_HOME&#125;/$&#123;APP_NAME&#125; &gt; /dev/null 2&gt;&amp;1  &amp;<br>fi<br>;;<br><br><br>logs)  # 日志<br>tail -f $&#123;APP_HOME&#125;/logs/checkpeople.log<br>;;<br><br><br>status)  # 状态<br>PID=$(ps -ef | grep $&#123;APP_NAME&#125; | grep -v grep | awk &#x27;&#123;print $2&#125;&#x27;)<br>if [ -z &quot;$PID&quot; ] ;then<br>        echo &quot;$&#123;APP_NAME&#125; is not running&quot;<br>else<br>        echo &quot;$&#123;APP_NAME&#125; is running, pid $PID&quot;<br>fi<br>;;<br><br>esac<br></code></pre></td></tr></table></figure><p><code>APP_HOME</code> ：程序所在目录</p><p><code>APP_NAME</code>： 程序名称</p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p><code>sh install.sh start</code></p><p><code>sh install.sh stop</code></p><p><code>sh install.sh restart</code></p><p><code>sh install.sh status</code></p><p><code>sh install.sh logs</code></p>]]></content>
    
    
    <categories>
      
      <category>liunx</category>
      
    </categories>
    
    
    <tags>
      
      <tag>开发</tag>
      
      <tag>liunx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>动态生成小程序二维码带参数</title>
    <link href="/wiki/2021/12/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E5%8A%A8%E6%80%81%E7%94%9F%E6%88%90%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BA%8C%E7%BB%B4%E7%A0%81%E5%B8%A6%E5%8F%82%E6%95%B0/"/>
    <url>/wiki/2021/12/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E5%8A%A8%E6%80%81%E7%94%9F%E6%88%90%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BA%8C%E7%BB%B4%E7%A0%81%E5%B8%A6%E5%8F%82%E6%95%B0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>微信开发者平台：<code>https://mp.weixin.qq.com/</code></p></blockquote><h3 id="通过微信平台接口生成动态二维码"><a href="#通过微信平台接口生成动态二维码" class="headerlink" title="通过微信平台接口生成动态二维码"></a>通过微信平台接口生成动态二维码</h3><p><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/qr-code.html">官方文档</a></p><h4 id="获取access-token"><a href="#获取access-token" class="headerlink" title="获取access_token"></a>获取access_token</h4><p>get请求</p><p><code>https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=wxb161a8515835eedf&amp;secret=9f40b93197b9f54bbf389e2ab97547cb</code></p><p><code>appid</code> 和 <code>secret</code> 在小程序页面查看</p><h4 id="获取小程序码"><a href="#获取小程序码" class="headerlink" title="获取小程序码"></a>获取小程序码</h4><p>http请求</p><p><code>https://api.weixin.qq.com/wxa/getwxacode?access_token=51_ls1QYZgwYEt4219pcND5oXiDeuVRHU2dnTZDFa6og1pYukv0t_vBMWv_FJf2XRlYeZl5avud_eofwFcXBrlLjnL7XTcsnIevS-iBcNQvQWdJNCqs7UdNQGgAwtuJeKfEThT3ecuWJbL-UIJnRRYgAJALLS</code></p><p>参数</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br> <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;page/index/index?&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;width&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">430</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>返回图片Buffer</p>]]></content>
    
    
    <categories>
      
      <category>微信小程序</category>
      
    </categories>
    
    
    <tags>
      
      <tag>微信小程序</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java解析netcore identity4授权token</title>
    <link href="/wiki/2021/12/07/java/java%E8%A7%A3%E6%9E%90netcore%20identity4%E6%8E%88%E6%9D%83token/"/>
    <url>/wiki/2021/12/07/java/java%E8%A7%A3%E6%9E%90netcore%20identity4%E6%8E%88%E6%9D%83token/</url>
    
    <content type="html"><![CDATA[<blockquote><p>java对接netcore identity4service 授权，解析token。</p></blockquote><h3 id="获取identity4service-公钥"><a href="#获取identity4service-公钥" class="headerlink" title="获取identity4service 公钥"></a>获取identity4service 公钥</h3><p><code>http://*:5121/.well-known/openid-configuration/jwks</code></p><p>如果<code>identity4service</code> 使用临时加密的方式（<code>AddDeveloperSigningCredential</code>，<code>AddTemporarySigningCredential</code>），会导致<code>identity4service</code>每次重启会生成一对新的证书，所以每次获取公钥要保证是最新的。</p><p>也可以给<code>identity4service</code>配置证书。</p><p><code>Startup.cs</code></p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c#">services.AddIdentityServer()<br>                    <span class="hljs-comment">//.AddDeveloperSigningCredential(true, ConstanceHelper.AppSettings.CredentialFileName)</span><br>                    .AddSigningCredential(<span class="hljs-keyword">new</span> X509Certificate2(Path.Combine(basePath,<br>                         configuration[<span class="hljs-string">&quot;Certificates:Path&quot;</span>]),<br>                         configuration[<span class="hljs-string">&quot;Certificates:Password&quot;</span>]))<br>                   .AddInMemoryApiResources(Config.GetApis())<br>                   .AddInMemoryIdentityResources(Config.GetIdentityResources())<br>                   .AddInMemoryClients(Config.GetClients())<br>                   .AddProfileService&lt;ProfileService&gt;()<br>                   .AddResourceOwnerValidator&lt;ResourceOwnerPasswordValidator&gt;()<br>                   .AddCustomAuthorizeRequestValidator&lt;CustomAuthorizeRequestValidator&gt;();<br></code></pre></td></tr></table></figure><p><code>application.json</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;Certificates&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;Path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Certificates\\IS4.pfx&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;Password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;xxxxxx&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h4 id="获取公钥"><a href="#获取公钥" class="headerlink" title="获取公钥"></a>获取公钥</h4><p><code>http://172.16.100.177:5121/.well-known/openid-configuration/jwks</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;keys&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;kty&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;RSA&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;use&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;sig&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;kid&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;800740ecb2919cf1bd943da1d7e1c38b&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;e&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;AQAB&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;n&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;wSxc3gNHN7lo9C5LC0Ewoh6aERStezc2HofougTOvfzLgFFWBNBWkCe7X32em1MGzpEguuA90myubLjSvxYvkRq3YJXzwpapAtU32sciXdcPT-d4Qy-RQjQ269pEpLqsSpSYBBC-LHKGTg01AaI_41NS-lw3d_G3DCcT5RaBoMPds5UpOJqHrLLPIKgMGarE7XmPs9w0NyPHz7RU_MHn9UEWTzOByiKBnTZI_nGVEebCGqIdREq8NZnfTjbGrMiRt2i7gY7Cl7K39mwWoovNwvg_p9KscWykiTJzsU2M6EHskRECOfoZ65FHvUHXnZ3IK-VxJ2GqLW_-5eK3lUPY6Q&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;alg&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;RS256&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h3 id="java-解析验证token"><a href="#java-解析验证token" class="headerlink" title="java 解析验证token"></a>java 解析验证token</h3><p>前端获取<code>identity4service</code>token，调用接口；java服务端截取token字符串，获取公钥来做验证。</p><p><code>拦截器代码</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserAuth userAuth;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;config.defaultUserId&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String defaultUserId;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;config.umsPublicKey&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String umsPublicKey;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object object)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">/** 如果不是映射到方法直接通过*/</span><br>        <span class="hljs-keyword">if</span> (!(object <span class="hljs-keyword">instanceof</span> HandlerMethod)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/** 验证接口是否需要登录 */</span><br>        <span class="hljs-type">HandlerMethod</span> <span class="hljs-variable">handlerMethod</span> <span class="hljs-operator">=</span> (HandlerMethod) object;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> handlerMethod.getMethod();<br>        <span class="hljs-comment">/** 判断接口是否需要登录 */</span><br>        <span class="hljs-type">UserToken</span> <span class="hljs-variable">userToken</span> <span class="hljs-operator">=</span> method.getAnnotation(UserToken.class);<br><br>        <span class="hljs-keyword">if</span> (userToken != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> httpServletRequest.getHeader(<span class="hljs-string">&quot;Authorization&quot;</span>);<br><br>            <span class="hljs-comment">/** 如果token为空 */</span><br>            <span class="hljs-keyword">if</span> (token == <span class="hljs-literal">null</span>) &#123;<br>                httpServletResponse.setStatus(<span class="hljs-number">401</span>);<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataApiException</span>(HttpStatusEnum.Token401);<br>            &#125;<br><br>            token = token.replace(<span class="hljs-string">&quot;Bearer &quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br><br>            <span class="hljs-type">DecodedJWT</span> <span class="hljs-variable">verifier</span> <span class="hljs-operator">=</span> JWT.decode(token);<br><br>            <span class="hljs-comment">/** 验证签名 */</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">ConfigurableJWTProcessor</span> <span class="hljs-variable">jwtProcessor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultJWTProcessor</span>();<br>                <span class="hljs-type">ClassPathResource</span> <span class="hljs-variable">classPathResource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(umsPublicKey);<br>                <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(umsPublicKey.getBytes());<br>                <span class="hljs-type">JWKSource</span> <span class="hljs-variable">keySource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImmutableJWKSet</span>(JWKSet.load(is));<br>                <span class="hljs-type">JWSAlgorithm</span> <span class="hljs-variable">expectedJWSAlg</span> <span class="hljs-operator">=</span> JWSAlgorithm.RS256;<br>                <span class="hljs-type">JWSKeySelector</span> <span class="hljs-variable">keySelector</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JWSVerificationKeySelector</span>(expectedJWSAlg, keySource);<br>                jwtProcessor.setJWSKeySelector(keySelector);<br>                <span class="hljs-type">SecurityContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                jwtProcessor.process(token, ctx);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataApiException</span>(HttpStatusEnum.Token401, <span class="hljs-string">&quot;token签名验证失败！&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-type">Date</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> verifier.getExpiresAt();<br>            <span class="hljs-keyword">if</span> (a.getTime() &lt; System.currentTimeMillis()) &#123;<br>                httpServletResponse.setStatus(<span class="hljs-number">401</span>);<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataApiException</span>(HttpStatusEnum.Token401, <span class="hljs-string">&quot;token时间过期！&quot;</span>);<br>            &#125;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> verifier.getSubject();<br>            userAuth.setUserId(userId);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            userAuth.setUserId(defaultUserId);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>InterceptorConfig.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.soyuan.dataapi.interfaces.interceptor;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterceptorConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>        registry.addInterceptor(authenticationInterceptor())<br>                .addPathPatterns(<span class="hljs-string">&quot;/**&quot;</span>);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> AuthenticationInterceptor <span class="hljs-title function_">authenticationInterceptor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthenticationInterceptor</span>();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><code>UserToken.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.soyuan.dataapi.interfaces.interceptor;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.ElementType;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.annotation.RetentionPolicy;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><br><span class="hljs-meta">@Target(&#123;ElementType.METHOD&#125;)</span><span class="hljs-comment">// 可用在方法名上</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><span class="hljs-comment">// 运行时有效</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> UserToken &#123;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><code>接口使用</code></p><p><code>controller</code> 使用增加  <code>@UserToken</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@GetMapping(&quot;/GetApiGroupsByUserId&quot;)</span><br><span class="hljs-meta">@UserToken</span><br><span class="hljs-keyword">public</span> ApiResult&lt;List&lt;ApiGroupDto&gt;&gt; <span class="hljs-title function_">GetApiGroupsByUserId</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(required = false)</span> String groupName)</span> &#123;<br>    <span class="hljs-keyword">return</span> ApiResult.ok(apiGroupService.GetApiGroupList(groupName));<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>netcore</tag>
      
      <tag>identity4service</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>apollo 配置中心多环境docker版本</title>
    <link href="/wiki/2021/12/03/apollo/apollo%20%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%A4%9A%E7%8E%AF%E5%A2%83docker%E7%89%88%E6%9C%AC/"/>
    <url>/wiki/2021/12/03/apollo/apollo%20%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%A4%9A%E7%8E%AF%E5%A2%83docker%E7%89%88%E6%9C%AC/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>apollo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>apollo</tag>
      
      <tag>运维</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>apollo 配置中心多环境部署</title>
    <link href="/wiki/2021/12/03/apollo/apollo%20%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2/"/>
    <url>/wiki/2021/12/03/apollo/apollo%20%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<blockquote><p>Apollo（阿波罗）是一款可靠的分布式配置管理中心，诞生于携程框架研发部，能够集中化管理应用不同环境、不同集群的配置，配置修改后能够实时推送到应用端，并且具备规范的权限、流程治理等特性，适用于微服务配置管理场景。</p></blockquote><h3 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h3><p>gitree: <code>https://gitee.com/apolloconfig/apollo</code></p><p>github: <code>https://github.com/apolloconfig/apollo</code></p><p>文档地址：<code>https://www.apolloconfig.com/#/zh/README</code> 源码里面也有完整的文档，根目录下 <code>docs</code> <code>doc</code> 文件夹</p><p>下载完的代码目录</p><p><img src="/img/apollo/1.png"></p><h3 id="各模块介绍"><a href="#各模块介绍" class="headerlink" title="各模块介绍"></a>各模块介绍</h3><h4 id="config-service"><a href="#config-service" class="headerlink" title="config service"></a>config service</h4><p>代码路径：<code>apollo-configservice</code></p><p><img src="/img/apollo/2.png"></p><ul><li>提供配置获取接口</li><li>提供配置更新推送接口（基于Http long polling）<ul><li>服务端使用<a href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/context/request/async/DeferredResult.html">Spring DeferredResult</a>实现异步化，从而大大增加长连接数量</li><li>目前使用的tomcat embed默认配置是最多10000个连接（可以调整），使用了4C8G的虚拟机实测可以支撑10000个连接，所以满足需求（一个应用实例只会发起一个长连接）。</li></ul></li><li>接口服务对象为Apollo客户端</li></ul><h4 id="admin-service"><a href="#admin-service" class="headerlink" title="admin service"></a>admin service</h4><p>代码路径：<code>apollo-adminservice</code></p><ul><li>提供配置管理接口</li><li>提供配置修改、发布等接口</li><li>接口服务对象为Portal</li></ul><h4 id="protal"><a href="#protal" class="headerlink" title="protal"></a>protal</h4><p>代码路径：<code>apollo-protal</code></p><ul><li>提供Web界面供用户管理配置</li><li>通过Meta Server获取Admin Service服务列表（IP+Port），通过IP+Port访问服务</li><li>在Portal侧做load balance、错误重试</li></ul><h3 id="源码编译部署"><a href="#源码编译部署" class="headerlink" title="源码编译部署"></a>源码编译部署</h3><p>多环境部署就是每一套环境，部署一套 <code>config service</code> 和 <code>admin service</code>；<code>protal</code> 是一套。</p><p>每个<code>config service</code> 和 <code>admin service</code> 也可以做集群横向扩展，使用同一套数据库，然后做个<code>nginx</code>反向代理负载均衡，<code>protal</code>里面配置代理后的地址；多个config service的时候，数据库的Eureka需要配置多个config的地址，它们会互相复制。</p><p><img src="/img/apollo/3.png"></p><h4 id="修改编译配置文件"><a href="#修改编译配置文件" class="headerlink" title="修改编译配置文件"></a>修改编译配置文件</h4><p>源码下载下来可以直接拿<code>IDEA</code>打开，安装maven 直接安装依赖；或者直接运行 <code>/script/build.sh</code> 脚本进行打包。</p><p><code>build.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment"># Copyright 2021 Apollo Authors</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">you may not use this file except <span class="hljs-keyword">in</span> compliance with the License.</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">You may obtain a copy of the License at</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment"># http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">distributed under the License is distributed on an <span class="hljs-string">&quot;AS IS&quot;</span> BASIS,</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">See the License <span class="hljs-keyword">for</span> the specific language governing permissions and</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">limitations under the License.</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"></span><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">apollo config db info</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">config service，admin service 数据库信息</span><br>apollo_config_db_url=&#x27;jdbc:mysql://221.226.4.130:48005/ApolloConfigDB_dev_92?serverTimezone=GMT%2b8&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=false&amp;serverTimezone=GMT%2b8&#x27;<br>apollo_config_db_username=&#x27;root&#x27;<br>apollo_config_db_password=&#x27;soyuan.123&#x27;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">apollo portal db info</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">portal 数据库信息</span><br>apollo_portal_db_url=&#x27;jdbc:mysql://221.226.4.130:48005/ApolloPortalDB?serverTimezone=GMT%2b8&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=false&amp;serverTimezone=GMT%2b8&#x27;<br>apollo_portal_db_username=&#x27;root&#x27;<br>apollo_portal_db_password=&#x27;soyuan.123&#x27;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">meta server url, different environments should have different meta server addresses</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">各个环境的config地址 数据库信息</span><br>dev_meta=http://172.16.100.92:8080<br>fat_meta=http://fill-in-fat-meta-server:8080<br>uat_meta=http://fill-in-uat-meta-server:8080<br>pro_meta=http://221.226.4.130:48025<br><br>META_SERVERS_OPTS=&quot;-Ddev_meta=$dev_meta -Dfat_meta=$fat_meta -Duat_meta=$uat_meta -Dpro_meta=$pro_meta&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">=============== Please <span class="hljs-keyword">do</span> not modify the following content =============== <span class="hljs-comment">#</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">go to script directory</span><br>cd &quot;$&#123;0%/*&#125;&quot; || exit <br><br>cd ..<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">package config-service and admin-service</span><br>echo &quot;==== starting to build config-service and admin-service ====&quot;<br><br>mvn clean package -DskipTests -pl apollo-configservice,apollo-adminservice -am -Dapollo_profile=github -Dspring_datasource_url=$apollo_config_db_url -Dspring_datasource_username=$apollo_config_db_username -Dspring_datasource_password=$apollo_config_db_password<br><br>echo &quot;==== building config-service and admin-service finished ====&quot;<br><br>echo &quot;==== starting to build portal ====&quot;<br><br>mvn clean package -DskipTests -pl apollo-portal -am -Dapollo_profile=github,auth -Dspring_datasource_url=$apollo_portal_db_url -Dspring_datasource_username=$apollo_portal_db_username -Dspring_datasource_password=$apollo_portal_db_password $META_SERVERS_OPTS<br><br>echo &quot;==== building portal finished ====&quot;<br></code></pre></td></tr></table></figure><p><strong>数据库链接字符串一定要注意，源码中的默认格式低版本mysql不支持会报错</strong></p><h4 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h4><p>配置文件修改后，开始打包，直接运行<code>./build.sh</code>,成功接口如下。</p><p><img src="/img/apollo/5.png"></p><p>生成的包分别位于一下目录</p><ul><li> configservice：<code>apollo-configservice\target\apollo-configservice-2.0.0-SNAPSHOT-github.zip</code></li><li>adminservice：<code>apollo-adminservice\target\apollo-adminservice-2.0.0-SNAPSHOT-github.zip</code></li><li>protal：<code>apollo-portal\target\apollo-portal-2.0.0-SNAPSHOT-github.zip</code></li></ul><h4 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h4><p>环境列表</p><table><thead><tr><th>服务器</th><th>环境名称</th><th>部署服务</th></tr></thead><tbody><tr><td>172.16.100.92</td><td>DEV</td><td>configservice,adminservice,protal</td></tr><tr><td>221.226.4.130</td><td>PRO</td><td>configservice,adminservice</td></tr></tbody></table><h5 id="172-16-100-92"><a href="#172-16-100-92" class="headerlink" title="172.16.100.92"></a>172.16.100.92</h5><p>把 <code>build.sh</code>  <code>configservice</code> 的配置文件改成  <code>172.16.100.92</code> 的配置。</p><p><code>apollo-configservice-2.0.0-SNAPSHOT-github.zip</code> 上传到服务器，解压出来目录结构如下</p><p><img src="/img/apollo/6.png"></p><p>如果想改启动端口，和日志输出目录，修改 <code>script/startup.sh</code> 的  <code>LOG_DIR</code> <code>SERVER_PORT</code></p><p>启动：<code>./script/startup.sh</code></p><p>停止: <code>./script/shutdown.sh</code></p><hr><p><code>apollo-adminservice-2.0.0-SNAPSHOT-github.zip</code> 上传到服务器，解压出来目录结构如下</p><p><img src="/img/apollo/7.png"></p><p>如果想改启动端口，和日志输出目录，修改 <code>script/startup.sh</code> 的  <code>LOG_DIR</code> <code>SERVER_PORT</code></p><p>启动：<code>./script/startup.sh</code></p><p>停止: <code>./script/shutdown.sh</code></p><h5 id="221-226-4-130"><a href="#221-226-4-130" class="headerlink" title="221.226.4.130"></a>221.226.4.130</h5><p>把 <code>build.sh</code>  <code>configservice</code> 的配置文件改成  <code>221.226.4.130</code> 的配置。</p><p>部署启动过程同上。</p><h5 id="protal-1"><a href="#protal-1" class="headerlink" title="protal"></a>protal</h5><p>管理页面为了安全，部署到内网只能内网访问</p><p>把 <code>build.sh</code>  <code>meta server url</code> 的配置文件改成对应的环境的地址，然后打包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">dev_meta=http://172.16.100.92:8080<br>fat_meta=http://fill-in-fat-meta-server:8080<br>uat_meta=http://fill-in-uat-meta-server:8080<br>pro_meta=http://221.226.4.130:48025<br></code></pre></td></tr></table></figure><p>数据库修改环境列表</p><p><img src="/img/apollo/8.png"></p><p><code>apollo-portal-2.0.0-SNAPSHOT-github.zip</code> 上传到服务器，解压目录如下</p><p><img src="/img/apollo/9.png"></p><p>如果想改启动端口，和日志输出目录，修改 <code>script/startup.sh</code> 的  <code>LOG_DIR</code> <code>SERVER_PORT</code></p><p>启动：<code>./script/startup.sh</code></p><p>停止: <code>./script/shutdown.sh</code></p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>默认登录账号密码 <code>apollo/admin</code></p><p>创建应用可以添加多个 <code>namespace</code>，<code>集群</code> 对配置文件进行管理</p><h3 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h3><p> <a href="https://github.com/apolloconfig/apollo/wiki/%E9%83%A8%E7%BD%B2&%E5%BC%80%E5%8F%91%E9%81%87%E5%88%B0%E7%9A%84%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">部署&amp;开发遇到的常见问题</a></p><h3 id="admin-server-或者-config-server-注册了内网IP，导致portal或者client访问不了admin-server或config-server"><a href="#admin-server-或者-config-server-注册了内网IP，导致portal或者client访问不了admin-server或config-server" class="headerlink" title="admin server 或者 config server 注册了内网IP，导致portal或者client访问不了admin server或config server"></a>admin server 或者 config server 注册了内网IP，导致portal或者client访问不了admin server或config server</h3><p><strong>推荐第二种方案，直接在<code>startup.sh</code> 增加启动参数</strong></p><p>分布式部署的时候，<code>apollo-configservice</code>和<code>apollo-adminservice</code>需要把自己的IP和端口注册到Meta Server（apollo-configservice本身）。</p><p>Apollo客户端和Portal会从Meta Server获取服务的地址（IP+端口），然后通过服务地址直接访问。</p><p>所以如果实际部署的机器有多块网卡（如docker），或者存在某些网卡的IP是Apollo客户端和Portal无法访问的（如网络安全限制），那么我们就需要在<code>apollo-configservice</code>和<code>apollo-adminservice</code>中做相关限制以避免Eureka将这些网卡的IP注册到Meta Server。</p><h4 id="方案一：-忽略某些网卡"><a href="#方案一：-忽略某些网卡" class="headerlink" title="方案一： 忽略某些网卡"></a>方案一： 忽略某些网卡</h4><p>具体文档可以参考<a href="http://projects.spring.io/spring-cloud/spring-cloud.html#ignore-network-interfaces">Ignore Network Interfaces</a>章节。具体而言，就是分别编辑<a href="https://github.com/ctripcorp/apollo/blob/master/apollo-configservice/src/main/resources/application.yml">apollo-configservice/src/main/resources/application.yml</a>和<a href="https://github.com/ctripcorp/apollo/blob/master/apollo-adminservice/src/main/resources/application.yml">apollo-adminservice/src/main/resources/application.yml</a>，然后把需要忽略的网卡加进去。</p><p>如下面这个例子就是对于<code>apollo-configservice</code>，把docker0和veth.*的网卡在注册到Eureka时忽略掉。</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">spring</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">application</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-attribute">name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">apollo-configservice</span><br>  <span class="hljs-attribute">profiles</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">active</span><span class="hljs-punctuation">:</span> <span class="hljs-string">$&#123;apollo_profile&#125;</span><br>  <span class="hljs-attribute">cloud</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">inetutils</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-attribute">ignoredInterfaces</span><span class="hljs-punctuation">:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">docker0</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">veth.*</span><br></code></pre></td></tr></table></figure><blockquote><p>注意，对于application.yml修改时要小心，千万不要把其它信息改错了，如spring.application.name等。</p></blockquote><h4 id="方案二：强制指定admin-server和config-server向eureka注册的IP"><a href="#方案二：强制指定admin-server和config-server向eureka注册的IP" class="headerlink" title="方案二：强制指定admin server和config server向eureka注册的IP"></a>方案二：强制指定admin server和config server向eureka注册的IP</h4><p>可以修改startup.sh，通过JVM System Property在运行时传入，如<code>-Deureka.instance.ip-address=$&#123;指定的IP&#125;</code>，或者也可以修改apollo-adminservice或apollo-configservice 的bootstrap.yml文件，加入以下配置</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">eureka</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">instance</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">ip-address</span><span class="hljs-punctuation">:</span> <span class="hljs-string">$&#123;指定的IP&#125;</span><br></code></pre></td></tr></table></figure><h4 id="方案三：强制指定admin-server和config-server向eureka注册的IP和Port"><a href="#方案三：强制指定admin-server和config-server向eureka注册的IP和Port" class="headerlink" title="方案三：强制指定admin server和config server向eureka注册的IP和Port"></a>方案三：强制指定admin server和config server向eureka注册的IP和Port</h4><p>可以修改startup.sh，通过JVM System Property在运行时传入，如<code>-Deureka.instance.homePageUrl=http://$&#123;指定的IP&#125;:$&#123;指定的Port&#125;</code>，或者也可以修改apollo-adminservice或apollo-configservice 的bootstrap.yml文件，加入以下配置</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">eureka:</span><br><span class="hljs-symbol">  instance:</span><br><span class="hljs-symbol">    homePageUrl:</span> http:<span class="hljs-comment">//$&#123;指定的IP&#125;:$&#123;指定的Port&#125;</span><br><span class="hljs-symbol">    preferIpAddress:</span> false<br></code></pre></td></tr></table></figure><p>做完上述修改并重启后，可以查看Eureka页面（http://${config-service-url:port}）检查注册上来的IP信息是否正确。</p><blockquote><p>注：如果Apollo部署在公有云上，本地开发环境无法连接，但又需要做开发测试的话，客户端可以升级到0.11.0版本及以上，然后通过<code>-Dapollo.configService=http://config-service的公网IP:端口</code>来跳过meta service的服务发现，记得要对公网 SLB 设置 IP 白名单，避免数据泄露</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>apollo</category>
      
    </categories>
    
    
    <tags>
      
      <tag>apollo</tag>
      
      <tag>运维</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker启动端口禁止ipv6</title>
    <link href="/wiki/2021/12/01/docker/docker%E5%90%AF%E5%8A%A8%E7%AB%AF%E5%8F%A3%E7%A6%81%E6%AD%A2ipv6/"/>
    <url>/wiki/2021/12/01/docker/docker%E5%90%AF%E5%8A%A8%E7%AB%AF%E5%8F%A3%E7%A6%81%E6%AD%A2ipv6/</url>
    
    <content type="html"><![CDATA[<blockquote><p>centos 上 docker有的时候启动会监听ipv6地址 []，这个时候页面就访问不了了，可以把系统的ipv6禁用掉</p><p>使用命令ifconfig 可查看ipv6地址</p></blockquote><p><img src="/img/docker/1.png"></p><h3 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h3><p><code>/etc/default/grub</code></p><p>增加配置 <code>ipv6.disable=1</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">GRUB_TIMEOUT=5<br>GRUB_DISTRIBUTOR=&quot;$(sed &#x27;s, release .*$,,g&#x27; /etc/system-release)&quot;<br>GRUB_DEFAULT=saved<br>GRUB_DISABLE_SUBMENU=true<br>GRUB_TERMINAL_OUTPUT=&quot;console&quot;<br>GRUB_CMDLINE_LINUX=&quot;ipv6.disable=1 crashkernel=auto rd.lvm.lv=cl/root rd.lvm.lv=cl/swap rhgb quiet&quot;<br>GRUB_DISABLE_RECOVERY=&quot;true&quot;<br></code></pre></td></tr></table></figure><h3 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h3><p><code>grub2-mkconfig -o /boot/grub2/grub.cfg</code></p><h3 id="重启生效"><a href="#重启生效" class="headerlink" title="重启生效"></a>重启生效</h3><p><code>reboot</code></p><h3 id="检查是否生效"><a href="#检查是否生效" class="headerlink" title="检查是否生效"></a>检查是否生效</h3><p><code>ifconfig</code></p><p><img src="/img/docker/2.png"></p>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>开发</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hadoop集群</title>
    <link href="/wiki/2021/11/30/hadoop/hadoop%E9%9B%86%E7%BE%A4/"/>
    <url>/wiki/2021/11/30/hadoop/hadoop%E9%9B%86%E7%BE%A4/</url>
    
    <content type="html"><![CDATA[<h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><p>hadoop 3.2.0</p><h2 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h2><table><thead><tr><th>机器</th><th>ip</th><th>分配节点</th></tr></thead><tbody><tr><td>cdh1</td><td>172.16.100.63</td><td>NameNode、DataNode、ResourceManager</td></tr><tr><td>cdh2</td><td>172.16.100.64</td><td>DataNode、NodeManager SecondaryNameNode</td></tr><tr><td>cdh3</td><td>172.16.100.71</td><td>DataNode  NodeManager HistoryServer</td></tr></tbody></table><h2 id="配置服务器"><a href="#配置服务器" class="headerlink" title="配置服务器"></a>配置服务器</h2><ul><li>时间同步</li><li>免密码登录</li><li>hosts</li><li>关闭防火墙</li><li>安装jdk</li></ul><h2 id="在所有服务器-cdh1-cdh2-cdh3-配置环境变量"><a href="#在所有服务器-cdh1-cdh2-cdh3-配置环境变量" class="headerlink" title="在所有服务器(cdh1,cdh2,cdh3)配置环境变量"></a>在所有服务器(cdh1,cdh2,cdh3)配置环境变量</h2><p><code>vi /etc/profile.d/hadoop.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">export HADOOP_HOME=/opt/hadoop/hadoop/hadoop-3.2.0<br>export PATH=$PATH:$HADOOP_HOME/bin:$HADOOP_HOME/sbin<br>export HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop<br></code></pre></td></tr></table></figure><p><code>source /etc/profile.d/hadoop.sh</code></p><h2 id="配置Hadoop-JDK路径，定义集群操作用户，在hadoop-env-sh文件中添加如下内容"><a href="#配置Hadoop-JDK路径，定义集群操作用户，在hadoop-env-sh文件中添加如下内容" class="headerlink" title="配置Hadoop JDK路径，定义集群操作用户，在hadoop-env.sh文件中添加如下内容"></a>配置Hadoop JDK路径，定义集群操作用户，在hadoop-env.sh文件中添加如下内容</h2><p>配置文件路径 <code>hadoop-3.2.0/etc/hadoop</code></p><p><code>vi hadoop-env.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">export JAVA_HOME=/usr/java/jdk1.8.0_301<br><br>export HDFS_NAMENODE_USER=root<br>export HDFS_DATANODE_USER=root<br>export HDFS_SECONDARYNAMENODE_USER=root<br>export YARN_RESOURCEMANAGER_USER=root<br>export YARN_NODEMANAGER_USER=root<br><br>export HADOOP_PID_DIR=/opt/hadoop/hadoop/hadoop-3.2.0/pids<br>export HADOOP_LOG_DIR=/opt/hadoop/hadoop/hadoop-3.2.0/logs<br></code></pre></td></tr></table></figure><h2 id="配置core-site-xml"><a href="#配置core-site-xml" class="headerlink" title="配置core-site.xml"></a>配置core-site.xml</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>fs.defaultFS<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hdfs://cdh1:8020<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hadoop.tmp.dir<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>/opt/hadoop/hadoop/hadoop-3.2.0/tmp<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></table></figure><p><code>fs.defaultFS</code>为<code>NameNode</code>的地址</p><p><code>hadoop.tmp.dir</code>为<code>hadoop</code>临时目录的地址</p><h2 id="配置hdfs-site-xml"><a href="#配置hdfs-site-xml" class="headerlink" title="配置hdfs-site.xml"></a>配置hdfs-site.xml</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>dfs.namenode.secondary.http-address<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>cdh2:50090<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>dfs.replication<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>dfs.namenode.name.dir<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>file:/opt/hadoop/hadoop/name<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>dfs.datanode.data.dir<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>file:/opt/hadoop/hadoop/data<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></table></figure><p><code>dfs.namenode.secondary.http-address</code>是指定<code>secondaryNameNode</code>的http访问地址和端口号，因为在规划中，我们将<code>cdh2</code>规划为<code>SecondaryNameNode</code>服务器。</p><h2 id="配置workers"><a href="#配置workers" class="headerlink" title="配置workers"></a>配置workers</h2><p><code>vi workers</code></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">cdh1</span><br>cdh2<br>cdh3<br></code></pre></td></tr></table></figure><p><code>workers</code>文件是指定<code>HDFS</code>上有哪些<code>DataNode</code>节点。</p><h2 id="配置yarn-site-xml"><a href="#配置yarn-site-xml" class="headerlink" title="配置yarn-site.xml"></a>配置yarn-site.xml</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br><span class="hljs-comment">&lt;!-- Site specific YARN configuration properties --&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>mapreduce_shuffle<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.nodemanager.localizer.address<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>0.0.0.0:8140<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.resourcemanager.hostname<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>cdh1<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.log-aggregation-enable<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.log-aggregation.retain-seconds<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>604800<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.log.server.url<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>http://cdh3:19888/jobhistory/logs<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></table></figure><p>根据规划<code>yarn.resourcemanager.hostname</code>这个指定<code>resourcemanager</code>服务器指向cdh1。<br><code>yarn.log-aggregation-enable</code>是配置是否启用日志聚集功能。<br><code>yarn.log-aggregation.retain-seconds</code>是配置聚集的日志在<code>HDFS</code>上最多保存多长时间。</p><h2 id="配置mapred-site-xml"><a href="#配置mapred-site-xml" class="headerlink" title="配置mapred-site.xml"></a>配置mapred-site.xml</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>mapreduce.framework.name<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>yarn<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.app.mapreduce.am.env<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>HADOOP_MAPRED_HOME=/opt/hadoop/hadoop/hadoop-3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>mapreduce.map.env<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>HADOOP_MAPRED_HOME=/opt/hadoop/hadoop/hadoop-3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>mapreduce.reduce.env<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>HADOOP_MAPRED_HOME=/opt/hadoop/hadoop/hadoop-3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>mapreduce.jobhistory.address<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>cdh3:10020<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>mapreduce.jobhistory.webapp.address<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>cdh3:19888<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p><code>mapreduce.framework.name</code>设置<code>mapreduce</code>任务运行在<code>yarn</code>上。<br><code>mapreduce.jobhistory.address</code>是设置<code>mapreduce</code>的历史服务器安装在cdh3机器上。<br><code>mapreduce.jobhistory.webapp.address</code>是设置历史服务器的<code>web</code>页面地址和端口号。</p><h2 id="复制Hadoop配置好的包到其他Linux主机"><a href="#复制Hadoop配置好的包到其他Linux主机" class="headerlink" title="复制Hadoop配置好的包到其他Linux主机"></a>复制Hadoop配置好的包到其他Linux主机</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">scp -r hadoop/ cdh2:/opt/hadoop/<br>scp -r hadoop/ cdh3:/opt/hadoop/<br></code></pre></td></tr></table></figure><h2 id="格式化NameNode"><a href="#格式化NameNode" class="headerlink" title="格式化NameNode"></a>格式化NameNode</h2><p>在NameNode机器上执行格式化</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hdfs namenode -format<br></code></pre></td></tr></table></figure><p>如果需要重新格式化<code>NameNode</code>,需要先将原来<code>NameNode</code>和<code>DataNode</code>下的文件全部删除，不然会报错，<code>NameNode</code>和<code>DataNode</code>所在目录是在<code>core-site.xml</code>中<code>hadoop.tmp.dir</code>、<code>dfs.namenode.name.dir</code>、<code>dfs.datanode.data.dir</code>属性配置的。</p><p>因为每次格式化，默认是创建一个集群ID，并写入<code>NameNode</code>和<code>DataNode</code>的<code>VERSION</code>文件中（<code>VERSION</code>文件所在目录为<code>hdfs/name/current</code> 和 <code>hdfs/data/current</code>），重新格式化时，默认会生成一个新的<code>集群ID</code>,如果不删除原来的目录，会导致<code>namenode</code>中的<code>VERSION</code>文件中是新的集群ID,而<code>DataNode</code>中是旧的<code>集群ID</code>，不一致时会报错。</p><h2 id="启动集群"><a href="#启动集群" class="headerlink" title="启动集群"></a>启动集群</h2><h3 id="启动HDFS"><a href="#启动HDFS" class="headerlink" title="启动HDFS"></a>启动HDFS</h3><p>在cdh1上执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sh start-dfs.sh<br></code></pre></td></tr></table></figure><h3 id="启动YARN"><a href="#启动YARN" class="headerlink" title="启动YARN"></a>启动YARN</h3><p>在cdh1上执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sh start-yarn.sh<br></code></pre></td></tr></table></figure><h3 id="启动日志服务"><a href="#启动日志服务" class="headerlink" title="启动日志服务"></a>启动日志服务</h3><p>因为我们规划的是在cdh3服务器上运行jobhistoryserver服务，所以要在cdh3上启动。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mapred --daemon start historyserver<br></code></pre></td></tr></table></figure><h3 id="查看HDFS-Web页面"><a href="#查看HDFS-Web页面" class="headerlink" title="查看HDFS Web页面"></a>查看HDFS Web页面</h3><p><code>http://cdh1:9870/</code></p><p> <code>3.0.0以上版本访问WebUI默认端口从50070改为9870</code></p><h3 id="查看YARN-Web页面"><a href="#查看YARN-Web页面" class="headerlink" title="查看YARN Web页面"></a>查看YARN Web页面</h3><p><code>http://cdh1:8088/</code></p><h3 id="强制namenode离开安全模式"><a href="#强制namenode离开安全模式" class="headerlink" title="强制namenode离开安全模式"></a>强制namenode离开安全模式</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">hadoop dfsadmin -safemode leave<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>hadoop</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hadoop</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hbase集群</title>
    <link href="/wiki/2021/11/30/hadoop/hbase%E9%9B%86%E7%BE%A4/"/>
    <url>/wiki/2021/11/30/hadoop/hbase%E9%9B%86%E7%BE%A4/</url>
    
    <content type="html"><![CDATA[<h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><p>hbase 2.4.9</p><h2 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h2><table><thead><tr><th>机器</th><th>ip</th><th>分配节点</th></tr></thead><tbody><tr><td>cdh1</td><td>172.16.100.63</td><td>HMaster HRegionServer</td></tr><tr><td>cdh2</td><td>172.16.100.64</td><td>HRegionServer</td></tr><tr><td>cdh3</td><td>172.16.100.71</td><td>HRegionServer</td></tr></tbody></table><p><code>cdh1</code> 又是<code>HMaster</code>  同时也是<code>HRegionServer</code>，因为安装phoenix的时候需要安装到<code>HRegionServer</code>，如果<code>cdh1</code> 是<code>HMaster</code>  <code>Phoenix</code>可以安装到<code>cdh2</code>上。</p><h2 id="配置服务器"><a href="#配置服务器" class="headerlink" title="配置服务器"></a>配置服务器</h2><ul><li>时间同步</li><li>免密码登录</li><li>hosts</li><li>关闭防火墙</li><li>安装jdk</li></ul><h2 id="上传服务器指定目录解压"><a href="#上传服务器指定目录解压" class="headerlink" title="上传服务器指定目录解压"></a>上传服务器指定目录解压</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">tar -zxvf hbase-2.4.9-bin.tar.gz<br></code></pre></td></tr></table></figure><h2 id="在所有服务器-cdh1-cdh2-cdh3-配置环境变量"><a href="#在所有服务器-cdh1-cdh2-cdh3-配置环境变量" class="headerlink" title="在所有服务器(cdh1,cdh2,cdh3)配置环境变量"></a>在所有服务器(cdh1,cdh2,cdh3)配置环境变量</h2><p><code>vi /etc/profile.d/hbase.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">export HBASE_HOME=/opt/hadoop/hbase/hbase-2.4.9<br>export PATH=$PATH:$HBASE_HOME/bin<br></code></pre></td></tr></table></figure><p><code>source /etc/profile.d/hbase.sh</code></p><h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><p>配置文件目录：<code>/hbase-2.4.9/conf</code></p><h2 id="修改-hbase-env-sh"><a href="#修改-hbase-env-sh" class="headerlink" title="修改 hbase-env.sh"></a>修改 hbase-env.sh</h2><p><code>vi hbase-env.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">export JAVA_HOME=/usr/java/jdk1.8.0_301<br>export HBASE_MANAGES_ZK=false<br></code></pre></td></tr></table></figure><p><code>HBASE_MANAGES_ZK </code> 禁止使用hbase自带的zk</p><h2 id="修改hbase-site-xml"><a href="#修改hbase-site-xml" class="headerlink" title="修改hbase-site.xml"></a>修改hbase-site.xml</h2><p><code>vi hbase-site.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>  <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">    The following properties are set for running HBase as a single process on a</span><br><span class="hljs-comment">    developer workstation. With this configuration, HBase is running in</span><br><span class="hljs-comment">    &quot;stand-alone&quot; mode and without a distributed file system. In this mode, and</span><br><span class="hljs-comment">    without further configuration, HBase and ZooKeeper data are stored on the</span><br><span class="hljs-comment">    local filesystem, in a path under the value configured for `hbase.tmp.dir`.</span><br><span class="hljs-comment">    This value is overridden from its default value of `/tmp` because many</span><br><span class="hljs-comment">    systems clean `/tmp` on a regular basis. Instead, it points to a path within</span><br><span class="hljs-comment">    this HBase installation directory.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    Running against the `LocalFileSystem`, as opposed to a distributed</span><br><span class="hljs-comment">    filesystem, runs the risk of data integrity issues and data loss. Normally</span><br><span class="hljs-comment">    HBase will refuse to run in such an environment. Setting</span><br><span class="hljs-comment">    `hbase.unsafe.stream.capability.enforce` to `false` overrides this behavior,</span><br><span class="hljs-comment">    permitting operation. This configuration is for the developer workstation</span><br><span class="hljs-comment">    only and __should not be used in production!__</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    See also https://hbase.apache.org/book.html#standalone_dist</span><br><span class="hljs-comment">  --&gt;</span><br>  <span class="hljs-comment">&lt;!--zookeeper集群地址--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>cdh1:2181,cdh2:2181,cdh3:2181<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>zookeeper address<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>  <span class="hljs-comment">&lt;!--hdfs集群地址--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hbase.rootdir<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hdfs://cdh1/hbase<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>hdfs address<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><br>  <span class="hljs-comment">&lt;!--hbase集群模式--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hbase.cluster.distributed<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="修改regionservers"><a href="#修改regionservers" class="headerlink" title="修改regionservers"></a>修改regionservers</h2><p><code>vi regionservers</code></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">cdh1</span><br>cdh2<br>cdh3<br></code></pre></td></tr></table></figure><h2 id="修改hdfs-site-xml-和-core-site-xml"><a href="#修改hdfs-site-xml-和-core-site-xml" class="headerlink" title="修改hdfs-site.xml 和 core-site.xml"></a>修改hdfs-site.xml 和 core-site.xml</h2><p><strong>最重要一步，要把 hadoop 的 hdfs-site.xml 和 core-site.xml 放到 hbase-1.2.6/conf 下</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cp /opt/hadoop/hadoop/hadoop-3.2.0/etc/hadoop/hdfs-site.xml .<br>cp /opt/hadoop/hadoop/hadoop-3.2.0/etc/hadoop/core-site.xml .<br></code></pre></td></tr></table></figure><h2 id="将HBase安装包分发到其他节点"><a href="#将HBase安装包分发到其他节点" class="headerlink" title="将HBase安装包分发到其他节点"></a>将HBase安装包分发到其他节点</h2><p>分发之前先删除HBase目录下的docs文件夹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">rm -rf ./doc<br><br>scp -r hbase/ cdh2/opt/hadoop/<br>scp -r hbase/ cdh3opt/hadoop/<br></code></pre></td></tr></table></figure><h2 id="启动Hbase"><a href="#启动Hbase" class="headerlink" title="启动Hbase"></a>启动Hbase</h2><p>在cdh1下面执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">start-hbase.sh<br></code></pre></td></tr></table></figure><p>单独启动</p><p><code>cdh2 hbase-daemon.sh start regionserver</code></p><p><code>cdh3 hbase-daemon.sh start regionserver</code></p><p><code>cdh1 hbase-daemon.sh start master</code></p><h2 id="查看运行状态"><a href="#查看运行状态" class="headerlink" title="查看运行状态"></a>查看运行状态</h2><p><code>http://cdh1:16010/master-status</code></p><h2 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h2><p><code>检查时间同步</code></p><p><code>初始化hdfs上是否有垃圾数据</code></p>]]></content>
    
    
    <categories>
      
      <category>hadoop</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hadoop</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hdfs操作</title>
    <link href="/wiki/2021/11/30/hadoop/hdfs%E6%93%8D%E4%BD%9C/"/>
    <url>/wiki/2021/11/30/hadoop/hdfs%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<p>HDFS（Hadoop Distributed File System）：分布式文件系统</p><h3 id="操作HDFS"><a href="#操作HDFS" class="headerlink" title="操作HDFS"></a>操作HDFS</h3><h4 id="操作命令-hdfs-dfs"><a href="#操作命令-hdfs-dfs" class="headerlink" title="操作命令 hdfs dfs ****"></a>操作命令 <code>hdfs dfs ****</code></h4><p> <code>-mkdir</code> 创建目录</p><p> 举例：    <code>hdfs dfs -mkdir /aaa</code></p><p>​                <code>hdfs dfs -mkdir -p /bbb/ccc</code>   -p表示如果父目录不存在 则先创建父目录</p><p> <code>-ls</code>    查看某个目录</p><p>  <code>-ls -R</code>  查看某个目录，包括子目录，简写：-lsr</p><p>  <code>-put</code> 上传数据  <code>hdfs dfs -put data.txt /input</code></p><p> <code>-copyFromLocal</code> 上传数据   <code>hdfs dfs -copyFromLocal data.txt /input</code></p><p>  <code>-moveFromLocal</code> 上传数据（相当于ctrl + x 剪切）</p><p> <code>-copyToLocal</code>  下载数据</p><p><code>-get</code>    下载数据</p><p> <code>-rm</code> 删除目录</p><p> <code>-rm -r</code> 删除目录（递归删除包括子目录）简写 -rmr</p><p>​        <code>hdfs dfs -rmr /tools</code>    </p>]]></content>
    
    
    <categories>
      
      <category>hadoop</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hadoop</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hive部署</title>
    <link href="/wiki/2021/11/30/hadoop/hive%E9%83%A8%E7%BD%B2/"/>
    <url>/wiki/2021/11/30/hadoop/hive%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><p>apache-hive-2.3.9</p><p><a href="https://dlcdn.apache.org/hive/hive-2.3.9/">下载地址</a></p><h2 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h2><p>hive属于一个工具直接部署到<code>cdh1</code>主节点上</p><h2 id="上传服务器指定目录解压"><a href="#上传服务器指定目录解压" class="headerlink" title="上传服务器指定目录解压"></a>上传服务器指定目录解压</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">tar -xf apache-hive-2.3.9-bin.tar.gz<br></code></pre></td></tr></table></figure><h2 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h2><p><code>vi /etc/profile.d/hive.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">export HIVE_HOME=/opt/hadoop/hive/apache-hive-2.3.9-bin<br>export PATH=$PATH:$HIVE_HOME/bin<br></code></pre></td></tr></table></figure><p><code>source /etc/profile.d/hive.sh</code> </p><h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><p>拷贝一个新的配置文件 <code>cp hive-default.xml.template hive-site.xml</code></p><p><code>hive</code>需要把元数据存储到<code>mysql</code>里面，把驱动 <code>mysql-connector-java-5.1.48.jar</code> 放到 <code>apache-hive-2.3.9-bin/lib</code> 下。</p><p>找到以下节点修改成</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>javax.jdo.option.ConnectionURL<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>jdbc:mysql://172.16.100.177:3306/hive?createDatabaseIfNotExist=true<span class="hljs-symbol">&amp;amp;</span>useSSL=false<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>JDBC connect string for a JDBC metastore<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>javax.jdo.option.ConnectionDriverName<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>com.mysql.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Driver class name for a JDBC metastore<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>javax.jdo.option.ConnectionUserName<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>root<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>username to use against metastore database<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><br>   <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>javax.jdo.option.ConnectionPassword<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>soyuan.123<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>password to use against metastore database<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br></code></pre></td></tr></table></figure><p>xml文件中 <code>&amp;</code> 替换成 <code>&amp;amp;</code></p><h2 id="生成数据库"><a href="#生成数据库" class="headerlink" title="生成数据库"></a>生成数据库</h2><p>保证上面的配置都对的情况下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">schematool -dbType mysql -initSchema<br></code></pre></td></tr></table></figure><h2 id="修改配置文件本地路径"><a href="#修改配置文件本地路径" class="headerlink" title="修改配置文件本地路径"></a>修改配置文件本地路径</h2><p>把配置文件里面的  <code>$&#123;system:java.io.tmpdir</code>}   <code>$&#123;system:user.name&#125;</code> 都换成本地的绝对路径，不然会报错。</p><p>创建目录 <code>/opt/hadoop/hive/tmp</code></p><p>把<code>$&#123;system:java.io.tmpdir&#125;</code> 改成 <code>/opt/hadoop/hive/tmp</code></p><p>把*<code>$&#123;system:user.name&#125;</code>* 改成<code>cdh1</code></p><h2 id="创建hdfs文件夹"><a href="#创建hdfs文件夹" class="headerlink" title="创建hdfs文件夹"></a>创建hdfs文件夹</h2><p>因为配置文件配置了路径</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hive.metastore.warehouse.dir<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>/user/hive/warehouse<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>location of default database for the warehouse<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><br> <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hive.exec.scratchdir<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>/user/hive/tmp<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>HDFS root scratch dir for Hive jobs which gets created with write all (733) permission. For each connecting user, an HDFS scratch dir: $&#123;hive.exec.scratchdir&#125;/<span class="hljs-symbol">&amp;lt;</span>username<span class="hljs-symbol">&amp;gt;</span> is created, with $&#123;hive.scratch.dir.permission&#125;.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><br> <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hive.querylog.location<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>/user/hive/log<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Location of Hive run time structured log file<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">hdfs dfs -<span class="hljs-built_in">mkdir</span> -p /user/hive/warehouse</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">hdfs dfs -<span class="hljs-built_in">mkdir</span> -p /user/hive/tmp</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">hdfs dfs -<span class="hljs-built_in">mkdir</span> -p /user/hive/log</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">hdfs dfs -<span class="hljs-built_in">chmod</span> -R 777 /user/hive/warehouse</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">hdfs dfs -<span class="hljs-built_in">chmod</span> -R 777 /user/hive/tmp</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">hdfs dfs -<span class="hljs-built_in">chmod</span> -R 777 /user/hive/log</span><br></code></pre></td></tr></table></figure><h2 id="使用客户端"><a href="#使用客户端" class="headerlink" title="使用客户端"></a>使用客户端</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">hive</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">show databases;</span> <br></code></pre></td></tr></table></figure><h2 id="启动HiveServer2服务"><a href="#启动HiveServer2服务" class="headerlink" title="启动HiveServer2服务"></a>启动HiveServer2服务</h2><p>在每个hadoop 节点下修改<code>core-stie.xml</code> 增加配置,链接时候的账号密码 <code>root/root</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- hive配置   --&gt;</span>       <br> <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>     <br>        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hadoop.proxyuser.root.hosts<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>     <br>        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>*<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span> <br><span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>     <br>        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hadoop.proxyuser.root.groups<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>*<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span> <br><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br></code></pre></td></tr></table></figure><p>HiveServer2（HS2）是一个服务端接口，使远程客户端可以执行对Hive的查询并返回结果。目前基于Thrift RPC的实现是HiveServer的改进版本，并支持多客户端并发和身份验证</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">hiveserver2</span><br></code></pre></td></tr></table></figure><p>如果正式使用可以打包成系统服务</p><h2 id="web页面"><a href="#web页面" class="headerlink" title="web页面"></a>web页面</h2><p><code>http://cdh1:10002/</code></p><h2 id="beeline客户端测试"><a href="#beeline客户端测试" class="headerlink" title="beeline客户端测试"></a>beeline客户端测试</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">!connect jdbc:hive2://cdh1:10000/hive1</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">账号密码都是 root/root</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>hadoop</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hadoop</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hue安装</title>
    <link href="/wiki/2021/11/30/hadoop/hue%E5%AE%89%E8%A3%85/"/>
    <url>/wiki/2021/11/30/hadoop/hue%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3.1&#x27;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">mongo:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">gethue/hue:latest</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">hue</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">8888</span><span class="hljs-string">:8888</span> <br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./hue.ini:/usr/share/hue/desktop/conf/hue.ini</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/hosts:/etc/hosts</span><br></code></pre></td></tr></table></figure><h3 id="配置hadoop"><a href="#配置hadoop" class="headerlink" title="配置hadoop"></a>配置hadoop</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[hadoop]</span><br><br><span class="hljs-comment"># Configuration for HDFS NameNode</span><br><span class="hljs-comment"># ------------------------------------------------------------------------</span><br><span class="hljs-section">[[hdfs_clusters]]</span><br>  <span class="hljs-comment"># HA support by using HttpFs</span><br><br><span class="hljs-section">[[[default]]]</span><br><span class="hljs-comment"># Enter the filesystem uri</span><br><span class="hljs-attr">fs_defaultfs</span>=hdfs://<span class="hljs-number">172.16</span>.<span class="hljs-number">100.63</span>:<span class="hljs-number">8020</span><br><br></code></pre></td></tr></table></figure><p>配置yarn集群</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[[yarn_clusters]]</span><br><br><span class="hljs-section">[[[default]]]</span><br><span class="hljs-comment"># Enter the host on which you are running the ResourceManager</span><br><span class="hljs-comment">## resourcemanager_host=localhost</span><br><br><span class="hljs-comment"># The port where the ResourceManager IPC listens on</span><br><span class="hljs-comment">## resourcemanager_port=8032</span><br><br><span class="hljs-comment"># Whether to submit jobs to this cluster</span><br><span class="hljs-attr">submit_to</span>=<span class="hljs-literal">True</span><br><br><span class="hljs-comment"># Resource Manager logical name (required for HA)</span><br><span class="hljs-comment">## logical_name=</span><br><br><span class="hljs-comment"># Change this if your YARN cluster is Kerberos-secured</span><br><span class="hljs-comment">## security_enabled=false</span><br><br><span class="hljs-comment"># URL of the ResourceManager API</span><br><span class="hljs-comment">## resourcemanager_api_url=http://localhost:8088</span><br><br><span class="hljs-comment"># URL of the ProxyServer API</span><br><span class="hljs-comment">## proxy_api_url=http://localhost:8088</span><br><br><span class="hljs-comment"># URL of the HistoryServer API</span><br> <span class="hljs-attr">history_server_api_url</span>=http://<span class="hljs-number">172.16</span>.<span class="hljs-number">100.71</span>:<span class="hljs-number">10020</span><br><br><span class="hljs-comment"># URL of the Spark History Server</span><br><span class="hljs-comment">## spark_history_server_url=http://localhost:18088</span><br><br><span class="hljs-comment"># Change this if your Spark History Server is Kerberos-secured</span><br><span class="hljs-comment">## spark_history_server_security_enabled=false</span><br><br><span class="hljs-comment"># In secure mode (HTTPS), if SSL certificates from YARN Rest APIs</span><br><span class="hljs-comment"># have to be verified against certificate authority</span><br><span class="hljs-comment">## ssl_cert_ca_verify=True</span><br><br>  <span class="hljs-comment"># HA support by specifying multiple clusters.</span><br>  <span class="hljs-comment"># Redefine different properties there.</span><br>  <span class="hljs-comment"># e.g.</span><br><br>  <span class="hljs-comment"># [[[ha]]]</span><br>  <span class="hljs-comment"># Resource Manager logical name (required for HA)</span><br>  <span class="hljs-comment">## logical_name=my-rm-name</span><br><br>  <span class="hljs-comment"># Un-comment to enable</span><br>  <span class="hljs-comment">## submit_to=True</span><br><br>  <span class="hljs-comment"># URL of the ResourceManager API</span><br>  <span class="hljs-attr">resourcemanager_api_url</span>=http://<span class="hljs-number">172.16</span>.<span class="hljs-number">100.63</span>:<span class="hljs-number">8088</span><br><br>  <span class="hljs-comment"># ...</span><br><br><br><span class="hljs-comment">###########################################################################</span><br><span class="hljs-comment"># Settings to configure Beeswax with Hive</span><br><span class="hljs-comment">###########################################################################</span><br><br></code></pre></td></tr></table></figure><h3 id="thrift-version-版本"><a href="#thrift-version-版本" class="headerlink" title="thrift_version 版本"></a>thrift_version 版本</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">thrift_version</span>=<span class="hljs-number">7</span><br></code></pre></td></tr></table></figure><h3 id="配置mysql数据库"><a href="#配置mysql数据库" class="headerlink" title="配置mysql数据库"></a>配置mysql数据库</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[[database]]</span><br><span class="hljs-attr">engine</span>=mysql<br><span class="hljs-attr">host</span>=<span class="hljs-number">172.16</span>.<span class="hljs-number">100.177</span><br><span class="hljs-attr">port</span>=<span class="hljs-number">3306</span><br><span class="hljs-attr">user</span>=root<br><span class="hljs-attr">password</span>=soyuan.<span class="hljs-number">123</span><br><span class="hljs-attr">name</span>=huedb<br></code></pre></td></tr></table></figure><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker-compose up -d<br></code></pre></td></tr></table></figure><p>第一次启动先创建个用户 <code>root,root</code></p><p><code>http://172.16.100.92:8888/</code></p>]]></content>
    
    
    <categories>
      
      <category>hadoop</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hadoop</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kafka集群</title>
    <link href="/wiki/2021/11/30/hadoop/kafka%E9%9B%86%E7%BE%A4/"/>
    <url>/wiki/2021/11/30/hadoop/kafka%E9%9B%86%E7%BE%A4/</url>
    
    <content type="html"><![CDATA[<h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><p>kafka_2.12-3.0.0</p><h2 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h2><table><thead><tr><th>机器</th><th>ip</th></tr></thead><tbody><tr><td>cdh1</td><td>172.16.100.63</td></tr><tr><td>cdh2</td><td>172.16.100.64</td></tr><tr><td>cdh3</td><td>172.16.100.71</td></tr></tbody></table><h2 id="配置服务器"><a href="#配置服务器" class="headerlink" title="配置服务器"></a>配置服务器</h2><ul><li>时间同步</li><li>免密码登录</li><li>hosts</li><li>关闭防火墙</li><li>安装jdk</li></ul><h2 id="在所有服务器-cdh1-cdh2-cdh3-配置环境变量"><a href="#在所有服务器-cdh1-cdh2-cdh3-配置环境变量" class="headerlink" title="在所有服务器(cdh1,cdh2,cdh3)配置环境变量"></a>在所有服务器(cdh1,cdh2,cdh3)配置环境变量</h2><p>把安装包上传到服务器</p><p><code>vi /etc/profile.d/kafka.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">export KAFKA_HOME=/opt/hadoop/kafka/kafka_2.12-3.0.0<br>export PATH=$PATH:$KAFKA_HOME/bin <br></code></pre></td></tr></table></figure><p><code>source /etc/profile.d/kafka.sh</code></p><h2 id="在config目录下配置集群"><a href="#在config目录下配置集群" class="headerlink" title="在config目录下配置集群"></a>在config目录下配置集群</h2><p><code>vi server.properties</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">broker.id=0<br>listeners=PLAINTEXT://cdh1:9092<br>log.dirs=/tmp/kafka-logs<br>log.dirs=/opt/hadoop/kafka/kafka-logs<br>zookeeper.connect=cdh1:2181,cdh2:2181,cdh3:2181<br></code></pre></td></tr></table></figure><p><code>broker.id</code> 每个集群的id不能一样</p><h2 id="把服务分发到每个服务器"><a href="#把服务分发到每个服务器" class="headerlink" title="把服务分发到每个服务器"></a>把服务分发到每个服务器</h2><p>分发之后别忘了改<code>broker.id</code> <code>listeners=PLAINTEXT</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">scp -r kafka/ cdh2:/opt/hadoop/<br>scp -r kafka/ cdh3:/opt/hadoop/<br></code></pre></td></tr></table></figure><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>每台机器执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kafka-server-start.sh -daemon /opt/hadoop/kafka/kafka_2.12-3.0.0/config/server.properties<br></code></pre></td></tr></table></figure><h2 id="启动完成后，查看zookeeper集群连接情况"><a href="#启动完成后，查看zookeeper集群连接情况" class="headerlink" title="启动完成后，查看zookeeper集群连接情况"></a>启动完成后，查看zookeeper集群连接情况</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">链接zookeeper</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">zkCil.sh</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看brokers</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">ls</span> /brokers</span><br>[ids, seqid, topics]<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">brokers ids</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">ls</span> /brokers/ids</span><br>[0, 1, 3]<br></code></pre></td></tr></table></figure><h2 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">查看所有通道</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kafka-topics.sh --list --bootstrap-server cdh1:9092</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">删除通道</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kafka-topics.sh --bootstrap-server cdh1:9092 --delete --topic lot_userinfo_v2</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">消费</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kafka-console-consumer.sh --bootstrap-server cdh1:9092 --topic lot_userinfo_v2</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看通道信息</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kafka-topics.sh --bootstrap-server cdh1:9092 --topic lot_userinfo_v2 --describe</span><br></code></pre></td></tr></table></figure><h2 id="kafka-manager-安装"><a href="#kafka-manager-安装" class="headerlink" title="kafka-manager 安装"></a>kafka-manager 安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker pull sheepkiller/kafka-manager</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d --name kfk-manager --restart always -p 9000:9000 -e ZK_HOSTS=172.16.100.63:2181,172.16.100.64:2181,172.16.100.71:2181 sheepkiller/kafka-manager</span><br></code></pre></td></tr></table></figure><h3 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h3><p><code>http://172.16.100.92:9000/</code></p>]]></content>
    
    
    <categories>
      
      <category>hadoop</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hadoop</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kettle配置hadoop,hbaseoutput</title>
    <link href="/wiki/2021/11/30/hadoop/kettle%E9%85%8D%E7%BD%AEhadoop,hbaseoutput/"/>
    <url>/wiki/2021/11/30/hadoop/kettle%E9%85%8D%E7%BD%AEhadoop,hbaseoutput/</url>
    
    <content type="html"><![CDATA[<h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><p>pdi-ce-8.3.0.0-371</p><p>这个连接hadoop的时候， 9.x版本有问题</p><h2 id="下载并解压到电脑"><a href="#下载并解压到电脑" class="headerlink" title="下载并解压到电脑"></a>下载并解压到电脑</h2><p><a href="https://sourceforge.net/projects/pentaho/files/Pentaho%208.3/client-tools/">下载链接</a></p><h2 id="配置hadoop集群"><a href="#配置hadoop集群" class="headerlink" title="配置hadoop集群"></a>配置hadoop集群</h2><h3 id="按照下图进行添加hadoop"><a href="#按照下图进行添加hadoop" class="headerlink" title="按照下图进行添加hadoop"></a>按照下图进行添加hadoop</h3><p> <img src="/wiki/img/hadoop/1.png"></p><h3 id="点击测试hadoop集群"><a href="#点击测试hadoop集群" class="headerlink" title="点击测试hadoop集群"></a>点击测试hadoop集群</h3><p> <img src="/wiki/img/hadoop/2.png"></p><h2 id="同步hadoop配置文件"><a href="#同步hadoop配置文件" class="headerlink" title="同步hadoop配置文件"></a>同步hadoop配置文件</h2><p><code>hadoop</code>  <code>/hadoop-3.2.0/etc/hadoop</code> 目录下配置：<code>yarn-site.xml</code>，<code>mapred-site.xml</code>，<code>hdfs-site.xml</code>，<code>core-site.xml</code></p><p> <code>hbase</code>  <code>/hbase-2.4.9/conf</code> 目录下：<code>hbase-site.xml</code></p><p>全部覆盖到 <code>\pdi-ce-8.3.0.0-371\data-integration\plugins\pentaho-big-data-plugin\hadoop-configurations\hdp30</code></p><p>重启 <code>kettle</code></p><h2 id="测试是否能查看hdfs目录"><a href="#测试是否能查看hdfs目录" class="headerlink" title="测试是否能查看hdfs目录"></a>测试是否能查看hdfs目录</h2><p>拖拽一个 <code>核心对象</code> &gt; <code>Big Data</code> &gt; <code>Hadoop file output</code></p><p> <img src="/wiki/img/hadoop/3.png"></p><h2 id="mysql-数据抽取到-hbase-output"><a href="#mysql-数据抽取到-hbase-output" class="headerlink" title="mysql 数据抽取到 hbase output"></a>mysql 数据抽取到 hbase output</h2><h3 id="新建mysql数据库"><a href="#新建mysql数据库" class="headerlink" title="新建mysql数据库"></a>新建mysql数据库</h3><p>如果没有驱动去oracle下载mysql驱动，然后放到<code>\pdi-ce-8.3.0.0-371\data-integration\lib</code>，然后重启kettle</p><p> <img src="/wiki/img/hadoop/4.png"></p><h3 id="新增数据输入组件"><a href="#新增数据输入组件" class="headerlink" title="新增数据输入组件"></a>新增数据输入组件</h3><p>数据库链接选择上一步中创建的数据库</p><p> <img src="/wiki/img/hadoop/5.png"></p><p>可以点击预览查看数据</p><h3 id="新增hbase-output-组件"><a href="#新增hbase-output-组件" class="headerlink" title="新增hbase output 组件"></a>新增hbase output 组件</h3><p><code>hadoop cluster</code> 选择上面新建的hadoop</p><p><code>hbase-site.xml</code> 选择上面的<code>hbase</code>配置文件</p><p> <img src="/wiki/img/hadoop/6.png"></p><h3 id="增加hbase-mapping映射关系"><a href="#增加hbase-mapping映射关系" class="headerlink" title="增加hbase mapping映射关系"></a>增加hbase mapping映射关系</h3><p>hbase中的每个表都可以创建多个映射关系，一对多的，想要导入数据就必须先表创建映射关系</p><p> <img src="/wiki/img/hadoop/7.png"></p><ol><li>为表创建mapping</li><li>hbase库中的表</li><li>新创建的mapping表名，这个可以输入，也可以获取表中已经存在的mapping 就是修改</li><li>保存/修改mapping</li><li>获取表输入的字段</li></ol><p><code>Alias</code> 表输入的字段</p><p><code>Key</code> 是否是主键，如果是在<code>hbase</code>里面就是<code>RowKey</code></p><p><code>Column family</code> hbase 列族</p><p><code>Column name</code> hbase 列名</p><p><code>Type</code> 字段类型</p><h3 id="配置hbase-output-链接信息"><a href="#配置hbase-output-链接信息" class="headerlink" title="配置hbase output 链接信息"></a>配置hbase output 链接信息</h3><p> <img src="/wiki/img/hadoop/8.png"></p><p><code>Hbase table name</code>  hbase表名，如果前面没有为这个表配置mapping，这里不显示</p><p><code>mapping name</code> hbase表的mapping</p><h2 id="输出输入关系"><a href="#输出输入关系" class="headerlink" title="输出输入关系"></a>输出输入关系</h2><p>按住shift 先点击输入组件再点击输出组件，如下图</p><p> <img src="/wiki/img/hadoop/9.png"></p><h2 id="开始执行"><a href="#开始执行" class="headerlink" title="开始执行"></a>开始执行</h2>]]></content>
    
    
    <categories>
      
      <category>hadoop</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hadoop</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>phoneix 安装</title>
    <link href="/wiki/2021/11/30/hadoop/phoneix%20%E5%AE%89%E8%A3%85/"/>
    <url>/wiki/2021/11/30/hadoop/phoneix%20%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><p>phoenix-hbase-2.4-5.1.2-bin</p><h2 id="上传服务器指定目录解压"><a href="#上传服务器指定目录解压" class="headerlink" title="上传服务器指定目录解压"></a>上传服务器指定目录解压</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">tar -xf phoenix-hbase-2.4-5.1.2-bin.tar.gz<br></code></pre></td></tr></table></figure><h2 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h2><p><code>vi /etc/profile.d/phoenix.sh</code> </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">export PHOENIX_HOME=/opt/hadoop/phoenix/phoenix-hbase-2.4-5.1.2-bin<br>export PATH=$PATH:$PHOENIX_HOME/bin<br></code></pre></td></tr></table></figure><h2 id="拷贝jar包到所有节点"><a href="#拷贝jar包到所有节点" class="headerlink" title="拷贝jar包到所有节点"></a>拷贝jar包到所有节点</h2><p><strong>只拷贝这一个jar，千万别拷贝多了</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cp</span> phoenix-server-hbase-2.4-5.1.2.jar /opt/hadoop/hbase/hbase-2.4.9/lib/</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">scp phoenix-server-hbase-2.4-5.1.2.jar cdh2:/opt/hadoop/hbase/hbase-2.4.9/lib/</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">scp phoenix-server-hbase-2.4-5.1.2.jar cdh3:/opt/hadoop/hbase/hbase-2.4.9/lib/</span><br></code></pre></td></tr></table></figure><h2 id="修改hbase配置文件"><a href="#修改hbase配置文件" class="headerlink" title="修改hbase配置文件"></a>修改hbase配置文件</h2><p><code>修改完配置文件，发送到各个子节点</code></p><p><code>vi hbase-site.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--增加节点,防止启动Phoenix的时候报错，导致hbase节点终止 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hbase.coprocessor.abortonerror<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><br><span class="hljs-comment">&lt;!--hbase可变索引默认没有开启 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hbase.regionserver.wal.codec<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>org.apache.hadoop.hbase.regionserver.wal.IndexedWALEditCodec<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span> <br><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>hadoop</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hadoop</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>二进制减法</title>
    <link href="/wiki/2021/11/30/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%A6%82%E8%AE%BA/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%87%8F%E6%B3%95/"/>
    <url>/wiki/2021/11/30/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%A6%82%E8%AE%BA/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%87%8F%E6%B3%95/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>计算机概论</category>
      
    </categories>
    
    
    <tags>
      
      <tag>计算机概论</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jenkins gitee插件</title>
    <link href="/wiki/2021/11/24/jenkins/jenkins-gitee%E6%8F%92%E4%BB%B6/"/>
    <url>/wiki/2021/11/24/jenkins/jenkins-gitee%E6%8F%92%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jenkins远程触发构建</title>
    <link href="/wiki/2021/11/24/jenkins/jenkins%E8%BF%9C%E7%A8%8B%E8%A7%A6%E5%8F%91%E6%9E%84%E5%BB%BA/"/>
    <url>/wiki/2021/11/24/jenkins/jenkins%E8%BF%9C%E7%A8%8B%E8%A7%A6%E5%8F%91%E6%9E%84%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<p>s</p>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>etcd安装</title>
    <link href="/wiki/2021/11/24/k8s/etcd%E5%AE%89%E8%A3%85/"/>
    <url>/wiki/2021/11/24/k8s/etcd%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><p>etcd Version: 3.5.1</p><h2 id="单机版本安装"><a href="#单机版本安装" class="headerlink" title="单机版本安装"></a>单机版本安装</h2><h3 id="下载安装包解压到服务器"><a href="#下载安装包解压到服务器" class="headerlink" title="下载安装包解压到服务器"></a>下载安装包解压到服务器</h3><p><code>https://github.com/etcd-io/etcd/releases</code></p><p>解压到 <code>/soyuan/k8s/etcd</code></p><p>命令移动到：<code>mv /soyuan/k8s/etcd/etcd-v3.5.1-linux-amd64/etcd* /usr/local/bin/</code></p><h3 id="安装到系统服务"><a href="#安装到系统服务" class="headerlink" title="安装到系统服务"></a>安装到系统服务</h3><p><code>vi /usr/lib/systemd/system/etcd.service</code> </p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Unit]</span><br><span class="hljs-attr">Description</span>=Etcd service<br><span class="hljs-attr">After</span>=network.target<br><br><span class="hljs-section">[Service]</span><br><span class="hljs-attr">Type</span>=simple<br><span class="hljs-attr">WorkingDirectory</span>=/soyuan/k8s/etcd<br><span class="hljs-attr">EnvironmentFile</span>=-/soyuan/k8s/etcd/etcd.conf<br><span class="hljs-attr">ExecStart</span>=/usr/local/bin/etcd<br><br><br><span class="hljs-section">[Install]</span><br><span class="hljs-attr">WantedBy</span>=multi-user.target<br></code></pre></td></tr></table></figure><p><code>增加环境变量配置文件</code></p><p><code>vi etcd.conf</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">ETCD_NAME</span>=default<br><span class="hljs-attr">ETCD_DATA_DIR</span>=<span class="hljs-string">&quot;/soyuan/k8s/etcd/default.etcd&quot;</span><br><span class="hljs-attr">ETCD_LISTEN_CLIENT_URLS</span>=<span class="hljs-string">&quot;http://0.0.0.0:2379&quot;</span><br><span class="hljs-attr">ETCD_ADVERTISE_CLIENT_URLS</span>=<span class="hljs-string">&quot;http://0.0.0.0:2379&quot;</span><br></code></pre></td></tr></table></figure><h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">启动服务</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl start etcd</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">添加到开机运行</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> etcd</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看运行状态</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">etcdctl endpoint health</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>falnnel网络</title>
    <link href="/wiki/2021/11/24/k8s/falnnel%E7%BD%91%E7%BB%9C/"/>
    <url>/wiki/2021/11/24/k8s/falnnel%E7%BD%91%E7%BB%9C/</url>
    
    <content type="html"><![CDATA[<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">etcd里面存储一个子网信息</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">etcdctl --endpoints=<span class="hljs-string">&quot;http://172.16.100.92:2379&quot;</span> put /coreos.com/network/config  <span class="hljs-string">&#x27;&#123; &quot;Network&quot;: &quot;172.17.0.0/16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;&#x27;</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">etcdctl --endpoints=<span class="hljs-string">&quot;http://172.16.100.92:2379&quot;</span> get /coreos.com/network/config</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">二进制包上传上服务器</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">tar zxvf flannel-v0.11.0-linux-amd64.tar.gz</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mv</span> flanneld mk-docker-opts.sh /usr/local/bin</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">新建启动环境变量</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> /soyuan/k8s/cfg/flanneld</span><br>FLANNEL_OPTIONS=&quot;--etcd-endpoints=http://172.16.100.92:2379&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">新建系统服务文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> /usr/lib/systemd/system/flanneld.service</span><br><br>[Unit]<br>Description=Flanneld overlay address etcd agent<br>After=network-online.target network.target<br>Before=docker.service<br>  <br>[Service]<br>Type=notify<br>EnvironmentFile=/soyuan/k8s/cfg/flanneld<br>ExecStart=/usr/local/bin/flanneld --ip-masq $FLANNEL_OPTIONS<br>ExecStartPost=/usr/local/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/subnet.env   # 生成docker的网段参数<br>Restart=on-failure<br><br>[Install]<br>WantedBy=multi-user.target<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动服务</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl start flanneld</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> flanneld</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">配置Docker启动指定子网段</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> /usr/lib/systemd/system/docker.service</span><br><br>[Unit]<br>Description=Docker Application Container Engine<br>Documentation=https://docs.docker.com<br>After=network-online.target firewalld.service<br>Wants=network-online.target<br><br>[Service]<br>Type=notify<br>EnvironmentFile=/run/flannel/subnet.env<br>ExecStart=/usr/local/bin/dockerd $DOCKER_NETWORK_OPTIONS -H tcp://0.0.0.0:2371 -H unix:///var/run/docker.sock<br>ExecReload=/bin/kill -s HUP $MAINPID<br>LimitNOFILE=infinity<br>LimitNPROC=infinity<br>TimeoutStartSec=0<br>Delegate=yes<br>KillMode=process<br>Restart=on-failure<br>StartLimitBurst=3<br>StartLimitInterval=60s<br><br>[Install]<br>WantedBy=multi-user.target<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">重启docker</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl restart docker</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">/etc/docker/daemon.json 不要重复配置bip</span><br></code></pre></td></tr></table></figure><h3 id="flanneld-不能和etcd-v3通信问题"><a href="#flanneld-不能和etcd-v3通信问题" class="headerlink" title="flanneld 不能和etcd v3通信问题"></a>flanneld 不能和etcd v3通信问题</h3><p><code>Couldn&#39;t fetch network config: client: response is invalid json. The endpoint is probably not valid etcd cluster endpoint</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">删除刚才创建的key</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">etcdctl get --prefix /coreos.com</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">etcdctl del /coreos.com/network/config</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">在etcd启动参数里面加入 --enable-v2 参数</span><br>[Unit]<br>Description=Etcd service<br>After=network.target<br><br>[Service]<br>Type=simple<br>WorkingDirectory=/soyuan/k8s/etcd<br>EnvironmentFile=-/soyuan/k8s/etcd/etcd.conf<br>ExecStart=/usr/local/bin/etcd --enable-v2<br><br><br>[Install]<br>WantedBy=multi-user.target<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">重启etcd</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl restart etcd</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">重新导入参数</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">ETCDCTL_API=2 etcdctl --endpoints=<span class="hljs-string">&quot;http://172.16.100.92:2379&quot;</span> <span class="hljs-built_in">set</span> /coreos.com/network/config <span class="hljs-string">&#x27;&#123; &quot;Network&quot;: &quot;172.17.0.0/16&quot;, &quot;Backend&quot;:  &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;&#x27;</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">参看配置</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">ETCDCTL_API=2 etcdctl get /coreos.com/network/config</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ingress</title>
    <link href="/wiki/2021/11/24/k8s/ingress/"/>
    <url>/wiki/2021/11/24/k8s/ingress/</url>
    
    <content type="html"><![CDATA[<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Namespace</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">ingress-nginx</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">ingress-nginx</span><br>    <span class="hljs-attr">app.kubernetes.io/part-of:</span> <span class="hljs-string">ingress-nginx</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-configuration</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">ingress-nginx</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">ingress-nginx</span><br>    <span class="hljs-attr">app.kubernetes.io/part-of:</span> <span class="hljs-string">ingress-nginx</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">tcp-services</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">ingress-nginx</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">ingress-nginx</span><br>    <span class="hljs-attr">app.kubernetes.io/part-of:</span> <span class="hljs-string">ingress-nginx</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">udp-services</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">ingress-nginx</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">ingress-nginx</span><br>    <span class="hljs-attr">app.kubernetes.io/part-of:</span> <span class="hljs-string">ingress-nginx</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress-serviceaccount</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">ingress-nginx</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">ingress-nginx</span><br>    <span class="hljs-attr">app.kubernetes.io/part-of:</span> <span class="hljs-string">ingress-nginx</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress-clusterrole</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">ingress-nginx</span><br>    <span class="hljs-attr">app.kubernetes.io/part-of:</span> <span class="hljs-string">ingress-nginx</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">configmaps</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">endpoints</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">pods</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">secrets</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">services</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">events</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">create</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">patch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;extensions&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;networking.k8s.io&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ingresses</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;extensions&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;networking.k8s.io&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ingresses/status</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">update</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress-role</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">ingress-nginx</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">ingress-nginx</span><br>    <span class="hljs-attr">app.kubernetes.io/part-of:</span> <span class="hljs-string">ingress-nginx</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">configmaps</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">pods</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">secrets</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">namespaces</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">configmaps</span><br>    <span class="hljs-attr">resourceNames:</span><br>      <span class="hljs-comment"># Defaults to &quot;&lt;election-id&gt;-&lt;ingress-class&gt;&quot;</span><br>      <span class="hljs-comment"># Here: &quot;&lt;ingress-controller-leader&gt;-&lt;nginx&gt;&quot;</span><br>      <span class="hljs-comment"># This has to be adapted if you change either parameter</span><br>      <span class="hljs-comment"># when launching the nginx-ingress-controller.</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;ingress-controller-leader-nginx&quot;</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">update</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">configmaps</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">create</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">endpoints</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">RoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress-role-nisa-binding</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">ingress-nginx</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">ingress-nginx</span><br>    <span class="hljs-attr">app.kubernetes.io/part-of:</span> <span class="hljs-string">ingress-nginx</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress-role</span><br><span class="hljs-attr">subjects:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress-serviceaccount</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">ingress-nginx</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress-clusterrole-nisa-binding</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">ingress-nginx</span><br>    <span class="hljs-attr">app.kubernetes.io/part-of:</span> <span class="hljs-string">ingress-nginx</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress-clusterrole</span><br><span class="hljs-attr">subjects:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress-serviceaccount</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">ingress-nginx</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress-controller</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">ingress-nginx</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">ingress-nginx</span><br>    <span class="hljs-attr">app.kubernetes.io/part-of:</span> <span class="hljs-string">ingress-nginx</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">ingress-nginx</span><br>      <span class="hljs-attr">app.kubernetes.io/part-of:</span> <span class="hljs-string">ingress-nginx</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">ingress-nginx</span><br>        <span class="hljs-attr">app.kubernetes.io/part-of:</span> <span class="hljs-string">ingress-nginx</span><br>      <span class="hljs-attr">annotations:</span><br>        <span class="hljs-attr">prometheus.io/port:</span> <span class="hljs-string">&quot;10254&quot;</span><br>        <span class="hljs-attr">prometheus.io/scrape:</span> <span class="hljs-string">&quot;true&quot;</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-comment"># wait up to five minutes for the drain of connections</span><br>      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 需要添加这句，使用主机网络</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">nginx-ingress-serviceaccount</span><br>      <span class="hljs-attr">nodeSelector:</span><br>        <span class="hljs-attr">kubernetes.io/os:</span> <span class="hljs-string">linux</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">public</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress-controller</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">/nginx-ingress-controller</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--configmap=$(POD_NAMESPACE)/nginx-configuration</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--udp-services-configmap=$(POD_NAMESPACE)/udp-services</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--publish-service=$(POD_NAMESPACE)/ingress-nginx</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--annotations-prefix=nginx.ingress.kubernetes.io</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--http-port=10000</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--https-port=10001</span>  <br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--default-server-port=10002</span><br>          <span class="hljs-attr">securityContext:</span><br>            <span class="hljs-attr">allowPrivilegeEscalation:</span> <span class="hljs-literal">true</span><br>            <span class="hljs-attr">capabilities:</span><br>              <span class="hljs-attr">drop:</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">ALL</span><br>              <span class="hljs-attr">add:</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">NET_BIND_SERVICE</span><br>            <span class="hljs-comment"># www-data -&gt; 101</span><br>            <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">101</span><br>          <span class="hljs-attr">env:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAME</span><br>              <span class="hljs-attr">valueFrom:</span><br>                <span class="hljs-attr">fieldRef:</span><br>                  <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.name</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAMESPACE</span><br>              <span class="hljs-attr">valueFrom:</span><br>                <span class="hljs-attr">fieldRef:</span><br>                  <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.namespace</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10000</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">https</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">10001</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/healthz</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-number">10254</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">10</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span><br>            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">10</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/healthz</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-number">10254</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span><br>            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">10</span><br>          <span class="hljs-attr">lifecycle:</span><br>            <span class="hljs-attr">preStop:</span><br>              <span class="hljs-attr">exec:</span><br>                <span class="hljs-attr">command:</span><br>                  <span class="hljs-bullet">-</span> <span class="hljs-string">/wait-shutdown</span><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">LimitRange</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">ingress-nginx</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">ingress-nginx</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">ingress-nginx</span><br>    <span class="hljs-attr">app.kubernetes.io/part-of:</span> <span class="hljs-string">ingress-nginx</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">limits:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">min:</span><br>      <span class="hljs-attr">memory:</span> <span class="hljs-string">90Mi</span><br>      <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">Container</span><br></code></pre></td></tr></table></figure><p><code>ingress-nginx.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">extensions/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">ingress-nginx</span>        <span class="hljs-comment">#自定义ingress名称</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">gitlab.soyuan.com.cn</span>     <span class="hljs-comment"># 自定义域名</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/cloud</span><br>        <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">cloud-svc</span>  <span class="hljs-comment"># 对应上面创建的service名称</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">30002</span><br></code></pre></td></tr></table></figure><p><code>测试服务</code></p><p><code>nginx-deployment.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-deployment</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span> <span class="hljs-comment"># 调度的pod lables</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">nodeSelector:</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">public</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:latest</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-svc</span><br><span class="hljs-attr">spec:</span> <br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span> <br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>k8s gitlab</title>
    <link href="/wiki/2021/11/24/k8s/k8s%20gitlab/"/>
    <url>/wiki/2021/11/24/k8s/k8s%20gitlab/</url>
    
    <content type="html"><![CDATA[<p>先创建pv</p><p><code>gitlab-pv.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># gitlab redis pv</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span><br><span class="hljs-attr">metadata:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-redis-pv</span><br>    <span class="hljs-attr">labels:</span><br>      <span class="hljs-attr">release:</span> <span class="hljs-string">&quot;gitlab-redis-pv&quot;</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">capacity:</span><br>    <span class="hljs-attr">storage:</span> <span class="hljs-string">50Gi</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">persistentVolumeReclaimPolicy:</span> <span class="hljs-string">Retain</span> <br>  <span class="hljs-attr">nfs:</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">/soyuan/k8s/data/gitlab/redis</span><br>    <span class="hljs-attr">server:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.100</span><span class="hljs-number">.224</span><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-comment"># gitlab postgresql pv</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span><br><span class="hljs-attr">metadata:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-postgresql-pv</span><br>    <span class="hljs-attr">labels:</span><br>      <span class="hljs-attr">release:</span> <span class="hljs-string">&quot;gitlab-postgresql-pv&quot;</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">capacity:</span><br>    <span class="hljs-attr">storage:</span> <span class="hljs-string">50Gi</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">persistentVolumeReclaimPolicy:</span> <span class="hljs-string">Retain</span> <br>  <span class="hljs-attr">nfs:</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">/soyuan/k8s/data/gitlab/postgresql</span><br>    <span class="hljs-attr">server:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.100</span><span class="hljs-number">.224</span><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-comment"># gitlab pv</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span><br><span class="hljs-attr">metadata:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-pv</span><br>    <span class="hljs-attr">labels:</span><br>      <span class="hljs-attr">release:</span> <span class="hljs-string">&quot;gitlab-pv&quot;</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">capacity:</span><br>    <span class="hljs-attr">storage:</span> <span class="hljs-string">50Gi</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">persistentVolumeReclaimPolicy:</span> <span class="hljs-string">Retain</span> <br>  <span class="hljs-attr">nfs:</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">/soyuan/k8s/data/gitlab/gitlab</span><br>    <span class="hljs-attr">server:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.100</span><span class="hljs-number">.224</span><br><br></code></pre></td></tr></table></figure><p><code>gitlab-pvc.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-redis-pvc</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">devops</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">50Gi</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">release:</span> <span class="hljs-string">&quot;gitlab-redis-pv&quot;</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-postgresql-pvc</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">devops</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">50Gi</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">release:</span> <span class="hljs-string">&quot;gitlab-postgresql-pv&quot;</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-pvc</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">devops</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">50Gi</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">release:</span> <span class="hljs-string">&quot;gitlab-pv&quot;</span><br></code></pre></td></tr></table></figure><p><code>gitlab-devops-namespace.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Namespace</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">devops</span><br></code></pre></td></tr></table></figure><p><code>gitlab-redis.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-redis</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">devops</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-redis</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-redis</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-redis</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-redis</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">nodeSelector:</span> <br>        <span class="hljs-attr">type:</span> <span class="hljs-string">public</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-redis</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">sameersbn/redis</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-redis</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">6379</span><br>              <span class="hljs-attr">hostPort:</span> <span class="hljs-number">6379</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/lib/redis</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">data</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">exec:</span><br>              <span class="hljs-attr">command:</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">redis-cli</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">ping</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">exec:</span><br>              <span class="hljs-attr">command:</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">redis-cli</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">ping</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">data</span><br>          <span class="hljs-attr">persistentVolumeClaim:</span><br>            <span class="hljs-attr">claimName:</span> <span class="hljs-string">gitlab-redis-pvc</span><br></code></pre></td></tr></table></figure><p><code>gitlab-postgresql.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-postgresql</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">devops</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-postgresql</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-postgresql</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-postgresql</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-postgresql</span><br>    <span class="hljs-attr">spec:</span>  <br>      <span class="hljs-attr">nodeSelector:</span> <br>        <span class="hljs-attr">type:</span> <span class="hljs-string">public</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab-postgresql</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">sameersbn/postgresql</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">env:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DB_USER</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">gitlab</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DB_PASS</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">soyuan.123</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DB_NAME</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">gitlab_production</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DB_EXTENSION</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">pg_trgm,btree_gist</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">postgres</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">5432</span><br>              <span class="hljs-attr">hostPort:</span> <span class="hljs-number">5432</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/lib/postgresql</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">data</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">exec:</span><br>              <span class="hljs-attr">command:</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">pg_isready</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">-h</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">localhost</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">-U</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">postgres</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">exec:</span><br>              <span class="hljs-attr">command:</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">pg_isready</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">-h</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">localhost</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">-U</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">postgres</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">data</span><br>          <span class="hljs-attr">persistentVolumeClaim:</span><br>            <span class="hljs-attr">claimName:</span> <span class="hljs-string">gitlab-postgresql-pvc</span><br></code></pre></td></tr></table></figure><p><code>gitlab.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">devops</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab</span><br>    <span class="hljs-attr">spec:</span>        <br>      <span class="hljs-attr">nodeSelector:</span> <br>        <span class="hljs-attr">type:</span> <span class="hljs-string">public</span><br>      <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">gitlab</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">sameersbn/gitlab:14.6.2</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">env:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">TZ</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">Asia/Shanghai</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GITLAB_TIMEZONE</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">Beijing</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GITLAB_SECRETS_DB_KEY_BASE</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">long-and-random-alpha-numeric-string</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GITLAB_SECRETS_SECRET_KEY_BASE</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">long-and-random-alpha-numeric-string</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GITLAB_SECRETS_OTP_KEY_BASE</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">long-and-random-alpha-numeric-string</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GITLAB_ROOT_PASSWORD</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">soyuan.123</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GITLAB_ROOT_EMAIL</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">chenc@soyuan.com.cn</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GITLAB_HOST</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">gitlab.soyuan.com.cn</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GITLAB_PORT</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;80&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GITLAB_SSH_PORT</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;22&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GITLAB_NOTIFY_ON_BROKEN_BUILDS</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;true&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GITLAB_NOTIFY_PUSHER</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;false&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GITLAB_BACKUP_SCHEDULE</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">daily</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GITLAB_BACKUP_TIME</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-number">01</span><span class="hljs-string">:00</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DB_TYPE</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">postgres</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DB_HOST</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.100</span><span class="hljs-number">.224</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DB_PORT</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;5432&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DB_USER</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">gitlab</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DB_PASS</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">soyuan.123</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DB_NAME</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">gitlab_production</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">REDIS_HOST</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.100</span><span class="hljs-number">.224</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">REDIS_PORT</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;6379&quot;</span><br><br><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">LDAP_ENABLED</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;true&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">LDAP_LABEL</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;soyuan LDAP&#x27;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">LDAP_HOST</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;172.20.10.105&#x27;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">LDAP_PORT</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;636&#x27;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">LDAP_UID</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;sAMAccountName&#x27;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">LDAP_BIND_DN</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;query@soyuan.com.cn&#x27;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">LDAP_PASS</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;cQ3@46VTJAVG&#x27;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">LDAP_BASE</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;CN=Person,CN=Schema,CN=Configuration,DC=soyuan,DC=com,DC=cn&#x27;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">LDAP_ALLOW_USERNAME_OR_EMAIL_LOGIN</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;true&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">LDAP_VERIFY_SSL</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;true&#x27;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">LDAP_METHOD</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;&#x27;</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span> <br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ssh</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">22</span> <br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/home/git/data</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">data</span><br>          <span class="hljs-comment"># livenessProbe:</span><br>          <span class="hljs-comment">#   httpGet:</span><br>          <span class="hljs-comment">#     path: /</span><br>          <span class="hljs-comment">#     port: 80</span><br>          <span class="hljs-comment">#   initialDelaySeconds: 180</span><br>          <span class="hljs-comment">#   timeoutSeconds: 5</span><br>          <span class="hljs-comment"># readinessProbe:</span><br>          <span class="hljs-comment">#   httpGet:</span><br>          <span class="hljs-comment">#     path: /</span><br>          <span class="hljs-comment">#     port: 80</span><br>          <span class="hljs-comment">#   initialDelaySeconds: 5</span><br>          <span class="hljs-comment">#   timeoutSeconds: 1</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">data</span><br>          <span class="hljs-attr">persistentVolumeClaim:</span><br>            <span class="hljs-attr">claimName:</span> <span class="hljs-string">gitlab-pvc</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>k8s jira</title>
    <link href="/wiki/2021/11/24/k8s/k8s%20jira/"/>
    <url>/wiki/2021/11/24/k8s/k8s%20jira/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>k8s pv pvc</title>
    <link href="/wiki/2021/11/24/k8s/k8s%20pv%20pvc/"/>
    <url>/wiki/2021/11/24/k8s/k8s%20pv%20pvc/</url>
    
    <content type="html"><![CDATA[<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span><br><span class="hljs-attr">metadata:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">pv1</span><br>    <span class="hljs-attr">labels:</span><br>      <span class="hljs-attr">release:</span> <span class="hljs-string">&quot;stable&quot;</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">capacity:</span><br>    <span class="hljs-attr">storage:</span> <span class="hljs-string">5Gi</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">persistentVolumeReclaimPolicy:</span> <span class="hljs-string">Retain</span> <br>  <span class="hljs-attr">nfs:</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">/soyuan/k8s/data/pv1</span><br>    <span class="hljs-attr">server:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.100</span><span class="hljs-number">.224</span><br><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">myclaim</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">1Gi</span> <br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">release:</span> <span class="hljs-string">&quot;stable&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">mypod</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">mynginx</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:latest</span><br>      <span class="hljs-attr">volumeMounts:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">&quot;/var/www/html&quot;</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">mypd</span><br>  <span class="hljs-attr">volumes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">mypd</span><br>      <span class="hljs-attr">persistentVolumeClaim:</span><br>        <span class="hljs-attr">claimName:</span> <span class="hljs-string">myclaim</span><br></code></pre></td></tr></table></figure><p><a href="https://jimmysong.io/kubernetes-handbook/practice/using-nfs-for-persistent-storage.html">https://jimmysong.io/kubernetes-handbook/practice/using-nfs-for-persistent-storage.html</a></p>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>k8s storageclass</title>
    <link href="/wiki/2021/11/24/k8s/k8s%20storageclass/"/>
    <url>/wiki/2021/11/24/k8s/k8s%20storageclass/</url>
    
    <content type="html"><![CDATA[<h2 id="创建权限相关资源"><a href="#创建权限相关资源" class="headerlink" title="创建权限相关资源"></a>创建权限相关资源</h2><p><code>rbac.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client-provisioner</span><br>  <span class="hljs-comment"># replace with namespace where provisioner is deployed</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>        <span class="hljs-comment">#根据实际环境设定namespace,下面类同</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client-provisioner-runner</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;persistentvolumes&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;create&quot;</span>, <span class="hljs-string">&quot;delete&quot;</span>]<br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;persistentvolumeclaims&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>]<br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;storage.k8s.io&quot;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;storageclasses&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>]<br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;events&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;create&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-string">&quot;patch&quot;</span>]<br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">run-nfs-client-provisioner</span><br><span class="hljs-attr">subjects:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client-provisioner</span><br>    <span class="hljs-comment"># replace with namespace where provisioner is deployed</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client-provisioner-runner</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">leader-locking-nfs-client-provisioner</span><br>    <span class="hljs-comment"># replace with namespace where provisioner is deployed</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;endpoints&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;create&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-string">&quot;patch&quot;</span>]<br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">RoleBinding</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">leader-locking-nfs-client-provisioner</span><br><span class="hljs-attr">subjects:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client-provisioner</span><br>    <span class="hljs-comment"># replace with namespace where provisioner is deployed</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">leader-locking-nfs-client-provisioner</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure><h2 id="部署provisioner-deployment"><a href="#部署provisioner-deployment" class="headerlink" title="部署provisioner-deployment"></a>部署provisioner-deployment</h2><p><code>prvisor-deployment.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client-provisioner</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nfs-client-provisioner</span><br>  <span class="hljs-comment"># replace with namespace where provisioner is deployed</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>  <span class="hljs-comment">#与RBAC文件中的namespace保持一致</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nfs-client-provisioner</span><br>  <span class="hljs-attr">strategy:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">Recreate</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nfs-client-provisioner</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nfs-client-provisioner</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">nfs-client-provisioner</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client-provisioner</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/external_storage/nfs-client-provisioner:latest</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client-root</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/persistentvolumes</span><br>          <span class="hljs-attr">env:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">PROVISIONER_NAME</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">test-nfs-storage</span>  <span class="hljs-comment">#provisioner名称,请确保该名称与 nfs-StorageClass.yaml文件中的provisioner名称保持一致</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">NFS_SERVER</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.100</span><span class="hljs-number">.224</span>   <span class="hljs-comment">#NFS Server IP地址</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">NFS_PATH</span> <br>              <span class="hljs-attr">value:</span> <span class="hljs-string">/soyuan/k8s/storage</span>    <span class="hljs-comment">#NFS挂载卷</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client-root</span><br>          <span class="hljs-attr">nfs:</span><br>            <span class="hljs-attr">server:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.100</span><span class="hljs-number">.224</span>  <span class="hljs-comment">#NFS Server IP地址</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/soyuan/k8s/storage</span>     <span class="hljs-comment">#NFS 挂载卷</span><br></code></pre></td></tr></table></figure><h2 id="创建nfs-storageclass"><a href="#创建nfs-storageclass" class="headerlink" title="创建nfs-storageclass"></a>创建nfs-storageclass</h2><p><code>nfs-storage.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">storage.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StorageClass</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">test-nfs-storage</span><br><span class="hljs-attr">provisioner:</span> <span class="hljs-string">test-nfs-storage</span> <span class="hljs-comment">#这里的名称要和provisioner配置文件中的环境变量PROVISIONER_NAME保持一致</span><br><span class="hljs-attr">parameters:</span><br>  <span class="hljs-comment"># archiveOnDelete 指定为 false 表示删除 PVC 后 PV 也会被删除。</span><br>  <span class="hljs-comment"># 如果想在 PVC 被删除后仍旧保留数据的，可指定为 true</span><br>  <span class="hljs-attr">archiveOnDelete:</span> <span class="hljs-string">&quot;false&quot;</span><br></code></pre></td></tr></table></figure><h2 id="创建测试PVC"><a href="#创建测试PVC" class="headerlink" title="创建测试PVC"></a>创建测试PVC</h2><p>pvc也可以使用storageclass</p><p><code>storage-pvc.yaml</code> </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">test-claim</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">volume.beta.kubernetes.io/storage-class:</span> <span class="hljs-string">&quot;test-nfs-storage&quot;</span>   <span class="hljs-comment">#与nfs-StorageClass.yaml metadata.name保持一致</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">1Mi</span><br></code></pre></td></tr></table></figure><h2 id="测试storageclass"><a href="#测试storageclass" class="headerlink" title="测试storageclass"></a>测试storageclass</h2><p>根据pod容器名称生成<code>pvc</code> 和 <code>pv</code></p><p><code>nginx-statefulset.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-web</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nfs-web</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">&quot;nginx&quot;</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nfs-web</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:latest</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">web</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">www</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/usr/share/nginx/html</span><br>  <span class="hljs-attr">volumeClaimTemplates:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">www</span><br>      <span class="hljs-attr">annotations:</span><br>        <span class="hljs-attr">volume.beta.kubernetes.io/storage-class:</span> <span class="hljs-string">test-nfs-storage</span>   <span class="hljs-comment"># 指明storageclass的名称</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">accessModes:</span> [ <span class="hljs-string">&quot;ReadWriteOnce&quot;</span> ]<br>      <span class="hljs-attr">resources:</span><br>        <span class="hljs-attr">requests:</span><br>          <span class="hljs-attr">storage:</span> <span class="hljs-string">1Gi</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>k8s 配置自签发ssl证书</title>
    <link href="/wiki/2021/11/24/k8s/k8s%20%E9%85%8D%E7%BD%AE%E8%87%AA%E7%AD%BE%E5%8F%91ssl%E8%AF%81%E4%B9%A6/"/>
    <url>/wiki/2021/11/24/k8s/k8s%20%E9%85%8D%E7%BD%AE%E8%87%AA%E7%AD%BE%E5%8F%91ssl%E8%AF%81%E4%B9%A6/</url>
    
    <content type="html"><![CDATA[<p>有的<code>pod</code>需要访问<code>api-server</code>时使用的<code>https</code>协议</p><h2 id="删除之前的默认生成的secret"><a href="#删除之前的默认生成的secret" class="headerlink" title="删除之前的默认生成的secret"></a>删除之前的默认生成的secret</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">查看default命名空间下</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl get secret</span> <br>NAME                  TYPE                                  DATA   AGE<br>default-token-dlcmj   kubernetes.io/service-account-token   3      14h<br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl delete secret default-token-dlcmj</span><br></code></pre></td></tr></table></figure><h2 id="配置-api-server"><a href="#配置-api-server" class="headerlink" title="配置 api-server"></a>配置 api-server</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs ini">    <span class="hljs-attr">KUBE_API_ADDRESS</span>=<span class="hljs-string">&quot; --insecure-bind-address=0.0.0.0 \</span><br><span class="hljs-string">                      --insecure-port=0 \</span><br><span class="hljs-string">                      --secure-port=6443\</span><br><span class="hljs-string">                      --logtostderr=false \</span><br><span class="hljs-string">                      --log-dir=/soyuan/k8s/api-server/logs \</span><br><span class="hljs-string">                      --v=0 \</span><br><span class="hljs-string">                      --tls-cert-file=/soyuan/k8s/ssl/server.crt \</span><br><span class="hljs-string">                      --tls-private-key-file=/soyuan/k8s/ssl/server.key \</span><br><span class="hljs-string">                      --client-ca-file=/soyuan/k8s/ssl/ca.crt \</span><br><span class="hljs-string">                      --kubelet-https=true  \</span><br><span class="hljs-string">                      --service-account-key-file=/soyuan/k8s/ssl/ca.key \</span><br><span class="hljs-string">                      --enable-swagger-ui=true  &quot;</span><br><span class="hljs-attr">KUBE_ETCD_SERVERS</span>=<span class="hljs-string">&quot; --etcd-servers=http://172.16.100.92:2379&quot;</span><br><span class="hljs-attr">KUBE_SERVICE_ADDRESSES</span>=<span class="hljs-string">&quot; --service-cluster-ip-range=10.254.0.0/16  \</span><br><span class="hljs-string">   --service-node-port-range=1-65535 &quot;</span><br><span class="hljs-attr">KUBE_ADMISSION_CONTROL</span>=<span class="hljs-string">&quot; --admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota,ServiceAccount&quot;</span><br><span class="hljs-attr">KUBE_API_ARGS</span>=<span class="hljs-string">&quot;&quot;</span><br></code></pre></td></tr></table></figure><p> <code>--tls-cert-file</code> 服务器证书文件</p><p><code>--tls-private-key-file</code> 服务器证书私钥文件</p><p><code>--client-ca-file</code> 根证书</p><p><code>--insecure-port=0</code> 把非安全端口关闭</p><p><code>--secure-port=6443</code> 安全端口</p><h2 id="配置controller-manager"><a href="#配置controller-manager" class="headerlink" title="配置controller-manager"></a>配置controller-manager</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">KUBE_CONTROLLER_MANAGER_AGE</span>=<span class="hljs-string">&quot;  --master=https://172.16.100.92:6443   \</span><br><span class="hljs-string">--service-account-private-key-file=/soyuan/k8s/ssl/server.key  \</span><br><span class="hljs-string">--root-ca-file=/soyuan/k8s/ssl/ca.crt  \</span><br><span class="hljs-string">--logtostderr=false  \</span><br><span class="hljs-string">--log-dir=/soyuan/k8s/controller-manager/logs \</span><br><span class="hljs-string">--v=0   &quot;</span><br></code></pre></td></tr></table></figure><p><code>--service-account-private-key-file</code> 服务器私钥文件</p><p><code>--root-ca-file</code> 根证书</p><h2 id="配置kubelet"><a href="#配置kubelet" class="headerlink" title="配置kubelet"></a>配置kubelet</h2><p><code>kubeletenv</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">KUBELET_ARGS</span>=<span class="hljs-string">&quot;--enable-server=true --enable-debugging-handlers=true --fail-swap-on=false --kubeconfig=/soyuan/k8s/kube-node/kubeconfig --hostname-override=kube-master  --cluster-dns=172.16.100.92 --cluster-domain=kube-master  --service-account-key-file=/soyuan/k8s/ssl/server.key --root-ca-file=/soyuan/k8s/ssl/ca.crt&quot;</span><br></code></pre></td></tr></table></figure><p><code>kubeconfig</code></p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">apiVersion:</span> v1<br><span class="hljs-symbol">kind:</span> Config<br><span class="hljs-symbol">clusters:</span><br>- name: kubernetes<br><span class="hljs-symbol">  cluster:</span><br>    certificate-authority: <span class="hljs-keyword">/soyuan/</span>k8s<span class="hljs-keyword">/ssl/</span>ca.crt<br><span class="hljs-symbol">    server:</span> https:<span class="hljs-comment">//172.16.100.92:6443</span><br><span class="hljs-symbol">users:</span><br>- name: kubelet<br><span class="hljs-symbol">  user:</span><br>    client-certificate: <span class="hljs-keyword">/soyuan/</span>k8s<span class="hljs-keyword">/ssl/</span>server.crt<br>    client-key: <span class="hljs-keyword">/soyuan/</span>k8s<span class="hljs-keyword">/ssl/</span>server.key<br><span class="hljs-symbol">contexts:</span><br>- context:<br><span class="hljs-symbol">    cluster:</span> kubernetes<br><span class="hljs-symbol">    user:</span> kubelet<br><span class="hljs-symbol">  name:</span> service-account-context<br>current-context: service-account-context<br></code></pre></td></tr></table></figure><p><code>certificate-authority</code> 根证书 </p><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl restart kube-apiserver</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl restart kube-controller-manager</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl restart kube-scheduler</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl restart kube-proxy</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl restart kubelet</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>k8s 集群部署(https)</title>
    <link href="/wiki/2021/11/24/k8s/k8s%20%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2(https)/"/>
    <url>/wiki/2021/11/24/k8s/k8s%20%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2(https)/</url>
    
    <content type="html"><![CDATA[<h2 id="master"><a href="#master" class="headerlink" title="master"></a>master</h2><h3 id="api-server"><a href="#api-server" class="headerlink" title="api-server"></a>api-server</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">创建node节点第一次访问时候的token</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">生成随机数</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">head</span> -c 16 /dev/urandom | <span class="hljs-built_in">od</span> -An -t x | <span class="hljs-built_in">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span></span><br>538d66be23b7d8e87ca8e0cf7b4191ae<br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">echo</span> 538d66be23b7d8e87ca8e0cf7b4191ae,kubelet-bootstrap,10001,system:kubelet-bootstrap &gt; token.csv</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">环境变量文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> kube-apiserver-env</span><br><br>KUBE_APISERVER_OPTS=&quot;--logtostderr=true \<br>--v=0 \<br>--etcd-servers=http://172.16.100.92:2379 \<br>--bind-address=172.16.100.92 \<br>--secure-port=6443 \<br>--advertise-address=172.16.100.92 \<br>--allow-privileged=true \<br>--service-cluster-ip-range=10.254.0.0/16 \<br>--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \<br>--authorization-mode=RBAC,Node \<br>--enable-bootstrap-token-auth \<br>--token-auth-file=/soyuan/k8s/token.csv \<br>--service-node-port-range=30000-50000 \<br>--tls-cert-file=/soyuan/k8s/ssl/server.pem  \<br>--tls-private-key-file=/soyuan/k8s/ssl/server-key.pem \<br>--client-ca-file=/soyuan/k8s/ssl/ca.pem \<br>--service-account-key-file=/soyuan/k8s/ssl/ca-key.pem &quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">systemd 服务配置文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> /usr/lib/systemd/system/kube-apiserver.service</span><br><br>[Unit]<br>Description=k8sapiserver<br>Documentation=k8sapiserver<br>After=etcd.server<br>Wants=etcd.server<br><br>[Service]<br>EnvironmentFile=-/soyuan/k8s/cfg/kube-apiserver-env<br>ExecStart=/usr/local/bin/kube-apiserver $KUBE_APISERVER_OPTS<br>Restart=failure<br>Type=notify<br>LimitNOFILE=65536<br><br><br>[Install]<br>WantedBy=multi-user.target<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动服务</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl start kube-apiserver</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> kube-apiserver</span><br></code></pre></td></tr></table></figure><p><code>–logtostderr</code> 启用日志<br><code>—v</code> 日志等级<br><code>–etcd-servers etcd</code>集群地址<br><code>–bind-address</code> 监听地址<br><code>–secure-port</code> https安全端口<br><code>–advertise-address</code> 集群通告地址<br><code>–allow-privileged</code> 启用授权<br><code>–service-cluster-ip-range</code> Service虚拟IP地址段<br><code>–enable-admission-plugins</code> 准入控制模块<br><code>–authorization-mode</code> 认证授权，启用RBAC授权和节点自管理<br><code>–enable-bootstrap-token-auth</code> 启用TLS bootstrap功能，后面会讲到<br><code>–token-auth-file</code> token文件   </p><h3 id="scheduler"><a href="#scheduler" class="headerlink" title="scheduler"></a>scheduler</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">环境变量文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> kube-scheduler-env</span><br><br>KUBE_SCHEDULER_OPTS=&quot;--logtostderr=true \<br>--v=0 \<br>--master=127.0.0.1:8080 \<br>--leader-elect&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">systemd 系统服务文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> /usr/lib/systemd/system/kube-scheduler.service</span><br><br>[Unit]<br>Description=Kubernetes Scheduler<br>After=kube-apiserver.service <br>Requires=kube-apiserver.service<br><br>[Service]<br>EnvironmentFile=-/soyuan/k8s/cfg/kube-scheduler-env<br>ExecStart=/usr/local/bin/kube-scheduler $KUBE_SCHEDULER_OPTS<br>Restart=on-failure<br>LimitNOFILE=65536<br><br>[Install]<br>WantedBy=multi-user.target<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动服务</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl start kube-scheduler</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> kube-scheduler</span><br></code></pre></td></tr></table></figure><p><code>–master</code> 连接本地apiserver<br><code>–leader-elect</code> 当该组件启动多个时，自动选举（HA）</p><h3 id="controller-manager"><a href="#controller-manager" class="headerlink" title="controller-manager"></a>controller-manager</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">环境变量文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> kube-controller-manager-env</span><br><br>KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=true \<br>--v=0 \<br>--master=127.0.0.1:8080 \<br>--leader-elect=true \<br>--address=127.0.0.1 \<br>--service-cluster-ip-range=10.254.0.0/16 \<br>--cluster-name=kubernetes \<br>--cluster-signing-cert-file=/soyuan/k8s/ssl/ca.pem \<br>--cluster-signing-key-file=/soyuan/k8s/ssl/ca-key.pem  \<br>--root-ca-file=/soyuan/k8s/ssl/ca.pem \<br>--service-account-private-key-file=/soyuan/k8s/ssl/ca-key.pem&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">systemd 系统服务文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> /usr/lib/systemd/system/kube-controller-manager.service</span><br><br>[Unit]<br>Description=controller manager<br>After=kube-apiserver.service<br>Requires=kube-apiserver.service<br><br>[Service]<br>EnvironmentFile=-/soyuan/k8s/cfg/kube-controller-manager-env<br>ExecStart=/usr/local/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTS<br>Restart=on-failure<br><br>[Install]<br>WantedBy=multi-user.target<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动服务</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl start kube-controller-manager</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> kube-controller-manager</span><br></code></pre></td></tr></table></figure><h2 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h2><p>Master apiserver启用TLS认证后，Node节点kubelet组件想要加入集群，必须使用CA签发的有效证书才能与apiserver通信，当Node节点很多时，签署证书是一件很繁琐的事情，因此有了TLS Bootstrapping机制，kubelet会以一个低权限用户自动向apiserver申请证书，kubelet的证书由apiserver动态签署。</p><p>第一次访问使用token访问，然后自动申请证书</p><h3 id="将kubelet-bootstrap用户绑定到系统集群角色"><a href="#将kubelet-bootstrap用户绑定到系统集群角色" class="headerlink" title="将kubelet-bootstrap用户绑定到系统集群角色"></a>将kubelet-bootstrap用户绑定到系统集群角色</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="language-bash">  --clusterrole=system:node-bootstrapper \</span><br><span class="language-bash">  --user=kubelet-bootstrap</span><br></code></pre></td></tr></table></figure><h3 id="创建kubeconfig文件"><a href="#创建kubeconfig文件" class="headerlink" title="创建kubeconfig文件"></a>创建kubeconfig文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">创建kubelet bootstrapping kubeconfig ,BOOTSTRAP_TOKEN 要和上面的apiserver生成的保持一直</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">BOOTSTRAP_TOKEN=538d66be23b7d8e87ca8e0cf7b4191ae</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">KUBE_APISERVER=<span class="hljs-string">&quot;https://172.16.100.92:6443&quot;</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置集群参数</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl config set-cluster kubernetes \</span><br><span class="language-bash">  --certificate-authority=/soyuan/k8s/ssl/ca.pem \</span><br><span class="language-bash">  --embed-certs=<span class="hljs-literal">true</span> \</span><br><span class="language-bash">  --server=<span class="hljs-variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="language-bash">  --kubeconfig=bootstrap.kubeconfig</span><br>  <br><span class="hljs-meta prompt_">  # </span><span class="language-bash">设置客户端认证参数</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl config set-credentials kubelet-bootstrap \</span><br><span class="language-bash">  --token=<span class="hljs-variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</span><br><span class="language-bash">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置上下文参数</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl config set-context default \</span><br><span class="language-bash">  --cluster=kubernetes \</span><br><span class="language-bash">  --user=kubelet-bootstrap \</span><br><span class="language-bash">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置默认上下文</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br></code></pre></td></tr></table></figure><h3 id="创建kube-proxy-kubeconfig文件"><a href="#创建kube-proxy-kubeconfig文件" class="headerlink" title="创建kube-proxy kubeconfig文件"></a>创建kube-proxy kubeconfig文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl config set-cluster kubernetes \</span><br><span class="language-bash">  --certificate-authority=/soyuan/k8s/ssl/ca.pem \</span><br><span class="language-bash">  --embed-certs=<span class="hljs-literal">true</span> \</span><br><span class="language-bash">  --server=<span class="hljs-variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="language-bash">  --kubeconfig=kube-proxy.kubeconfig</span><br>  <br><span class="hljs-meta prompt_"> $ </span><span class="language-bash">kubectl config set-credentials kube-proxy \</span><br><span class="language-bash">  --client-certificate=/soyuan/k8s/ssl/kube-proxy.pem \</span><br><span class="language-bash">  --client-key=/soyuan/k8s/ssl/kube-proxy-key.pem \</span><br><span class="language-bash">  --embed-certs=<span class="hljs-literal">true</span> \</span><br><span class="language-bash">  --kubeconfig=kube-proxy.kubeconfig</span><br>  <br><span class="hljs-meta prompt_"> $ </span><span class="language-bash">kubectl config set-context default \</span><br><span class="language-bash">  --cluster=kubernetes \</span><br><span class="language-bash">  --user=kube-proxy \</span><br><span class="language-bash">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br></code></pre></td></tr></table></figure><h3 id="部署kubelet组件"><a href="#部署kubelet组件" class="headerlink" title="部署kubelet组件"></a>部署kubelet组件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">环境变量文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> kubelet-env</span><br><br>KUBELET_OPTS=&quot;--logtostderr=true \<br>--v=0 \<br>--hostname-override=172.16.100.63 \<br>--kubeconfig=/opt/k8s/cfg/kubelet.kubeconfig \<br>--bootstrap-kubeconfig=/opt/k8s/cfg/bootstrap.kubeconfig \<br>--config=/opt/k8s/cfg/kubelet.config \<br>--cert-dir=/opt/k8s/ssl &quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">kubelet.config</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> kubelet.config</span><br><br>kind: KubeletConfiguration<br>apiVersion: kubelet.config.k8s.io/v1beta1<br>address: 172.16.100.63<br>port: 10250<br>readOnlyPort: 10255<br>cgroupDriver: cgroupfs<br>clusterDNS: [&quot;10.254.0.2&quot;]<br>clusterDomain: cluster.local.<br>failSwapOn: false<br>authentication:<br>  anonymous:<br>    enabled: true <br>    <br><span class="hljs-meta prompt_"># </span><span class="language-bash">systemd 服务文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> /usr/lib/systemd/system/kubelet.service</span><br><br><br>[Unit]<br>Description=Kubernetes Kubelet Server<br>Documentation=https://github.com/GoogleCloudPlatform/kubernetes<br>After=docker.service<br>Requires=docker.service<br> <br>[Service]<br>EnvironmentFile=/opt/k8s/cfg/kubelet-env<br>ExecStart=/usr/local/bin/kubelet $KUBELET_OPTS<br>Restart=on-failure<br>KillMode=process<br> <br>[Install]<br>WantedBy=multi-user.target<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动kubelet</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl start kubelet</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">stytemctl <span class="hljs-built_in">enable</span> kubelet</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">master节点的 kubelet-bootstrap 用户一定不要忘了创建，没有的话会报下面的错误</span><br>cannot create certificate signing request: certificatesigningrequests.certificates.k8s.io is forbidden: User &quot;kubelet-bootstrap&quot; cannot create resource &quot;certificatesigningrequests&quot; in API group &quot;certificates.k8s.io&quot; at the cluster scope<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">在master节点审批node节点加入集群</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动后还没有加入到集群中，需要手动允许该节点加入</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl get csr</span><br><br>NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION<br>node-csr-B_510xY-Sd9or1Yu3kTLt6bnpCdbU0CS6nPFGNfp5eo   3m58s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl certificate approve node-csr-B_510xY-Sd9or1Yu3kTLt6bnpCdbU0CS6nPFGNfp5eo</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl get node</span><br></code></pre></td></tr></table></figure><p><code>–hostname-override</code> 在集群中显示的主机名<br><code>–kubeconfig</code> 指定kubeconfig文件位置，会自动生成<br><code>–bootstrap-kubeconfig</code> 指定刚才生成的bootstrap.kubeconfig文件<br><code>–cert-dir</code> 颁发证书存放位置<br><code>–pod-infra-container-image</code> 管理Pod网络的镜像</p><h3 id="部署kube-proxy组件"><a href="#部署kube-proxy组件" class="headerlink" title="部署kube-proxy组件"></a>部署kube-proxy组件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">环境变量文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> kube-proxy-env</span><br><br>KUBE_PROXY_OPTS=&quot;--logtostderr=true \<br>--v=0 \<br>--hostname-override=172.16.100.63 \<br>--cluster-cidr=10.254.0.0/24 \<br>--masquerade-all=true \<br>--kubeconfig=/opt/k8s/cfg/kube-proxy.kubeconfig&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">systemd 系统文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> /usr/lib/systemd/system/kube-proxy.service</span><br><br>[Unit]<br>Description=Kubernetes Kube-Proxy Server<br>Documentation=https://github.com/GoogleCloudPlatform/kubernetes<br>After=network.target<br> <br>[Service]<br>EnvironmentFile=/opt/k8s/cfg/kube-proxy-env<br>ExecStart=/usr/local/bin/kube-proxy $KUBE_PROXY_OPTS<br>Restart=on-failure<br>LimitNOFILE=65536<br> <br>[Install]<br>WantedBy=multi-user.target<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动服务</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl start kube-proxy</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> kube-proxy</span><br></code></pre></td></tr></table></figure><h2 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h2><p><code>kubectl get node</code></p>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>k8sDashboard安装</title>
    <link href="/wiki/2021/11/24/k8s/k8sDashboard%E5%AE%89%E8%A3%85/"/>
    <url>/wiki/2021/11/24/k8s/k8sDashboard%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h2 id="源码仓库"><a href="#源码仓库" class="headerlink" title="源码仓库"></a>源码仓库</h2><p><a href="https://github.com/kubernetes/dashboard">GitHub</a></p><h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><p><a href="https://binglog.com/wp-content/uploads/myfile/dashboard-v2.0.5.yaml">dashboard v2.0.5</a> </p><p><a href="https://binglog.com/wp-content/uploads/myfile/dashboard-v2.0.0-beta5.yaml">dashboard v2.0.0-beta5</a> —&gt; kubernetes 1.16<br><a href="https://binglog.com/wp-content/uploads/myfile/dashboard-v2.0.0.yaml">dashboard v2.0.0</a> —&gt; kubernetes 1.18<br><a href="https://binglog.com/wp-content/uploads/myfile/dashboard-v2.0.1.yaml">dashboard v2.0.1</a> —&gt; kubernetes 1.18<br><a href="https://binglog.com/wp-content/uploads/myfile/dashboard-v2.0.2.yaml">dashboard v2.0.2</a> —&gt; kubernetes 1.18<br><a href="https://binglog.com/wp-content/uploads/myfile/dashboard-v2.0.3.yaml">dashboard v2.0.3</a> —&gt; kubernetes 1.18<br><a href="https://binglog.com/wp-content/uploads/myfile/dashboard-v2.0.4.yaml">dashboard v2.0.4</a> —&gt; kubernetes 1.19<br><a href="https://binglog.com/wp-content/uploads/myfile/dashboard-v2.0.5.yaml">dashboard v2.0.5</a> —&gt; kubernetes 1.19<br><a href="https://binglog.com/wp-content/uploads/myfile/dashboard-v2.1.0.yaml">dashboard v2.1.0</a> —&gt; kubernetes 1.20<br><a href="https://binglog.com/wp-content/uploads/myfile/dashboard-v2.2.0.yaml">dashboard v2.2.0</a> —&gt; kubernetes 1.20<br><a href="https://binglog.com/wp-content/uploads/myfile/dashboard-v2.3.0.yaml">dashboard v2.3.0</a> —&gt; kubernetes 1.21<br><a href="https://binglog.com/wp-content/uploads/myfile/dashboard-v2.3.1.yaml">dashboard v2.3.1</a> —&gt; kubernetes 1.21</p><h2 id="通过官方配置文件安装"><a href="#通过官方配置文件安装" class="headerlink" title="通过官方配置文件安装"></a>通过官方配置文件安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">wget https://binglog.com/wp-content/uploads/myfile/dashboard-v2.0.5.yaml</span><br></code></pre></td></tr></table></figure><p><code>kubernetes-dashboard.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># Copyright 2017 The Kubernetes Authors.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="hljs-comment"># you may not use this file except in compliance with the License.</span><br><span class="hljs-comment"># You may obtain a copy of the License at</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#     http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Unless required by applicable law or agreed to in writing, software</span><br><span class="hljs-comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="hljs-comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="hljs-comment"># See the License for the specific language governing permissions and</span><br><span class="hljs-comment"># limitations under the License.</span><br><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Namespace</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">443</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8443</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">30001</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard-certs</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">Opaque</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">dashboard.crt:</span> <span class="hljs-string">&quot;LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVuakNDQTRhZ0F3SUJBZ0lVS1Z2aGMvem1tS3ZlSEpXK1JsZkwrR29PUS9Fd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1lqRUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjBKbGFXcHBibWN4RURBT0JnTlZCQWNUQjJKbAphV3BwYm1jeER6QU5CZ05WQkFvVEJuTnZlWFZoYmpFTk1Bc0dBMVVFQ3hNRWMzQjZiREVQTUEwR0ExVUVBeE1HCmMyOTVkV0Z1TUI0WERUSXlNREV5TXpBM016Y3dNRm9YRFRNeU1ERXlNVEEzTXpjd01Gb3daVEVMTUFrR0ExVUUKQmhNQ1EwNHhFREFPQmdOVkJBZ1RCMEpsYVVwcGJtY3hFREFPQmdOVkJBY1RCMEpsYVVwcGJtY3hEREFLQmdOVgpCQW9UQTJzNGN6RVBNQTBHQTFVRUN4TUdVM2x6ZEdWdE1STXdFUVlEVlFRREV3cHJkV0psY201bGRHVnpNSUlCCklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUF6NTM3bmRkeHMzQ1Z4ZGIrOXFKajBzUVoKQ1FnTmdxU3FGS3lFNkFzc2VHcHFmdnZCKzhBUUtLZ0V6VG1rRWdYa0xrWmJkd1lHeFQzU09Nd2ZUNjd6WWZKMgprQ1FtcmxRWExsdXlnMUtLM2RPQ2tDN0NPSHZHbG1YNzlCV0Q0b1BPMTJkU0NBR1VCTXVJM2VlSW03c1hlSW4wCnNydHNnUTJzOW9lWTNTTzVkS1hTNy9TcUUxWG9pYUxvRlMvaU5YVWNvaDRGVG9qMkFTc3FHNlRpUXgzQmpWd2gKRlBHZFVFZ2FwQlJCQXQ5TzlQUXV5S1V3Q1RBSHdHc1ZVQjRSMlJLSE5yc0xFUWxjcVFHcTJHTnlVUG9xTnpCLwpJWlo1VDllMnExNmEwc0J0dWszb0RIK2FZOGJ1ckxqbE9sWnd5eFJaUGt5KzBBb3ptY1JUMU9jOWdTcnVXd0lECkFRQUJvNElCUnpDQ0FVTXdEZ1lEVlIwUEFRSC9CQVFEQWdXZ01CMEdBMVVkSlFRV01CUUdDQ3NHQVFVRkJ3TUIKQmdnckJnRUZCUWNEQWpBTUJnTlZIUk1CQWY4RUFqQUFNQjBHQTFVZERnUVdCQlJQOGJCVUhrYlBTN1dtN3VFVwpmZXplelhKUmNEQWZCZ05WSFNNRUdEQVdnQlN1NVYwa1F4eGNYTXFnRTlOdGlDNTd1cmJUV2pDQnd3WURWUjBSCkJJRzdNSUc0Z2hSbmFYUnNZV0l1YzI5NWRXRnVMbU52YlM1amJvSUthM1ZpWlhKdVpYUmxjNElTYTNWaVpYSnUKWlhSbGN5NWtaV1poZFd4MGdoWnJkV0psY201bGRHVnpMbVJsWm1GMWJIUXVjM1pqZ2g1cmRXSmxjbTVsZEdWegpMbVJsWm1GMWJIUXVjM1pqTG1Oc2RYTjBaWEtDSkd0MVltVnlibVYwWlhNdVpHVm1ZWFZzZEM1emRtTXVZMngxCmMzUmxjaTVzYjJOaGJJY0VDdjRBQVljRXJCQmtYSWNFckJCa1A0Y0VyQkJrUUljRXJCQmtSNGNFckJCazREQU4KQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBa3c3V0ZZbkJTVVNGdG5pclRJQVZ4TEV5OFVUY0QrUzhYajlOOGJKRApYWEtIM2lQVmxVdDQ2N2JHc1Z5TU9CWVRyNjBSZHFBYUN6aUs1OVp3VkNuWkJSOU4vT21uYzRGYk9OaEROeDJoCjFnZWpXckFlbTZaWVZ1eFlUdWF1SkdCQkZEYVorMS9HazZSb2liczBqdHVIL2x5dFBMYlJjY2RTY052SHNVaS8KMmhkS2VZbGpiejh0MjZFWG1QOHhvVnJ1SkVkR2dMdmJqWXhIQmJFbHRJbDdtODFoaGN0Y1hJL084dWNoTkg4aQphaXdBYUt5ZTllcmVqaDNZa3ZEZXFlcDNmQUVoc21HYURPQTd4SDNCMmpJTFJTUzhtTUd2VEszRWRXMUJJVnlVClNxUlZoVmVQMTZEWnVhaDdXTXlubzFkMmZPMlNMeDNZVkkyMEwyRXgzYlVMQnc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==&quot;</span><br>  <span class="hljs-attr">dashboard.key:</span> <span class="hljs-string">&quot;LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBejUzN25kZHhzM0NWeGRiKzlxSmowc1FaQ1FnTmdxU3FGS3lFNkFzc2VHcHFmdnZCCis4QVFLS2dFelRta0VnWGtMa1piZHdZR3hUM1NPTXdmVDY3ellmSjJrQ1FtcmxRWExsdXlnMUtLM2RPQ2tDN0MKT0h2R2xtWDc5QldENG9QTzEyZFNDQUdVQk11STNlZUltN3NYZUluMHNydHNnUTJzOW9lWTNTTzVkS1hTNy9TcQpFMVhvaWFMb0ZTL2lOWFVjb2g0RlRvajJBU3NxRzZUaVF4M0JqVndoRlBHZFVFZ2FwQlJCQXQ5TzlQUXV5S1V3CkNUQUh3R3NWVUI0UjJSS0hOcnNMRVFsY3FRR3EyR055VVBvcU56Qi9JWlo1VDllMnExNmEwc0J0dWszb0RIK2EKWThidXJMamxPbFp3eXhSWlBreSswQW96bWNSVDFPYzlnU3J1V3dJREFRQUJBb0lCQVFDc2UwVkVkbTRoY3hFYQprV2kwSVdqbytyMEp3Y1RubWtFcWQ4RGF2aDJ0MUVxeFFCcUNPYWV5L3hNdUpBcm9aamlSTVNaZmxZUWViU091CngvWGpUeWNuWWpXWnZrN2NXVVFBNFhGR3BGWjF2M2dpckpYeU12SmlsRXRqRmxUQTVGdjhtL3VNWnpNL1lKQk8KT2tKRmpvTUxReUVsTTR3TEV2OTB1R1lJb2RzNnllRDIwRnV4S3dtcElaeEJPcWQvUkdlc0MwVXdMME1wWU9MNQpLN0xrVnlSM2pBdDhCOGk0eUhudTN0cG00WW04ZURrMlE1Rk03YnMzamJMZU5Kalozem1hV1o4SG9QaDFWZGZzCmlpSjlEcStVZjNHdXJ5dlZad01tTDFIQy80aDJVSVY0MHlQS1RPNCtkUENMeC95RnBENEpIeFZkWmxlZStmenAKRTN0QkpaWUJBb0dCQVBPT0RSTXZMTWRnOG9BczlEczdVMGRoU0R6ZEN4V1BkWUJkNUwrMXR2NDNicGFJVzQvTQpNZXRJT2ZKYVFWandzYWJVb1Y5dGxiOG04UGVDY1pmQThBQ3dGQmZYTCtwTnNMRGQ1RytUL2ZMakczNjNGN0ZaCk1Gd1ljRDRKVFY4MWlBaFlkZHd6d0ZDZVJVcGRSNTltMWF0MjNvVTdWNUIwWkdWWGFHYkJ6bUNCQW9HQkFObzUKMUNzTThRcVI5OXZqeks4UWtmTkVvNkxVcExWSmZVSGdObHdDYkJ3cExEamdieGxDTjNzRCt0YW1BTWhqcVdrSAorYnhzeHJkR3YxT1ZrcmNFOWN0RkZVQVdQTGFEbkRoSlR5akZZdjh1bnpDWFZCOTdhYXZ1RzdlZ1VncmU1UHVQCmVTRFJRcDdlT1NmUVdjL1o0Z2l5dFcybHdmaFpCYlpDZzAzYWJtRGJBb0dBT1h2UmdqR2tNL3Fod2JiYWZoQm0KZTNadWdrNzVpc0V0VG5yYXZwUzQrQTlGUHFvNFVod3p2QUIwRE10WW1SRldITFlhMEZjZy9OaklEdUx1eEk1NQpGdkI0RFpod2FyQ2pmMXNmeTJYMmpoa2tLQ2cybzFrVm5PYjN0dXlqSWxHVUpjUWJMVG5acmkxczFUeG01eXh5ClNlSG9hekd5WFJuYmlEKzFHR3V0dGdFQ2dZQWtzcWJnV252S2lFT0RRZXF3NGZ0NVNtaXVRRTQyZ2xaREZyNXQKZUtiUGtZanpRNkxMUDV4dTNudDNUMUZBWWFvaWxJbkZ5eEVienhUcnJIS1F2by9MRUNJRHRmbWR3OElvb1FOagoydFhNRGY0TlFOV1B1Y1JLZW05RTBQd2JBZUxGL3htaWtDNUE0eVAvY3dVM2MrK1VBT0dMdjkwL3MxREhscVhZCkdNeUpFd0tCZ1FDQjF0OHNkWlJIa3ZMNmpHdjV0aGhhU2VyZGdWMDIzcDdGNTJRZkpkeFU4OXJkK2JyR2I0dnMKUS9uM3hadm9naVBQMTV5M1MzV2xHN2Y1VXpXSjdtc1NmZjE1R2FzOHdVYzNwaVBtYkJ1TThNWCtnNWFxcGxrbQp3N2p2YzRER01wSmM2MWRWSmhxZE9EMGxhRVhJYTFSS1ZhVEpJcm50OVNwd09zNldFWHBzSlE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=&quot;</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard-csrf</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">Opaque</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">csrf:</span> <span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard-key-holder</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">Opaque</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard-settings</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-comment"># Allow Dashboard to get, update and delete Dashboard exclusive secrets.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;secrets&quot;</span>]<br>    <span class="hljs-attr">resourceNames:</span> [<span class="hljs-string">&quot;kubernetes-dashboard-key-holder&quot;</span>, <span class="hljs-string">&quot;kubernetes-dashboard-certs&quot;</span>, <span class="hljs-string">&quot;kubernetes-dashboard-csrf&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-string">&quot;delete&quot;</span>]<br>    <span class="hljs-comment"># Allow Dashboard to get and update &#x27;kubernetes-dashboard-settings&#x27; config map.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;configmaps&quot;</span>]<br>    <span class="hljs-attr">resourceNames:</span> [<span class="hljs-string">&quot;kubernetes-dashboard-settings&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>]<br>    <span class="hljs-comment"># Allow Dashboard to get metrics.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;services&quot;</span>]<br>    <span class="hljs-attr">resourceNames:</span> [<span class="hljs-string">&quot;heapster&quot;</span>, <span class="hljs-string">&quot;dashboard-metrics-scraper&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;proxy&quot;</span>]<br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;services/proxy&quot;</span>]<br>    <span class="hljs-attr">resourceNames:</span> [<span class="hljs-string">&quot;heapster&quot;</span>, <span class="hljs-string">&quot;http:heapster:&quot;</span>, <span class="hljs-string">&quot;https:heapster:&quot;</span>, <span class="hljs-string">&quot;dashboard-metrics-scraper&quot;</span>, <span class="hljs-string">&quot;http:dashboard-metrics-scraper&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>]<br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-comment"># Allow Metrics Scraper to get metrics from the Metrics server</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;metrics.k8s.io&quot;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;pods&quot;</span>, <span class="hljs-string">&quot;nodes&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>]<br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">RoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">subjects:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">cluster-admin</span><br><span class="hljs-attr">subjects:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">revisionHistoryLimit:</span> <span class="hljs-number">10</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br>    <span class="hljs-attr">spec:</span><br>     <span class="hljs-comment"># 节点选择器只能运行到92上</span><br>      <span class="hljs-attr">nodeSelector:</span> <br>        <span class="hljs-attr">type:</span> <span class="hljs-string">master</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">kubernetesui/dashboard:v2.0.5</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">Always</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8443</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--auto-generate-certificates</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--namespace=kubernetes-dashboard</span><br>            <span class="hljs-comment"># Uncomment the following line to manually specify Kubernetes API server Host</span><br>            <span class="hljs-comment"># If not specified, Dashboard will attempt to auto discover the API server and connect</span><br>            <span class="hljs-comment"># to it. Uncomment only if the default does not work.</span><br>            <span class="hljs-comment">#- --apiserver-host=http://127.0.0.1:8080</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard-certs</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/certs</span><br>              <span class="hljs-comment"># Create on-disk volume to store exec logs</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/tmp</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">tmp-volume</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTPS</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-number">8443</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">30</span><br>          <span class="hljs-attr">securityContext:</span><br>            <span class="hljs-attr">allowPrivilegeEscalation:</span> <span class="hljs-literal">false</span><br>            <span class="hljs-attr">readOnlyRootFilesystem:</span> <span class="hljs-literal">true</span><br>            <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">1001</span><br>            <span class="hljs-attr">runAsGroup:</span> <span class="hljs-number">2001</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard-certs</span><br>          <span class="hljs-attr">secret:</span><br>            <span class="hljs-attr">secretName:</span> <span class="hljs-string">kubernetes-dashboard-certs</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tmp-volume</span><br>          <span class="hljs-attr">emptyDir:</span> &#123;&#125;<br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">kubernetes-dashboard</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">dashboard-metrics-scraper</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">dashboard-metrics-scraper</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8000</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8000</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">dashboard-metrics-scraper</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">dashboard-metrics-scraper</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">dashboard-metrics-scraper</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">revisionHistoryLimit:</span> <span class="hljs-number">10</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">dashboard-metrics-scraper</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">dashboard-metrics-scraper</span><br>      <span class="hljs-attr">annotations:</span><br>        <span class="hljs-attr">seccomp.security.alpha.kubernetes.io/pod:</span> <span class="hljs-string">&#x27;runtime/default&#x27;</span><br>    <span class="hljs-attr">spec:</span><br>     <span class="hljs-comment"># 节点选择器只能运行到92上</span><br>      <span class="hljs-attr">nodeSelector:</span> <br>        <span class="hljs-attr">type:</span> <span class="hljs-string">master</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">dashboard-metrics-scraper</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">kubernetesui/metrics-scraper:v1.0.6</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8000</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-number">8000</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">30</span><br>          <span class="hljs-attr">volumeMounts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/tmp</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">tmp-volume</span><br>          <span class="hljs-attr">securityContext:</span><br>            <span class="hljs-attr">allowPrivilegeEscalation:</span> <span class="hljs-literal">false</span><br>            <span class="hljs-attr">readOnlyRootFilesystem:</span> <span class="hljs-literal">true</span><br>            <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">1001</span><br>            <span class="hljs-attr">runAsGroup:</span> <span class="hljs-number">2001</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">kubernetes-dashboard</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tmp-volume</span><br>          <span class="hljs-attr">emptyDir:</span> &#123;&#125;<br></code></pre></td></tr></table></figure><p><strong>证书的内容要base64编码</strong></p><h3 id="修改配置文件暴露端口"><a href="#修改配置文件暴露端口" class="headerlink" title="修改配置文件暴露端口"></a>修改配置文件暴露端口</h3><p><code>Service</code> 部分增加 <code>type=NodePort</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">443</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8443</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">30001</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br></code></pre></td></tr></table></figure><p>对外暴露端口：30001</p><h3 id="增加k8s-dashboard-ssl证书"><a href="#增加k8s-dashboard-ssl证书" class="headerlink" title="增加k8s dashboard ssl证书"></a>增加k8s dashboard ssl证书</h3><p>由于<code>dashboard</code>走的<code>HTTPS</code>，ssl证书制作，请看上面我的blog</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl create secret generic kubernetes-dashboard-certs --from-file=dashboard.key --from-file=dashboard.crt -n kube-system</span><br></code></pre></td></tr></table></figure><p>把你的证书和私钥名称都改成dashboard，容器内部去的名称是<code>dashboard.key</code>,<code>dashboard.crt</code></p><p>如果 <code>secret kubernetes-dashboard-certs</code> 已经存在可以修改   <code>kubectl edit secret kubernetes-dashboard-certs -n kube-system</code>，获取删除了重新创建</p><p>也可以直接把ssl的证书内容<code>dashboard.key</code>,<code>dashboard.crt</code>  base64编码后，直接放到上面的yaml里面进行创建</p><h3 id="下载镜像"><a href="#下载镜像" class="headerlink" title="下载镜像"></a>下载镜像</h3><p> 如果镜像下来不下来可以使用下面的方式，先在阿里云下载下来，然后再把改签改成配置需要的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker pull registry.aliyuncs.com/google_containers/kubernetes-dashboard-amd64:v1.10.1</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker tag registry.aliyuncs.com/google_containers/kubernetes-dashboard-amd64:v1.10.1 k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1</span><br></code></pre></td></tr></table></figure><h3 id="启动dashboard"><a href="#启动dashboard" class="headerlink" title="启动dashboard"></a>启动dashboard</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl create -f dashboard.yaml</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看pod状态</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl get pod -n kube-system</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看svc</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl get svc -n kube-system</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看deployment</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl get deployment -n kube-system</span><br></code></pre></td></tr></table></figure><p>如果pod起不来，查看<code>/var/log/messages</code> 报 <code>is forbidden: SecurityContext.RunAsUser is forbidden</code></p><p>解决办法，修改 api-server 启动参数 <code>--enable-admission-plugins</code> 把 <code>SecurityContextDeny</code>  去掉，然后重启 api-server</p><p><code>api-server 启动参数</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">KUBE_API_ADDRESS</span>=<span class="hljs-string">&quot; --insecure-bind-address=0.0.0.0 --insecure-port=8080 --logtostderr=false --log-dir=/soyuan/k8s/api-server/logs --v=0&quot;</span><br><span class="hljs-attr">KUBE_ETCD_SERVERS</span>=<span class="hljs-string">&quot; --etcd-servers=http://172.16.100.92:2379&quot;</span><br><span class="hljs-attr">KUBE_SERVICE_ADDRESSES</span>=<span class="hljs-string">&quot; --service-cluster-ip-range=10.254.0.0/16 --service-node-port-range=1-65535&quot;</span><br><span class="hljs-attr">KUBE_ADMISSION_CONTROL</span>=<span class="hljs-string">&quot; --admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota,ServiceAccount&quot;</span><br><span class="hljs-attr">KUBE_API_ARGS</span>=<span class="hljs-string">&quot;&quot;</span><br></code></pre></td></tr></table></figure><h2 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h2><p>登录 dashboard 的时候支持 Kubeconfig 和token 两种认证方式，Kubeconfig 中也依赖token 字段</p><h3 id="生成token"><a href="#生成token" class="headerlink" title="生成token"></a>生成token</h3><p>创建admin用户会自动获取token，如果没有获取到，那就是<code>api-server</code>,和<code>controller-manager</code> 这个两个服务启动参数问题</p><p>api-server 启动参数里面要有  <code>--admission-control</code>  里面 要有 <code>ServiceAccount</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">KUBE_API_ADDRESS</span>=<span class="hljs-string">&quot; --insecure-bind-address=0.0.0.0 --insecure-port=8080 --logtostderr=false --log-dir=/soyuan/k8s/api-server/logs --v=0&quot;</span><br><span class="hljs-attr">KUBE_ETCD_SERVERS</span>=<span class="hljs-string">&quot; --etcd-servers=http://172.16.100.92:2379&quot;</span><br><span class="hljs-attr">KUBE_SERVICE_ADDRESSES</span>=<span class="hljs-string">&quot; --service-cluster-ip-range=10.254.0.0/16 --service-node-port-range=1-65535&quot;</span><br><span class="hljs-attr">KUBE_ADMISSION_CONTROL</span>=<span class="hljs-string">&quot; --admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota,ServiceAccount&quot;</span><br><span class="hljs-attr">KUBE_API_ARGS</span>=<span class="hljs-string">&quot;&quot;</span><br></code></pre></td></tr></table></figure><p><code>controller-manager</code> 要配置秘钥，签名<code>token</code>的时候需要</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">KUBE_CONTROLLER_MANAGER_AGE</span>=<span class="hljs-string">&quot;--master=http://172.16.100.92:8080 --service-account-private-key-file=/soyuan/k8s/kubeservice/172.16.100.92.key --logtostderr=false --log-dir=/soyuan/k8s/controller-manager/logs --v=0&quot;</span><br></code></pre></td></tr></table></figure><p><code>--service-account-private-key-file=/soyuan/k8s/kubeservice/172.16.100.92.key</code></p><p>然后重启这两个服务</p><h4 id="查看token"><a href="#查看token" class="headerlink" title="查看token"></a>查看token</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">查看token</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl get secret -n kube-system</span><br>kubernetes-dashboard-token-jdj4m   kubernetes.io/service-account-token   2      4m38s<br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看token</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl describe secret kubernetes-dashboard-token-s2lvs -n kubernetes-dashboard</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">token</span><br>eyJhbGciOiJSUzI1NiIsImtpZCI6Ii1fT21WTVo1Q0hVeFRYakZwb1lMY2Y3eVVMVjRYQUIzWm9zOXJ0dlBUc00ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi1zMmx2cyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjVhZjcxNjYyLTQ0ZWUtNGI0NC1iYmZhLTViMjljM2YwMmRiMSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.Q7WBzNlSq9Hk104kchJ7y1AMinKU1iS9hv3vpc34bpC6xuO-eOdZ9hrwH4rdgR-fHcq_ZE7bctxnKmG1nDoi-kWTkbBKV7sJdontDR5_EE2tKhF7XNUg7Rpe5pyemFxh4mHpnnmEXTB35ek2bAFnJ1cPY45kHuHmEWUZtey7O8F8WAdNDfnDH744ORdT6xte4nMrg0q2XosnOlEwgln9CticOCu-qUVZ5X3NiHdMxCZISMJtaF6cjLwS1vW1SUipK4niwlLlSSM3q-fVMCgFd6F8_x8qRtgZA0iWfFGrlAewtK4UbRNi5hHLDk-n26wyyi3sEY4dsdMxB11c3db10w<br></code></pre></td></tr></table></figure><h3 id="kubeconfig登录"><a href="#kubeconfig登录" class="headerlink" title="kubeconfig登录"></a>kubeconfig登录</h3><p>用户<code>kubernetes-dashboard</code>的token</p><p>先查看生成的token</p><p><code>kubectl get secret -n kubernetes-dashboard kubernetes-dashboard-token-s2lvs -o jsonpath=&#123;.data.token&#125;|base64 -d</code></p><p>配置一个环境变量<code>DASH_TOCKEN</code></p><p><code>DASH_TOCKEN=$(kubectl get secret -n kubernetes-dashboard kubernetes-dashboard-token-s2lvs -o jsonpath=&#123;.data.token&#125;|base64 -d)</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl config set-cluster kubernetes --server=&quot;https://172.16.100.92:6443&quot; --certificate-authority=/soyuan/k8s/ca.crt --kubeconfig=/soyuan/k8s/def-ns-admin.conf<br><br>kubectl config set-credentials kubernetes-dashboard --token=$DASH_TOCKEN --kubeconfig=./def-ns-admin.conf<br><br>kubectl config set-context kubernetes-dashboard@kubernetes --cluster=kubernetes --user=kubernetes-dashboard --kubeconfig=./def-ns-admin.conf<br>kubectl config use-context kubernetes-dashboard@kubernetes --kubeconfig=./def-ns-admin.conf<br></code></pre></td></tr></table></figure><p>暂时登录不上去先用token</p><h3 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h3><p>有可能会报找不到用户的错误</p><p>新建用户</p><p><code>kubectl create clusterrolebinding system:anonymous --clusterrole=cluster-admin --user=system:anonymous</code></p>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>k8syaml</title>
    <link href="/wiki/2021/11/24/k8s/k8syaml/"/>
    <url>/wiki/2021/11/24/k8s/k8syaml/</url>
    
    <content type="html"><![CDATA[<p><code>kube-apiserver</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># cat /soyuan/k8s/cfg/kube-apiserver-env</span><br><br><span class="hljs-attr">KUBE_APISERVER_OPTS</span>=<span class="hljs-string">&quot;--logtostderr=true \</span><br><span class="hljs-string">--v=4 \</span><br><span class="hljs-string">--etcd-servers=http://172.16.100.92:2379 \</span><br><span class="hljs-string">--bind-address=172.16.100.92 \</span><br><span class="hljs-string">--secure-port=6443 \</span><br><span class="hljs-string">--advertise-address=172.16.100.92 \</span><br><span class="hljs-string">--allow-privileged=true \</span><br><span class="hljs-string">--service-cluster-ip-range=10.254.0.0/16 \</span><br><span class="hljs-string">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,SecurityContextDeny,ServiceAccount,ResourceQuota,NodeRestriction \</span><br><span class="hljs-string">--authorization-mode=RBAC,Node \</span><br><span class="hljs-string">--enable-bootstrap-token-auth \</span><br><span class="hljs-string">--token-auth-file=/soyuan/k8s/token.csv \</span><br><span class="hljs-string">--service-node-port-range=30000-50000 \</span><br><span class="hljs-string">--tls-cert-file=/soyuan/k8s/ssl/server.pem  \</span><br><span class="hljs-string">--tls-private-key-file=/soyuan/k8s/ssl/server-key.pem \</span><br><span class="hljs-string">--client-ca-file=/soyuan/k8s/ssl/ca.pem \</span><br><span class="hljs-string">--service-account-key-file=/soyuan/k8s/ssl/ca-key.pem &quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># cat /usr/lib/systemd/system/kube-apiserver.service </span><br><br><span class="hljs-section">[Unit]</span><br><span class="hljs-attr">Description</span>=Kubernetes API Server<br><span class="hljs-attr">Documentation</span>=https://github.com/kubernetes/kubernetes<br><br><span class="hljs-section">[Service]</span><br><span class="hljs-attr">EnvironmentFile</span>=-/soyuan/k8s/cfg/kube-apiserver-env<br><span class="hljs-attr">ExecStart</span>=/opt/kubernetes/bin/kube-apiserver <span class="hljs-variable">$KUBE_APISERVER_OPTS</span><br><span class="hljs-attr">Restart</span>=<span class="hljs-literal">on</span>-failure<br><br><span class="hljs-section">[Install]</span><br><span class="hljs-attr">WantedBy</span>=multi-user.target<br></code></pre></td></tr></table></figure><p>kube-controller-manager</p><p>kube-controller-manager-env</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># cat /soyuan/k8s/cfg/kube-controller-manager-env</span><br><br><span class="hljs-attr">KUBE_CONTROLLER_MANAGER_OPTS</span>=<span class="hljs-string">&quot;--logtostderr=true \</span><br><span class="hljs-string">--v=4 \</span><br><span class="hljs-string">--master=127.0.0.1:8080 \</span><br><span class="hljs-string">--leader-elect=true \</span><br><span class="hljs-string">--address=127.0.0.1 \</span><br><span class="hljs-string">--service-cluster-ip-range=10.254.0.0/16 \</span><br><span class="hljs-string">--cluster-name=kubernetes \</span><br><span class="hljs-string">--cluster-signing-cert-file=/soyuan/k8s/ssl/ca.pem \</span><br><span class="hljs-string">--cluster-signing-key-file=/soyuan/k8s/ssl/ca-key.pem  \</span><br><span class="hljs-string">--root-ca-file=/soyuan/k8s/ssl/ca.pem \</span><br><span class="hljs-string">--service-account-private-key-file=/soyuan/k8s/ssl/ca-key.pem&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># cat /usr/lib/systemd/system/kube-controller-manager.service</span><br><br><span class="hljs-section">[Unit]</span><br><span class="hljs-attr">Description</span>=Kubernetes Controller Manager<br><span class="hljs-attr">Documentation</span>=https://github.com/kubernetes/kubernetes<br><br><span class="hljs-section">[Service]</span><br><span class="hljs-attr">EnvironmentFile</span>=-/soyuan/k8s/cfg/kube-controller-manager-env<br><span class="hljs-attr">ExecStart</span>=/opt/kubernetes/bin/kube-controller-manager <span class="hljs-variable">$KUBE_CONTROLLER_MANAGER_OPTS</span><br><span class="hljs-attr">Restart</span>=<span class="hljs-literal">on</span>-failure<br><br><span class="hljs-section">[Install]</span><br><span class="hljs-attr">WantedBy</span>=multi-user.target<br></code></pre></td></tr></table></figure><p>kube-scheduler</p><p>kube-scheduler-env</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># cat /soyuan/k8s/cfg/kube-scheduler-env</span><br><br><span class="hljs-attr">KUBE_SCHEDULER_OPTS</span>=<span class="hljs-string">&quot;--logtostderr=true \</span><br><span class="hljs-string">--v=4 \</span><br><span class="hljs-string">--master=127.0.0.1:8080 \</span><br><span class="hljs-string">--leader-elect&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># cat /usr/lib/systemd/system/kube-scheduler.service </span><br><span class="hljs-section">[Unit]</span><br><span class="hljs-attr">Description</span>=Kubernetes Scheduler<br><span class="hljs-attr">Documentation</span>=https://github.com/kubernetes/kubernetes<br><br><span class="hljs-section">[Service]</span><br><span class="hljs-attr">EnvironmentFile</span>=-/soyuan/k8s/cfg/kube-scheduler-env<br><span class="hljs-attr">ExecStart</span>=/opt/kubernetes/bin/kube-scheduler <span class="hljs-variable">$KUBE_SCHEDULER_OPTS</span><br><span class="hljs-attr">Restart</span>=<span class="hljs-literal">on</span>-failure<br><br><span class="hljs-section">[Install]</span><br><span class="hljs-attr">WantedBy</span>=multi-user.target<br></code></pre></td></tr></table></figure><p>kubelet</p><p>kubelet-env</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># cat /soyuan/k8s/cfg/kubelet-env</span><br><br> <span class="hljs-attr">KUBELET_OPTS</span>=<span class="hljs-string">&quot;--logtostderr=true \</span><br><span class="hljs-string">--v=4 \</span><br><span class="hljs-string">--hostname-override=172.16.100.63 \</span><br><span class="hljs-string">--kubeconfig=/opt/k8s/cfg/kubelet.kubeconfig \</span><br><span class="hljs-string">--bootstrap-kubeconfig=/opt/k8s/cfg/bootstrap.kubeconfig \</span><br><span class="hljs-string">--config=/opt/k8s/cfg/kubelet.config \</span><br><span class="hljs-string">--cert-dir=/opt/k8s/ssl &quot;</span><br></code></pre></td></tr></table></figure><p><code>--bootstrap-kubeconfig</code> 自动生成文件</p><p>kubelet.config</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">KubeletConfiguration</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubelet.config.k8s.io/v1beta1</span><br><span class="hljs-attr">address:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.100</span><span class="hljs-number">.63</span><br><span class="hljs-attr">port:</span> <span class="hljs-number">10250</span><br><span class="hljs-attr">readOnlyPort:</span> <span class="hljs-number">10255</span><br><span class="hljs-attr">cgroupDriver:</span> <span class="hljs-string">cgroupfs</span><br><span class="hljs-attr">clusterDNS:</span> [<span class="hljs-string">&quot;10.254.0.2&quot;</span>]<br><span class="hljs-attr">clusterDomain:</span> <span class="hljs-string">cluster.local.</span><br><span class="hljs-attr">failSwapOn:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">authentication:</span><br>  <span class="hljs-attr">anonymous:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><p>token.csv</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">head</span> -c 16 /dev/urandom | <span class="hljs-built_in">od</span> -An -t x | <span class="hljs-built_in">tr</span> -d <span class="hljs-string">&#x27; &#x27;</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">echo</span> 538d66be23b7d8e87ca8e0cf7b4191ae,kubelet-bootstrap,10001,<span class="hljs-string">&quot;system:kubelet-bootstrap&quot;</span> &gt; token.csv</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建角色</span><br>kubectl create clusterrolebinding kubelet-bootstrap \<br>  --clusterrole=system:node-bootstrapper \<br>  --user=kubelet-bootstrap<br>  <br>  <br>  <br>BOOTSTRAP_TOKEN=538d66be23b7d8e87ca8e0cf7b4191ae<br>KUBE_APISERVER=&quot;https://172.16.100.92:6443&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建kubelet bootstrapping kubeconfig</span> <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置集群参数</span><br>kubectl config set-cluster kubernetes \<br>  --certificate-authority=/soyuan/k8s/ssl/ca.pem \<br>  --embed-certs=true \<br>  --server=$&#123;KUBE_APISERVER&#125; \<br>  --kubeconfig=bootstrap.kubeconfig<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置客户端认证参数</span><br>kubectl config set-credentials kubelet-bootstrap \<br>  --token=$&#123;BOOTSTRAP_TOKEN&#125; \<br>  --kubeconfig=bootstrap.kubeconfig<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置上下文参数</span><br>kubectl config set-context default \<br>  --cluster=kubernetes \<br>  --user=kubelet-bootstrap \<br>  --kubeconfig=bootstrap.kubeconfig<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置默认上下文</span><br>kubectl config use-context default --kubeconfig=bootstrap.kubeconfig<br><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建kube-proxy kubeconfig文件</span><br><br>kubectl config set-cluster kubernetes \<br>  --certificate-authority=/soyuan/k8s/ssl/ca.crt \<br>  --embed-certs=true \<br>  --server=$&#123;KUBE_APISERVER&#125; \<br>  --kubeconfig=kube-proxy.kubeconfig<br><br>kubectl config set-credentials kube-proxy \<br>  --client-certificate=/soyuan/k8s/ssl/server.crt \<br>  --client-key=/soyuan/k8s/ssl/server.key \<br>  --embed-certs=true \<br>  --kubeconfig=kube-proxy.kubeconfig<br><br>kubectl config set-context default \<br>  --cluster=kubernetes \<br>  --user=kube-proxy \<br>  --kubeconfig=kube-proxy.kubeconfig<br><br>kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig<br>  <br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>k8s二进制文件部署</title>
    <link href="/wiki/2021/11/24/k8s/k8s%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E9%83%A8%E7%BD%B2/"/>
    <url>/wiki/2021/11/24/k8s/k8s%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><p>k8s: <code>1.19</code></p><p>docker:<code>19.03</code></p><h2 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h2><table><thead><tr><th>机器</th><th>ip</th><th>分配节点</th></tr></thead><tbody><tr><td>172.16.100.92</td><td>172.16.100.92</td><td>etcd,api-server,kube-controller,kube-scheduler</td></tr><tr><td>172.16.100.63</td><td>172.16.100.63</td><td>docker,kube-proxy,kubelet</td></tr><tr><td>172.16.100.64</td><td>172.16.100.64</td><td>docker,kube-proxy,kubelet</td></tr><tr><td>172.16.100.71</td><td>172.16.100.71</td><td>docker,kube-proxy,kubelet</td></tr></tbody></table><p><code>先在服务器安装etcd服务</code></p><h2 id="服务器的-selinux-最好要要关掉"><a href="#服务器的-selinux-最好要要关掉" class="headerlink" title="服务器的 selinux 最好要要关掉"></a>服务器的 selinux 最好要要关掉</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">vi /etc/selinux/config</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改 SELINUX=disabled</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">reboot</span><br></code></pre></td></tr></table></figure><h3 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h3><p><code>https://github.com/kubernetes/kubernetes/releases</code></p><p>找到对应的版本点击 <code>CHANGELOG</code> 下载对应操作系统的压缩包</p><p>1.19版本</p><p><code>https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.19.md</code></p><p>下载<code>Server Binaries</code>文件 </p><p><code>kubernetes-server-linux-amd64.tar</code></p><p>下载完成解压出来，二进制可执行文件在 <code>kubernetes\server\bin</code> 目录</p><h2 id="安装-kube-apiserver"><a href="#安装-kube-apiserver" class="headerlink" title="安装 kube-apiserver"></a>安装 kube-apiserver</h2><p>将 <code>kube-apiserver</code> 上传到服务器</p><p>新建服务服务文件</p><p><code>vim /usr/lib/systemd/system/kube-apiserver.service</code> </p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Unit]</span><br><span class="hljs-attr">Description</span>=k8sapiserver<br><span class="hljs-attr">Documentation</span>=k8sapiserver<br><span class="hljs-attr">After</span>=etcd.server<br><span class="hljs-attr">Wants</span>=etcd.server<br><br><span class="hljs-section">[Service]</span><br><span class="hljs-attr">EnvironmentFile</span>=/soyuan/k8s/api-server/apiserver<br><span class="hljs-attr">ExecStart</span>=/usr/local/bin/kube-apiserver <span class="hljs-variable">$KUBE_API_ADDRESS</span> <span class="hljs-variable">$KUBE_ETCD_SERVERS</span> <span class="hljs-variable">$KUBE_SERVICE_ADDRESSES</span> <span class="hljs-variable">$KUBE_ADMISSION_CONTROL</span> <span class="hljs-variable">$KUBE_API_ARGS</span><br><span class="hljs-attr">Restart</span>=failure<br><span class="hljs-attr">Type</span>=notify<br><span class="hljs-attr">LimitNOFILE</span>=<span class="hljs-number">65536</span><br><br><br><span class="hljs-section">[Install]</span><br><span class="hljs-attr">WantedBy</span>=multi-user.target<br></code></pre></td></tr></table></figure><p><code>EnvironmentFile</code> 配置文件 <code>/soyuan/k8s/api-server/apiserver</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">KUBE_API_ADDRESS</span>=<span class="hljs-string">&quot; --insecure-bind-address=0.0.0.0 --insecure-port=8080 --logtostderr=false --log-dir=/soyuan/k8s/api-server/logs --v=0&quot;</span><br><span class="hljs-attr">KUBE_ETCD_SERVERS</span>=<span class="hljs-string">&quot; --etcd-servers=http://172.16.100.92:2379&quot;</span><br><span class="hljs-attr">KUBE_SERVICE_ADDRESSES</span>=<span class="hljs-string">&quot; --service-cluster-ip-range=10.254.0.0/16 --service-node-port-range=1-65535&quot;</span><br><span class="hljs-attr">KUBE_ADMISSION_CONTROL</span>=<span class="hljs-string">&quot; --admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota,ServiceAccount&quot;</span><br><span class="hljs-attr">KUBE_API_ARGS</span>=<span class="hljs-string">&quot;&quot;</span><br></code></pre></td></tr></table></figure><h3 id="启动-kube-apiserver"><a href="#启动-kube-apiserver" class="headerlink" title="启动 kube-apiserver"></a>启动 kube-apiserver</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">重新加载系统服务文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动api-server</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl start kube-apiserver</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看状态</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl status kube-apiserver</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置开机启动</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> kube-apiserver</span><br></code></pre></td></tr></table></figure><h2 id="安装kube-controller-manager"><a href="#安装kube-controller-manager" class="headerlink" title="安装kube-controller-manager"></a>安装kube-controller-manager</h2><p>将 <code>kube-controller-manager</code> 上传到服务器</p><p><code>vim /usr/lib/systemd/system/kube-controller-manager.service</code> </p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Unit]</span><br><span class="hljs-attr">Description</span>=controller manager<br><span class="hljs-attr">After</span>=kube-apiserver.service<br><span class="hljs-attr">Requires</span>=kube-apiserver.service<br><br><span class="hljs-section">[Service]</span><br><span class="hljs-attr">EnvironmentFile</span>=/soyuan/k8s/kube-controller-manager/controller-manager<br><span class="hljs-attr">ExecStart</span>=/usr/local/bin/kube-controller-manager <span class="hljs-variable">$KUBE_CONTROLLER_MANAGER_AGE</span><br><span class="hljs-attr">Restart</span>=<span class="hljs-literal">on</span>-failure<br><span class="hljs-attr">LimitNOFILE</span>=<span class="hljs-number">65536</span><br><br><span class="hljs-section">[Install]</span><br><span class="hljs-attr">WantedBy</span>=multi-user.target<br></code></pre></td></tr></table></figure><p><code>EnvironmentFile</code> 配置文件 <code>/soyuan/k8s/kube-controller-manager/controller-manager</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">KUBE_CONTROLLER_MANAGER_AGE</span>=<span class="hljs-string">&quot;--master=http://172.16.100.92:8080 --service-account-private-key-file=/soyuan/k8s/172.16.100.92.key --logtostderr=false --log-dir=/soyuan/k8s/controller-manager/logs --v=0&quot;</span><br></code></pre></td></tr></table></figure><h3 id="启动kube-controller-manager服务"><a href="#启动kube-controller-manager服务" class="headerlink" title="启动kube-controller-manager服务"></a>启动kube-controller-manager服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">重新加载系统服务文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动服务</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl start kube-controller-manager</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看服务状态</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl status kube-controller-manager</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置开机启动</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> kube-controller-manager</span><br></code></pre></td></tr></table></figure><h2 id="安装kube-scheduler服务"><a href="#安装kube-scheduler服务" class="headerlink" title="安装kube-scheduler服务"></a>安装kube-scheduler服务</h2><p>将 <code>kube-scheduler</code> 上传到服务器</p><p><code>vim /usr/lib/systemd/system/kube-scheduler.service</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Unit]</span><br><span class="hljs-attr">Description</span>=Kubernetes Scheduler<br><span class="hljs-attr">After</span>=kube-apiserver.service <br><span class="hljs-attr">Requires</span>=kube-apiserver.service<br><br><span class="hljs-section">[Service]</span><br><span class="hljs-attr">EnvironmentFile</span>=/soyuan/k8s/kube-scheduler/scheduler<br><span class="hljs-attr">ExecStart</span>=/usr/local/bin/kube-scheduler <span class="hljs-variable">$KUBE_MASTER</span> <span class="hljs-variable">$KUBE_SCHEDULER_ARGS</span><br><span class="hljs-attr">Restart</span>=<span class="hljs-literal">on</span>-failure<br><span class="hljs-attr">LimitNOFILE</span>=<span class="hljs-number">65536</span><br><br><span class="hljs-section">[Install]</span><br><span class="hljs-attr">WantedBy</span>=multi-user.target<br></code></pre></td></tr></table></figure><p><code>EnvironmentFile</code> 配置文件 <code>/soyuan/k8s/kube-scheduler/scheduler</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">KUBE_MASTER</span>=<span class="hljs-string">&quot;--master=http://172.16.100.92:8080&quot;</span><br><span class="hljs-attr">KUBE_SCHEDULER_ARGS</span>=<span class="hljs-string">&quot;--logtostderr=true --log-dir=/soyuan/k8s/kube-schduler/logs --v=2&quot;</span><br></code></pre></td></tr></table></figure><h3 id="启动kube-scheduler服务"><a href="#启动kube-scheduler服务" class="headerlink" title="启动kube-scheduler服务"></a>启动kube-scheduler服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">重新加载系统服务文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动服务</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl start kube-scheduler</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看服务状态</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl status kube-scheduler</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置开机启动</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> kube-scheduler</span><br></code></pre></td></tr></table></figure><h2 id="在node节点安装kube-proxy"><a href="#在node节点安装kube-proxy" class="headerlink" title="在node节点安装kube-proxy"></a>在node节点安装kube-proxy</h2><p><code>vim /usr/lib/systemd/system/kube-proxy.service</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Unit]</span><br><span class="hljs-attr">Description</span>=Kubernetes Kube-Proxy Server<br><span class="hljs-attr">Documentation</span>=https://github.com/GoogleCloudPlatform/kubernetes<br><span class="hljs-attr">After</span>=network.target<br> <br><span class="hljs-section">[Service]</span><br><span class="hljs-attr">EnvironmentFile</span>=/soyuan/k8s/kube-node/config<br><span class="hljs-attr">EnvironmentFile</span>=/soyuan/k8s/kube-node/proxy<br><span class="hljs-attr">ExecStart</span>=/usr/local/bin/kube-proxy \<br>            $KUBE_LOGTOSTDERR \<br>            $KUBE_LOG_LEVEL \<br>            $KUBE_MASTER \<br>            $KUBE_PROXY_ARGS<br><span class="hljs-attr">Restart</span>=<span class="hljs-literal">on</span>-failure<br><span class="hljs-attr">LimitNOFILE</span>=<span class="hljs-number">65536</span><br> <br><span class="hljs-section">[Install]</span><br><span class="hljs-attr">WantedBy</span>=multi-user.target<br></code></pre></td></tr></table></figure><p><code>EnvironmentFile</code> 配置文件 </p><p><code>/soyuan/k8s/kube-node/config</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">KUBE_LOGTOSTDERR</span>=<span class="hljs-string">&quot;--logtostderr=true&quot;</span><br><span class="hljs-attr">KUBE_LOG_LEVEL</span>=<span class="hljs-string">&quot;--v=0&quot;</span><br><span class="hljs-attr">KUBE_ALLOW_PRIV</span>=<span class="hljs-string">&quot;--allow_privileged=false&quot;</span><br><span class="hljs-attr">KUBE_MASTER</span>=<span class="hljs-string">&quot;--master=http://172.16.100.92:8080 --kubeconfig /opt/k8s/kubeconfig&quot;</span><br></code></pre></td></tr></table></figure><p> <code>/soyuan/k8s/kube-node/proxy</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">KUBE_PROXY_ARGS</span>=<span class="hljs-string">&quot;&quot;</span><br></code></pre></td></tr></table></figure><p>可以再 <code>KUBE_PROXY_ARGS</code> 变量中增加启动可选参数</p><h3 id="启动kube-proxy服务"><a href="#启动kube-proxy服务" class="headerlink" title="启动kube-proxy服务"></a>启动kube-proxy服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">重新加载系统服务文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动服务</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl start kube-proxy</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看服务状态</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl status kube-proxy</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置开机启动</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> kube-proxy</span><br></code></pre></td></tr></table></figure><h2 id="在node节点安装kubelet"><a href="#在node节点安装kubelet" class="headerlink" title="在node节点安装kubelet"></a>在node节点安装kubelet</h2><p>机器必须先按照docker</p><p><code>vim /usr/lib/systemd/system/kubelet.service</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Unit]</span><br><span class="hljs-attr">Description</span>=Kubernetes Kubelet Server<br><span class="hljs-attr">Documentation</span>=https://github.com/GoogleCloudPlatform/kubernetes<br><span class="hljs-attr">After</span>=docker.service<br><span class="hljs-attr">Requires</span>=docker.service<br> <br><span class="hljs-section">[Service]</span><br><span class="hljs-attr">WorkingDirectory</span>=/soyuan/k8s/kube-node/kubelet<br><span class="hljs-attr">EnvironmentFile</span>=/soyuan/k8s/kube-node/kubeletenv<br><span class="hljs-attr">ExecStart</span>=/usr/local/bin/kubelet <span class="hljs-variable">$KUBELET_ARGS</span><br><span class="hljs-attr">Restart</span>=<span class="hljs-literal">on</span>-failure<br><span class="hljs-attr">KillMode</span>=process<br> <br><span class="hljs-section">[Install]</span><br><span class="hljs-attr">WantedBy</span>=multi-user.target<br></code></pre></td></tr></table></figure><p><code>EnvironmentFile</code> 配置文件 </p><p><code>/soyuan/k8s/kube-node/kubeletenv</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">KUBELET_ARGS</span>=<span class="hljs-string">&quot;--enable-server=true --enable-debugging-handlers=true --fail-swap-on=false --kubeconfig=/soyuan/k8s/kube-node/kubeconfig --hostname-override=kube-master  --cluster-dns=172.16.100.92 --cluster-domain=kube-master --certificate-authority=/soyuan/k8s/ssl/ca.crt&quot;</span><br></code></pre></td></tr></table></figure><p><code>/soyuan/k8s/kube-node/kubeconfig</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Config</span><br><span class="hljs-attr">users:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">kubelet</span><br><span class="hljs-attr">clusters:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes</span><br>  <span class="hljs-attr">cluster:</span><br>    <span class="hljs-attr">server:</span> <span class="hljs-string">http://172.16.100.92:8080</span><br><span class="hljs-attr">contexts:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">context:</span><br>    <span class="hljs-attr">cluster:</span> <span class="hljs-string">kubernetes</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">kubelet</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">service-account-context</span><br><span class="hljs-attr">current-context:</span> <span class="hljs-string">service-account-context</span><br></code></pre></td></tr></table></figure><h3 id="启动kebulet服务"><a href="#启动kebulet服务" class="headerlink" title="启动kebulet服务"></a>启动kebulet服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">重新加载系统服务文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建工作目录</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> -p /soyuan/k8s/kube-node/kubelet</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动服务</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl start kubelet</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看服务状态</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl status kubelet</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置开机启动</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> kubelet</span><br></code></pre></td></tr></table></figure><h3 id="导入docker-基础镜像"><a href="#导入docker-基础镜像" class="headerlink" title="导入docker 基础镜像"></a>导入docker 基础镜像</h3><p>kubelet 运行时需要基础镜像，需要先下载，因为默认镜像下载地址需要翻墙，所以得自己手动下载。</p><p>查看需要的镜像文件列表</p><p><code>kubeadm config images list</code></p><p><img src="/wiki/img/k8s/1.png"></p><p>从阿里云下载镜像，然后再把镜像名称改成k8s需要的</p><p><code>vim pullk8s.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">for i in `kubeadm config images list`; do<br>        imageName=$&#123;i#k8s.gcr.io/&#125;<br>        docker pull registry.aliyuncs.com/google_containers/$imageName<br>        docker tag registry.aliyuncs.com/google_containers/$imageName k8s.gcr.io/$imageName<br>        docker rmi registry.aliyuncs.com/google_containers/$imageName<br>done;<br></code></pre></td></tr></table></figure><p><code>sh ./pullk8s.sh</code></p><p>下载完成如下图</p><p><img src="/wiki/img/k8s/2.png"></p><h2 id="域名修改"><a href="#域名修改" class="headerlink" title="域名修改"></a>域名修改</h2><p>每个注册上来的node的 <code>hostname-override</code> 在<code>master</code>要配置<code>hosts</code>节点</p>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>k8s制作ssl证书</title>
    <link href="/wiki/2021/11/24/k8s/k8s%E5%88%B6%E4%BD%9Cssl%E8%AF%81%E4%B9%A6/"/>
    <url>/wiki/2021/11/24/k8s/k8s%E5%88%B6%E4%BD%9Cssl%E8%AF%81%E4%B9%A6/</url>
    
    <content type="html"><![CDATA[<h2 id="通过ca生成服务器证书"><a href="#通过ca生成服务器证书" class="headerlink" title="通过ca生成服务器证书"></a>通过ca生成服务器证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">server 证书请求文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> server-csr.json</span><br>&#123;<br>    &quot;CN&quot;: &quot;kubernetes&quot;,<br>    &quot;hosts&quot;: [<br>      &quot;10.254.0.1&quot;,<br>      &quot;172.16.100.92&quot;,<br>      &quot;172.16.100.63&quot;,<br>      &quot;kubernetes&quot;,<br>      &quot;kubernetes.default&quot;,<br>      &quot;kubernetes.default.svc&quot;,<br>      &quot;kubernetes.default.svc.cluster&quot;,<br>      &quot;kubernetes.default.svc.cluster.local&quot;<br>    ],<br>    &quot;key&quot;: &#123;<br>        &quot;algo&quot;: &quot;rsa&quot;,<br>        &quot;size&quot;: 2048<br>    &#125;,<br>    &quot;names&quot;: [<br>        &#123;<br>            &quot;C&quot;: &quot;CN&quot;,<br>            &quot;L&quot;: &quot;BeiJing&quot;,<br>            &quot;ST&quot;: &quot;BeiJing&quot;,<br>            &quot;O&quot;: &quot;k8s&quot;,<br>            &quot;OU&quot;: &quot;System&quot;<br>        &#125;<br>    ]<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">生成 server 证书</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=92 server-csr.json | cfssljson -bare server</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">kube-proxy 证书 请求文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> kube-proxy-csr.json</span><br><br>&#123;<br>  &quot;CN&quot;: &quot;system:kube-proxy&quot;,<br>  &quot;hosts&quot;: [],<br>  &quot;key&quot;: &#123;<br>    &quot;algo&quot;: &quot;rsa&quot;,<br>    &quot;size&quot;: 2048<br>  &#125;,<br>  &quot;names&quot;: [<br>    &#123;<br>      &quot;C&quot;: &quot;CN&quot;,<br>      &quot;L&quot;: &quot;BeiJing&quot;,<br>      &quot;ST&quot;: &quot;BeiJing&quot;,<br>      &quot;O&quot;: &quot;k8s&quot;,<br>      &quot;OU&quot;: &quot;System&quot;<br>    &#125;<br>  ]<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=92 kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Metricbeat收集系统指标</title>
    <link href="/wiki/2021/11/16/elasticsearch/Metricbeat%E6%94%B6%E9%9B%86%E7%B3%BB%E7%BB%9F%E6%8C%87%E6%A0%87/"/>
    <url>/wiki/2021/11/16/elasticsearch/Metricbeat%E6%94%B6%E9%9B%86%E7%B3%BB%E7%BB%9F%E6%8C%87%E6%A0%87/</url>
    
    <content type="html"><![CDATA[<h3 id="Metricbeat-部署"><a href="#Metricbeat-部署" class="headerlink" title="Metricbeat 部署"></a>Metricbeat 部署</h3><h4 id="下载程序"><a href="#下载程序" class="headerlink" title="下载程序"></a>下载程序</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-7.6.2-darwin-x86_64.tar.gz<br>tar xzvf metricbeat-7.6.2-darwin-x86_64.tar.gz<br>cd metricbeat-7.6.2-darwin-x86_64/<br></code></pre></td></tr></table></figure><h4 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p>修改 <code>metricbeat.yml</code> 设置连接信息：</p><p><code>es信息</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#-------------------------- Elasticsearch output ------------------------------</span><br><span class="hljs-attr">output.elasticsearch:</span><br>  <span class="hljs-comment"># Array of hosts to connect to.</span><br>  <span class="hljs-attr">hosts:</span> [<span class="hljs-string">&quot;172.16.100.92:9200&quot;</span>]<br><br>  <span class="hljs-comment"># Protocol - either `http` (default) or `https`.</span><br>  <span class="hljs-attr">protocol:</span> <span class="hljs-string">&quot;http&quot;</span><br><br>  <span class="hljs-comment"># Authentication credentials - either API key or username/password.</span><br>  <span class="hljs-comment">#api_key: &quot;id:api_key&quot;</span><br>  <span class="hljs-comment">#username: &quot;elastic&quot;</span><br>  <span class="hljs-comment">#password: &quot;changeme&quot;</span><br><br></code></pre></td></tr></table></figure><p><code>Kibana信息</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#============================== Kibana =====================================</span><br><br><span class="hljs-comment"># Starting with Beats version 6.0.0, the dashboards are loaded via the Kibana API.</span><br><span class="hljs-comment"># This requires a Kibana endpoint configuration.</span><br><span class="hljs-attr">setup.kibana:</span><br><br>  <span class="hljs-comment"># Kibana Host</span><br>  <span class="hljs-comment"># Scheme and port can be left out and will be set to the default (http and 5601)</span><br>  <span class="hljs-comment"># In case you specify and additional path, the scheme is required: http://localhost:5601/path</span><br>  <span class="hljs-comment"># IPv6 addresses should always be defined as: https://[2001:db8::1]:5601</span><br>  <span class="hljs-attr">host:</span> <span class="hljs-string">&quot;172.16.100.92:5601&quot;</span><br><br>  <span class="hljs-comment"># Kibana Space ID</span><br>  <span class="hljs-comment"># ID of the Kibana Space into which the dashboards should be loaded. By default,</span><br>  <span class="hljs-comment"># the Default Space will be used.</span><br>  <span class="hljs-comment">#space.id:</span><br></code></pre></td></tr></table></figure><p><code>公共信息</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#================================ General =====================================</span><br><br><span class="hljs-comment"># The name of the shipper that publishes the network data. It can be used to group</span><br><span class="hljs-comment"># all the transactions sent by a single shipper in the web interface.</span><br><span class="hljs-attr">name:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.100</span><span class="hljs-number">.92</span><br><br><span class="hljs-comment"># The tags of the shipper are included in their own field with each</span><br><span class="hljs-comment"># transaction published.</span><br><span class="hljs-comment">#tags: [&quot;service-X&quot;, &quot;web-tier&quot;]</span><br><br><span class="hljs-comment"># Optional fields that you can specify to add additional information to the</span><br><span class="hljs-comment"># output.</span><br><span class="hljs-comment">#fields:</span><br><span class="hljs-comment">#  env: staging</span><br><br></code></pre></td></tr></table></figure><p><code>启动system模块</code></p><p><code>./metricbeat modules enable system</code></p><p>其他模块请参考<code>/modules.d</code> 下的文件</p><p>可以在 <code>modules.d</code> 文件夹下找到 <code>system.yml</code> 配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># Module: system</span><br><span class="hljs-comment"># Docs: https://www.elastic.co/guide/en/beats/metricbeat/7.6/metricbeat-module-system.html</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">module:</span> <span class="hljs-string">system</span><br>  <span class="hljs-attr">period:</span> <span class="hljs-string">10s</span><br>  <span class="hljs-attr">metricsets:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">cpu</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">load</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">memory</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">network</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">process</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">process_summary</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">socket_summary</span><br>    <span class="hljs-comment">#- entropy</span><br>    <span class="hljs-comment">#- core</span><br>    <span class="hljs-comment">#- diskio</span><br>    <span class="hljs-comment">#- socket</span><br>    <span class="hljs-comment">#- service</span><br>  <span class="hljs-attr">process.include_top_n:</span><br>    <span class="hljs-attr">by_cpu:</span> <span class="hljs-number">5</span>      <span class="hljs-comment"># include top 5 processes by CPU</span><br>    <span class="hljs-attr">by_memory:</span> <span class="hljs-number">5</span>   <span class="hljs-comment"># include top 5 processes by memory</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">module:</span> <span class="hljs-string">system</span><br>  <span class="hljs-attr">period:</span> <span class="hljs-string">1m</span><br>  <span class="hljs-attr">metricsets:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">filesystem</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">fsstat</span><br>  <span class="hljs-attr">processors:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">drop_event.when.regexp:</span><br>      <span class="hljs-attr">system.filesystem.mount_point:</span> <span class="hljs-string">&#x27;^/(sys|cgroup|proc|dev|etc|host|lib)($|/)&#x27;</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">module:</span> <span class="hljs-string">system</span><br>  <span class="hljs-attr">period:</span> <span class="hljs-string">15m</span><br>  <span class="hljs-attr">metricsets:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">uptime</span><br><br><span class="hljs-comment">#- module: system</span><br><span class="hljs-comment">#  period: 5m</span><br><span class="hljs-comment">#  metricsets:</span><br><span class="hljs-comment">#    - raid</span><br><span class="hljs-comment">#  raid.mount_point: &#x27;/&#x27;</span><br><br></code></pre></td></tr></table></figure><h4 id="设置仪表盘数据"><a href="#设置仪表盘数据" class="headerlink" title="设置仪表盘数据"></a>设置仪表盘数据</h4><p><code>./metricbeat setup</code></p><h4 id="前台启动"><a href="#前台启动" class="headerlink" title="前台启动"></a>前台启动</h4><p><code>./metricbeat -e</code></p><h4 id="安装成系统服务"><a href="#安装成系统服务" class="headerlink" title="安装成系统服务"></a>安装成系统服务</h4><p>请参考 <a href="../java/springboot%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF.md">springboot开机自启</a></p>]]></content>
    
    
    <categories>
      
      <category>elasticsearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>开发</tag>
      
      <tag>elasticsearch</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>elasticsearch部署</title>
    <link href="/wiki/2021/11/10/elasticsearch/elasticsearch%E9%83%A8%E7%BD%B2/"/>
    <url>/wiki/2021/11/10/elasticsearch/elasticsearch%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h3 id="ElasticSearch-部署"><a href="#ElasticSearch-部署" class="headerlink" title="ElasticSearch 部署"></a>ElasticSearch 部署</h3><ul><li>每个节点可部署到不同的服务器</li><li>镜像：elasticsearch:7.6.2</li><li>可以配置单机模式 “discovery.type=single-node”</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs shell">version: &quot;3&quot;<br>services:<br>  es_n0:<br>    image: elasticsearch:7.6.2<br>    container_name: es_n0<br>    privileged: true<br>    environment:<br>      - cluster.name=elasticsearch-cluster<br>      - node.name=node0<br>      - node.master=true<br>      - node.data=true<br>      - bootstrap.memory_lock=true<br>      - search.max_buckets=100000000<br>      - http.cors.enabled=true<br>      - http.cors.allow-origin=*<br>      - cluster.initial_master_nodes=node0<br>      - &quot;ES_JAVA_OPTS=-Xms1024m -Xmx1024m&quot;<br>      - &quot;discovery.zen.ping.unicast.hosts=es_n0,es_n1,es_n2&quot;<br>      - &quot;discovery.zen.minimum_master_nodes=2&quot;<br>      - client.transport.ping_timeout=60s<br>    ulimits:<br>      memlock:<br>        soft: -1<br>        hard: -1<br>    volumes:<br>      - /etc/localtime:/etc/localtime<br>      - /data/base/es/data/node0:/usr/share/elasticsearch/data<br>      - ./logs/node0:/usr/share/elasticsearch/logs<br>    ports:<br>      - 9200:9200<br>      - 9300:9300<br>  es_n1:<br>    image: elasticsearch:7.6.2<br>    container_name: es_n1<br>    privileged: true<br>    environment:<br>      - cluster.name=elasticsearch-cluster<br>      - node.name=node0<br>      - node.master=true<br>      - node.data=true<br>      - bootstrap.memory_lock=true<br>      - search.max_buckets=100000000<br>      - http.cors.enabled=true<br>      - http.cors.allow-origin=*<br>      - cluster.initial_master_nodes=node0<br>      - &quot;ES_JAVA_OPTS=-Xms1024m -Xmx1024m&quot;<br>      - &quot;discovery.zen.ping.unicast.hosts=es_n0,es_n1,es_n2&quot;<br>      - &quot;discovery.zen.minimum_master_nodes=2&quot;<br>      - client.transport.ping_timeout=60s<br>    ulimits:<br>      memlock:<br>        soft: -1<br>        hard: -1<br>    volumes:<br>      - /etc/localtime:/etc/localtime<br>      - /data/base/es/data/node1:/usr/share/elasticsearch/data<br>      - ./logs/node1:/usr/share/elasticsearch/logs<br>    ports:<br>      - 9201:9200<br>      - 9301:9300<br>  es_n2:<br>    image: elasticsearch:7.6.2<br>    container_name: es_n2<br>    privileged: true<br>    environment:<br>      - cluster.name=elasticsearch-cluster<br>      - node.name=node0<br>      - node.master=true<br>      - node.data=true<br>      - bootstrap.memory_lock=true<br>      - search.max_buckets=100000000<br>      - http.cors.enabled=true<br>      - http.cors.allow-origin=*<br>      - cluster.initial_master_nodes=node0<br>      - &quot;ES_JAVA_OPTS=-Xms1024m -Xmx1024m&quot;<br>      - &quot;discovery.zen.ping.unicast.hosts=es_n0,es_n1,es_n2&quot;<br>      - &quot;discovery.zen.minimum_master_nodes=2&quot;<br>      - client.transport.ping_timeout=60s<br>    ulimits:<br>      memlock:<br>        soft: -1<br>        hard: -1<br>    volumes:<br>      - /etc/localtime:/etc/localtime<br>      - /data/base/es/data/node2:/usr/share/elasticsearch/data<br>      - ./logs/node2:/usr/share/elasticsearch/logs<br>    ports:<br>      - 9202:9200<br>      - 9302:9300<br><br></code></pre></td></tr></table></figure><h3 id="启动前给logs文件夹和数据文件夹赋权"><a href="#启动前给logs文件夹和数据文件夹赋权" class="headerlink" title="启动前给logs文件夹和数据文件夹赋权"></a>启动前给logs文件夹和数据文件夹赋权</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">chmod 777 logs/node0/<br>chmod 777 logs/node1/<br>chmod 777 logs/node2/<br><br>chmod 777 /data/base/es/data/node0<br>chmod 777 /data/base/es/data/node1<br>chmod 777 /data/base/es/data/node2<br></code></pre></td></tr></table></figure><h3 id="单机模式"><a href="#单机模式" class="headerlink" title="单机模式"></a>单机模式</h3><p>要把<code>cluster.initial_master_nodes</code> <code>&quot;discovery.zen.ping.unicast.hosts=es_n0,es_n1,es_n2&quot;</code> <code>&quot;discovery.zen.minimum_master_nodes=2&quot;</code> 注释掉</p>]]></content>
    
    
    <categories>
      
      <category>elasticsearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>开发</tag>
      
      <tag>elasticsearch</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kibana部署</title>
    <link href="/wiki/2021/11/10/elasticsearch/kibana%E9%83%A8%E7%BD%B2/"/>
    <url>/wiki/2021/11/10/elasticsearch/kibana%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h3 id="kibana部署"><a href="#kibana部署" class="headerlink" title="kibana部署"></a>kibana部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">version: &quot;3&quot;<br>services:<br>  kibana:<br>    image: kibana:7.6.2<br>    container_name: kibana<br>    ports:<br>      - 5601:5601<br>    volumes:<br>      - /etc/localtime:/etc/localtime<br>      - ./kibana/kibana.yml:/usr/share/kibana/config/kibana.yml:rw <br></code></pre></td></tr></table></figure><p><code>kibana.yml</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment">## ** THIS IS AN AUTO-GENERATED FILE **</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment">#  # Default Kibana configuration for docker target</span></span><br>server.name: kibana<br>server.host: &quot;0.0.0.0&quot;<br>elasticsearch.hosts: [&quot;http://172.16.100.92:9200&quot;]<br>xpack.monitoring.ui.container.elasticsearch.enabled: true<br>i18n.locale: &quot;zh-CN&quot;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>elasticsearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>开发</tag>
      
      <tag>elasticsearch</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>logstash部署</title>
    <link href="/wiki/2021/11/10/elasticsearch/logstash%E9%83%A8%E7%BD%B2/"/>
    <url>/wiki/2021/11/10/elasticsearch/logstash%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h3 id="Logstash-部署"><a href="#Logstash-部署" class="headerlink" title="Logstash 部署"></a>Logstash 部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">version: &quot;3&quot;<br>services:<br>  logstash:<br>    image: logstash:7.8.0<br>    container_name: logstash<br>    volumes:<br>      - ./logstash.yml:/usr/share/logstash/config/logstash.yml<br>      - ./conf.d/logstash.conf:/usr/share/logstash/pipeline/logstash.conf<br>      - /opt/dockercompose/logfile/umstransition:/umstransitionLogs<br>    network_mode: host # 网络模式<br></code></pre></td></tr></table></figure><p><code>logstash.yml</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">xpack.monitoring.elasticsearch.hosts: [ &quot;http://172.16.100.92:9200&quot;,&quot;http://172.16.100.92:9201&quot;,&quot;http://172.16.100.92:9202&quot; ]<br>http.host: &quot;0.0.0.0&quot;<br></code></pre></td></tr></table></figure><p><code>logstash.conf</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">logstash.conf</span><br>input &#123;<br>     file &#123;<br>     path =&gt; &quot;/umstransitionLogs/*&quot;<br>     type =&gt; &quot;umstransitionLogs&quot;<br>     start_position =&gt; &quot;beginning&quot; <br>     &#125;<br>&#125; <br><br><br>output &#123;<br> if [type] == &quot;umstransitionLogs&quot; &#123;<br> elasticsearch &#123;<br>            hosts =&gt; [ &quot;http://172.16.100.92:9200&quot;]<br>            index =&gt; &quot;umstransitionlogs-93-%&#123;+YYYY.MM.dd&#125;&quot;<br>    &#125;<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>elasticsearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>开发</tag>
      
      <tag>elasticsearch</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jenkins构建vue</title>
    <link href="/wiki/2021/11/03/jenkins/jenkins%E6%9E%84%E5%BB%BAvue/"/>
    <url>/wiki/2021/11/03/jenkins/jenkins%E6%9E%84%E5%BB%BAvue/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jenlins构建springboot</title>
    <link href="/wiki/2021/11/03/jenkins/jenlins%E6%9E%84%E5%BB%BAspringboot/"/>
    <url>/wiki/2021/11/03/jenkins/jenlins%E6%9E%84%E5%BB%BAspringboot/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>centos配置jdk环境变量</title>
    <link href="/wiki/2021/11/03/java/centos%E9%85%8D%E7%BD%AEjdk%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/"/>
    <url>/wiki/2021/11/03/java/centos%E9%85%8D%E7%BD%AEjdk%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/</url>
    
    <content type="html"><![CDATA[<h2 id="下载jdk"><a href="#下载jdk" class="headerlink" title="下载jdk"></a>下载jdk</h2><p><code>https://www.oracle.com/java/technologies/downloads/</code></p><h2 id="增加环境变量"><a href="#增加环境变量" class="headerlink" title="增加环境变量"></a>增加环境变量</h2><p><code>vi /etc/profile</code></p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">export JAVA_HOME=/opt/jdk/jdk1.8.0_301<br>export CLASSPATH=$JAVA_HOME/lib/<br>export PATH=$PATH:$JAVA_HOME/bin<br>export PATH JAVA_HOME CLASSPATH<br></code></pre></td></tr></table></figure><p><code>source /etc/profile</code></p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p><img src="/wiki/img/java/1.png"></p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>maven安装</title>
    <link href="/wiki/2021/11/03/java/maven%E5%AE%89%E8%A3%85/"/>
    <url>/wiki/2021/11/03/java/maven%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h2 id="下载maven"><a href="#下载maven" class="headerlink" title="下载maven"></a>下载maven</h2><p><code>https://maven.apache.org/download.cgi</code></p><blockquote><p>下载完解压到指定目录，windows和liunx操作方式是一样的</p></blockquote><h2 id="修改阿里云代理"><a href="#修改阿里云代理" class="headerlink" title="修改阿里云代理"></a>修改阿里云代理</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">mirror</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>alimaven<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">mirrorOf</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">mirrorOf</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>aliyun maven<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/repositories/central/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">mirror</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">mirrors</span>&gt;</span><br><br></code></pre></td></tr></table></figure><h2 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h2><p><code>vi /etc/profile</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">maven</span><br>export MAVEN_HOME=/soyuan/apache-maven-3.6.2-bin/apache-maven-3.6.2<br>export PATH=$MAVEN_HOME/bin:$PATH<br><br></code></pre></td></tr></table></figure><p><code>source /etc/profile</code></p><h2 id="增加权限"><a href="#增加权限" class="headerlink" title="增加权限"></a>增加权限</h2><p><code>chmod +x /soyuan/apache-maven-3.6.2-bin/apache-maven-3.6.2/bin/*</code></p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p><img src="/wiki/img/java/2.png"></p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>springboot开机自启</title>
    <link href="/wiki/2021/11/03/java/springboot%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF/"/>
    <url>/wiki/2021/11/03/java/springboot%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF/</url>
    
    <content type="html"><![CDATA[<h4 id="编写service脚本"><a href="#编写service脚本" class="headerlink" title="编写service脚本"></a>编写service脚本</h4><p><code>vim /etc/systemd/system/transform.service</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">[Unit]<br>Description= transform service<br>Documentation=transform service<br>After=network-online.target firewalld.service<br>Wants=network-online.target<br><br>[Service]<br>ExecStart=/opt/jdk/jdk1.8.0_301/bin/java -jar /opt/transform/transform-0.0.1-SNAPSHOT.jar<br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure><h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h4><p> <code>systemctl start transform</code></p><h4 id="停止服务"><a href="#停止服务" class="headerlink" title="停止服务"></a>停止服务</h4><p> <code>systemctl stop transform</code></p><h4 id="开机自启"><a href="#开机自启" class="headerlink" title="开机自启"></a>开机自启</h4><p><code>systemctl enable transform</code></p><h4 id="取消开机自启"><a href="#取消开机自启" class="headerlink" title="取消开机自启"></a>取消开机自启</h4><p><code>systemctl disable transform</code></p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>开发</tag>
      
      <tag>java</tag>
      
      <tag>spring boot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jenkins安装部署</title>
    <link href="/wiki/2021/11/02/jenkins/jenkins%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"/>
    <url>/wiki/2021/11/02/jenkins/jenkins%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h2 id="下载war包"><a href="#下载war包" class="headerlink" title="下载war包"></a>下载war包</h2><p><code>https://www.jenkins.io/zh/download/</code></p><h2 id="前台直接运行"><a href="#前台直接运行" class="headerlink" title="前台直接运行"></a>前台直接运行</h2><p><code>java -jar jenkins.war --httpPort=7000</code></p><h2 id="初始化配置"><a href="#初始化配置" class="headerlink" title="初始化配置"></a>初始化配置</h2><p><strong>浏览器运行</strong></p><blockquote><p><code>http://172.16.100.92:7000</code></p></blockquote><p><img src="/img/jenkins/1.png"></p><p>按照提示进行配置 </p><h2 id="admin初始化密码修改"><a href="#admin初始化密码修改" class="headerlink" title="admin初始化密码修改"></a>admin初始化密码修改</h2><blockquote><p>可以新创建用户，如果使用admin账户可以修改配置文件初始化密码</p></blockquote><p><strong>找到储存密码位置</strong><br><code>/root/.jenkins/users/admin_8611388362064810197/config.xml</code><br><code>vim /var/lib/jenkins/users/admin_1769376840817810947/config.xml</code><br><strong>打开该配置文件找到<passwordHash>节点</strong><br>123456加密后：#jbcrypt:$2a$10$MiIVR0rr/UhQBqT.bBq0QehTiQVqgNpUGyWW2nJObaVAM/2xSQdSq<br><strong>替换密码，重启</strong></p><p><img src="/img/jenkins/2.png"></p><h2 id="打包成liunx系统服务"><a href="#打包成liunx系统服务" class="headerlink" title="打包成liunx系统服务"></a>打包成liunx系统服务</h2><p><strong>启动停止脚本</strong><br><code>vi jenkins.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br>JAVA_HOME=/opt/jdk/jdk1.8.0_301<br><br>pid=`ps -ef | grep jenkins.war | grep -v &#x27;grep&#x27;| awk &#x27;&#123;print $2&#125;&#x27;| wc -l`<br>if [ &quot;$1&quot; = &quot;start&quot; ];then<br>   if [ $pid -gt 0 ];then<br>      echo &#x27;jenkins is running...&#x27;<br>   else<br>      nohup $JAVA_HOME/bin/java -jar /soyuan/jenkins/jenkins.war --enable-future-java --httpPort=7000  2&gt;&amp;1 &amp;<br>   fi<br>elif [ &quot;$1&quot; = &quot;stop&quot; ];then<br>   exec ps -ef | grep jenkins | grep -v grep | awk &#x27;&#123;print $2&#125;&#x27;| xargs kill -9<br>   echo &#x27;jenkins is stop..&#x27;<br>else<br>   echo &quot;Please input like this:&quot;./jenkins.sh start&quot; or &quot;./jenkins stop&quot;&quot;<br>fi<br></code></pre></td></tr></table></figure><p><strong>脚本权限</strong></p><p><code>chmod +x jenkins.sh</code></p><p><strong>测试脚本</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">./jenkins.sh start<br>./jenkins.sh stop<br></code></pre></td></tr></table></figure><h2 id="创建系统服务"><a href="#创建系统服务" class="headerlink" title="创建系统服务"></a>创建系统服务</h2><p><code>vim /etc/systemd/system/jenkins.service</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">[Unit]<br>Description=Jenkins<br>After=network.target<br><br>[Service]<br>Type=forking<br>ExecStart=/soyuan/jenkins/jenkins.sh start<br>ExecReload=<br>ExecStop=/soyuan/jenkins/jenkins.sh stop<br>PrivateTmp=true<br><br>[Install]<br>WantedBy=multi-user.target<br><br></code></pre></td></tr></table></figure><p><strong>重新加载系统服务</strong></p><p><code>systemctl daemon-reload</code></p><p><strong>启动服务</strong></p><p><code>systemctl start jenkins</code></p><p><strong>开机启动</strong></p><p><code>systemctl enable jenkins</code></p><p><strong>配置本机jdk maven</strong></p><blockquote><p><code>系统设置 -&gt; 全局工具配置</code></p></blockquote><p> <img src="/img/jenkins/3.png"><br> <img src="/img/jenkins/4.png"></p>]]></content>
    
    
    <categories>
      
      <category>jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>运维</tag>
      
      <tag>jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>dockerfile centos</title>
    <link href="/wiki/2021/11/02/docker/dockerfile%20centos/"/>
    <url>/wiki/2021/11/02/docker/dockerfile%20centos/</url>
    
    <content type="html"><![CDATA[<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs docker"><span class="hljs-keyword">FROM</span> centos:<span class="hljs-number">7</span><br><br><span class="hljs-keyword">COPY</span><span class="language-bash"> <span class="hljs-built_in">test</span> /</span><br><br><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"> <span class="hljs-built_in">tail</span> -f /test</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>开发</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker安装</title>
    <link href="/wiki/2021/11/02/docker/docker%E5%AE%89%E8%A3%85/"/>
    <url>/wiki/2021/11/02/docker/docker%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h3 id="下载docker二进制文件"><a href="#下载docker二进制文件" class="headerlink" title="下载docker二进制文件"></a>下载docker二进制文件</h3><p><code>https://download.docker.com/linux/static/stable/x86_64/docker-19.03.6.tgz</code></p><h3 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h3><p><code>tar xf docker-19.03.6.tgz</code></p><h3 id="复制到-usr-local-bin"><a href="#复制到-usr-local-bin" class="headerlink" title="复制到/usr/local/bin"></a>复制到/usr/local/bin</h3><p><code>mv docker/* /usr/local/bin/</code></p><h3 id="直接运行"><a href="#直接运行" class="headerlink" title="直接运行"></a>直接运行</h3><p><code>/usr/bin/dockerd</code></p><h3 id="demon模式运行-并保存日志"><a href="#demon模式运行-并保存日志" class="headerlink" title="demon模式运行,并保存日志"></a>demon模式运行,并保存日志</h3><p><code>nohup /usr/bin/dockerd &gt;/docker.log 2&gt;&amp;1 &amp;</code></p><h3 id="systemctl运行"><a href="#systemctl运行" class="headerlink" title="systemctl运行"></a>systemctl运行</h3><p>sudo vim /usr/lib/systemd/system/docker.service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell">[Unit]<br>Description=Docker Application Container Engine<br>Documentation=https://docs.docker.com<br>After=network-online.target firewalld.service<br>Wants=network-online.target<br><br>[Service]<br>Type=notify<br>ExecStart=/usr/local/bin/dockerd -H tcp://0.0.0.0:2371 -H unix:///var/run/docker.sock<br>ExecReload=/bin/kill -s HUP $MAINPID<br>LimitNOFILE=infinity<br>LimitNPROC=infinity<br>TimeoutStartSec=0<br>Delegate=yes<br>KillMode=process<br>Restart=on-failure<br>StartLimitBurst=3<br>StartLimitInterval=60s<br><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure><h3 id="设置权限权限为可执行"><a href="#设置权限权限为可执行" class="headerlink" title="设置权限权限为可执行"></a>设置权限权限为可执行</h3><p><code>chmod +x /etc/systemd/system/docker.service</code></p><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl daemon-reload   //重载配置文件<br>systemctl start docker    //启动Docker<br>systemctl stop docker    //关闭docker<br>systemctl restart  docker    //重启docker<br>systemctl enable docker.service   //设置开机自启<br>systemctl status docker    //查看Docker状态<br></code></pre></td></tr></table></figure><h3 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">chmod +x docker-compose<br>mv docker-compose /usr/local/bin<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>开发</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker限制日志大小</title>
    <link href="/wiki/2021/11/02/docker/docker%E9%99%90%E5%88%B6%E6%97%A5%E5%BF%97%E5%A4%A7%E5%B0%8F/"/>
    <url>/wiki/2021/11/02/docker/docker%E9%99%90%E5%88%B6%E6%97%A5%E5%BF%97%E5%A4%A7%E5%B0%8F/</url>
    
    <content type="html"><![CDATA[<p>新建/etc/docker/daemon.json，若有就不用新建了。添加log-dirver和log-opts参数，样例如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">vim /etc/docker/daemon.json</span><br><br>&#123;<br>  &quot;log-driver&quot;:&quot;json-file&quot;,<br>  &quot;log-opts&quot;: &#123;&quot;max-size&quot;:&quot;500m&quot;, &quot;max-file&quot;:&quot;3&quot;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>max-size=500m，意味着一个容器日志大小上限是500M， </li><li>max-file=3，意味着一个容器有三个日志，分别是id+.json、id+1.json、id+2.json。</li></ul><p>然后重启docker的守护线程</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl restart docker<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>开发</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>环境配置</title>
    <link href="/wiki/2021/11/02/go/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    <url>/wiki/2021/11/02/go/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<p><a href="https://goproxy.cn/">https://goproxy.cn/</a></p>]]></content>
    
    
    <categories>
      
      <category>go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>开发</tag>
      
      <tag>go</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>git配置ssh秘钥</title>
    <link href="/wiki/2021/11/02/git/git%E9%85%8D%E7%BD%AEssh%E7%A7%98%E9%92%A5/"/>
    <url>/wiki/2021/11/02/git/git%E9%85%8D%E7%BD%AEssh%E7%A7%98%E9%92%A5/</url>
    
    <content type="html"><![CDATA[<h2 id="gitlab支持算法类型"><a href="#gitlab支持算法类型" class="headerlink" title="gitlab支持算法类型"></a>gitlab支持算法类型</h2><p>最新gitlab支持算法类型如下</p><table><thead><tr><th>算法</th><th>公钥</th><th>私钥</th></tr></thead><tbody><tr><td>ED25519（首选）</td><td>id_ed25519.pub</td><td>id_ed25519</td></tr><tr><td>RSA（至少 2048 位密钥大小）</td><td>id_rsa.pub</td><td>id_rsa</td></tr><tr><td>DSA（已弃用）</td><td>id_dsa.pub</td><td>id_dsa</td></tr><tr><td>ECDSA</td><td>id_ecdsa.pub</td><td>id_ecdsa</td></tr></tbody></table><p><strong>RSA一定要注意，1024位的密码支持了，要生成2048位的。</strong></p><p>生成<code>ED25519</code>密钥对</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ssh-keygen -t ed25519 -C &quot;zhaops@soyuan.com.cn&quot; <br></code></pre></td></tr></table></figure><p>生成<code>2048</code>位<code>RSA</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ssh-keygen -t rsa -b 2048 -C &quot;zhaops@soyuan.com.cn&quot; <br></code></pre></td></tr></table></figure><p>文件生成到 <code>~/.ssh/</code> 目录</p><h2 id="指定要是用的密钥对"><a href="#指定要是用的密钥对" class="headerlink" title="指定要是用的密钥对"></a>指定要是用的密钥对</h2><p>获取代码,提交代码默认使用的密钥对为 <code>id_rsa.pub</code>  <code>id_rsa</code>  ，可以根据提交的<code>域名</code>或<code>ip</code>单独指定<code>pull</code>，<code>push</code>使用的密钥对，</p><p><code>vi ~/.ssh/config</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini">Host git@gitlab.soyuan.com.cn  <span class="hljs-comment"># 这个是你提交的时候的域名，会根据这个去匹配</span><br>    Hostname git@gitlab.soyuan.com.cn<br>    User git<br>    Port 30022<br>    PreferredAuthentications publickey<br>    IdentityFile ~/.ssh/id_ed25519<br></code></pre></td></tr></table></figure><p>把公钥添加到<code>git</code> 或者 <code>gitlab</code>的<code>ssh管理</code>，私钥填到上面的配置文件中</p>]]></content>
    
    
    <categories>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
      <tag>工具配置</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>k8s部署</title>
    <link href="/wiki/2021/11/02/srs/k8s%E9%83%A8%E7%BD%B2/"/>
    <url>/wiki/2021/11/02/srs/k8s%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h3 id="证书"><a href="#证书" class="headerlink" title="证书"></a>证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl create secret generic 92-ssl --from-file=ssh-privatekey=172.16.100.92-key.pem --from-file=ssh-publickey=172.16.100.92.pem<br></code></pre></td></tr></table></figure><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p><code>srs.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">srs-config</span><br><span class="hljs-attr">data:</span> <br>  <span class="hljs-attr">srs.conf:</span> <span class="hljs-string">|-</span><br><span class="hljs-string">        listen              1935;</span><br><span class="hljs-string">        max_connections     1000;</span><br><span class="hljs-string">        daemon              off;</span><br><span class="hljs-string">        http_api &#123;</span><br><span class="hljs-string">            enabled         on;</span><br><span class="hljs-string">            listen          1985;</span><br><span class="hljs-string">                https &#123;</span><br><span class="hljs-string">                        enabled on;</span><br><span class="hljs-string">                        listen 443;</span><br><span class="hljs-string">                        key /ssl/ssh-privatekey;</span><br><span class="hljs-string">                        cert /ssl/ssh-publickey;</span><br><span class="hljs-string">                      &#125;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">        http_server &#123;</span><br><span class="hljs-string">            enabled         on;</span><br><span class="hljs-string">            listen          8080;</span><br><span class="hljs-string">            https &#123;</span><br><span class="hljs-string">                  enabled on;</span><br><span class="hljs-string">                  listen 8090;</span><br><span class="hljs-string">                  key /ssl/ssh-privatekey;</span><br><span class="hljs-string">                  cert /ssl/ssh-publickey;</span><br><span class="hljs-string">            &#125;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">        rtc_server &#123;</span><br><span class="hljs-string">              enabled         on;</span><br><span class="hljs-string">              # Listen at udp://38000</span><br><span class="hljs-string">              listen          38000;</span><br><span class="hljs-string">              #</span><br><span class="hljs-string">              # The $CANDIDATE means fetch from env, if not configed, use * as default.</span><br><span class="hljs-string">              #</span><br><span class="hljs-string">              # The * means retrieving server IP automatically, from all network interfaces,</span><br><span class="hljs-string">              # @see https://github.com/ossrs/srs/issues/307#issuecomment-599028124</span><br><span class="hljs-string">              candidate       $CANDIDATE;</span><br><span class="hljs-string">          &#125;</span><br><span class="hljs-string"></span><br><br>        <span class="hljs-string">vhost</span> <span class="hljs-string">__defaultVhost__</span> &#123;<br>            <span class="hljs-comment"># 低延迟模式</span><br>              <span class="hljs-string">tcp_nodelay</span>     <span class="hljs-string">on;</span><br>              <span class="hljs-string">min_latency</span>     <span class="hljs-string">on;</span><br><br>              <span class="hljs-string">play</span> &#123;<br>                  <span class="hljs-string">gop_cache</span>       <span class="hljs-string">off;</span><br>                  <span class="hljs-string">queue_length</span>    <span class="hljs-number">10</span><span class="hljs-string">;</span><br>                  <span class="hljs-string">mw_latency</span>      <span class="hljs-number">100</span><span class="hljs-string">;</span><br>              &#125;<br><br>              <span class="hljs-string">publish</span> &#123;<br>                  <span class="hljs-string">mr</span> <span class="hljs-string">off;</span><br>              &#125;<br>              <br>              <span class="hljs-comment"># hls 播放</span><br>              <span class="hljs-string">hls</span> &#123;<br>                  <span class="hljs-string">enabled</span>         <span class="hljs-string">off;</span><br>                  <span class="hljs-string">hls_path</span>        <span class="hljs-string">./objs/nginx/html;</span><br>              &#125;<br>              <span class="hljs-comment"># 开启 flv 播放</span><br>              <span class="hljs-string">http_remux</span> &#123;<br>                  <span class="hljs-string">enabled</span>     <span class="hljs-string">off;</span><br>                  <span class="hljs-string">mount</span>       [<span class="hljs-string">vhost</span>]<span class="hljs-string">/</span>[<span class="hljs-string">app</span>]<span class="hljs-string">/</span>[<span class="hljs-string">stream</span>]<span class="hljs-string">.flv;</span><br>              &#125;<br>              <span class="hljs-string">rtc</span> &#123;<br>                  <span class="hljs-string">enabled</span>     <span class="hljs-string">on;</span><br>                  <span class="hljs-string">bframe</span>      <span class="hljs-string">discard;</span><br>                  <span class="hljs-string">rtc_to_rtmp</span> <span class="hljs-string">off;</span><br>              &#125;<br>        &#125;<br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">srs-deployment</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">srs</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">srs</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">srs</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">nodeSelector:</span> <br>        <span class="hljs-attr">type:</span> <span class="hljs-string">master</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>        <span class="hljs-attr">configMap:</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">srs-config</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">secret-volume</span><br>        <span class="hljs-attr">secret:</span><br>          <span class="hljs-attr">secretName:</span> <span class="hljs-number">92</span><span class="hljs-string">-ssl</span> <br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">srs</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">ossrs/srs:4</span><br>        <span class="hljs-attr">env:</span> <br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">CANDIDATE</span><br>            <span class="hljs-attr">value:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.100</span><span class="hljs-number">.92</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">1935</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">1985</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8090</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">38000</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">443</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/usr/local/srs/conf</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">secret-volume</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/ssl</span><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">srs-service</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">srs</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-comment"># rtmp </span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">srs-service-1935-31935</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">1935</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">1935</span><br>    <span class="hljs-attr">nodePort:</span> <span class="hljs-number">31935</span><br>  <span class="hljs-comment"># api</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">srs-service-443-31443</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">443</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">443</span><br>    <span class="hljs-attr">nodePort:</span> <span class="hljs-number">31443</span><br>  <span class="hljs-comment"># svc</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">srs-service-8090-38090</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">8090</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8090</span><br>    <span class="hljs-attr">nodePort:</span> <span class="hljs-number">38090</span><br>  <span class="hljs-comment"># rtc</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">srs-service-38000-38000</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">38000</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">UDP</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">38000</span><br>    <span class="hljs-attr">nodePort:</span> <span class="hljs-number">38000</span><br></code></pre></td></tr></table></figure><h3 id="端口信息"><a href="#端口信息" class="headerlink" title="端口信息"></a>端口信息</h3><table><thead><tr><th>内部端口</th><th>外部端口</th><th>解释</th></tr></thead><tbody><tr><td>1935</td><td>31935</td><td>rtmp推流端口</td></tr><tr><td>443</td><td>31443</td><td>https srs api</td></tr><tr><td>8090</td><td>38090</td><td>https http服务地址，flv播放地址等</td></tr><tr><td>38000</td><td>38000</td><td>rtc端口</td></tr></tbody></table><h3 id="flv播放"><a href="#flv播放" class="headerlink" title="flv播放"></a>flv播放</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span><span class="hljs-number">172.16</span>.<span class="hljs-number">100.92</span>:<span class="hljs-number">38090</span><span class="hljs-regexp">/live/</span>aaa.flv<br></code></pre></td></tr></table></figure><h3 id="信令服务器"><a href="#信令服务器" class="headerlink" title="信令服务器"></a>信令服务器</h3><p>/soyuan/sslone2one</p><h3 id="srs"><a href="#srs" class="headerlink" title="srs"></a>srs</h3><p>/soyuan/srs</p><h3 id="仓库"><a href="#仓库" class="headerlink" title="仓库"></a>仓库</h3><p><a href="https://github.com/ossrs/srs">https://github.com/ossrs/srs</a><br><a href="https://github.com/ossrs/srs-docs">https://github.com/ossrs/srs-docs</a></p><h3 id="平滑退出"><a href="#平滑退出" class="headerlink" title="平滑退出"></a>平滑退出</h3><p><a href="https://github.com/ossrs/srs/issues/1579">https://github.com/ossrs/srs/issues/1579</a><br>grace_final_wait 3200;<br>force_grace_quit off;</p>]]></content>
    
    
    <categories>
      
      <category>srs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>开发</tag>
      
      <tag>srs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>公网环境部署</title>
    <link href="/wiki/2021/11/02/srs/%E5%85%AC%E7%BD%91%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2/"/>
    <url>/wiki/2021/11/02/srs/%E5%85%AC%E7%BD%91%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h3 id="服务器规划"><a href="#服务器规划" class="headerlink" title="服务器规划"></a>服务器规划</h3><table><thead><tr><th>服务器</th><th>域名</th><th>备注</th></tr></thead><tbody><tr><td>221.226.4.130</td><td>meeting.soyuan.com.cn</td><td></td></tr></tbody></table><p>服务改用docker方式部署，后期测试完成改成k8s</p><h3 id="端口规划"><a href="#端口规划" class="headerlink" title="端口规划"></a>端口规划</h3><table><thead><tr><th>服务</th><th>端口</th><th>备注</th><th>目录</th></tr></thead><tbody><tr><td>signaling</td><td>48031:1989 信令服务</td><td>信令服务</td><td>/opt/srs/signaling</td></tr><tr><td>signaling proxy</td><td>48032:443 信令服务代理</td><td>信令服务代理</td><td>/opt/srs/signaling</td></tr><tr><td>srs</td><td>48033:1935 rtmp服务<br/>48034:1985 http api 服务<br/>48035:443 https api 服务<br/>48036:8080 http proxy 服务<br/>48037:8090 https proxy 服务<br/>48038:48038 rtc udp</td><td>会议服务</td><td>/opt/srs/srs</td></tr><tr><td>es</td><td>48039</td><td></td><td></td></tr><tr><td>kibana</td><td>48040</td><td></td><td></td></tr></tbody></table><h3 id="signaling-服务"><a href="#signaling-服务" class="headerlink" title="signaling 服务"></a>signaling 服务</h3><p><code>docker-compose.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3&quot;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">signaling:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">java:8</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">signaling</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">48031</span><span class="hljs-string">:9999</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./signaling-0.0.1-SNAPSHOT.jar:/app.jar</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/localtime:/etc/localtime</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./ffmpeg:/ffmpeg</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">TZ=Asia/Shanghai</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">java</span> <span class="hljs-string">-jar</span> <span class="hljs-string">app.jar</span><br>  <span class="hljs-attr">singnalingproxy:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">singnalingproxy</span><br>    <span class="hljs-attr">links:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">signaling</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">48032</span><span class="hljs-string">:443</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">TZ=Asia/Shanghai</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./meeting.soyuan.com.cn.pem:/meeting.soyuan.com.cn.pem</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./meeting.soyuan.com.cn.key:/meeting.soyuan.com.cn.key</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginxsetting:/etc/nginx/conf.d</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/localtime:/etc/localtime</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./web:/web</span><br></code></pre></td></tr></table></figure><p><code>.nginxsetting/ssl.conf</code></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>     <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<br>     <span class="hljs-comment">#填写绑定证书的域名</span><br>     <span class="hljs-attribute">server_name</span> meeting.soyuan.com.cn;<br>     <span class="hljs-comment">#证书文件名称</span><br>     <span class="hljs-attribute">ssl_certificate</span> /meeting.soyuan.com.cn.pem;<br>     <span class="hljs-comment">#私钥文件名称</span><br>     <span class="hljs-attribute">ssl_certificate_key</span> /meeting.soyuan.com.cn.key;<br>     <span class="hljs-attribute">ssl_session_timeout</span> <span class="hljs-number">5m</span>;<br>     <span class="hljs-comment">#请按照以下协议配置</span><br>     <span class="hljs-attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="hljs-number">1</span> TLSv1.<span class="hljs-number">2</span>;<br>     <span class="hljs-comment">#请按照以下套件配置，配置加密套件，写法遵循 openssl 标准。</span><br>     <span class="hljs-attribute">ssl_ciphers</span> ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;<br><br>    <br>     <span class="hljs-section">location</span> /meeting &#123;<br>          <span class="hljs-attribute">proxy_pass</span> http://signaling:9999;<br>          <span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;<br>              <span class="hljs-attribute">proxy_set_header</span> Upgrade <span class="hljs-variable">$http_upgrade</span>;<br>              <span class="hljs-attribute">proxy_set_header</span> Connection <span class="hljs-string">&quot;Upgrade&quot;</span>;<br>     &#125;   <br>     <br>     <span class="hljs-section">location</span> / &#123;<br>        <span class="hljs-attribute">root</span>   /web;<br>        <span class="hljs-attribute">index</span>  index.html index.htm;<br>     &#125;   <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h4><p><code>docker-compose up -d</code></p><h3 id="srs服务"><a href="#srs服务" class="headerlink" title="srs服务"></a>srs服务</h3><p><code>docker-compose.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3&quot;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">srs:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">ossrs/srs:4</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">srs</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./srs.conf:/usr/local/srs/conf/docker.conf</span> <br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./meeting.soyuan.com.cn.pem:/meeting.soyuan.com.cn.pem</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./meeting.soyuan.com.cn.key:/meeting.soyuan.com.cn.key</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./live:/usr/local/srs/objs/nginx/html/live</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">48033</span><span class="hljs-string">:1935</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">48034</span><span class="hljs-string">:1985</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">48035</span><span class="hljs-string">:443</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">48036</span><span class="hljs-string">:8080</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">48037</span><span class="hljs-string">:8090</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">48038</span><span class="hljs-string">:48038/udp</span> <br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;CANDIDATE=meeting.soyuan.com.cn&quot;</span><br></code></pre></td></tr></table></figure><p><code>docker版本配置文件要映射到 docker.conf</code></p><p><strong>SRS on  amd64 x86_64, conf:conf/docker.conf, limit:1000, writev:1024, encoding:little-endian, HZ:100</strong></p><p><code>srs.conf</code></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">listen</span>              <span class="hljs-number">1935</span>;<br><span class="hljs-attribute">max_connections</span>     <span class="hljs-number">1000</span>;<br><span class="hljs-attribute">daemon</span>              <span class="hljs-literal">off</span>;<br><span class="hljs-comment"># the log tank, console or file.</span><br><span class="hljs-comment"># if console, print log to console.</span><br><span class="hljs-comment"># if file, write log to file. requires srs_log_file if log to file.</span><br><span class="hljs-comment"># default: file.</span><br><span class="hljs-attribute">srs_log_tank</span>        console;<br><br><span class="hljs-section">stats</span> &#123;<br>          <span class="hljs-comment"># the index of device ip.</span><br>          <span class="hljs-comment"># we may retrieve more than one network device.</span><br>          <span class="hljs-comment"># default: 0</span><br>          <span class="hljs-attribute">network</span>         <span class="hljs-number">0</span>;<br>          <span class="hljs-comment"># the device name to stat the disk iops.</span><br>          <span class="hljs-comment"># ignore the device of /proc/diskstats if not configed.</span><br>          <span class="hljs-attribute">disk</span>            sda sdb xvda xvdb;<br>      &#125;<br><br><span class="hljs-section">http_api</span> &#123;<br>    <span class="hljs-attribute">enabled</span>         <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">listen</span>          <span class="hljs-number">1985</span>;<br>    <span class="hljs-section">raw_api</span> &#123;<br>            <span class="hljs-comment"># whether enable the HTTP RAW API.</span><br>            <span class="hljs-comment"># default: off</span><br>            <span class="hljs-attribute">enabled</span>             <span class="hljs-literal">on</span>;<br>            <span class="hljs-comment"># whether enable rpc reload.</span><br>            <span class="hljs-comment"># default: off</span><br>            <span class="hljs-attribute">allow_reload</span>        <span class="hljs-literal">on</span>;<br>            <span class="hljs-comment"># whether enable rpc query.</span><br>            <span class="hljs-comment"># default: off</span><br>            <span class="hljs-attribute">allow_query</span>         <span class="hljs-literal">on</span>;<br>            <span class="hljs-comment"># whether enable rpc update.</span><br>            <span class="hljs-comment"># default: off</span><br>            <span class="hljs-attribute">allow_update</span>        <span class="hljs-literal">on</span>;<br>          &#125;<br>    <span class="hljs-section">https</span> &#123;<br>            <span class="hljs-attribute">enabled</span> <span class="hljs-literal">on</span>;<br>            <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span>;<br>            <span class="hljs-attribute">key</span> /meeting.soyuan.com.cn.key;<br>            <span class="hljs-attribute">cert</span> /meeting.soyuan.com.cn.pem;<br>          &#125;<br>&#125;<br><span class="hljs-section">http_server</span> &#123;<br>    <span class="hljs-attribute">enabled</span>         <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">listen</span>          <span class="hljs-number">8080</span>;<br>    <span class="hljs-section">https</span> &#123;<br>          <span class="hljs-attribute">enabled</span> <span class="hljs-literal">on</span>;<br>          <span class="hljs-attribute">listen</span> <span class="hljs-number">8090</span>;<br>          <span class="hljs-attribute">key</span> /meeting.soyuan.com.cn.key;<br>          <span class="hljs-attribute">cert</span> /meeting.soyuan.com.cn.pem;<br>    &#125;<br>&#125;<br><span class="hljs-section">rtc_server</span> &#123;<br>      <span class="hljs-attribute">enabled</span>         <span class="hljs-literal">on</span>;<br>      <span class="hljs-comment"># Listen at udp://48038</span><br>      <span class="hljs-attribute">listen</span>          <span class="hljs-number">48038</span>;<br>      <span class="hljs-comment">#</span><br>      <span class="hljs-comment"># The $CANDIDATE means fetch from env, if not configed, use * as default.</span><br>      <span class="hljs-comment">#</span><br>      <span class="hljs-comment"># The * means retrieving server IP automatically, from all network interfaces,</span><br>      <span class="hljs-comment"># @see https://github.com/ossrs/srs/issues/307#issuecomment-599028124</span><br>      <span class="hljs-attribute">candidate</span>       <span class="hljs-variable">$CANDIDATE</span>;<br>  &#125;<br><br><span class="hljs-comment"># 默认的 vhost __defaultVhost__</span><br><span class="hljs-attribute">vhost</span> meeting.soyuan.com.cn &#123;<br> <span class="hljs-comment"># 低延迟模式</span><br>      <span class="hljs-attribute">tcp_nodelay</span>     <span class="hljs-literal">on</span>;<br>      <span class="hljs-attribute">min_latency</span>     <span class="hljs-literal">on</span>;<br>      <span class="hljs-section">play</span> &#123;<br>          <span class="hljs-attribute">gop_cache</span>       <span class="hljs-literal">off</span>;<br>          <span class="hljs-attribute">queue_length</span>    <span class="hljs-number">10</span>;<br>          <span class="hljs-attribute">mw_latency</span>      <span class="hljs-number">100</span>;<br>      &#125;<br><br>      <span class="hljs-section">publish</span> &#123;<br>          <span class="hljs-attribute">mr</span> <span class="hljs-literal">off</span>;<br>      &#125;<br>      <br>      <span class="hljs-comment"># hls 播放</span><br>      <span class="hljs-section">hls</span> &#123;<br>          <span class="hljs-attribute">enabled</span>         <span class="hljs-literal">off</span>;<br>          <span class="hljs-attribute">hls_path</span>        ./objs/nginx/html;<br>      &#125;<br>      <span class="hljs-comment"># 开启 flv 播放</span><br>      <span class="hljs-section">http_remux</span> &#123;<br>          <span class="hljs-attribute">enabled</span>     <span class="hljs-literal">off</span>;<br>          <span class="hljs-attribute">mount</span>       [vhost]/[app]/[stream].flv;<br>      &#125;<br>      <span class="hljs-section">rtc</span> &#123;<br>          <span class="hljs-attribute">enabled</span>     <span class="hljs-literal">on</span>;<br>          <span class="hljs-attribute">bframe</span>      discard;<br>          <span class="hljs-comment"># rtc 转 rtmp，为了录制视频</span><br>          <span class="hljs-attribute">rtc_to_rtmp</span> <span class="hljs-literal">on</span>;<br>      &#125;<br>      <span class="hljs-section">dvr</span> &#123;<br>          <span class="hljs-attribute">enabled</span>         <span class="hljs-literal">on</span>;<br>          <span class="hljs-attribute">dvr_apply</span>       all;<br>          <span class="hljs-attribute">dvr_plan</span>        session;<br>          <span class="hljs-attribute">dvr_path</span>        ./objs/nginx/html/[app]/[stream].[timestamp].mp4;<br>          <span class="hljs-attribute">time_jitter</span>             full;<br>      &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="启动服务-1"><a href="#启动服务-1" class="headerlink" title="启动服务"></a>启动服务</h4><p><code>docker-compose up -d</code></p>]]></content>
    
    
    <categories>
      
      <category>srs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>开发</tag>
      
      <tag>srs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>cfssl工具制作证书</title>
    <link href="/wiki/2021/11/02/ssl/cfssl%E5%B7%A5%E5%85%B7%E5%88%B6%E4%BD%9C%E8%AF%81%E4%B9%A6/"/>
    <url>/wiki/2021/11/02/ssl/cfssl%E5%B7%A5%E5%85%B7%E5%88%B6%E4%BD%9C%E8%AF%81%E4%B9%A6/</url>
    
    <content type="html"><![CDATA[<h2 id="安装cfssl"><a href="#安装cfssl" class="headerlink" title="安装cfssl"></a>安装cfssl</h2><p><a href="https://github.com/cloudflare/cfssl/releases">去git下载二进制文件</a></p><p>下载文件 <code>cfssl_1.6.1_linux_amd64</code> <code>cfssl-certinfo_1.6.1_linux_amd64</code> <code>cfssljson_1.6.1_linux_amd64</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">赋权限</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">chmod</span> +x cffs*</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">移动到 /usr/local/bin</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mv</span> cfssl_1.6.1_linux_amd64 /usr/local/bin/cfssl</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mv</span> cfssl-certinfo_1.6.1_linux_amd64 /usr/local/bin/cfssl-certinfo</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mv</span> cfssljson_1.6.1_linux_amd64 /usr/local/bin/cfssljson</span><br></code></pre></td></tr></table></figure><h2 id="生成根证书"><a href="#生成根证书" class="headerlink" title="生成根证书"></a>生成根证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">根证书请求配置文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> ca-csr.json</span><br><br>&#123;<br>        &quot;CN&quot;: &quot;soyuan&quot;,<br>        &quot;key&quot;: &#123;<br>                &quot;algo&quot;: &quot;rsa&quot;,<br>                &quot;size&quot;: 2048<br>        &#125;,<br>        &quot;names&quot;: [&#123;<br>                &quot;C&quot;: &quot;CN&quot;,<br>                &quot;ST&quot;: &quot;Beijing&quot;,<br>                &quot;L&quot;: &quot;beijing&quot;,<br>                &quot;O&quot;: &quot;soyuan&quot;,<br>                &quot;OU&quot;: &quot;spzl&quot;<br>        &#125;]<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">生成证书</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">-base ca 指定生成的证书名称</span><br></code></pre></td></tr></table></figure><p><code>CN</code>   证书名称</p><p><code>C</code> Country， 国家</p><p><code>L</code> Locality，地区，城市</p><p><code>O</code> Organization Name，组织名称，公司名称</p><p><code>OU</code> Organization Unit Name，组织单位名称，公司部门</p><p><code>ST</code> State，州，省</p><h2 id="通过ca签发服务器证书"><a href="#通过ca签发服务器证书" class="headerlink" title="通过ca签发服务器证书"></a>通过ca签发服务器证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">服务器证书请求配置文件</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> 172.16.100.92-csr.json</span><br>&#123;<br>    &quot;CN&quot;: &quot;172.16.100.92&quot;,<br>    &quot;hosts&quot;: [<br>      &quot;172.16.100.92&quot;,<br>      &quot;kube-master&quot;<br>    ],<br>    &quot;key&quot;: &#123;<br>        &quot;algo&quot;: &quot;rsa&quot;,<br>        &quot;size&quot;: 2048<br>    &#125;,<br>    &quot;names&quot;: [<br>        &#123;<br>            &quot;C&quot;: &quot;CN&quot;,<br>            &quot;L&quot;: &quot;BeiJing&quot;,<br>            &quot;ST&quot;: &quot;BeiJing&quot;,<br>            &quot;O&quot;: &quot;soyuan&quot;,<br>            &quot;OU&quot;: &quot;spzl&quot;<br>        &#125;<br>    ]<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">生成证书策略文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> ca-config.json</span><br>&#123;<br>  &quot;signing&quot;: &#123;<br>    &quot;default&quot;: &#123;<br>      &quot;expiry&quot;: &quot;87600h&quot;<br>    &#125;,<br>    &quot;profiles&quot;: &#123;<br>      &quot;server&quot;: &#123;<br>        &quot;expiry&quot;: &quot;87600h&quot;,<br>        &quot;usages&quot;: [<br>          &quot;signing&quot;,<br>          &quot;key encipherment&quot;,<br>          &quot;server auth&quot;,<br>          &quot;client auth&quot;<br>        ]<br>      &#125;,<br>      &quot;intermediate&quot;: &#123;<br>        &quot;expiry&quot;: &quot;87600h&quot;,<br>        &quot;usages&quot;: [<br>          &quot;signing&quot;,<br>          &quot;key encipherment&quot;,<br>          &quot;cert sign&quot;,<br>          &quot;crl sign&quot;,<br>          &quot;server auth&quot;,<br>          &quot;client auth&quot;<br>        ]<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">生成证书</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=92 172.16.100.92-csr.json | cfssljson -bare 172.16.100.92</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">单独生成csr文件</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">cfssl genkey csr.json | cfssljson -bare 172.16.100.92</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">证书和私钥合并成pfx</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">openssl pkcs12 -<span class="hljs-built_in">export</span> -out certificate.pfx -inkey private_key.pem -<span class="hljs-keyword">in</span> certificate.pem -certfile intermediate_cert.pem</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">pfx 提取证书和私钥</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">openssl pkcs12 -<span class="hljs-keyword">in</span> certificate.pfx -nocerts -nodes -out private_key.pem</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">openssl pkcs12 -<span class="hljs-keyword">in</span> certificate.pfx -clcerts -nokeys -out certificate.pem</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">openssl verify -CAfile ca.pem intermediate.pem</span> <br></code></pre></td></tr></table></figure><ul><li>默认策略，指定了证书的有效期是一年(8760h)</li><li><code>usages.signing</code>, 表示该证书可用于签名其它证书；生成的 ca.pem 证书中 CA=TRUE</li><li><code>usages.server auth</code>：表示 client 可以用该 CA 对 server 提供的证书进行验证</li><li><code>usages.client auth</code>：表示 server 可以用该 CA 对 client 提供的证书进行验证</li></ul><h2 id="证书格式转换"><a href="#证书格式转换" class="headerlink" title="证书格式转换"></a>证书格式转换</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">pem &gt; crt</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">openssl x509 -<span class="hljs-keyword">in</span> ca.pem -out ca.crt</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">pem &gt; key</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">openssl rsa -<span class="hljs-keyword">in</span> ca.pem -out ca.key</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ssl</category>
      
    </categories>
    
    
    <tags>
      
      <tag>开发</tag>
      
      <tag>ssl</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>制作ssl证书</title>
    <link href="/wiki/2021/11/02/ssl/%E5%88%B6%E4%BD%9C%E8%AF%81%E4%B9%A6/"/>
    <url>/wiki/2021/11/02/ssl/%E5%88%B6%E4%BD%9C%E8%AF%81%E4%B9%A6/</url>
    
    <content type="html"><![CDATA[<h2 id="制作根证书"><a href="#制作根证书" class="headerlink" title="制作根证书"></a>制作根证书</h2><blockquote><p>openssl默认生成的是v1版本的证书，浏览器目前只支持v3版本的证书，v3 版本证书生成时需要在cnf配置文件中增加扩展属性</p><p>subjectAltName 扩展属性指定自签名证书ip地址或者dns；必须设置，不设置会导致浏览器提示不安全</p><p>配置文件在生成csr的时候可以设置默认值</p><p>配置文件在生成crt的时候可以设置扩展属性</p></blockquote><p><code>ca.conf</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">[ req ]<br>default_bits       = 4096<br>distinguished_name = req_distinguished_name <br><br>[ req_distinguished_name ]<br>countryName                 = Country Name (2 letter code)<br>countryName_default         = CN<br>stateOrProvinceName         = State or Province Name (full name)<br>stateOrProvinceName_default = BJ<br>localityName                = Locality Name (eg, city)<br>localityName_default        = BJ<br>organizationName            = Organization Name (eg, company)<br>organizationName_default    = soyuan<br>organizationalUnitName            = Organizational Unit Name (eg, section)<br>organizationalUnitName_default    = soyuan<br>commonName                  = Common Name (e.g. server FQDN or YOUR name)<br>commonName_max              = 64<br>commonName_default          = soyuan<br></code></pre></td></tr></table></figure><h4 id="名字解释"><a href="#名字解释" class="headerlink" title="名字解释"></a>名字解释</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">Enter pass phrase for fd.key:输入私钥的加密密码，如生成的是加密私钥<br>Country Name (2 letter code) [XX]:CN输入国家名，至少两个字符<br>State or Province Name(ful name) []:JX输入洲/省的名称<br>Locality Name（eg,city) [Default City]:GZ输入地点名称(如城市)[默认城市]<br>Organization Name (eg, company) [Default Company Ltd]:JXUST输入组织名称<br>Organizational Unit Name (eg, section) []:XA输入部门名称<br>Common Name (eg, your name or your server&#x27;s hostname) []:last-player输入常用名称<br>Email Address []:asdad@asda.com输入邮箱地址<br></code></pre></td></tr></table></figure><h4 id="生成服务器私钥"><a href="#生成服务器私钥" class="headerlink" title="生成服务器私钥"></a>生成服务器私钥</h4><p><code>openssl genrsa -out ca.key 2048</code></p><h4 id="创建根证书的申请文件"><a href="#创建根证书的申请文件" class="headerlink" title="创建根证书的申请文件"></a>创建根证书的申请文件</h4><p><code>openssl req -new -key ca.key -out ca.csr -config ca.conf</code></p><h4 id="创建一个自当前日期起为期十年的根证书"><a href="#创建一个自当前日期起为期十年的根证书" class="headerlink" title="创建一个自当前日期起为期十年的根证书"></a>创建一个自当前日期起为期十年的根证书</h4><p><code>openssl x509 -req -days 3650 -sha256 -extfile ca.cnf -signkey ca.key -in ca.csr -out ca.crt</code></p><h2 id="制作服务器证书"><a href="#制作服务器证书" class="headerlink" title="制作服务器证书"></a>制作服务器证书</h2><h4 id="创建服务器证书密钥"><a href="#创建服务器证书密钥" class="headerlink" title="创建服务器证书密钥"></a>创建服务器证书密钥</h4><p><code>openssl genrsa -des3 -out 172.16.100.92.key 2048</code></p><h4 id="创建服务器证书的申请文件"><a href="#创建服务器证书的申请文件" class="headerlink" title="创建服务器证书的申请文件"></a>创建服务器证书的申请文件</h4><p>生成服务器端证书的时候，要设置使用者ip 或域名，这个使用cnf文件</p><p><code>172.16.100.92.cnf</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs shell">[ req ]<br>default_bits       = 4096<br>distinguished_name = req_distinguished_name<br>req_extensions     = req_ext<br><br>[ req_distinguished_name ]<br>countryName                 = Country Name (2 letter code)<br>countryName_default         = CN<br>stateOrProvinceName         = State or Province Name (full name)<br>stateOrProvinceName_default = BJ<br>localityName                = Locality Name (eg, city)<br>localityName_default        = BJ<br>organizationName            = Organization Name (eg, company)<br>organizationName_default    = 92SVC<br>organizationalUnitName            = Organizational Unit Name (eg, section)<br>organizationalUnitName_default    = 92SVC<br>commonName                  = Common Name (e.g. server FQDN or YOUR name)<br>commonName_max              = 64<br>commonName_default          = 92SVC<br><br>[ req_ext ]<br>basicConstraints = CA:FALSE<br>keyUsage = nonRepudiation, digitalSignature, keyEncipherment<br>subjectAltName = @alt_names<br><br>[alt_names]<br>IP.1    = 172.16.100.92<br><span class="hljs-meta prompt_">#</span><span class="language-bash">DNS.1   = your-website.dev</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">DNS.2   = another-website.dev</span><br></code></pre></td></tr></table></figure><p><code>openssl req -new -key 172.16.100.92.key -out 172.16.100.92.csr -config 172.16.100.92.cnf</code> </p><h4 id="创建自当前日期起有效期为期两年的服务器证书"><a href="#创建自当前日期起有效期为期两年的服务器证书" class="headerlink" title="创建自当前日期起有效期为期两年的服务器证书"></a>创建自当前日期起有效期为期两年的服务器证书</h4><p><code>openssl x509 -req -days 730 -sha256 -extensions req_ext -extfile 172.16.100.92.cnf -CA ca.crt -CAkey server.key -CAserial 172.16.100.92.srl -CAcreateserial -in 172.16.100.92.csr -out 172.16.100.92.crt</code></p><ul><li>extensions 指定的扩展属性</li><li>extfile 指定扩展属性的所在文件 </li></ul><h4 id="把服务器秘钥不带密码的key解析出来"><a href="#把服务器秘钥不带密码的key解析出来" class="headerlink" title="把服务器秘钥不带密码的key解析出来"></a>把服务器秘钥不带密码的key解析出来</h4><p><code>openssl rsa -in 172.16.100.92.key -out 172.16.100.92_unsecure.key</code></p><h3 id="将证书合并成pfx文件"><a href="#将证书合并成pfx文件" class="headerlink" title="将证书合并成pfx文件"></a>将证书合并成pfx文件</h3><p><code>openssl pkcs12 -export -in 172.16.100.92.crt -inkey 172.16.100.92.key -out 172.16.100.92.pfx</code></p><p>将证书合并成pem文件</p><p><code>cat 172.16.100.92.key 172.16.100.92.crt &gt; 172.16.100.92.pem</code></p>]]></content>
    
    
    <categories>
      
      <category>ssl</category>
      
    </categories>
    
    
    <tags>
      
      <tag>开发</tag>
      
      <tag>ssl</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
